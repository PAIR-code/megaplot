/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright © 2016-2017 Mapbox, Inc.
 * This code available under the terms of the BSD 2-Clause license.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS “AS IS”
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */
/**
 * @license
 * The MIT License (MIT)
 *
 * Copyright (c) 2016 Mikola Lysenko
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).megaplot=e.megaplot||{})}(this,(function(e){"use strict";function t(e,t,r,i){return new(r||(r=Promise))((function(n,a){function o(e){try{u(i.next(e))}catch(e){a(e)}}function s(e){try{u(i.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,s)}u((i=i.apply(e,t||[])).next())}))}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var r=function(e){var t={exports:{}};return e(t,t.exports),t.exports}((function(e,t){e.exports=function(){var e=function(e){return e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Float32Array||e instanceof Float64Array||e instanceof Uint8ClampedArray},t=function(e,t){for(var r=Object.keys(t),i=0;i<r.length;++i)e[r[i]]=t[r[i]];return e},r="\n";function i(e){return"undefined"!=typeof atob?atob(e):"base64:"+e}function n(e){var t=new Error("(regl) "+e);throw console.error(t),t}function a(e,t){e||n(t)}function o(e){return e?": "+e:""}function s(e,t,r){e in t||n("unknown parameter ("+e+")"+o(r)+". possible values: "+Object.keys(t).join())}function u(t,r){e(t)||n("invalid parameter type"+o(r)+". must be a typed array")}function l(e,t){switch(t){case"number":return"number"==typeof e;case"object":return"object"==typeof e;case"string":return"string"==typeof e;case"boolean":return"boolean"==typeof e;case"function":return"function"==typeof e;case"undefined":return void 0===e;case"symbol":return"symbol"==typeof e}}function c(e,t,r){l(e,t)||n("invalid parameter type"+o(r)+". expected "+t+", got "+typeof e)}function f(e,t){e>=0&&(0|e)===e||n("invalid parameter type, ("+e+")"+o(t)+". must be a nonnegative integer")}function h(e,t,r){t.indexOf(e)<0&&n("invalid value"+o(r)+". must be one of: "+t)}var d=["gl","canvas","container","attributes","pixelRatio","extensions","optionalExtensions","profile","onDone"];function p(e){Object.keys(e).forEach((function(e){d.indexOf(e)<0&&n('invalid regl constructor argument "'+e+'". must be one of '+d)}))}function m(e,t){for(e+="";e.length<t;)e=" "+e;return e}function g(){this.name="unknown",this.lines=[],this.index={},this.hasErrors=!1}function b(e,t){this.number=e,this.line=t,this.errors=[]}function v(e,t,r){this.file=e,this.line=t,this.message=r}function x(){var e=new Error,t=(e.stack||e).toString(),r=/compileProcedure.*\n\s*at.*\((.*)\)/.exec(t);if(r)return r[1];var i=/compileProcedure.*\n\s*at\s+(.*)(\n|$)/.exec(t);return i?i[1]:"unknown"}function y(){var e=new Error,t=(e.stack||e).toString(),r=/at REGLCommand.*\n\s+at.*\((.*)\)/.exec(t);if(r)return r[1];var i=/at REGLCommand.*\n\s+at\s+(.*)\n/.exec(t);return i?i[1]:"unknown"}function w(e,t){var r=e.split("\n"),n=1,a=0,o={unknown:new g,0:new g};o.unknown.name=o[0].name=t||x(),o.unknown.lines.push(new b(0,""));for(var s=0;s<r.length;++s){var u=r[s],l=/^\s*#\s*(\w+)\s+(.+)\s*$/.exec(u);if(l)switch(l[1]){case"line":var c=/(\d+)(\s+\d+)?/.exec(l[2]);c&&(n=0|c[1],c[2]&&((a=0|c[2])in o||(o[a]=new g)));break;case"define":var f=/SHADER_NAME(_B64)?\s+(.*)$/.exec(l[2]);f&&(o[a].name=f[1]?i(f[2]):f[2])}o[a].lines.push(new b(n++,u))}return Object.keys(o).forEach((function(e){var t=o[e];t.lines.forEach((function(e){t.index[e.number]=e}))})),o}function T(e){var t=[];return e.split("\n").forEach((function(e){if(!(e.length<5)){var r=/^ERROR:\s+(\d+):(\d+):\s*(.*)$/.exec(e);r?t.push(new v(0|r[1],0|r[2],r[3].trim())):e.length>0&&t.push(new v("unknown",0,e))}})),t}function S(e,t){t.forEach((function(t){var r=e[t.file];if(r){var i=r.index[t.line];if(i)return i.errors.push(t),void(r.hasErrors=!0)}e.unknown.hasErrors=!0,e.unknown.lines[0].errors.push(t)}))}function k(e,t,i,n,o){if(!e.getShaderParameter(t,e.COMPILE_STATUS)){var s=e.getShaderInfoLog(t),u=n===e.FRAGMENT_SHADER?"fragment":"vertex";D(i,"string",u+" shader source must be a string",o);var l=w(i,o),c=T(s);S(l,c),Object.keys(l).forEach((function(e){var t=l[e];if(t.hasErrors){var i=[""],n=[""];a("file number "+e+": "+t.name+"\n","color:red;text-decoration:underline;font-weight:bold"),t.lines.forEach((function(e){if(e.errors.length>0){a(m(e.number,4)+"|  ","background-color:yellow; font-weight:bold"),a(e.line+r,"color:red; background-color:yellow; font-weight:bold");var t=0;e.errors.forEach((function(i){var n=i.message,o=/^\s*'(.*)'\s*:\s*(.*)$/.exec(n);if(o){var s=o[1];switch(n=o[2],s){case"assign":s="="}t=Math.max(e.line.indexOf(s,t),0)}else t=0;a(m("| ",6)),a(m("^^^",t+3)+r,"font-weight:bold"),a(m("| ",6)),a(n+r,"font-weight:bold")})),a(m("| ",6)+r)}else a(m(e.number,4)+"|  "),a(e.line+r,"color:red")})),"undefined"==typeof document||window.chrome?console.log(i.join("")):(n[0]=i.join("%c"),console.log.apply(console,n))}function a(e,t){i.push(e),n.push(t||"")}})),a.raise("Error compiling "+u+" shader, "+l[0].name)}}function A(e,t,i,n,o){if(!e.getProgramParameter(t,e.LINK_STATUS)){var s=e.getProgramInfoLog(t),u=w(i,o),l='Error linking program with vertex shader, "'+w(n,o)[0].name+'", and fragment shader "'+u[0].name+'"';"undefined"!=typeof document?console.log("%c"+l+r+"%c"+s,"color:red;text-decoration:underline;font-weight:bold","color:red"):console.log(l+r+s),a.raise(l)}}function C(e){e._commandRef=x()}function P(e,t,r,i){function n(e){return e?i.id(e):0}function a(e,t){Object.keys(t).forEach((function(t){e[i.id(t)]=!0}))}C(e),e._fragId=n(e.static.frag),e._vertId=n(e.static.vert);var o=e._uniformSet={};a(o,t.static),a(o,t.dynamic);var s=e._attributeSet={};a(s,r.static),a(s,r.dynamic),e._hasCount="count"in e.static||"count"in e.dynamic||"elements"in e.static||"elements"in e.dynamic}function R(e,t){var r=y();n(e+" in command "+(t||x())+("unknown"===r?"":" called from "+r))}function E(e,t,r){e||R(t,r||x())}function z(e,t,r,i){e in t||R("unknown parameter ("+e+")"+o(r)+". possible values: "+Object.keys(t).join(),i||x())}function D(e,t,r,i){l(e,t)||R("invalid parameter type"+o(r)+". expected "+t+", got "+typeof e,i||x())}function _(e){e()}function M(e,t,r){e.texture?h(e.texture._texture.internalformat,t,"unsupported texture format for attachment"):h(e.renderbuffer._renderbuffer.format,r,"unsupported renderbuffer format for attachment")}var V=33071,N=9728,I=9984,B=9985,O=9986,F=9987,j=5121,W=5122,L=5123,H=5124,U=5125,$=5126,G=32819,q=32820,X=33635,Y=34042,Z=36193,Q={};function K(e,t){return e===q||e===G||e===X?2:e===Y?4:Q[e]*t}function J(e){return!(e&e-1||!e)}function ee(e,t,r){var i,n=t.width,o=t.height,s=t.channels;a(n>0&&n<=r.maxTextureSize&&o>0&&o<=r.maxTextureSize,"invalid texture shape"),e.wrapS===V&&e.wrapT===V||a(J(n)&&J(o),"incompatible wrap mode for texture, both width and height must be power of 2"),1===t.mipmask?1!==n&&1!==o&&a(e.minFilter!==I&&e.minFilter!==O&&e.minFilter!==B&&e.minFilter!==F,"min filter requires mipmap"):(a(J(n)&&J(o),"texture must be a square power of 2 to support mipmapping"),a(t.mipmask===(n<<1)-1,"missing or incomplete mipmap data")),t.type===$&&(r.extensions.indexOf("oes_texture_float_linear")<0&&a(e.minFilter===N&&e.magFilter===N,"filter not supported, must enable oes_texture_float_linear"),a(!e.genMipmaps,"mipmap generation not supported with float textures"));var u=t.images;for(i=0;i<16;++i)if(u[i]){var l=n>>i,c=o>>i;a(t.mipmask&1<<i,"missing mipmap data");var f=u[i];if(a(f.width===l&&f.height===c,"invalid shape for mip images"),a(f.format===t.format&&f.internalformat===t.internalformat&&f.type===t.type,"incompatible type for mip image"),f.compressed);else if(f.data){var h=Math.ceil(K(f.type,s)*l/f.unpackAlignment)*f.unpackAlignment;a(f.data.byteLength===h*c,"invalid data for image, buffer size is inconsistent with image format")}else f.element||f.copy}else e.genMipmaps||a(0==(t.mipmask&1<<i),"extra mipmap data");t.compressed&&a(!e.genMipmaps,"mipmap generation for compressed images not supported")}function te(e,t,r,i){var n=e.width,o=e.height,s=e.channels;a(n>0&&n<=i.maxTextureSize&&o>0&&o<=i.maxTextureSize,"invalid texture shape"),a(n===o,"cube map must be square"),a(t.wrapS===V&&t.wrapT===V,"wrap mode not supported by cube map");for(var u=0;u<r.length;++u){var l=r[u];a(l.width===n&&l.height===o,"inconsistent cube map face shape"),t.genMipmaps&&(a(!l.compressed,"can not generate mipmap for compressed textures"),a(1===l.mipmask,"can not specify mipmaps and generate mipmaps"));for(var c=l.images,f=0;f<16;++f){var h=c[f];if(h){var d=n>>f,p=o>>f;a(l.mipmask&1<<f,"missing mipmap data"),a(h.width===d&&h.height===p,"invalid shape for mip images"),a(h.format===e.format&&h.internalformat===e.internalformat&&h.type===e.type,"incompatible type for mip image"),h.compressed||(h.data?a(h.data.byteLength===d*p*Math.max(K(h.type,s),h.unpackAlignment),"invalid data for image, buffer size is inconsistent with image format"):h.element||h.copy)}}}}Q[5120]=Q[j]=1,Q[W]=Q[L]=Q[Z]=Q[X]=Q[G]=Q[q]=2,Q[H]=Q[U]=Q[$]=Q[Y]=4;var re=t(a,{optional:_,raise:n,commandRaise:R,command:E,parameter:s,commandParameter:z,constructor:p,type:c,commandType:D,isTypedArray:u,nni:f,oneOf:h,shaderError:k,linkError:A,callSite:y,saveCommandRef:C,saveDrawInfo:P,framebufferFormat:M,guessCommand:x,texture2D:ee,textureCube:te}),ie=0,ne=0;function ae(e,t){this.id=ie++,this.type=e,this.data=t}function oe(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function se(e){if(0===e.length)return[];var t=e.charAt(0),r=e.charAt(e.length-1);if(e.length>1&&t===r&&('"'===t||"'"===t))return['"'+oe(e.substr(1,e.length-2))+'"'];var i=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(e);if(i)return se(e.substr(0,i.index)).concat(se(i[1])).concat(se(e.substr(i.index+i[0].length)));var n=e.split(".");if(1===n.length)return['"'+oe(e)+'"'];for(var a=[],o=0;o<n.length;++o)a=a.concat(se(n[o]));return a}function ue(e){return"["+se(e).join("][")+"]"}function le(e,t){return new ae(e,ue(t+""))}function ce(e){return"function"==typeof e&&!e._reglType||e instanceof ae}function fe(e,t){return"function"==typeof e?new ae(ne,e):e}var he={DynamicVariable:ae,define:le,isDynamic:ce,unbox:fe,accessor:ue},de={next:"function"==typeof requestAnimationFrame?function(e){return requestAnimationFrame(e)}:function(e){return setTimeout(e,16)},cancel:"function"==typeof cancelAnimationFrame?function(e){return cancelAnimationFrame(e)}:clearTimeout},pe="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date};function me(){var e={"":0},t=[""];return{id:function(r){var i=e[r];return i||(i=e[r]=t.length,t.push(r),i)},str:function(e){return t[e]}}}function ge(e,r,i){var n=document.createElement("canvas");function a(){var r=window.innerWidth,a=window.innerHeight;if(e!==document.body){var o=e.getBoundingClientRect();r=o.right-o.left,a=o.bottom-o.top}n.width=i*r,n.height=i*a,t(n.style,{width:r+"px",height:a+"px"})}function o(){window.removeEventListener("resize",a),e.removeChild(n)}return t(n.style,{border:0,margin:0,padding:0,top:0,left:0}),e.appendChild(n),e===document.body&&(n.style.position="absolute",t(e.style,{margin:0,padding:0})),window.addEventListener("resize",a,!1),a(),{canvas:n,onDestroy:o}}function be(e,t){function r(r){try{return e.getContext(r,t)}catch(e){return null}}return r("webgl")||r("experimental-webgl")||r("webgl-experimental")}function ve(e){return"string"==typeof e.nodeName&&"function"==typeof e.appendChild&&"function"==typeof e.getBoundingClientRect}function xe(e){return"function"==typeof e.drawArrays||"function"==typeof e.drawElements}function ye(e){return"string"==typeof e?e.split():(re(Array.isArray(e),"invalid extension array"),e)}function we(e){return"string"==typeof e?(re("undefined"!=typeof document,"not supported outside of DOM"),document.querySelector(e)):e}function Te(e){var t,r,i,n,a=e||{},o={},s=[],u=[],l="undefined"==typeof window?1:window.devicePixelRatio,c=!1,f=function(e){e&&re.raise(e)},h=function(){};if("string"==typeof a?(re("undefined"!=typeof document,"selector queries only supported in DOM enviroments"),t=document.querySelector(a),re(t,"invalid query string for element")):"object"==typeof a?ve(a)?t=a:xe(a)?i=(n=a).canvas:(re.constructor(a),"gl"in a?n=a.gl:"canvas"in a?i=we(a.canvas):"container"in a&&(r=we(a.container)),"attributes"in a&&(o=a.attributes,re.type(o,"object","invalid context attributes")),"extensions"in a&&(s=ye(a.extensions)),"optionalExtensions"in a&&(u=ye(a.optionalExtensions)),"onDone"in a&&(re.type(a.onDone,"function","invalid or missing onDone callback"),f=a.onDone),"profile"in a&&(c=!!a.profile),"pixelRatio"in a&&(l=+a.pixelRatio,re(l>0,"invalid pixel ratio"))):re.raise("invalid arguments to regl"),t&&("canvas"===t.nodeName.toLowerCase()?i=t:r=t),!n){if(!i){re("undefined"!=typeof document,"must manually specify webgl context outside of DOM environments");var d=ge(r||document.body,f,l);if(!d)return null;i=d.canvas,h=d.onDestroy}o.premultipliedAlpha=o.premultipliedAlpha||!1,n=be(i,o)}return n?{gl:n,canvas:i,container:r,extensions:s,optionalExtensions:u,pixelRatio:l,profile:c,onDone:f,onDestroy:h}:(h(),f("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function Se(e,t){var r={};function i(t){re.type(t,"string","extension name must be string");var i,n=t.toLowerCase();try{i=r[n]=e.getExtension(n)}catch(e){}return!!i}for(var n=0;n<t.extensions.length;++n){var a=t.extensions[n];if(!i(a))return t.onDestroy(),t.onDone('"'+a+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return t.optionalExtensions.forEach(i),{extensions:r,restore:function(){Object.keys(r).forEach((function(e){if(r[e]&&!i(e))throw new Error("(regl): error restoring extension "+e)}))}}}function ke(e,t){for(var r=Array(e),i=0;i<e;++i)r[i]=t(i);return r}var Ae=5120,Ce=5121,Pe=5122,Re=5123,Ee=5124,ze=5125,De=5126;function _e(e){for(var t=16;t<=1<<28;t*=16)if(e<=t)return t;return 0}function Me(e){var t,r;return t=(e>65535)<<4,t|=r=((e>>>=t)>255)<<3,t|=r=((e>>>=r)>15)<<2,(t|=r=((e>>>=r)>3)<<1)|(e>>>=r)>>1}function Ve(){var e=ke(8,(function(){return[]}));function t(t){var r=_e(t),i=e[Me(r)>>2];return i.length>0?i.pop():new ArrayBuffer(r)}function r(t){e[Me(t.byteLength)>>2].push(t)}function i(e,r){var i=null;switch(e){case Ae:i=new Int8Array(t(r),0,r);break;case Ce:i=new Uint8Array(t(r),0,r);break;case Pe:i=new Int16Array(t(2*r),0,r);break;case Re:i=new Uint16Array(t(2*r),0,r);break;case Ee:i=new Int32Array(t(4*r),0,r);break;case ze:i=new Uint32Array(t(4*r),0,r);break;case De:i=new Float32Array(t(4*r),0,r);break;default:return null}return i.length!==r?i.subarray(0,r):i}function n(e){r(e.buffer)}return{alloc:t,free:r,allocType:i,freeType:n}}var Ne=Ve();Ne.zero=Ve();var Ie=3408,Be=3410,Oe=3411,Fe=3412,je=3413,We=3414,Le=3415,He=33901,Ue=33902,$e=3379,Ge=3386,qe=34921,Xe=36347,Ye=36348,Ze=35661,Qe=35660,Ke=34930,Je=36349,et=34076,tt=34024,rt=7936,it=7937,nt=7938,at=35724,ot=34047,st=36063,ut=34852,lt=3553,ct=34067,ft=34069,ht=33984,dt=6408,pt=5126,mt=5121,gt=36160,bt=36053,vt=36064,xt=16384,yt=function(e,t){var r=1;t.ext_texture_filter_anisotropic&&(r=e.getParameter(ot));var i=1,n=1;t.webgl_draw_buffers&&(i=e.getParameter(ut),n=e.getParameter(st));var a=!!t.oes_texture_float;if(a){var o=e.createTexture();e.bindTexture(lt,o),e.texImage2D(lt,0,dt,1,1,0,dt,pt,null);var s=e.createFramebuffer();if(e.bindFramebuffer(gt,s),e.framebufferTexture2D(gt,vt,lt,o,0),e.bindTexture(lt,null),e.checkFramebufferStatus(gt)!==bt)a=!1;else{e.viewport(0,0,1,1),e.clearColor(1,0,0,1),e.clear(xt);var u=Ne.allocType(pt,4);e.readPixels(0,0,1,1,dt,pt,u),e.getError()?a=!1:(e.deleteFramebuffer(s),e.deleteTexture(o),a=1===u[0]),Ne.freeType(u)}}var l=!0;if("undefined"==typeof navigator||!(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent))){var c=e.createTexture(),f=Ne.allocType(mt,36);e.activeTexture(ht),e.bindTexture(ct,c),e.texImage2D(ft,0,dt,3,3,0,dt,mt,f),Ne.freeType(f),e.bindTexture(ct,null),e.deleteTexture(c),l=!e.getError()}return{colorBits:[e.getParameter(Be),e.getParameter(Oe),e.getParameter(Fe),e.getParameter(je)],depthBits:e.getParameter(We),stencilBits:e.getParameter(Le),subpixelBits:e.getParameter(Ie),extensions:Object.keys(t).filter((function(e){return!!t[e]})),maxAnisotropic:r,maxDrawbuffers:i,maxColorAttachments:n,pointSizeDims:e.getParameter(He),lineWidthDims:e.getParameter(Ue),maxViewportDims:e.getParameter(Ge),maxCombinedTextureUnits:e.getParameter(Ze),maxCubeMapSize:e.getParameter(et),maxRenderbufferSize:e.getParameter(tt),maxTextureUnits:e.getParameter(Ke),maxTextureSize:e.getParameter($e),maxAttributes:e.getParameter(qe),maxVertexUniforms:e.getParameter(Xe),maxVertexTextureUnits:e.getParameter(Qe),maxVaryingVectors:e.getParameter(Ye),maxFragmentUniforms:e.getParameter(Je),glsl:e.getParameter(at),renderer:e.getParameter(it),vendor:e.getParameter(rt),version:e.getParameter(nt),readFloat:a,npotTextureCube:l}};function wt(t){return!!t&&"object"==typeof t&&Array.isArray(t.shape)&&Array.isArray(t.stride)&&"number"==typeof t.offset&&t.shape.length===t.stride.length&&(Array.isArray(t.data)||e(t.data))}var Tt=function(e){return Object.keys(e).map((function(t){return e[t]}))},St={shape:Et,flatten:Rt};function kt(e,t,r){for(var i=0;i<t;++i)r[i]=e[i]}function At(e,t,r,i){for(var n=0,a=0;a<t;++a)for(var o=e[a],s=0;s<r;++s)i[n++]=o[s]}function Ct(e,t,r,i,n,a){for(var o=a,s=0;s<t;++s)for(var u=e[s],l=0;l<r;++l)for(var c=u[l],f=0;f<i;++f)n[o++]=c[f]}function Pt(e,t,r,i,n){for(var a=1,o=r+1;o<t.length;++o)a*=t[o];var s=t[r];if(t.length-r==4){var u=t[r+1],l=t[r+2],c=t[r+3];for(o=0;o<s;++o)Ct(e[o],u,l,c,i,n),n+=a}else for(o=0;o<s;++o)Pt(e[o],t,r+1,i,n),n+=a}function Rt(e,t,r,i){var n=1;if(t.length)for(var a=0;a<t.length;++a)n*=t[a];else n=0;var o=i||Ne.allocType(r,n);switch(t.length){case 0:break;case 1:kt(e,t[0],o);break;case 2:At(e,t[0],t[1],o);break;case 3:Ct(e,t[0],t[1],t[2],o,0);break;default:Pt(e,t,0,o,0)}return o}function Et(e){for(var t=[],r=e;r.length;r=r[0])t.push(r.length);return t}var zt={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},Dt={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126},_t={dynamic:35048,stream:35040,static:35044},Mt=St.flatten,Vt=St.shape,Nt=35044,It=35040,Bt=5121,Ot=5126,Ft=[];function jt(e){return 0|zt[Object.prototype.toString.call(e)]}function Wt(e,t){for(var r=0;r<t.length;++r)e[r]=t[r]}function Lt(e,t,r,i,n,a,o){for(var s=0,u=0;u<r;++u)for(var l=0;l<i;++l)e[s++]=t[n*u+a*l+o]}function Ht(t,r,i,n){var a=0,o={};function s(e){this.id=a++,this.buffer=t.createBuffer(),this.type=e,this.usage=Nt,this.byteLength=0,this.dimension=1,this.dtype=Bt,this.persistentData=null,i.profile&&(this.stats={size:0})}s.prototype.bind=function(){t.bindBuffer(this.type,this.buffer)},s.prototype.destroy=function(){d(this)};var u=[];function l(e,t){var r=u.pop();return r||(r=new s(e)),r.bind(),h(r,t,It,0,1,!1),r}function c(e){u.push(e)}function f(e,r,i){e.byteLength=r.byteLength,t.bufferData(e.type,r,i)}function h(t,r,i,n,a,o){var s,u;if(t.usage=i,Array.isArray(r)){if(t.dtype=n||Ot,r.length>0)if(Array.isArray(r[0])){s=Vt(r);for(var l=1,c=1;c<s.length;++c)l*=s[c];t.dimension=l,f(t,u=Mt(r,s,t.dtype),i),o?t.persistentData=u:Ne.freeType(u)}else if("number"==typeof r[0]){t.dimension=a;var h=Ne.allocType(t.dtype,r.length);Wt(h,r),f(t,h,i),o?t.persistentData=h:Ne.freeType(h)}else e(r[0])?(t.dimension=r[0].length,t.dtype=n||jt(r[0])||Ot,f(t,u=Mt(r,[r.length,r[0].length],t.dtype),i),o?t.persistentData=u:Ne.freeType(u)):re.raise("invalid buffer data")}else if(e(r))t.dtype=n||jt(r),t.dimension=a,f(t,r,i),o&&(t.persistentData=new Uint8Array(new Uint8Array(r.buffer)));else if(wt(r)){s=r.shape;var d=r.stride,p=r.offset,m=0,g=0,b=0,v=0;1===s.length?(m=s[0],g=1,b=d[0],v=0):2===s.length?(m=s[0],g=s[1],b=d[0],v=d[1]):re.raise("invalid shape"),t.dtype=n||jt(r.data)||Ot,t.dimension=g;var x=Ne.allocType(t.dtype,m*g);Lt(x,r.data,m,g,b,v,p),f(t,x,i),o?t.persistentData=x:Ne.freeType(x)}else r instanceof ArrayBuffer?(t.dtype=Bt,t.dimension=a,f(t,r,i),o&&(t.persistentData=new Uint8Array(new Uint8Array(r)))):re.raise("invalid buffer data")}function d(e){r.bufferCount--,n(e);var i=e.buffer;re(i,"buffer must not be deleted already"),t.deleteBuffer(i),e.buffer=null,delete o[e.id]}function p(n,a,u,l){r.bufferCount++;var c=new s(a);function f(r){var n=Nt,a=null,o=0,s=0,u=1;return Array.isArray(r)||e(r)||wt(r)||r instanceof ArrayBuffer?a=r:"number"==typeof r?o=0|r:r&&(re.type(r,"object","buffer arguments must be an object, a number or an array"),"data"in r&&(re(null===a||Array.isArray(a)||e(a)||wt(a),"invalid data for buffer"),a=r.data),"usage"in r&&(re.parameter(r.usage,_t,"invalid buffer usage"),n=_t[r.usage]),"type"in r&&(re.parameter(r.type,Dt,"invalid buffer type"),s=Dt[r.type]),"dimension"in r&&(re.type(r.dimension,"number","invalid dimension"),u=0|r.dimension),"length"in r&&(re.nni(o,"buffer length must be a nonnegative integer"),o=0|r.length)),c.bind(),a?h(c,a,n,s,u,l):(o&&t.bufferData(c.type,o,n),c.dtype=s||Bt,c.usage=n,c.dimension=u,c.byteLength=o),i.profile&&(c.stats.size=c.byteLength*Ft[c.dtype]),f}function p(e,r){re(r+e.byteLength<=c.byteLength,"invalid buffer subdata call, buffer is too small.  Can't write data of size "+e.byteLength+" starting from offset "+r+" to a buffer of size "+c.byteLength),t.bufferSubData(c.type,r,e)}function m(t,r){var i,n=0|(r||0);if(c.bind(),e(t)||t instanceof ArrayBuffer)p(t,n);else if(Array.isArray(t)){if(t.length>0)if("number"==typeof t[0]){var a=Ne.allocType(c.dtype,t.length);Wt(a,t),p(a,n),Ne.freeType(a)}else if(Array.isArray(t[0])||e(t[0])){i=Vt(t);var o=Mt(t,i,c.dtype);p(o,n),Ne.freeType(o)}else re.raise("invalid buffer data")}else if(wt(t)){i=t.shape;var s=t.stride,u=0,l=0,h=0,d=0;1===i.length?(u=i[0],l=1,h=s[0],d=0):2===i.length?(u=i[0],l=i[1],h=s[0],d=s[1]):re.raise("invalid shape");var m=Array.isArray(t.data)?c.dtype:jt(t.data),g=Ne.allocType(m,u*l);Lt(g,t.data,u,l,h,d,t.offset),p(g,n),Ne.freeType(g)}else re.raise("invalid data for buffer subdata");return f}return o[c.id]=c,u||f(n),f._reglType="buffer",f._buffer=c,f.subdata=m,i.profile&&(f.stats=c.stats),f.destroy=function(){d(c)},f}function m(){Tt(o).forEach((function(e){e.buffer=t.createBuffer(),t.bindBuffer(e.type,e.buffer),t.bufferData(e.type,e.persistentData||e.byteLength,e.usage)}))}return i.profile&&(r.getTotalBufferSize=function(){var e=0;return Object.keys(o).forEach((function(t){e+=o[t].stats.size})),e}),{create:p,createStream:l,destroyStream:c,clear:function(){Tt(o).forEach(d),u.forEach(d)},getBuffer:function(e){return e&&e._buffer instanceof s?e._buffer:null},restore:m,_initBuffer:h}}Ft[5120]=1,Ft[5122]=2,Ft[5124]=4,Ft[5121]=1,Ft[5123]=2,Ft[5125]=4,Ft[5126]=4;var Ut={points:0,point:0,lines:1,line:1,triangles:4,triangle:4,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},$t=0,Gt=1,qt=4,Xt=5120,Yt=5121,Zt=5122,Qt=5123,Kt=5124,Jt=5125,er=34963,tr=35040,rr=35044;function ir(t,r,i,n){var a={},o=0,s={uint8:Yt,uint16:Qt};function u(e){this.id=o++,a[this.id]=this,this.buffer=e,this.primType=qt,this.vertCount=0,this.type=0}r.oes_element_index_uint&&(s.uint32=Jt),u.prototype.bind=function(){this.buffer.bind()};var l=[];function c(e){var t=l.pop();return t||(t=new u(i.create(null,er,!0,!1)._buffer)),h(t,e,tr,-1,-1,0,0),t}function f(e){l.push(e)}function h(n,a,o,s,u,l,c){var f;if(n.buffer.bind(),a){var h=c;c||e(a)&&(!wt(a)||e(a.data))||(h=r.oes_element_index_uint?Jt:Qt),i._initBuffer(n.buffer,a,o,h,3)}else t.bufferData(er,l,o),n.buffer.dtype=f||Yt,n.buffer.usage=o,n.buffer.dimension=3,n.buffer.byteLength=l;if(f=c,!c){switch(n.buffer.dtype){case Yt:case Xt:f=Yt;break;case Qt:case Zt:f=Qt;break;case Jt:case Kt:f=Jt;break;default:re.raise("unsupported type for element array")}n.buffer.dtype=f}n.type=f,re(f!==Jt||!!r.oes_element_index_uint,"32 bit element buffers not supported, enable oes_element_index_uint first");var d=u;d<0&&(d=n.buffer.byteLength,f===Qt?d>>=1:f===Jt&&(d>>=2)),n.vertCount=d;var p=s;if(s<0){p=qt;var m=n.buffer.dimension;1===m&&(p=$t),2===m&&(p=Gt),3===m&&(p=qt)}n.primType=p}function d(e){n.elementsCount--,re(null!==e.buffer,"must not double destroy elements"),delete a[e.id],e.buffer.destroy(),e.buffer=null}function p(t,r){var a=i.create(null,er,!0),o=new u(a._buffer);function l(t){if(t)if("number"==typeof t)a(t),o.primType=qt,o.vertCount=0|t,o.type=Yt;else{var r=null,i=rr,n=-1,u=-1,c=0,f=0;Array.isArray(t)||e(t)||wt(t)?r=t:(re.type(t,"object","invalid arguments for elements"),"data"in t&&(r=t.data,re(Array.isArray(r)||e(r)||wt(r),"invalid data for element buffer")),"usage"in t&&(re.parameter(t.usage,_t,"invalid element buffer usage"),i=_t[t.usage]),"primitive"in t&&(re.parameter(t.primitive,Ut,"invalid element buffer primitive"),n=Ut[t.primitive]),"count"in t&&(re("number"==typeof t.count&&t.count>=0,"invalid vertex count for elements"),u=0|t.count),"type"in t&&(re.parameter(t.type,s,"invalid buffer type"),f=s[t.type]),"length"in t?c=0|t.length:(c=u,f===Qt||f===Zt?c*=2:f!==Jt&&f!==Kt||(c*=4))),h(o,r,i,n,u,c,f)}else a(),o.primType=qt,o.vertCount=0,o.type=Yt;return l}return n.elementsCount++,l(t),l._reglType="elements",l._elements=o,l.subdata=function(e,t){return a.subdata(e,t),l},l.destroy=function(){d(o)},l}return{create:p,createStream:c,destroyStream:f,getElements:function(e){return"function"==typeof e&&e._elements instanceof u?e._elements:null},clear:function(){Tt(a).forEach(d)}}}var nr=new Float32Array(1),ar=new Uint32Array(nr.buffer),or=5123;function sr(e){for(var t=Ne.allocType(or,e.length),r=0;r<e.length;++r)if(isNaN(e[r]))t[r]=65535;else if(e[r]===1/0)t[r]=31744;else if(e[r]===-1/0)t[r]=64512;else{nr[0]=e[r];var i=ar[0],n=i>>>31<<15,a=(i<<1>>>24)-127,o=i>>13&1023;if(a<-24)t[r]=n;else if(a<-14){var s=-14-a;t[r]=n+(o+1024>>s)}else t[r]=a>15?n+31744:n+(a+15<<10)+o}return t}function ur(t){return Array.isArray(t)||e(t)}var lr=function(e){return!(e&e-1||!e)},cr=34467,fr=3553,hr=34067,dr=34069,pr=6408,mr=6406,gr=6407,br=6409,vr=6410,xr=32854,yr=32855,wr=36194,Tr=32819,Sr=32820,kr=33635,Ar=34042,Cr=6402,Pr=34041,Rr=35904,Er=35906,zr=36193,Dr=33776,_r=33777,Mr=33778,Vr=33779,Nr=35986,Ir=35987,Br=34798,Or=35840,Fr=35841,jr=35842,Wr=35843,Lr=36196,Hr=5121,Ur=5123,$r=5125,Gr=5126,qr=10242,Xr=10243,Yr=10497,Zr=33071,Qr=33648,Kr=10240,Jr=10241,ei=9728,ti=9729,ri=9984,ii=9985,ni=9986,ai=9987,oi=33170,si=4352,ui=4353,li=4354,ci=34046,fi=3317,hi=37440,di=37441,pi=37443,mi=37444,gi=33984,bi=[ri,ni,ii,ai],vi=[0,br,vr,gr,pr],xi={};function yi(e){return"[object "+e+"]"}xi[br]=xi[mr]=xi[Cr]=1,xi[Pr]=xi[vr]=2,xi[gr]=xi[Rr]=3,xi[pr]=xi[Er]=4;var wi=yi("HTMLCanvasElement"),Ti=yi("OffscreenCanvas"),Si=yi("CanvasRenderingContext2D"),ki=yi("ImageBitmap"),Ai=yi("HTMLImageElement"),Ci=yi("HTMLVideoElement"),Pi=Object.keys(zt).concat([wi,Ti,Si,ki,Ai,Ci]),Ri=[];Ri[Hr]=1,Ri[Gr]=4,Ri[zr]=2,Ri[Ur]=2,Ri[$r]=4;var Ei=[];function zi(e){return Array.isArray(e)&&(0===e.length||"number"==typeof e[0])}function Di(e){return!!Array.isArray(e)&&!(0===e.length||!ur(e[0]))}function _i(e){return Object.prototype.toString.call(e)}function Mi(e){return _i(e)===wi}function Vi(e){return _i(e)===Ti}function Ni(e){return _i(e)===Si}function Ii(e){return _i(e)===ki}function Bi(e){return _i(e)===Ai}function Oi(e){return _i(e)===Ci}function Fi(e){if(!e)return!1;var t=_i(e);return Pi.indexOf(t)>=0||zi(e)||Di(e)||wt(e)}function ji(e){return 0|zt[Object.prototype.toString.call(e)]}function Wi(e,t){var r=t.length;switch(e.type){case Hr:case Ur:case $r:case Gr:var i=Ne.allocType(e.type,r);i.set(t),e.data=i;break;case zr:e.data=sr(t);break;default:re.raise("unsupported texture type, must specify a typed array")}}function Li(e,t){return Ne.allocType(e.type===zr?Gr:e.type,t)}function Hi(e,t){e.type===zr?(e.data=sr(t),Ne.freeType(t)):e.data=t}function Ui(e,t,r,i,n,a){for(var o=e.width,s=e.height,u=e.channels,l=Li(e,o*s*u),c=0,f=0;f<s;++f)for(var h=0;h<o;++h)for(var d=0;d<u;++d)l[c++]=t[r*h+i*f+n*d+a];Hi(e,l)}function $i(e,t,r,i,n,a){var o;if(o=void 0!==Ei[e]?Ei[e]:xi[e]*Ri[t],a&&(o*=6),n){for(var s=0,u=r;u>=1;)s+=o*u*u,u/=2;return s}return o*r*i}function Gi(r,i,n,a,o,s,u){var l={"don't care":si,"dont care":si,nice:li,fast:ui},c={repeat:Yr,clamp:Zr,mirror:Qr},f={nearest:ei,linear:ti},h=t({mipmap:ai,"nearest mipmap nearest":ri,"linear mipmap nearest":ii,"nearest mipmap linear":ni,"linear mipmap linear":ai},f),d={none:0,browser:mi},p={uint8:Hr,rgba4:Tr,rgb565:kr,"rgb5 a1":Sr},m={alpha:mr,luminance:br,"luminance alpha":vr,rgb:gr,rgba:pr,rgba4:xr,"rgb5 a1":yr,rgb565:wr},g={};i.ext_srgb&&(m.srgb=Rr,m.srgba=Er),i.oes_texture_float&&(p.float32=p.float=Gr),i.oes_texture_half_float&&(p.float16=p["half float"]=zr),i.webgl_depth_texture&&(t(m,{depth:Cr,"depth stencil":Pr}),t(p,{uint16:Ur,uint32:$r,"depth stencil":Ar})),i.webgl_compressed_texture_s3tc&&t(g,{"rgb s3tc dxt1":Dr,"rgba s3tc dxt1":_r,"rgba s3tc dxt3":Mr,"rgba s3tc dxt5":Vr}),i.webgl_compressed_texture_atc&&t(g,{"rgb atc":Nr,"rgba atc explicit alpha":Ir,"rgba atc interpolated alpha":Br}),i.webgl_compressed_texture_pvrtc&&t(g,{"rgb pvrtc 4bppv1":Or,"rgb pvrtc 2bppv1":Fr,"rgba pvrtc 4bppv1":jr,"rgba pvrtc 2bppv1":Wr}),i.webgl_compressed_texture_etc1&&(g["rgb etc1"]=Lr);var b=Array.prototype.slice.call(r.getParameter(cr));Object.keys(g).forEach((function(e){var t=g[e];b.indexOf(t)>=0&&(m[e]=t)}));var v=Object.keys(m);n.textureFormats=v;var x=[];Object.keys(m).forEach((function(e){var t=m[e];x[t]=e}));var y=[];Object.keys(p).forEach((function(e){var t=p[e];y[t]=e}));var w=[];Object.keys(f).forEach((function(e){var t=f[e];w[t]=e}));var T=[];Object.keys(h).forEach((function(e){var t=h[e];T[t]=e}));var S=[];Object.keys(c).forEach((function(e){var t=c[e];S[t]=e}));var k=v.reduce((function(e,t){var r=m[t];return r===br||r===mr||r===br||r===vr||r===Cr||r===Pr||i.ext_srgb&&(r===Rr||r===Er)?e[r]=r:r===yr||t.indexOf("rgba")>=0?e[r]=pr:e[r]=gr,e}),{});function A(){this.internalformat=pr,this.format=pr,this.type=Hr,this.compressed=!1,this.premultiplyAlpha=!1,this.flipY=!1,this.unpackAlignment=1,this.colorSpace=mi,this.width=0,this.height=0,this.channels=0}function C(e,t){e.internalformat=t.internalformat,e.format=t.format,e.type=t.type,e.compressed=t.compressed,e.premultiplyAlpha=t.premultiplyAlpha,e.flipY=t.flipY,e.unpackAlignment=t.unpackAlignment,e.colorSpace=t.colorSpace,e.width=t.width,e.height=t.height,e.channels=t.channels}function P(e,t){if("object"==typeof t&&t){if("premultiplyAlpha"in t&&(re.type(t.premultiplyAlpha,"boolean","invalid premultiplyAlpha"),e.premultiplyAlpha=t.premultiplyAlpha),"flipY"in t&&(re.type(t.flipY,"boolean","invalid texture flip"),e.flipY=t.flipY),"alignment"in t&&(re.oneOf(t.alignment,[1,2,4,8],"invalid texture unpack alignment"),e.unpackAlignment=t.alignment),"colorSpace"in t&&(re.parameter(t.colorSpace,d,"invalid colorSpace"),e.colorSpace=d[t.colorSpace]),"type"in t){var r=t.type;re(i.oes_texture_float||!("float"===r||"float32"===r),"you must enable the OES_texture_float extension in order to use floating point textures."),re(i.oes_texture_half_float||!("half float"===r||"float16"===r),"you must enable the OES_texture_half_float extension in order to use 16-bit floating point textures."),re(i.webgl_depth_texture||!("uint16"===r||"uint32"===r||"depth stencil"===r),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),re.parameter(r,p,"invalid texture type"),e.type=p[r]}var a=e.width,o=e.height,s=e.channels,u=!1;"shape"in t?(re(Array.isArray(t.shape)&&t.shape.length>=2,"shape must be an array"),a=t.shape[0],o=t.shape[1],3===t.shape.length&&(s=t.shape[2],re(s>0&&s<=4,"invalid number of channels"),u=!0),re(a>=0&&a<=n.maxTextureSize,"invalid width"),re(o>=0&&o<=n.maxTextureSize,"invalid height")):("radius"in t&&(a=o=t.radius,re(a>=0&&a<=n.maxTextureSize,"invalid radius")),"width"in t&&(a=t.width,re(a>=0&&a<=n.maxTextureSize,"invalid width")),"height"in t&&(o=t.height,re(o>=0&&o<=n.maxTextureSize,"invalid height")),"channels"in t&&(s=t.channels,re(s>0&&s<=4,"invalid number of channels"),u=!0)),e.width=0|a,e.height=0|o,e.channels=0|s;var l=!1;if("format"in t){var c=t.format;re(i.webgl_depth_texture||!("depth"===c||"depth stencil"===c),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),re.parameter(c,m,"invalid texture format");var f=e.internalformat=m[c];e.format=k[f],c in p&&("type"in t||(e.type=p[c])),c in g&&(e.compressed=!0),l=!0}!u&&l?e.channels=xi[e.format]:u&&!l?e.channels!==vi[e.format]&&(e.format=e.internalformat=vi[e.channels]):l&&u&&re(e.channels===xi[e.format],"number of channels inconsistent with specified format")}}function R(e){r.pixelStorei(hi,e.flipY),r.pixelStorei(di,e.premultiplyAlpha),r.pixelStorei(pi,e.colorSpace),r.pixelStorei(fi,e.unpackAlignment)}function E(){A.call(this),this.xOffset=0,this.yOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function z(t,r){var i=null;if(Fi(r)?i=r:r&&(re.type(r,"object","invalid pixel data type"),P(t,r),"x"in r&&(t.xOffset=0|r.x),"y"in r&&(t.yOffset=0|r.y),Fi(r.data)&&(i=r.data)),re(!t.compressed||i instanceof Uint8Array,"compressed texture data must be stored in a uint8array"),r.copy){re(!i,"can not specify copy and data field for the same texture");var a=o.viewportWidth,s=o.viewportHeight;t.width=t.width||a-t.xOffset,t.height=t.height||s-t.yOffset,t.needsCopy=!0,re(t.xOffset>=0&&t.xOffset<a&&t.yOffset>=0&&t.yOffset<s&&t.width>0&&t.width<=a&&t.height>0&&t.height<=s,"copy texture read out of bounds")}else if(i){if(e(i))t.channels=t.channels||4,t.data=i,"type"in r||t.type!==Hr||(t.type=ji(i));else if(zi(i))t.channels=t.channels||4,Wi(t,i),t.alignment=1,t.needsFree=!0;else if(wt(i)){var u=i.data;Array.isArray(u)||t.type!==Hr||(t.type=ji(u));var l,c,f,h,d,p,m=i.shape,g=i.stride;3===m.length?(f=m[2],p=g[2]):(re(2===m.length,"invalid ndarray pixel data, must be 2 or 3D"),f=1,p=1),l=m[0],c=m[1],h=g[0],d=g[1],t.alignment=1,t.width=l,t.height=c,t.channels=f,t.format=t.internalformat=vi[f],t.needsFree=!0,Ui(t,u,h,d,p,i.offset)}else if(Mi(i)||Vi(i)||Ni(i))Mi(i)||Vi(i)?t.element=i:t.element=i.canvas,t.width=t.element.width,t.height=t.element.height,t.channels=4;else if(Ii(i))t.element=i,t.width=i.width,t.height=i.height,t.channels=4;else if(Bi(i))t.element=i,t.width=i.naturalWidth,t.height=i.naturalHeight,t.channels=4;else if(Oi(i))t.element=i,t.width=i.videoWidth,t.height=i.videoHeight,t.channels=4;else if(Di(i)){var b=t.width||i[0].length,v=t.height||i.length,x=t.channels;x=ur(i[0][0])?x||i[0][0].length:x||1;for(var y=St.shape(i),w=1,T=0;T<y.length;++T)w*=y[T];var S=Li(t,w);St.flatten(i,y,"",S),Hi(t,S),t.alignment=1,t.width=b,t.height=v,t.channels=x,t.format=t.internalformat=vi[x],t.needsFree=!0}}else t.width=t.width||1,t.height=t.height||1,t.channels=t.channels||4;t.type===Gr?re(n.extensions.indexOf("oes_texture_float")>=0,"oes_texture_float extension not enabled"):t.type===zr&&re(n.extensions.indexOf("oes_texture_half_float")>=0,"oes_texture_half_float extension not enabled")}function D(e,t,i){var n=e.element,o=e.data,s=e.internalformat,u=e.format,l=e.type,c=e.width,f=e.height;R(e),n?r.texImage2D(t,i,u,u,l,n):e.compressed?r.compressedTexImage2D(t,i,s,c,f,0,o):e.needsCopy?(a(),r.copyTexImage2D(t,i,u,e.xOffset,e.yOffset,c,f,0)):r.texImage2D(t,i,u,c,f,0,u,l,o||null)}function _(e,t,i,n,o){var s=e.element,u=e.data,l=e.internalformat,c=e.format,f=e.type,h=e.width,d=e.height;R(e),s?r.texSubImage2D(t,o,i,n,c,f,s):e.compressed?r.compressedTexSubImage2D(t,o,i,n,l,h,d,u):e.needsCopy?(a(),r.copyTexSubImage2D(t,o,i,n,e.xOffset,e.yOffset,h,d)):r.texSubImage2D(t,o,i,n,h,d,c,f,u)}var M=[];function V(){return M.pop()||new E}function N(e){e.needsFree&&Ne.freeType(e.data),E.call(e),M.push(e)}function I(){A.call(this),this.genMipmaps=!1,this.mipmapHint=si,this.mipmask=0,this.images=Array(16)}function B(e,t,r){var i=e.images[0]=V();e.mipmask=1,i.width=e.width=t,i.height=e.height=r,i.channels=e.channels=4}function O(e,t){var r=null;if(Fi(t))C(r=e.images[0]=V(),e),z(r,t),e.mipmask=1;else if(P(e,t),Array.isArray(t.mipmap))for(var i=t.mipmap,n=0;n<i.length;++n)C(r=e.images[n]=V(),e),r.width>>=n,r.height>>=n,z(r,i[n]),e.mipmask|=1<<n;else C(r=e.images[0]=V(),e),z(r,t),e.mipmask=1;C(e,e.images[0]),!e.compressed||e.internalformat!==Dr&&e.internalformat!==_r&&e.internalformat!==Mr&&e.internalformat!==Vr||re(e.width%4==0&&e.height%4==0,"for compressed texture formats, mipmap level 0 must have width and height that are a multiple of 4")}function F(e,t){for(var r=e.images,i=0;i<r.length;++i){if(!r[i])return;D(r[i],t,i)}}var j=[];function W(){var e=j.pop()||new I;A.call(e),e.mipmask=0;for(var t=0;t<16;++t)e.images[t]=null;return e}function L(e){for(var t=e.images,r=0;r<t.length;++r)t[r]&&N(t[r]),t[r]=null;j.push(e)}function H(){this.minFilter=ei,this.magFilter=ei,this.wrapS=Zr,this.wrapT=Zr,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=si}function U(e,t){if("min"in t){var r=t.min;re.parameter(r,h),e.minFilter=h[r],bi.indexOf(e.minFilter)>=0&&!("faces"in t)&&(e.genMipmaps=!0)}if("mag"in t){var i=t.mag;re.parameter(i,f),e.magFilter=f[i]}var a=e.wrapS,o=e.wrapT;if("wrap"in t){var s=t.wrap;"string"==typeof s?(re.parameter(s,c),a=o=c[s]):Array.isArray(s)&&(re.parameter(s[0],c),re.parameter(s[1],c),a=c[s[0]],o=c[s[1]])}else{if("wrapS"in t){var u=t.wrapS;re.parameter(u,c),a=c[u]}if("wrapT"in t){var d=t.wrapT;re.parameter(d,c),o=c[d]}}if(e.wrapS=a,e.wrapT=o,"anisotropic"in t){var p=t.anisotropic;re("number"==typeof p&&p>=1&&p<=n.maxAnisotropic,"aniso samples must be between 1 and "),e.anisotropic=t.anisotropic}if("mipmap"in t){var m=!1;switch(typeof t.mipmap){case"string":re.parameter(t.mipmap,l,"invalid mipmap hint"),e.mipmapHint=l[t.mipmap],e.genMipmaps=!0,m=!0;break;case"boolean":m=e.genMipmaps=t.mipmap;break;case"object":re(Array.isArray(t.mipmap),"invalid mipmap type"),e.genMipmaps=!1,m=!0;break;default:re.raise("invalid mipmap type")}m&&!("min"in t)&&(e.minFilter=ri)}}function $(e,t){r.texParameteri(t,Jr,e.minFilter),r.texParameteri(t,Kr,e.magFilter),r.texParameteri(t,qr,e.wrapS),r.texParameteri(t,Xr,e.wrapT),i.ext_texture_filter_anisotropic&&r.texParameteri(t,ci,e.anisotropic),e.genMipmaps&&(r.hint(oi,e.mipmapHint),r.generateMipmap(t))}var G=0,q={},X=n.maxTextureUnits,Y=Array(X).map((function(){return null}));function Z(e){A.call(this),this.mipmask=0,this.internalformat=pr,this.id=G++,this.refCount=1,this.target=e,this.texture=r.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new H,u.profile&&(this.stats={size:0})}function Q(e){r.activeTexture(gi),r.bindTexture(e.target,e.texture)}function K(){var e=Y[0];e?r.bindTexture(e.target,e.texture):r.bindTexture(fr,null)}function J(e){var t=e.texture;re(t,"must not double destroy texture");var i=e.unit,n=e.target;i>=0&&(r.activeTexture(gi+i),r.bindTexture(n,null),Y[i]=null),r.deleteTexture(t),e.texture=null,e.params=null,e.pixels=null,e.refCount=0,delete q[e.id],s.textureCount--}function ee(e,t){var i=new Z(fr);function a(e,t){var r=i.texInfo;H.call(r);var o=W();return"number"==typeof e?B(o,0|e,"number"==typeof t?0|t:0|e):e?(re.type(e,"object","invalid arguments to regl.texture"),U(r,e),O(o,e)):B(o,1,1),r.genMipmaps&&(o.mipmask=(o.width<<1)-1),i.mipmask=o.mipmask,C(i,o),re.texture2D(r,o,n),i.internalformat=o.internalformat,a.width=o.width,a.height=o.height,Q(i),F(o,fr),$(r,fr),K(),L(o),u.profile&&(i.stats.size=$i(i.internalformat,i.type,o.width,o.height,r.genMipmaps,!1)),a.format=x[i.internalformat],a.type=y[i.type],a.mag=w[r.magFilter],a.min=T[r.minFilter],a.wrapS=S[r.wrapS],a.wrapT=S[r.wrapT],a}function o(e,t,r,n){re(!!e,"must specify image data");var o=0|t,s=0|r,u=0|n,l=V();return C(l,i),l.width=0,l.height=0,z(l,e),l.width=l.width||(i.width>>u)-o,l.height=l.height||(i.height>>u)-s,re(i.type===l.type&&i.format===l.format&&i.internalformat===l.internalformat,"incompatible format for texture.subimage"),re(o>=0&&s>=0&&o+l.width<=i.width&&s+l.height<=i.height,"texture.subimage write out of bounds"),re(i.mipmask&1<<u,"missing mipmap data"),re(l.data||l.element||l.needsCopy,"missing image data"),Q(i),_(l,fr,o,s,u),K(),N(l),a}function l(e,t){var n=0|e,o=0|t||n;if(n===i.width&&o===i.height)return a;a.width=i.width=n,a.height=i.height=o,Q(i);for(var s=0;i.mipmask>>s;++s){var l=n>>s,c=o>>s;if(!l||!c)break;r.texImage2D(fr,s,i.format,l,c,0,i.format,i.type,null)}return K(),u.profile&&(i.stats.size=$i(i.internalformat,i.type,n,o,!1,!1)),a}return q[i.id]=i,s.textureCount++,a(e,t),a.subimage=o,a.resize=l,a._reglType="texture2d",a._texture=i,u.profile&&(a.stats=i.stats),a.destroy=function(){i.decRef()},a}function te(e,t,i,a,o,l){var c=new Z(hr);q[c.id]=c,s.cubeCount++;var f=new Array(6);function h(e,t,r,i,a,o){var s,l=c.texInfo;for(H.call(l),s=0;s<6;++s)f[s]=W();if("number"!=typeof e&&e)if("object"==typeof e)if(t)O(f[0],e),O(f[1],t),O(f[2],r),O(f[3],i),O(f[4],a),O(f[5],o);else if(U(l,e),P(c,e),"faces"in e){var d=e.faces;for(re(Array.isArray(d)&&6===d.length,"cube faces must be a length 6 array"),s=0;s<6;++s)re("object"==typeof d[s]&&!!d[s],"invalid input for cube map face"),C(f[s],c),O(f[s],d[s])}else for(s=0;s<6;++s)O(f[s],e);else re.raise("invalid arguments to cube map");else{var p=0|e||1;for(s=0;s<6;++s)B(f[s],p,p)}for(C(c,f[0]),n.npotTextureCube||re(lr(c.width)&&lr(c.height),"your browser does not support non power or two texture dimensions"),l.genMipmaps?c.mipmask=(f[0].width<<1)-1:c.mipmask=f[0].mipmask,re.textureCube(c,l,f,n),c.internalformat=f[0].internalformat,h.width=f[0].width,h.height=f[0].height,Q(c),s=0;s<6;++s)F(f[s],dr+s);for($(l,hr),K(),u.profile&&(c.stats.size=$i(c.internalformat,c.type,h.width,h.height,l.genMipmaps,!0)),h.format=x[c.internalformat],h.type=y[c.type],h.mag=w[l.magFilter],h.min=T[l.minFilter],h.wrapS=S[l.wrapS],h.wrapT=S[l.wrapT],s=0;s<6;++s)L(f[s]);return h}function d(e,t,r,i,n){re(!!t,"must specify image data"),re("number"==typeof e&&e===(0|e)&&e>=0&&e<6,"invalid face");var a=0|r,o=0|i,s=0|n,u=V();return C(u,c),u.width=0,u.height=0,z(u,t),u.width=u.width||(c.width>>s)-a,u.height=u.height||(c.height>>s)-o,re(c.type===u.type&&c.format===u.format&&c.internalformat===u.internalformat,"incompatible format for texture.subimage"),re(a>=0&&o>=0&&a+u.width<=c.width&&o+u.height<=c.height,"texture.subimage write out of bounds"),re(c.mipmask&1<<s,"missing mipmap data"),re(u.data||u.element||u.needsCopy,"missing image data"),Q(c),_(u,dr+e,a,o,s),K(),N(u),h}function p(e){var t=0|e;if(t!==c.width){h.width=c.width=t,h.height=c.height=t,Q(c);for(var i=0;i<6;++i)for(var n=0;c.mipmask>>n;++n)r.texImage2D(dr+i,n,c.format,t>>n,t>>n,0,c.format,c.type,null);return K(),u.profile&&(c.stats.size=$i(c.internalformat,c.type,h.width,h.height,!1,!0)),h}}return h(e,t,i,a,o,l),h.subimage=d,h.resize=p,h._reglType="textureCube",h._texture=c,u.profile&&(h.stats=c.stats),h.destroy=function(){c.decRef()},h}function ie(){for(var e=0;e<X;++e)r.activeTexture(gi+e),r.bindTexture(fr,null),Y[e]=null;Tt(q).forEach(J),s.cubeCount=0,s.textureCount=0}function ne(){for(var e=0;e<X;++e){var t=Y[e];t&&(t.bindCount=0,t.unit=-1,Y[e]=null)}Tt(q).forEach((function(e){e.texture=r.createTexture(),r.bindTexture(e.target,e.texture);for(var t=0;t<32;++t)if(0!=(e.mipmask&1<<t))if(e.target===fr)r.texImage2D(fr,t,e.internalformat,e.width>>t,e.height>>t,0,e.internalformat,e.type,null);else for(var i=0;i<6;++i)r.texImage2D(dr+i,t,e.internalformat,e.width>>t,e.height>>t,0,e.internalformat,e.type,null);$(e.texInfo,e.target)}))}return t(Z.prototype,{bind:function(){var e=this;e.bindCount+=1;var t=e.unit;if(t<0){for(var i=0;i<X;++i){var n=Y[i];if(n){if(n.bindCount>0)continue;n.unit=-1}Y[i]=e,t=i;break}t>=X&&re.raise("insufficient number of texture units"),u.profile&&s.maxTextureUnits<t+1&&(s.maxTextureUnits=t+1),e.unit=t,r.activeTexture(gi+t),r.bindTexture(e.target,e.texture)}return t},unbind:function(){this.bindCount-=1},decRef:function(){--this.refCount<=0&&J(this)}}),u.profile&&(s.getTotalTextureSize=function(){var e=0;return Object.keys(q).forEach((function(t){e+=q[t].stats.size})),e}),{create2D:ee,createCube:te,clear:ie,getTexture:function(e){return null},restore:ne}}Ei[xr]=2,Ei[yr]=2,Ei[wr]=2,Ei[Pr]=4,Ei[Dr]=.5,Ei[_r]=.5,Ei[Mr]=1,Ei[Vr]=1,Ei[Nr]=.5,Ei[Ir]=1,Ei[Br]=1,Ei[Or]=.5,Ei[Fr]=.25,Ei[jr]=.5,Ei[Wr]=.25,Ei[Lr]=.5;var qi=36161,Xi=32854,Yi=32855,Zi=36194,Qi=33189,Ki=36168,Ji=34041,en=35907,tn=34836,rn=34842,nn=34843,an=[];function on(e,t,r){return an[e]*t*r}an[Xi]=2,an[Yi]=2,an[Zi]=2,an[Qi]=2,an[Ki]=1,an[Ji]=4,an[en]=4,an[tn]=16,an[rn]=8,an[nn]=6;var sn=function(e,t,r,i,n){var a={rgba4:Xi,rgb565:Zi,"rgb5 a1":Yi,depth:Qi,stencil:Ki,"depth stencil":Ji};t.ext_srgb&&(a.srgba=en),t.ext_color_buffer_half_float&&(a.rgba16f=rn,a.rgb16f=nn),t.webgl_color_buffer_float&&(a.rgba32f=tn);var o=[];Object.keys(a).forEach((function(e){var t=a[e];o[t]=e}));var s=0,u={};function l(e){this.id=s++,this.refCount=1,this.renderbuffer=e,this.format=Xi,this.width=0,this.height=0,n.profile&&(this.stats={size:0})}function c(t){var r=t.renderbuffer;re(r,"must not double destroy renderbuffer"),e.bindRenderbuffer(qi,null),e.deleteRenderbuffer(r),t.renderbuffer=null,t.refCount=0,delete u[t.id],i.renderbufferCount--}function f(t,s){var c=new l(e.createRenderbuffer());function f(t,i){var s=0,u=0,l=Xi;if("object"==typeof t&&t){var h=t;if("shape"in h){var d=h.shape;re(Array.isArray(d)&&d.length>=2,"invalid renderbuffer shape"),s=0|d[0],u=0|d[1]}else"radius"in h&&(s=u=0|h.radius),"width"in h&&(s=0|h.width),"height"in h&&(u=0|h.height);"format"in h&&(re.parameter(h.format,a,"invalid renderbuffer format"),l=a[h.format])}else"number"==typeof t?(s=0|t,u="number"==typeof i?0|i:s):t?re.raise("invalid arguments to renderbuffer constructor"):s=u=1;if(re(s>0&&u>0&&s<=r.maxRenderbufferSize&&u<=r.maxRenderbufferSize,"invalid renderbuffer size"),s!==c.width||u!==c.height||l!==c.format)return f.width=c.width=s,f.height=c.height=u,c.format=l,e.bindRenderbuffer(qi,c.renderbuffer),e.renderbufferStorage(qi,l,s,u),re(0===e.getError(),"invalid render buffer format"),n.profile&&(c.stats.size=on(c.format,c.width,c.height)),f.format=o[c.format],f}function h(t,i){var a=0|t,o=0|i||a;return a===c.width&&o===c.height||(re(a>0&&o>0&&a<=r.maxRenderbufferSize&&o<=r.maxRenderbufferSize,"invalid renderbuffer size"),f.width=c.width=a,f.height=c.height=o,e.bindRenderbuffer(qi,c.renderbuffer),e.renderbufferStorage(qi,c.format,a,o),re(0===e.getError(),"invalid render buffer format"),n.profile&&(c.stats.size=on(c.format,c.width,c.height))),f}return u[c.id]=c,i.renderbufferCount++,f(t,s),f.resize=h,f._reglType="renderbuffer",f._renderbuffer=c,n.profile&&(f.stats=c.stats),f.destroy=function(){c.decRef()},f}function h(){Tt(u).forEach((function(t){t.renderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(qi,t.renderbuffer),e.renderbufferStorage(qi,t.format,t.width,t.height)})),e.bindRenderbuffer(qi,null)}return l.prototype.decRef=function(){--this.refCount<=0&&c(this)},n.profile&&(i.getTotalRenderbufferSize=function(){var e=0;return Object.keys(u).forEach((function(t){e+=u[t].stats.size})),e}),{create:f,clear:function(){Tt(u).forEach(c)},restore:h}},un=36160,ln=36161,cn=3553,fn=34069,hn=36064,dn=36096,pn=36128,mn=33306,gn=36053,bn=36054,vn=36055,xn=36057,yn=36061,wn=36193,Tn=5121,Sn=5126,kn=6407,An=6408,Cn=6402,Pn=[kn,An],Rn=[];Rn[An]=4,Rn[kn]=3;var En=[];En[Tn]=1,En[Sn]=4,En[wn]=2;var zn=33189,Dn=36168,_n=34041,Mn=[32854,32855,36194,35907,34842,34843,34836],Vn={};function Nn(e,r,i,n,a,o){var s={cur:null,next:null,dirty:!1,setFBO:null},u=["rgba"],l=["rgba4","rgb565","rgb5 a1"];r.ext_srgb&&l.push("srgba"),r.ext_color_buffer_half_float&&l.push("rgba16f","rgb16f"),r.webgl_color_buffer_float&&l.push("rgba32f");var c=["uint8"];function f(e,t,r){this.target=e,this.texture=t,this.renderbuffer=r;var i=0,n=0;t?(i=t.width,n=t.height):r&&(i=r.width,n=r.height),this.width=i,this.height=n}function h(e){e&&(e.texture&&e.texture._texture.decRef(),e.renderbuffer&&e.renderbuffer._renderbuffer.decRef())}function d(e,t,r){if(e)if(e.texture){var i=e.texture._texture,n=Math.max(1,i.width),a=Math.max(1,i.height);re(n===t&&a===r,"inconsistent width/height for supplied texture"),i.refCount+=1}else{var o=e.renderbuffer._renderbuffer;re(o.width===t&&o.height===r,"inconsistent width/height for renderbuffer"),o.refCount+=1}}function p(t,r){r&&(r.texture?e.framebufferTexture2D(un,t,r.target,r.texture._texture.texture,0):e.framebufferRenderbuffer(un,t,ln,r.renderbuffer._renderbuffer.renderbuffer))}function m(e){var t=cn,r=null,i=null,n=e;"object"==typeof e&&(n=e.data,"target"in e&&(t=0|e.target)),re.type(n,"function","invalid attachment data");var a=n._reglType;return"texture2d"===a?(r=n,re(t===cn)):"textureCube"===a?(r=n,re(t>=fn&&t<fn+6,"invalid cube map target")):"renderbuffer"===a?(i=n,t=ln):re.raise("invalid regl object for attachment"),new f(t,r,i)}function g(e,t,r,i,o){if(r){var s=n.create2D({width:e,height:t,format:i,type:o});return s._texture.refCount=0,new f(cn,s,null)}var u=a.create({width:e,height:t,format:i});return u._renderbuffer.refCount=0,new f(ln,null,u)}function b(e){return e&&(e.texture||e.renderbuffer)}function v(e,t,r){e&&(e.texture?e.texture.resize(t,r):e.renderbuffer&&e.renderbuffer.resize(t,r),e.width=t,e.height=r)}r.oes_texture_half_float&&c.push("half float","float16"),r.oes_texture_float&&c.push("float","float32");var x=0,y={};function w(){this.id=x++,y[this.id]=this,this.framebuffer=e.createFramebuffer(),this.width=0,this.height=0,this.colorAttachments=[],this.depthAttachment=null,this.stencilAttachment=null,this.depthStencilAttachment=null}function T(e){e.colorAttachments.forEach(h),h(e.depthAttachment),h(e.stencilAttachment),h(e.depthStencilAttachment)}function S(t){var r=t.framebuffer;re(r,"must not double destroy framebuffer"),e.deleteFramebuffer(r),t.framebuffer=null,o.framebufferCount--,delete y[t.id]}function k(t){var r;e.bindFramebuffer(un,t.framebuffer);var n=t.colorAttachments;for(r=0;r<n.length;++r)p(hn+r,n[r]);for(r=n.length;r<i.maxColorAttachments;++r)e.framebufferTexture2D(un,hn+r,cn,null,0);e.framebufferTexture2D(un,mn,cn,null,0),e.framebufferTexture2D(un,dn,cn,null,0),e.framebufferTexture2D(un,pn,cn,null,0),p(dn,t.depthAttachment),p(pn,t.stencilAttachment),p(mn,t.depthStencilAttachment);var a=e.checkFramebufferStatus(un);e.isContextLost()||a===gn||re.raise("framebuffer configuration not supported, status = "+Vn[a]),e.bindFramebuffer(un,s.next?s.next.framebuffer:null),s.cur=s.next,e.getError()}function A(e,n){var a=new w;function f(e,t){var n;re(s.next!==a,"can not update framebuffer which is currently in use");var o=0,h=0,p=!0,v=!0,x=null,y=!0,w="rgba",S="uint8",A=1,C=null,P=null,R=null,E=!1;if("number"==typeof e)o=0|e,h=0|t||o;else if(e){re.type(e,"object","invalid arguments for framebuffer");var z=e;if("shape"in z){var D=z.shape;re(Array.isArray(D)&&D.length>=2,"invalid shape for framebuffer"),o=D[0],h=D[1]}else"radius"in z&&(o=h=z.radius),"width"in z&&(o=z.width),"height"in z&&(h=z.height);("color"in z||"colors"in z)&&(x=z.color||z.colors,Array.isArray(x)&&re(1===x.length||r.webgl_draw_buffers,"multiple render targets not supported")),x||("colorCount"in z&&(A=0|z.colorCount,re(A>0,"invalid color buffer count")),"colorTexture"in z&&(y=!!z.colorTexture,w="rgba4"),"colorType"in z&&(S=z.colorType,y?(re(r.oes_texture_float||!("float"===S||"float32"===S),"you must enable OES_texture_float in order to use floating point framebuffer objects"),re(r.oes_texture_half_float||!("half float"===S||"float16"===S),"you must enable OES_texture_half_float in order to use 16-bit floating point framebuffer objects")):"half float"===S||"float16"===S?(re(r.ext_color_buffer_half_float,"you must enable EXT_color_buffer_half_float to use 16-bit render buffers"),w="rgba16f"):"float"!==S&&"float32"!==S||(re(r.webgl_color_buffer_float,"you must enable WEBGL_color_buffer_float in order to use 32-bit floating point renderbuffers"),w="rgba32f"),re.oneOf(S,c,"invalid color type")),"colorFormat"in z&&(w=z.colorFormat,u.indexOf(w)>=0?y=!0:l.indexOf(w)>=0?y=!1:y?re.oneOf(z.colorFormat,u,"invalid color format for texture"):re.oneOf(z.colorFormat,l,"invalid color format for renderbuffer"))),("depthTexture"in z||"depthStencilTexture"in z)&&(E=!(!z.depthTexture&&!z.depthStencilTexture),re(!E||r.webgl_depth_texture,"webgl_depth_texture extension not supported")),"depth"in z&&("boolean"==typeof z.depth?p=z.depth:(C=z.depth,v=!1)),"stencil"in z&&("boolean"==typeof z.stencil?v=z.stencil:(P=z.stencil,p=!1)),"depthStencil"in z&&("boolean"==typeof z.depthStencil?p=v=z.depthStencil:(R=z.depthStencil,p=!1,v=!1))}else o=h=1;var _=null,M=null,V=null,N=null;if(Array.isArray(x))_=x.map(m);else if(x)_=[m(x)];else for(_=new Array(A),n=0;n<A;++n)_[n]=g(o,h,y,w,S);re(r.webgl_draw_buffers||_.length<=1,"you must enable the WEBGL_draw_buffers extension in order to use multiple color buffers."),re(_.length<=i.maxColorAttachments,"too many color attachments, not supported"),o=o||_[0].width,h=h||_[0].height,C?M=m(C):p&&!v&&(M=g(o,h,E,"depth","uint32")),P?V=m(P):v&&!p&&(V=g(o,h,!1,"stencil","uint8")),R?N=m(R):!C&&!P&&v&&p&&(N=g(o,h,E,"depth stencil","depth stencil")),re(!!C+!!P+!!R<=1,"invalid framebuffer configuration, can specify exactly one depth/stencil attachment");var I=null;for(n=0;n<_.length;++n)if(d(_[n],o,h),re(!_[n]||_[n].texture&&Pn.indexOf(_[n].texture._texture.format)>=0||_[n].renderbuffer&&Mn.indexOf(_[n].renderbuffer._renderbuffer.format)>=0,"framebuffer color attachment "+n+" is invalid"),_[n]&&_[n].texture){var B=Rn[_[n].texture._texture.format]*En[_[n].texture._texture.type];null===I?I=B:re(I===B,"all color attachments much have the same number of bits per pixel.")}return d(M,o,h),re(!M||M.texture&&M.texture._texture.format===Cn||M.renderbuffer&&M.renderbuffer._renderbuffer.format===zn,"invalid depth attachment for framebuffer object"),d(V,o,h),re(!V||V.renderbuffer&&V.renderbuffer._renderbuffer.format===Dn,"invalid stencil attachment for framebuffer object"),d(N,o,h),re(!N||N.texture&&N.texture._texture.format===_n||N.renderbuffer&&N.renderbuffer._renderbuffer.format===_n,"invalid depth-stencil attachment for framebuffer object"),T(a),a.width=o,a.height=h,a.colorAttachments=_,a.depthAttachment=M,a.stencilAttachment=V,a.depthStencilAttachment=N,f.color=_.map(b),f.depth=b(M),f.stencil=b(V),f.depthStencil=b(N),f.width=a.width,f.height=a.height,k(a),f}function h(e,t){re(s.next!==a,"can not resize a framebuffer which is currently in use");var r=Math.max(0|e,1),i=Math.max(0|t||r,1);if(r===a.width&&i===a.height)return f;for(var n=a.colorAttachments,o=0;o<n.length;++o)v(n[o],r,i);return v(a.depthAttachment,r,i),v(a.stencilAttachment,r,i),v(a.depthStencilAttachment,r,i),a.width=f.width=r,a.height=f.height=i,k(a),f}return o.framebufferCount++,f(e,n),t(f,{resize:h,_reglType:"framebuffer",_framebuffer:a,destroy:function(){S(a),T(a)},use:function(e){s.setFBO({framebuffer:f},e)}})}function C(e){var a=Array(6);function o(e){var i;re(a.indexOf(s.next)<0,"can not update framebuffer which is currently in use");var l,f={color:null},h=0,d=null,p="rgba",m="uint8",g=1;if("number"==typeof e)h=0|e;else if(e){re.type(e,"object","invalid arguments for framebuffer");var b=e;if("shape"in b){var v=b.shape;re(Array.isArray(v)&&v.length>=2,"invalid shape for framebuffer"),re(v[0]===v[1],"cube framebuffer must be square"),h=v[0]}else"radius"in b&&(h=0|b.radius),"width"in b?(h=0|b.width,"height"in b&&re(b.height===h,"must be square")):"height"in b&&(h=0|b.height);("color"in b||"colors"in b)&&(d=b.color||b.colors,Array.isArray(d)&&re(1===d.length||r.webgl_draw_buffers,"multiple render targets not supported")),d||("colorCount"in b&&(g=0|b.colorCount,re(g>0,"invalid color buffer count")),"colorType"in b&&(re.oneOf(b.colorType,c,"invalid color type"),m=b.colorType),"colorFormat"in b&&(p=b.colorFormat,re.oneOf(b.colorFormat,u,"invalid color format for texture"))),"depth"in b&&(f.depth=b.depth),"stencil"in b&&(f.stencil=b.stencil),"depthStencil"in b&&(f.depthStencil=b.depthStencil)}else h=1;if(d)if(Array.isArray(d))for(l=[],i=0;i<d.length;++i)l[i]=d[i];else l=[d];else{l=Array(g);var x={radius:h,format:p,type:m};for(i=0;i<g;++i)l[i]=n.createCube(x)}for(f.color=Array(l.length),i=0;i<l.length;++i){var y=l[i];re("function"==typeof y&&"textureCube"===y._reglType,"invalid cube map"),h=h||y.width,re(y.width===h&&y.height===h,"invalid cube map shape"),f.color[i]={target:fn,data:l[i]}}for(i=0;i<6;++i){for(var w=0;w<l.length;++w)f.color[w].target=fn+i;i>0&&(f.depth=a[0].depth,f.stencil=a[0].stencil,f.depthStencil=a[0].depthStencil),a[i]?a[i](f):a[i]=A(f)}return t(o,{width:h,height:h,color:l})}function l(e){var t,r=0|e;if(re(r>0&&r<=i.maxCubeMapSize,"invalid radius for cube fbo"),r===o.width)return o;var n=o.color;for(t=0;t<n.length;++t)n[t].resize(r);for(t=0;t<6;++t)a[t].resize(r);return o.width=o.height=r,o}return o(e),t(o,{faces:a,resize:l,_reglType:"framebufferCube",destroy:function(){a.forEach((function(e){e.destroy()}))}})}function P(){s.cur=null,s.next=null,s.dirty=!0,Tt(y).forEach((function(t){t.framebuffer=e.createFramebuffer(),k(t)}))}return t(s,{getFramebuffer:function(e){if("function"==typeof e&&"framebuffer"===e._reglType){var t=e._framebuffer;if(t instanceof w)return t}return null},create:A,createCube:C,clear:function(){Tt(y).forEach(S)},restore:P})}Vn[gn]="complete",Vn[bn]="incomplete attachment",Vn[xn]="incomplete dimensions",Vn[vn]="incomplete, missing attachment",Vn[yn]="unsupported";var In=5126,Bn=34962;function On(){this.state=0,this.x=0,this.y=0,this.z=0,this.w=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=In,this.offset=0,this.stride=0,this.divisor=0}function Fn(t,r,i,n,a){for(var o=i.maxAttributes,s=new Array(o),u=0;u<o;++u)s[u]=new On;var l=0,c={},f={Record:On,scope:{},state:s,currentVAO:null,targetVAO:null,restore:d()?y:function(){},createVAO:w,getVAO:m,destroyBuffer:h,setVAO:d()?g:b,clear:d()?v:function(){}};function h(e){for(var r=0;r<s.length;++r){var i=s[r];i.buffer===e&&(t.disableVertexAttribArray(r),i.buffer=null)}}function d(){return r.oes_vertex_array_object}function p(){return r.angle_instanced_arrays}function m(e){return"function"==typeof e&&e._vao?e._vao:null}function g(e){if(e!==f.currentVAO){var t=d();e?t.bindVertexArrayOES(e.vao):t.bindVertexArrayOES(null),f.currentVAO=e}}function b(e){if(e!==f.currentVAO){if(e)e.bindAttrs();else{var r=p();for(let e=0;e<s.length;++e){var i=s[e];i.buffer?(t.enableVertexAttribArray(e),t.vertexAttribPointer(e,i.size,i.type,i.normalized,i.stride,i.offfset),r&&r.vertexAttribDivisorANGLE(e,i.divisor)):(t.disableVertexAttribArray(e),t.vertexAttrib4f(e,i.x,i.y,i.z,i.w))}}f.currentVAO=e}}function v(e){Tt(c).forEach((e=>{e.destroy()}))}function x(){this.id=++l,this.attributes=[];var e=d();this.vao=e?e.createVertexArrayOES():null,c[this.id]=this,this.buffers=[]}function y(){d()&&Tt(c).forEach((function(e){e.refresh()}))}function w(t){var i=new x;function s(t){re(Array.isArray(t),"arguments to vertex array constructor must be an array"),re(t.length<o,"too many attributes"),re(t.length>0,"must specify at least one attribute");for(var n=0;n<i.buffers.length;++n)i.buffers[n].destroy();i.buffers.length=0;var u=i.attributes;u.length=t.length;for(var l=0;l<t.length;++l){var c=t[l],f=u[l]=new On;if(Array.isArray(c)||e(c)||wt(c)){var h=a.create(c,Bn,!1,!0);f.buffer=a.getBuffer(h),f.size=0|f.buffer.dimension,f.normalized=!1,f.type=f.buffer.dtype,f.offset=0,f.stride=0,f.divisor=0,f.state=1,i.buffers.push(h)}else a.getBuffer(c)?(f.buffer=a.getBuffer(c),f.size=0|f.buffer.dimension,f.normalized=!1,f.type=f.buffer.dtype,f.offset=0,f.stride=0,f.divisor=0,f.state=1):a.getBuffer(c.buffer)?(f.buffer=a.getBuffer(c.buffer),f.size=0|(+c.size||f.buffer.dimension),f.normalized=!!c.normalized||!1,"type"in c?(re.parameter(c.type,Dt,"invalid buffer type"),f.type=Dt[c.type]):f.type=f.buffer.dtype,f.offset=0|(c.offset||0),f.stride=0|(c.stride||0),f.divisor=0|(c.divisor||0),f.state=1,re(f.size>=1&&f.size<=4,"size must be between 1 and 4"),re(f.offset>=0,"invalid offset"),re(f.stride>=0&&f.stride<=255,"stride must be between 0 and 255"),re(f.divisor>=0,"divisor must be positive"),re(!f.divisor||!!r.angle_instanced_arrays,"ANGLE_instanced_arrays must be enabled to use divisor")):"x"in c?(re(l>0,"first attribute must not be a constant"),f.x=+c.x||0,f.y=+c.y||0,f.z=+c.z||0,f.w=+c.w||0,f.state=2):re(!1,"invalid attribute spec for location "+l)}return i.refresh(),s}return n.vaoCount+=1,s.destroy=function(){i.destroy()},s._vao=i,s._reglType="vao",s(t)}return x.prototype.bindAttrs=function(){for(var e=p(),r=this.attributes,i=0;i<r.length;++i){var n=r[i];n.buffer?(t.enableVertexAttribArray(i),t.bindBuffer(Bn,n.buffer.buffer),t.vertexAttribPointer(i,n.size,n.type,n.normalized,n.stride,n.offset),e&&e.vertexAttribDivisorANGLE(i,n.divisor)):(t.disableVertexAttribArray(i),t.vertexAttrib4f(i,n.x,n.y,n.z,n.w))}for(var a=r.length;a<o;++a)t.disableVertexAttribArray(a)},x.prototype.refresh=function(){var e=d();e&&(e.bindVertexArrayOES(this.vao),this.bindAttrs(),f.currentVAO=this)},x.prototype.destroy=function(){if(this.vao){var e=d();this===f.currentVAO&&(f.currentVAO=null,e.bindVertexArrayOES(null)),e.deleteVertexArrayOES(this.vao),this.vao=null}c[this.id]&&(delete c[this.id],n.vaoCount-=1)},f}var jn=35632,Wn=35633,Ln=35718,Hn=35721;function Un(e,t,r,i){var n={},a={};function o(e,t,r,i){this.name=e,this.id=t,this.location=r,this.info=i}function s(e,t){for(var r=0;r<e.length;++r)if(e[r].id===t.id)return void(e[r].location=t.location);e.push(t)}function u(r,i,o){var s=r===jn?n:a,u=s[i];if(!u){var l=t.str(i);u=e.createShader(r),e.shaderSource(u,l),e.compileShader(u),re.shaderError(e,u,l,r,o),s[i]=u}return u}var l={},c=[],f=0;function h(e,t){this.id=f++,this.fragId=e,this.vertId=t,this.program=null,this.uniforms=[],this.attributes=[],i.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function d(r,n,a){var l,c,f=u(jn,r.fragId),h=u(Wn,r.vertId),d=r.program=e.createProgram();if(e.attachShader(d,f),e.attachShader(d,h),a)for(let t=0;t<a.length;++t){var p=a[t];e.bindAttribLocation(d,p[0],p[1])}e.linkProgram(d),re.linkError(e,d,t.str(r.fragId),t.str(r.vertId),n);var m=e.getProgramParameter(d,Ln);i.profile&&(r.stats.uniformsCount=m);var g=r.uniforms;for(l=0;l<m;++l)if(c=e.getActiveUniform(d,l))if(c.size>1)for(var b=0;b<c.size;++b){var v=c.name.replace("[0]","["+b+"]");s(g,new o(v,t.id(v),e.getUniformLocation(d,v),c))}else s(g,new o(c.name,t.id(c.name),e.getUniformLocation(d,c.name),c));var x=e.getProgramParameter(d,Hn);i.profile&&(r.stats.attributesCount=x);var y=r.attributes;for(l=0;l<x;++l)(c=e.getActiveAttrib(d,l))&&s(y,new o(c.name,t.id(c.name),e.getAttribLocation(d,c.name),c))}function p(){n={},a={};for(var e=0;e<c.length;++e)d(c[e],null,c[e].attributes.map((function(e){return[e.location,e.name]})))}return i.profile&&(r.getMaxUniformsCount=function(){var e=0;return c.forEach((function(t){t.stats.uniformsCount>e&&(e=t.stats.uniformsCount)})),e},r.getMaxAttributesCount=function(){var e=0;return c.forEach((function(t){t.stats.attributesCount>e&&(e=t.stats.attributesCount)})),e}),{clear:function(){var t=e.deleteShader.bind(e);Tt(n).forEach(t),n={},Tt(a).forEach(t),a={},c.forEach((function(t){e.deleteProgram(t.program)})),c.length=0,l={},r.shaderCount=0},program:function(e,t,i,n){re.command(e>=0,"missing vertex shader",i),re.command(t>=0,"missing fragment shader",i);var a=l[t];a||(a=l[t]={});var o=a[e];if(o&&!n)return o;var s=new h(t,e);return r.shaderCount++,d(s,i,n),o||(a[e]=s),c.push(s),s},restore:p,shader:u,frag:-1,vert:-1}}var $n=6408,Gn=5121,qn=3333,Xn=5126;function Yn(t,r,i,n,a,o,s){function u(u){var l;null===r.next?(re(a.preserveDrawingBuffer,'you must create a webgl context with "preserveDrawingBuffer":true in order to read pixels from the drawing buffer'),l=Gn):(re(null!==r.next.colorAttachments[0].texture,"You cannot read from a renderbuffer"),l=r.next.colorAttachments[0].texture._texture.type,o.oes_texture_float?(re(l===Gn||l===Xn,"Reading from a framebuffer is only allowed for the types 'uint8' and 'float'"),l===Xn&&re(s.readFloat,"Reading 'float' values is not permitted in your browser. For a fallback, please see: https://www.npmjs.com/package/glsl-read-float")):re(l===Gn,"Reading from a framebuffer is only allowed for the type 'uint8'"));var c=0,f=0,h=n.framebufferWidth,d=n.framebufferHeight,p=null;e(u)?p=u:u&&(re.type(u,"object","invalid arguments to regl.read()"),c=0|u.x,f=0|u.y,re(c>=0&&c<n.framebufferWidth,"invalid x offset for regl.read"),re(f>=0&&f<n.framebufferHeight,"invalid y offset for regl.read"),h=0|(u.width||n.framebufferWidth-c),d=0|(u.height||n.framebufferHeight-f),p=u.data||null),p&&(l===Gn?re(p instanceof Uint8Array,"buffer must be 'Uint8Array' when reading from a framebuffer of type 'uint8'"):l===Xn&&re(p instanceof Float32Array,"buffer must be 'Float32Array' when reading from a framebuffer of type 'float'")),re(h>0&&h+c<=n.framebufferWidth,"invalid width for read pixels"),re(d>0&&d+f<=n.framebufferHeight,"invalid height for read pixels"),i();var m=h*d*4;return p||(l===Gn?p=new Uint8Array(m):l===Xn&&(p=p||new Float32Array(m))),re.isTypedArray(p,"data buffer for regl.read() must be a typedarray"),re(p.byteLength>=m,"data buffer for regl.read() too small"),t.pixelStorei(qn,4),t.readPixels(c,f,h,d,$n,l,p),p}function l(e){var t;return r.setFBO({framebuffer:e.framebuffer},(function(){t=u(e)})),t}function c(e){return e&&"framebuffer"in e?l(e):u(e)}return c}function Zn(e){return Array.prototype.slice.call(e)}function Qn(e){return Zn(e).join("")}function Kn(){var e=0,r=[],i=[];function n(t){for(var n=0;n<i.length;++n)if(i[n]===t)return r[n];var a="g"+e++;return r.push(a),i.push(t),a}function a(){var r=[];function i(){r.push.apply(r,Zn(arguments))}var n=[];function a(){var t="v"+e++;return n.push(t),arguments.length>0&&(r.push(t,"="),r.push.apply(r,Zn(arguments)),r.push(";")),t}return t(i,{def:a,toString:function(){return Qn([n.length>0?"var "+n.join(",")+";":"",Qn(r)])}})}function o(){var e=a(),r=a(),i=e.toString,n=r.toString;function o(t,i){r(t,i,"=",e.def(t,i),";")}return t((function(){e.apply(e,Zn(arguments))}),{def:e.def,entry:e,exit:r,save:o,set:function(t,r,i){o(t,r),e(t,r,"=",i,";")},toString:function(){return i()+n()}})}function s(){var e=Qn(arguments),r=o(),i=o(),n=r.toString,a=i.toString;return t(r,{then:function(){return r.apply(r,Zn(arguments)),this},else:function(){return i.apply(i,Zn(arguments)),this},toString:function(){var t=a();return t&&(t="else{"+t+"}"),Qn(["if(",e,"){",n(),"}",t])}})}var u=a(),l={};function c(e,r){var i=[];function n(){var e="a"+i.length;return i.push(e),e}r=r||0;for(var a=0;a<r;++a)n();var s=o(),u=s.toString;return l[e]=t(s,{arg:n,toString:function(){return Qn(["function(",i.join(),"){",u(),"}"])}})}function f(){var e=['"use strict";',u,"return {"];Object.keys(l).forEach((function(t){e.push('"',t,'":',l[t].toString(),",")})),e.push("}");var t=Qn(e).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n");return Function.apply(null,r.concat(t)).apply(null,i)}return{global:u,link:n,block:a,proc:c,scope:o,cond:s,compile:f}}var Jn="xyzw".split(""),ea=5121,ta=1,ra=2,ia=0,na=1,aa=2,oa=3,sa=4,ua="dither",la="blend.enable",ca="blend.color",fa="blend.equation",ha="blend.func",da="depth.enable",pa="depth.func",ma="depth.range",ga="depth.mask",ba="colorMask",va="cull.enable",xa="cull.face",ya="frontFace",wa="lineWidth",Ta="polygonOffset.enable",Sa="polygonOffset.offset",ka="sample.alpha",Aa="sample.enable",Ca="sample.coverage",Pa="stencil.enable",Ra="stencil.mask",Ea="stencil.func",za="stencil.opFront",Da="stencil.opBack",_a="scissor.enable",Ma="scissor.box",Va="viewport",Na="profile",Ia="framebuffer",Ba="vert",Oa="frag",Fa="elements",ja="primitive",Wa="count",La="offset",Ha="instances",Ua="vao",$a="Width",Ga="Height",qa=Ia+$a,Xa=Ia+Ga,Ya=Va+$a,Za=Va+Ga,Qa="drawingBuffer",Ka=Qa+$a,Ja=Qa+Ga,eo=[ha,fa,Ea,za,Da,Ca,Va,Ma,Sa],to=34962,ro=34963,io=3553,no=34067,ao=2884,oo=3042,so=3024,uo=2960,lo=2929,co=3089,fo=32823,ho=32926,po=32928,mo=5126,go=35664,bo=35665,vo=35666,xo=5124,yo=35667,wo=35668,To=35669,So=35670,ko=35671,Ao=35672,Co=35673,Po=35674,Ro=35675,Eo=35676,zo=35678,Do=35680,_o=4,Mo=1028,Vo=1029,No=2304,Io=2305,Bo=32775,Oo=32776,Fo=519,jo=7680,Wo=0,Lo=1,Ho=32774,Uo=513,$o=36160,Go=36064,qo={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},Xo=["constant color, constant alpha","one minus constant color, constant alpha","constant color, one minus constant alpha","one minus constant color, one minus constant alpha","constant alpha, constant color","constant alpha, one minus constant color","one minus constant alpha, constant color","one minus constant alpha, one minus constant color"],Yo={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},Zo={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},Qo={frag:35632,vert:35633},Ko={cw:No,ccw:Io};function Jo(t){return Array.isArray(t)||e(t)||wt(t)}function es(e){return e.sort((function(e,t){return e===Va?-1:t===Va?1:e<t?-1:1}))}function ts(e,t,r,i){this.thisDep=e,this.contextDep=t,this.propDep=r,this.append=i}function rs(e){return e&&!(e.thisDep||e.contextDep||e.propDep)}function is(e){return new ts(!1,!1,!1,e)}function ns(e,t){var r=e.type;if(r===ia){var i=e.data.length;return new ts(!0,i>=1,i>=2,t)}if(r===sa){var n=e.data;return new ts(n.thisDep,n.contextDep,n.propDep,t)}return new ts(r===oa,r===aa,r===na,t)}var as=new ts(!1,!1,!1,(function(){}));function os(e,t,r,i,n,a,o,s,u,l,c,f,h,d,p){var m=l.Record,g={add:32774,subtract:32778,"reverse subtract":32779};r.ext_blend_minmax&&(g.min=Bo,g.max=Oo);var b=r.angle_instanced_arrays,v=r.webgl_draw_buffers,x={dirty:!0,profile:p.profile},y={},w=[],T={},S={};function k(e){return e.replace(".","_")}function A(e,t,r){var i=k(e);w.push(e),y[i]=x[i]=!!r,T[i]=t}function C(e,t,r){var i=k(e);w.push(e),Array.isArray(r)?(x[i]=r.slice(),y[i]=r.slice()):x[i]=y[i]=r,S[i]=t}A(ua,so),A(la,oo),C(ca,"blendColor",[0,0,0,0]),C(fa,"blendEquationSeparate",[Ho,Ho]),C(ha,"blendFuncSeparate",[Lo,Wo,Lo,Wo]),A(da,lo,!0),C(pa,"depthFunc",Uo),C(ma,"depthRange",[0,1]),C(ga,"depthMask",!0),C(ba,ba,[!0,!0,!0,!0]),A(va,ao),C(xa,"cullFace",Vo),C(ya,ya,Io),C(wa,wa,1),A(Ta,fo),C(Sa,"polygonOffset",[0,0]),A(ka,ho),A(Aa,po),C(Ca,"sampleCoverage",[1,!1]),A(Pa,uo),C(Ra,"stencilMask",-1),C(Ea,"stencilFunc",[Fo,0,-1]),C(za,"stencilOpSeparate",[Mo,jo,jo,jo]),C(Da,"stencilOpSeparate",[Vo,jo,jo,jo]),A(_a,co),C(Ma,"scissor",[0,0,e.drawingBufferWidth,e.drawingBufferHeight]),C(Va,Va,[0,0,e.drawingBufferWidth,e.drawingBufferHeight]);var P={gl:e,context:h,strings:t,next:y,current:x,draw:f,elements:a,buffer:n,shader:c,attributes:l.state,vao:l,uniforms:u,framebuffer:s,extensions:r,timer:d,isBufferArgs:Jo},R={primTypes:Ut,compareFuncs:Yo,blendFuncs:qo,blendEquations:g,stencilOps:Zo,glTypes:Dt,orientationType:Ko};re.optional((function(){P.isArrayLike=ur})),v&&(R.backBuffer=[Vo],R.drawBuffer=ke(i.maxDrawbuffers,(function(e){return 0===e?[0]:ke(e,(function(e){return Go+e}))})));var E=0;function z(){var e=Kn(),r=e.link,i=e.global;e.id=E++,e.batchId="0";var n=r(P),a=e.shared={props:"a0"};Object.keys(P).forEach((function(e){a[e]=i.def(n,".",e)})),re.optional((function(){e.CHECK=r(re),e.commandStr=re.guessCommand(),e.command=r(e.commandStr),e.assert=function(e,t,i){e("if(!(",t,"))",this.CHECK,".commandRaise(",r(i),",",this.command,");")},R.invalidBlendCombinations=Xo}));var o=e.next={},s=e.current={};Object.keys(S).forEach((function(e){Array.isArray(x[e])&&(o[e]=i.def(a.next,".",e),s[e]=i.def(a.current,".",e))}));var u=e.constants={};Object.keys(R).forEach((function(e){u[e]=i.def(JSON.stringify(R[e]))})),e.invoke=function(t,i){switch(i.type){case ia:var n=["this",a.context,a.props,e.batchId];return t.def(r(i.data),".call(",n.slice(0,Math.max(i.data.length+1,4)),")");case na:return t.def(a.props,i.data);case aa:return t.def(a.context,i.data);case oa:return t.def("this",i.data);case sa:return i.data.append(e,t),i.data.ref}},e.attribCache={};var c={};return e.scopeAttrib=function(e){var i=t.id(e);if(i in c)return c[i];var n=l.scope[i];return n||(n=l.scope[i]=new m),c[i]=r(n)},e}function D(e){var t,r=e.static,i=e.dynamic;if(Na in r){var n=!!r[Na];(t=is((function(e,t){return n}))).enable=n}else if(Na in i){var a=i[Na];t=ns(a,(function(e,t){return e.invoke(t,a)}))}return t}function _(e,t){var r=e.static,i=e.dynamic;if(Ia in r){var n=r[Ia];return n?(n=s.getFramebuffer(n),re.command(n,"invalid framebuffer object"),is((function(e,t){var r=e.link(n),i=e.shared;t.set(i.framebuffer,".next",r);var a=i.context;return t.set(a,"."+qa,r+".width"),t.set(a,"."+Xa,r+".height"),r}))):is((function(e,t){var r=e.shared;t.set(r.framebuffer,".next","null");var i=r.context;return t.set(i,"."+qa,i+"."+Ka),t.set(i,"."+Xa,i+"."+Ja),"null"}))}if(Ia in i){var a=i[Ia];return ns(a,(function(e,t){var r=e.invoke(t,a),i=e.shared,n=i.framebuffer,o=t.def(n,".getFramebuffer(",r,")");re.optional((function(){e.assert(t,"!"+r+"||"+o,"invalid framebuffer object")})),t.set(n,".next",o);var s=i.context;return t.set(s,"."+qa,o+"?"+o+".width:"+s+"."+Ka),t.set(s,"."+Xa,o+"?"+o+".height:"+s+"."+Ja),o}))}return null}function M(e,t,r){var i=e.static,n=e.dynamic;function a(e){if(e in i){var a=i[e];re.commandType(a,"object","invalid "+e,r.commandStr);var o,s,u=!0,l=0|a.x,c=0|a.y;return"width"in a?(o=0|a.width,re.command(o>=0,"invalid "+e,r.commandStr)):u=!1,"height"in a?(s=0|a.height,re.command(s>=0,"invalid "+e,r.commandStr)):u=!1,new ts(!u&&t&&t.thisDep,!u&&t&&t.contextDep,!u&&t&&t.propDep,(function(e,t){var r=e.shared.context,i=o;"width"in a||(i=t.def(r,".",qa,"-",l));var n=s;return"height"in a||(n=t.def(r,".",Xa,"-",c)),[l,c,i,n]}))}if(e in n){var f=n[e],h=ns(f,(function(t,r){var i=t.invoke(r,f);re.optional((function(){t.assert(r,i+"&&typeof "+i+'==="object"',"invalid "+e)}));var n=t.shared.context,a=r.def(i,".x|0"),o=r.def(i,".y|0"),s=r.def('"width" in ',i,"?",i,".width|0:","(",n,".",qa,"-",a,")"),u=r.def('"height" in ',i,"?",i,".height|0:","(",n,".",Xa,"-",o,")");return re.optional((function(){t.assert(r,s+">=0&&"+u+">=0","invalid "+e)})),[a,o,s,u]}));return t&&(h.thisDep=h.thisDep||t.thisDep,h.contextDep=h.contextDep||t.contextDep,h.propDep=h.propDep||t.propDep),h}return t?new ts(t.thisDep,t.contextDep,t.propDep,(function(e,t){var r=e.shared.context;return[0,0,t.def(r,".",qa),t.def(r,".",Xa)]})):null}var o=a(Va);if(o){var s=o;o=new ts(o.thisDep,o.contextDep,o.propDep,(function(e,t){var r=s.append(e,t),i=e.shared.context;return t.set(i,"."+Ya,r[2]),t.set(i,"."+Za,r[3]),r}))}return{viewport:o,scissor_box:a(Ma)}}function V(e,t){var r=e.static;if("string"==typeof r[Oa]&&"string"==typeof r[Ba]){if(Object.keys(t.dynamic).length>0)return null;var i=t.static,n=Object.keys(i);if(n.length>0&&"number"==typeof i[n[0]]){for(var a=[],o=0;o<n.length;++o)re("number"==typeof i[n[o]],"must specify all vertex attribute locations when using vaos"),a.push([0|i[n[o]],n[o]]);return a}}return null}function N(e,r,i){var n=e.static,a=e.dynamic;function o(e){if(e in n){var r=t.id(n[e]);re.optional((function(){c.shader(Qo[e],r,re.guessCommand())}));var i=is((function(){return r}));return i.id=r,i}if(e in a){var o=a[e];return ns(o,(function(t,r){var i=t.invoke(r,o),n=r.def(t.shared.strings,".id(",i,")");return re.optional((function(){r(t.shared.shader,".shader(",Qo[e],",",n,",",t.command,");")})),n}))}return null}var s,u=o(Oa),l=o(Ba),f=null;return rs(u)&&rs(l)?(f=c.program(l.id,u.id,null,i),s=is((function(e,t){return e.link(f)}))):s=new ts(u&&u.thisDep||l&&l.thisDep,u&&u.contextDep||l&&l.contextDep,u&&u.propDep||l&&l.propDep,(function(e,t){var r,i=e.shared.shader;r=u?u.append(e,t):t.def(i,".",Oa);var n=i+".program("+(l?l.append(e,t):t.def(i,".",Ba))+","+r;return re.optional((function(){n+=","+e.command})),t.def(n+")")})),{frag:u,vert:l,progVar:s,program:f}}function I(e,t){var r=e.static,i=e.dynamic;function n(){if(Fa in r){var e=r[Fa];Jo(e)?e=a.getElements(a.create(e,!0)):e&&(e=a.getElements(e),re.command(e,"invalid elements",t.commandStr));var n=is((function(t,r){if(e){var i=t.link(e);return t.ELEMENTS=i,i}return t.ELEMENTS=null,null}));return n.value=e,n}if(Fa in i){var o=i[Fa];return ns(o,(function(e,t){var r=e.shared,i=r.isBufferArgs,n=r.elements,a=e.invoke(t,o),s=t.def("null"),u=t.def(i,"(",a,")"),l=e.cond(u).then(s,"=",n,".createStream(",a,");").else(s,"=",n,".getElements(",a,");");return re.optional((function(){e.assert(l.else,"!"+a+"||"+s,"invalid elements")})),t.entry(l),t.exit(e.cond(u).then(n,".destroyStream(",s,");")),e.ELEMENTS=s,s}))}return null}var o=n();function s(){if(ja in r){var e=r[ja];return re.commandParameter(e,Ut,"invalid primitve",t.commandStr),is((function(t,r){return Ut[e]}))}if(ja in i){var n=i[ja];return ns(n,(function(e,t){var r=e.constants.primTypes,i=e.invoke(t,n);return re.optional((function(){e.assert(t,i+" in "+r,"invalid primitive, must be one of "+Object.keys(Ut))})),t.def(r,"[",i,"]")}))}return o?rs(o)?o.value?is((function(e,t){return t.def(e.ELEMENTS,".primType")})):is((function(){return _o})):new ts(o.thisDep,o.contextDep,o.propDep,(function(e,t){var r=e.ELEMENTS;return t.def(r,"?",r,".primType:",_o)})):null}function u(e,n){if(e in r){var a=0|r[e];return re.command(!n||a>=0,"invalid "+e,t.commandStr),is((function(e,t){return n&&(e.OFFSET=a),a}))}if(e in i){var s=i[e];return ns(s,(function(t,r){var i=t.invoke(r,s);return n&&(t.OFFSET=i,re.optional((function(){t.assert(r,i+">=0","invalid "+e)}))),i}))}return n&&o?is((function(e,t){return e.OFFSET="0",0})):null}var l=u(La,!0);function c(){if(Wa in r){var e=0|r[Wa];return re.command("number"==typeof e&&e>=0,"invalid vertex count",t.commandStr),is((function(){return e}))}if(Wa in i){var n=i[Wa];return ns(n,(function(e,t){var r=e.invoke(t,n);return re.optional((function(){e.assert(t,"typeof "+r+'==="number"&&'+r+">=0&&"+r+"===("+r+"|0)","invalid vertex count")})),r}))}if(o){if(rs(o)){if(o)return l?new ts(l.thisDep,l.contextDep,l.propDep,(function(e,t){var r=t.def(e.ELEMENTS,".vertCount-",e.OFFSET);return re.optional((function(){e.assert(t,r+">=0","invalid vertex offset/element buffer too small")})),r})):is((function(e,t){return t.def(e.ELEMENTS,".vertCount")}));var a=is((function(){return-1}));return re.optional((function(){a.MISSING=!0})),a}var s=new ts(o.thisDep||l.thisDep,o.contextDep||l.contextDep,o.propDep||l.propDep,(function(e,t){var r=e.ELEMENTS;return e.OFFSET?t.def(r,"?",r,".vertCount-",e.OFFSET,":-1"):t.def(r,"?",r,".vertCount:-1")}));return re.optional((function(){s.DYNAMIC=!0})),s}return null}return{elements:o,primitive:s(),count:c(),instances:u(Ha,!1),offset:l}}function B(e,t){var r=e.static,n=e.dynamic,a={};return w.forEach((function(e){var o=k(e);function s(t,i){if(e in r){var s=t(r[e]);a[o]=is((function(){return s}))}else if(e in n){var u=n[e];a[o]=ns(u,(function(e,t){return i(e,t,e.invoke(t,u))}))}}switch(e){case va:case la:case ua:case Pa:case da:case _a:case Ta:case ka:case Aa:case ga:return s((function(r){return re.commandType(r,"boolean",e,t.commandStr),r}),(function(t,r,i){return re.optional((function(){t.assert(r,"typeof "+i+'==="boolean"',"invalid flag "+e,t.commandStr)})),i}));case pa:return s((function(r){return re.commandParameter(r,Yo,"invalid "+e,t.commandStr),Yo[r]}),(function(t,r,i){var n=t.constants.compareFuncs;return re.optional((function(){t.assert(r,i+" in "+n,"invalid "+e+", must be one of "+Object.keys(Yo))})),r.def(n,"[",i,"]")}));case ma:return s((function(e){return re.command(ur(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]&&e[0]<=e[1],"depth range is 2d array",t.commandStr),e}),(function(e,t,r){return re.optional((function(){e.assert(t,e.shared.isArrayLike+"("+r+")&&"+r+".length===2&&typeof "+r+'[0]==="number"&&typeof '+r+'[1]==="number"&&'+r+"[0]<="+r+"[1]","depth range must be a 2d array")})),[t.def("+",r,"[0]"),t.def("+",r,"[1]")]}));case ha:return s((function(e){re.commandType(e,"object","blend.func",t.commandStr);var r="srcRGB"in e?e.srcRGB:e.src,i="srcAlpha"in e?e.srcAlpha:e.src,n="dstRGB"in e?e.dstRGB:e.dst,a="dstAlpha"in e?e.dstAlpha:e.dst;return re.commandParameter(r,qo,o+".srcRGB",t.commandStr),re.commandParameter(i,qo,o+".srcAlpha",t.commandStr),re.commandParameter(n,qo,o+".dstRGB",t.commandStr),re.commandParameter(a,qo,o+".dstAlpha",t.commandStr),re.command(-1===Xo.indexOf(r+", "+n),"unallowed blending combination (srcRGB, dstRGB) = ("+r+", "+n+")",t.commandStr),[qo[r],qo[n],qo[i],qo[a]]}),(function(t,r,i){var n=t.constants.blendFuncs;function a(a,o){var s=r.def('"',a,o,'" in ',i,"?",i,".",a,o,":",i,".",a);return re.optional((function(){t.assert(r,s+" in "+n,"invalid "+e+"."+a+o+", must be one of "+Object.keys(qo))})),s}re.optional((function(){t.assert(r,i+"&&typeof "+i+'==="object"',"invalid blend func, must be an object")}));var o=a("src","RGB"),s=a("dst","RGB");re.optional((function(){var e=t.constants.invalidBlendCombinations;t.assert(r,e+".indexOf("+o+'+", "+'+s+") === -1 ","unallowed blending combination for (srcRGB, dstRGB)")}));var u=r.def(n,"[",o,"]"),l=r.def(n,"[",a("src","Alpha"),"]");return[u,r.def(n,"[",s,"]"),l,r.def(n,"[",a("dst","Alpha"),"]")]}));case fa:return s((function(r){return"string"==typeof r?(re.commandParameter(r,g,"invalid "+e,t.commandStr),[g[r],g[r]]):"object"==typeof r?(re.commandParameter(r.rgb,g,e+".rgb",t.commandStr),re.commandParameter(r.alpha,g,e+".alpha",t.commandStr),[g[r.rgb],g[r.alpha]]):void re.commandRaise("invalid blend.equation",t.commandStr)}),(function(t,r,i){var n=t.constants.blendEquations,a=r.def(),o=r.def(),s=t.cond("typeof ",i,'==="string"');return re.optional((function(){function r(e,r,i){t.assert(e,i+" in "+n,"invalid "+r+", must be one of "+Object.keys(g))}r(s.then,e,i),t.assert(s.else,i+"&&typeof "+i+'==="object"',"invalid "+e),r(s.else,e+".rgb",i+".rgb"),r(s.else,e+".alpha",i+".alpha")})),s.then(a,"=",o,"=",n,"[",i,"];"),s.else(a,"=",n,"[",i,".rgb];",o,"=",n,"[",i,".alpha];"),r(s),[a,o]}));case ca:return s((function(e){return re.command(ur(e)&&4===e.length,"blend.color must be a 4d array",t.commandStr),ke(4,(function(t){return+e[t]}))}),(function(e,t,r){return re.optional((function(){e.assert(t,e.shared.isArrayLike+"("+r+")&&"+r+".length===4","blend.color must be a 4d array")})),ke(4,(function(e){return t.def("+",r,"[",e,"]")}))}));case Ra:return s((function(e){return re.commandType(e,"number",o,t.commandStr),0|e}),(function(e,t,r){return re.optional((function(){e.assert(t,"typeof "+r+'==="number"',"invalid stencil.mask")})),t.def(r,"|0")}));case Ea:return s((function(r){re.commandType(r,"object",o,t.commandStr);var i=r.cmp||"keep",n=r.ref||0,a="mask"in r?r.mask:-1;return re.commandParameter(i,Yo,e+".cmp",t.commandStr),re.commandType(n,"number",e+".ref",t.commandStr),re.commandType(a,"number",e+".mask",t.commandStr),[Yo[i],n,a]}),(function(e,t,r){var i=e.constants.compareFuncs;return re.optional((function(){function n(){e.assert(t,Array.prototype.join.call(arguments,""),"invalid stencil.func")}n(r+"&&typeof ",r,'==="object"'),n('!("cmp" in ',r,")||(",r,".cmp in ",i,")")})),[t.def('"cmp" in ',r,"?",i,"[",r,".cmp]",":",jo),t.def(r,".ref|0"),t.def('"mask" in ',r,"?",r,".mask|0:-1")]}));case za:case Da:return s((function(r){re.commandType(r,"object",o,t.commandStr);var i=r.fail||"keep",n=r.zfail||"keep",a=r.zpass||"keep";return re.commandParameter(i,Zo,e+".fail",t.commandStr),re.commandParameter(n,Zo,e+".zfail",t.commandStr),re.commandParameter(a,Zo,e+".zpass",t.commandStr),[e===Da?Vo:Mo,Zo[i],Zo[n],Zo[a]]}),(function(t,r,i){var n=t.constants.stencilOps;function a(a){return re.optional((function(){t.assert(r,'!("'+a+'" in '+i+")||("+i+"."+a+" in "+n+")","invalid "+e+"."+a+", must be one of "+Object.keys(Zo))})),r.def('"',a,'" in ',i,"?",n,"[",i,".",a,"]:",jo)}return re.optional((function(){t.assert(r,i+"&&typeof "+i+'==="object"',"invalid "+e)})),[e===Da?Vo:Mo,a("fail"),a("zfail"),a("zpass")]}));case Sa:return s((function(e){re.commandType(e,"object",o,t.commandStr);var r=0|e.factor,i=0|e.units;return re.commandType(r,"number",o+".factor",t.commandStr),re.commandType(i,"number",o+".units",t.commandStr),[r,i]}),(function(t,r,i){return re.optional((function(){t.assert(r,i+"&&typeof "+i+'==="object"',"invalid "+e)})),[r.def(i,".factor|0"),r.def(i,".units|0")]}));case xa:return s((function(e){var r=0;return"front"===e?r=Mo:"back"===e&&(r=Vo),re.command(!!r,o,t.commandStr),r}),(function(e,t,r){return re.optional((function(){e.assert(t,r+'==="front"||'+r+'==="back"',"invalid cull.face")})),t.def(r,'==="front"?',Mo,":",Vo)}));case wa:return s((function(e){return re.command("number"==typeof e&&e>=i.lineWidthDims[0]&&e<=i.lineWidthDims[1],"invalid line width, must be a positive number between "+i.lineWidthDims[0]+" and "+i.lineWidthDims[1],t.commandStr),e}),(function(e,t,r){return re.optional((function(){e.assert(t,"typeof "+r+'==="number"&&'+r+">="+i.lineWidthDims[0]+"&&"+r+"<="+i.lineWidthDims[1],"invalid line width")})),r}));case ya:return s((function(e){return re.commandParameter(e,Ko,o,t.commandStr),Ko[e]}),(function(e,t,r){return re.optional((function(){e.assert(t,r+'==="cw"||'+r+'==="ccw"',"invalid frontFace, must be one of cw,ccw")})),t.def(r+'==="cw"?'+No+":"+Io)}));case ba:return s((function(e){return re.command(ur(e)&&4===e.length,"color.mask must be length 4 array",t.commandStr),e.map((function(e){return!!e}))}),(function(e,t,r){return re.optional((function(){e.assert(t,e.shared.isArrayLike+"("+r+")&&"+r+".length===4","invalid color.mask")})),ke(4,(function(e){return"!!"+r+"["+e+"]"}))}));case Ca:return s((function(e){re.command("object"==typeof e&&e,o,t.commandStr);var r="value"in e?e.value:1,i=!!e.invert;return re.command("number"==typeof r&&r>=0&&r<=1,"sample.coverage.value must be a number between 0 and 1",t.commandStr),[r,i]}),(function(e,t,r){return re.optional((function(){e.assert(t,r+"&&typeof "+r+'==="object"',"invalid sample.coverage")})),[t.def('"value" in ',r,"?+",r,".value:1"),t.def("!!",r,".invert")]}))}})),a}function O(e,t){var r=e.static,i=e.dynamic,n={};return Object.keys(r).forEach((function(e){var i,a=r[e];if("number"==typeof a||"boolean"==typeof a)i=is((function(){return a}));else if("function"==typeof a){var o=a._reglType;"texture2d"===o||"textureCube"===o?i=is((function(e){return e.link(a)})):"framebuffer"===o||"framebufferCube"===o?(re.command(a.color.length>0,'missing color attachment for framebuffer sent to uniform "'+e+'"',t.commandStr),i=is((function(e){return e.link(a.color[0])}))):re.commandRaise('invalid data for uniform "'+e+'"',t.commandStr)}else ur(a)?i=is((function(t){return t.global.def("[",ke(a.length,(function(r){return re.command("number"==typeof a[r]||"boolean"==typeof a[r],"invalid uniform "+e,t.commandStr),a[r]})),"]")})):re.commandRaise('invalid or missing data for uniform "'+e+'"',t.commandStr);i.value=a,n[e]=i})),Object.keys(i).forEach((function(e){var t=i[e];n[e]=ns(t,(function(e,r){return e.invoke(r,t)}))})),n}function F(e,r){var i=e.static,a=e.dynamic,o={};return Object.keys(i).forEach((function(e){var a=i[e],s=t.id(e),u=new m;if(Jo(a))u.state=ta,u.buffer=n.getBuffer(n.create(a,to,!1,!0)),u.type=0;else{var l=n.getBuffer(a);if(l)u.state=ta,u.buffer=l,u.type=0;else if(re.command("object"==typeof a&&a,"invalid data for attribute "+e,r.commandStr),"constant"in a){var c=a.constant;u.buffer="null",u.state=ra,"number"==typeof c?u.x=c:(re.command(ur(c)&&c.length>0&&c.length<=4,"invalid constant for attribute "+e,r.commandStr),Jn.forEach((function(e,t){t<c.length&&(u[e]=c[t])})))}else{l=Jo(a.buffer)?n.getBuffer(n.create(a.buffer,to,!1,!0)):n.getBuffer(a.buffer),re.command(!!l,'missing buffer for attribute "'+e+'"',r.commandStr);var f=0|a.offset;re.command(f>=0,'invalid offset for attribute "'+e+'"',r.commandStr);var h=0|a.stride;re.command(h>=0&&h<256,'invalid stride for attribute "'+e+'", must be integer betweeen [0, 255]',r.commandStr);var d=0|a.size;re.command(!("size"in a)||d>0&&d<=4,'invalid size for attribute "'+e+'", must be 1,2,3,4',r.commandStr);var p=!!a.normalized,g=0;"type"in a&&(re.commandParameter(a.type,Dt,"invalid type for attribute "+e,r.commandStr),g=Dt[a.type]);var v=0|a.divisor;"divisor"in a&&(re.command(0===v||b,'cannot specify divisor for attribute "'+e+'", instancing not supported',r.commandStr),re.command(v>=0,'invalid divisor for attribute "'+e+'"',r.commandStr)),re.optional((function(){var t=r.commandStr,i=["buffer","offset","divisor","normalized","type","size","stride"];Object.keys(a).forEach((function(r){re.command(i.indexOf(r)>=0,'unknown parameter "'+r+'" for attribute pointer "'+e+'" (valid parameters are '+i+")",t)}))})),u.buffer=l,u.state=ta,u.size=d,u.normalized=p,u.type=g||l.dtype,u.offset=f,u.stride=h,u.divisor=v}}o[e]=is((function(e,t){var r=e.attribCache;if(s in r)return r[s];var i={isStream:!1};return Object.keys(u).forEach((function(e){i[e]=u[e]})),u.buffer&&(i.buffer=e.link(u.buffer),i.type=i.type||i.buffer+".dtype"),r[s]=i,i}))})),Object.keys(a).forEach((function(e){var t=a[e];function r(r,i){var n=r.invoke(i,t),a=r.shared,o=r.constants,s=a.isBufferArgs,u=a.buffer;re.optional((function(){r.assert(i,n+"&&(typeof "+n+'==="object"||typeof '+n+'==="function")&&('+s+"("+n+")||"+u+".getBuffer("+n+")||"+u+".getBuffer("+n+".buffer)||"+s+"("+n+'.buffer)||("constant" in '+n+"&&(typeof "+n+'.constant==="number"||'+a.isArrayLike+"("+n+".constant))))",'invalid dynamic attribute "'+e+'"')}));var l={isStream:i.def(!1)},c=new m;c.state=ta,Object.keys(c).forEach((function(e){l[e]=i.def(""+c[e])}));var f=l.buffer,h=l.type;function d(e){i(l[e],"=",n,".",e,"|0;")}return i("if(",s,"(",n,")){",l.isStream,"=true;",f,"=",u,".createStream(",to,",",n,");",h,"=",f,".dtype;","}else{",f,"=",u,".getBuffer(",n,");","if(",f,"){",h,"=",f,".dtype;",'}else if("constant" in ',n,"){",l.state,"=",ra,";","if(typeof "+n+'.constant === "number"){',l[Jn[0]],"=",n,".constant;",Jn.slice(1).map((function(e){return l[e]})).join("="),"=0;","}else{",Jn.map((function(e,t){return l[e]+"="+n+".constant.length>"+t+"?"+n+".constant["+t+"]:0;"})).join(""),"}}else{","if(",s,"(",n,".buffer)){",f,"=",u,".createStream(",to,",",n,".buffer);","}else{",f,"=",u,".getBuffer(",n,".buffer);","}",h,'="type" in ',n,"?",o.glTypes,"[",n,".type]:",f,".dtype;",l.normalized,"=!!",n,".normalized;"),d("size"),d("offset"),d("stride"),d("divisor"),i("}}"),i.exit("if(",l.isStream,"){",u,".destroyStream(",f,");","}"),l}o[e]=ns(t,r)})),o}function j(e,t){var r=e.static,i=e.dynamic;if(Ua in r){var n=r[Ua];return null!==n&&null===l.getVAO(n)&&(n=l.createVAO(n)),is((function(e){return e.link(l.getVAO(n))}))}if(Ua in i){var a=i[Ua];return ns(a,(function(e,t){var r=e.invoke(t,a);return t.def(e.shared.vao+".getVAO("+r+")")}))}return null}function W(e){var t=e.static,r=e.dynamic,i={};return Object.keys(t).forEach((function(e){var r=t[e];i[e]=is((function(e,t){return"number"==typeof r||"boolean"==typeof r?""+r:e.link(r)}))})),Object.keys(r).forEach((function(e){var t=r[e];i[e]=ns(t,(function(e,r){return e.invoke(r,t)}))})),i}function L(e,t,i,n,a){var o=e.static,s=e.dynamic;re.optional((function(){var e=[Ia,Ba,Oa,Fa,ja,La,Wa,Ha,Na,Ua].concat(w);function t(t){Object.keys(t).forEach((function(t){re.command(e.indexOf(t)>=0,'unknown parameter "'+t+'"',a.commandStr)}))}t(o),t(s)}));var u=V(e,t),c=_(e),f=M(e,c,a),h=I(e,a),d=B(e,a),p=N(e,a,u);function m(e){var t=f[e];t&&(d[e]=t)}m(Va),m(k(Ma));var g=Object.keys(d).length>0,b={framebuffer:c,draw:h,shader:p,state:d,dirty:g,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}};if(b.profile=D(e),b.uniforms=O(i,a),b.drawVAO=b.scopeVAO=j(e),!b.drawVAO&&p.program&&!u&&r.angle_instanced_arrays){var v=!0,x=p.program.attributes.map((function(e){var r=t.static[e];return v=v&&!!r,r}));if(v&&x.length>0){var y=l.getVAO(l.createVAO(x));b.drawVAO=new ts(null,null,null,(function(e,t){return e.link(y)})),b.useVAO=!0}}return u?b.useVAO=!0:b.attributes=F(t,a),b.context=W(n),b}function H(e,t,r){var i=e.shared.context,n=e.scope();Object.keys(r).forEach((function(a){t.save(i,"."+a);var o=r[a];n(i,".",a,"=",o.append(e,t),";")})),t(n)}function U(e,t,r,i){var n,a=e.shared,o=a.gl,s=a.framebuffer;v&&(n=t.def(a.extensions,".webgl_draw_buffers"));var u,l=e.constants,c=l.drawBuffer,f=l.backBuffer;u=r?r.append(e,t):t.def(s,".next"),i||t("if(",u,"!==",s,".cur){"),t("if(",u,"){",o,".bindFramebuffer(",$o,",",u,".framebuffer);"),v&&t(n,".drawBuffersWEBGL(",c,"[",u,".colorAttachments.length]);"),t("}else{",o,".bindFramebuffer(",$o,",null);"),v&&t(n,".drawBuffersWEBGL(",f,");"),t("}",s,".cur=",u,";"),i||t("}")}function $(e,t,r){var i=e.shared,n=i.gl,a=e.current,o=e.next,s=i.current,u=i.next,l=e.cond(s,".dirty");w.forEach((function(t){var i,c,f=k(t);if(!(f in r.state))if(f in o){i=o[f],c=a[f];var h=ke(x[f].length,(function(e){return l.def(i,"[",e,"]")}));l(e.cond(h.map((function(e,t){return e+"!=="+c+"["+t+"]"})).join("||")).then(n,".",S[f],"(",h,");",h.map((function(e,t){return c+"["+t+"]="+e})).join(";"),";"))}else{i=l.def(u,".",f);var d=e.cond(i,"!==",s,".",f);l(d),f in T?d(e.cond(i).then(n,".enable(",T[f],");").else(n,".disable(",T[f],");"),s,".",f,"=",i,";"):d(n,".",S[f],"(",i,");",s,".",f,"=",i,";")}})),0===Object.keys(r.state).length&&l(s,".dirty=false;"),t(l)}function G(e,t,r,i){var n=e.shared,a=e.current,o=n.current,s=n.gl;es(Object.keys(r)).forEach((function(n){var u=r[n];if(!i||i(u)){var l=u.append(e,t);if(T[n]){var c=T[n];rs(u)?t(s,l?".enable(":".disable(",c,");"):t(e.cond(l).then(s,".enable(",c,");").else(s,".disable(",c,");")),t(o,".",n,"=",l,";")}else if(ur(l)){var f=a[n];t(s,".",S[n],"(",l,");",l.map((function(e,t){return f+"["+t+"]="+e})).join(";"),";")}else t(s,".",S[n],"(",l,");",o,".",n,"=",l,";")}}))}function q(e,t){b&&(e.instancing=t.def(e.shared.extensions,".angle_instanced_arrays"))}function X(e,t,r,i,n){var a,o,s,u=e.shared,l=e.stats,c=u.current,f=u.timer,h=r.profile;function p(){return"undefined"==typeof performance?"Date.now()":"performance.now()"}function m(e){e(a=t.def(),"=",p(),";"),"string"==typeof n?e(l,".count+=",n,";"):e(l,".count++;"),d&&(i?e(o=t.def(),"=",f,".getNumPendingQueries();"):e(f,".beginQuery(",l,");"))}function g(e){e(l,".cpuTime+=",p(),"-",a,";"),d&&(i?e(f,".pushScopeStats(",o,",",f,".getNumPendingQueries(),",l,");"):e(f,".endQuery();"))}function b(e){var r=t.def(c,".profile");t(c,".profile=",e,";"),t.exit(c,".profile=",r,";")}if(h){if(rs(h))return void(h.enable?(m(t),g(t.exit),b("true")):b("false"));b(s=h.append(e,t))}else s=t.def(c,".profile");var v=e.block();m(v),t("if(",s,"){",v,"}");var x=e.block();g(x),t.exit("if(",s,"){",x,"}")}function Y(e,t,r,i,n){var a=e.shared;function o(e){switch(e){case go:case yo:case ko:return 2;case bo:case wo:case Ao:return 3;case vo:case To:case Co:return 4;default:return 1}}function s(r,i,n){var o=a.gl,s=t.def(r,".location"),u=t.def(a.attributes,"[",s,"]"),l=n.state,c=n.buffer,f=[n.x,n.y,n.z,n.w],h=["buffer","normalized","offset","stride"];function d(){t("if(!",u,".buffer){",o,".enableVertexAttribArray(",s,");}");var r,a=n.type;if(r=n.size?t.def(n.size,"||",i):i,t("if(",u,".type!==",a,"||",u,".size!==",r,"||",h.map((function(e){return u+"."+e+"!=="+n[e]})).join("||"),"){",o,".bindBuffer(",to,",",c,".buffer);",o,".vertexAttribPointer(",[s,r,a,n.normalized,n.stride,n.offset],");",u,".type=",a,";",u,".size=",r,";",h.map((function(e){return u+"."+e+"="+n[e]+";"})).join(""),"}"),b){var l=n.divisor;t("if(",u,".divisor!==",l,"){",e.instancing,".vertexAttribDivisorANGLE(",[s,l],");",u,".divisor=",l,";}")}}function p(){t("if(",u,".buffer){",o,".disableVertexAttribArray(",s,");",u,".buffer=null;","}if(",Jn.map((function(e,t){return u+"."+e+"!=="+f[t]})).join("||"),"){",o,".vertexAttrib4f(",s,",",f,");",Jn.map((function(e,t){return u+"."+e+"="+f[t]+";"})).join(""),"}")}l===ta?d():l===ra?p():(t("if(",l,"===",ta,"){"),d(),t("}else{"),p(),t("}"))}i.forEach((function(i){var a,u=i.name,l=r.attributes[u];if(l){if(!n(l))return;a=l.append(e,t)}else{if(!n(as))return;var c=e.scopeAttrib(u);re.optional((function(){e.assert(t,c+".state","missing attribute "+u)})),a={},Object.keys(new m).forEach((function(e){a[e]=t.def(c,".",e)}))}s(e.link(i),o(i.info.type),a)}))}function Z(e,r,i,n,a){for(var o,s=e.shared,u=s.gl,l=0;l<n.length;++l){var c,f=n[l],h=f.name,d=f.info.type,p=i.uniforms[h],m=e.link(f)+".location";if(p){if(!a(p))continue;if(rs(p)){var g=p.value;if(re.command(null!=g,'missing uniform "'+h+'"',e.commandStr),d===zo||d===Do){re.command("function"==typeof g&&(d===zo&&("texture2d"===g._reglType||"framebuffer"===g._reglType)||d===Do&&("textureCube"===g._reglType||"framebufferCube"===g._reglType)),"invalid texture for uniform "+h,e.commandStr);var b=e.link(g._texture||g.color[0]._texture);r(u,".uniform1i(",m,",",b+".bind());"),r.exit(b,".unbind();")}else if(d===Po||d===Ro||d===Eo){re.optional((function(){re.command(ur(g),"invalid matrix for uniform "+h,e.commandStr),re.command(d===Po&&4===g.length||d===Ro&&9===g.length||d===Eo&&16===g.length,"invalid length for matrix uniform "+h,e.commandStr)}));var v=e.global.def("new Float32Array(["+Array.prototype.slice.call(g)+"])"),x=2;d===Ro?x=3:d===Eo&&(x=4),r(u,".uniformMatrix",x,"fv(",m,",false,",v,");")}else{switch(d){case mo:re.commandType(g,"number","uniform "+h,e.commandStr),o="1f";break;case go:re.command(ur(g)&&2===g.length,"uniform "+h,e.commandStr),o="2f";break;case bo:re.command(ur(g)&&3===g.length,"uniform "+h,e.commandStr),o="3f";break;case vo:re.command(ur(g)&&4===g.length,"uniform "+h,e.commandStr),o="4f";break;case So:re.commandType(g,"boolean","uniform "+h,e.commandStr),o="1i";break;case xo:re.commandType(g,"number","uniform "+h,e.commandStr),o="1i";break;case ko:case yo:re.command(ur(g)&&2===g.length,"uniform "+h,e.commandStr),o="2i";break;case Ao:case wo:re.command(ur(g)&&3===g.length,"uniform "+h,e.commandStr),o="3i";break;case Co:case To:re.command(ur(g)&&4===g.length,"uniform "+h,e.commandStr),o="4i"}r(u,".uniform",o,"(",m,",",ur(g)?Array.prototype.slice.call(g):g,");")}continue}c=p.append(e,r)}else{if(!a(as))continue;c=r.def(s.uniforms,"[",t.id(h),"]")}d===zo?r("if(",c,"&&",c,'._reglType==="framebuffer"){',c,"=",c,".color[0];","}"):d===Do&&r("if(",c,"&&",c,'._reglType==="framebufferCube"){',c,"=",c,".color[0];","}"),re.optional((function(){function t(t,i){e.assert(r,t,'bad data or missing for uniform "'+h+'".  '+i)}function i(e){t("typeof "+c+'==="'+e+'"',"invalid type, expected "+e)}function n(r,i){t(s.isArrayLike+"("+c+")&&"+c+".length==="+r,"invalid vector, should have length "+r,e.commandStr)}function a(r){t("typeof "+c+'==="function"&&'+c+'._reglType==="texture'+(r===io?"2d":"Cube")+'"',"invalid texture type",e.commandStr)}switch(d){case xo:i("number");break;case yo:n(2);break;case wo:n(3);break;case To:n(4);break;case mo:i("number");break;case go:n(2);break;case bo:n(3);break;case vo:n(4);break;case So:i("boolean");break;case ko:n(2);break;case Ao:n(3);break;case Co:case Po:n(4);break;case Ro:n(9);break;case Eo:n(16);break;case zo:a(io);break;case Do:a(no)}}));var y=1;switch(d){case zo:case Do:var w=r.def(c,"._texture");r(u,".uniform1i(",m,",",w,".bind());"),r.exit(w,".unbind();");continue;case xo:case So:o="1i";break;case yo:case ko:o="2i",y=2;break;case wo:case Ao:o="3i",y=3;break;case To:case Co:o="4i",y=4;break;case mo:o="1f";break;case go:o="2f",y=2;break;case bo:o="3f",y=3;break;case vo:o="4f",y=4;break;case Po:o="Matrix2fv";break;case Ro:o="Matrix3fv";break;case Eo:o="Matrix4fv"}if(r(u,".uniform",o,"(",m,","),"M"===o.charAt(0)){var T=Math.pow(d-Po+2,2),S=e.global.def("new Float32Array(",T,")");r("false,(Array.isArray(",c,")||",c," instanceof Float32Array)?",c,":(",ke(T,(function(e){return S+"["+e+"]="+c+"["+e+"]"})),",",S,")")}else r(y>1?ke(y,(function(e){return c+"["+e+"]"})):c);r(");")}}function Q(e,t,r,i){var n=e.shared,a=n.gl,o=n.draw,s=i.draw;function u(){var n,u=s.elements,l=t;return u?((u.contextDep&&i.contextDynamic||u.propDep)&&(l=r),n=u.append(e,l)):n=l.def(o,".",Fa),n&&l("if("+n+")"+a+".bindBuffer("+ro+","+n+".buffer.buffer);"),n}function l(){var n,a=s.count,u=t;return a?((a.contextDep&&i.contextDynamic||a.propDep)&&(u=r),n=a.append(e,u),re.optional((function(){a.MISSING&&e.assert(t,"false","missing vertex count"),a.DYNAMIC&&e.assert(u,n+">=0","missing vertex count")}))):(n=u.def(o,".",Wa),re.optional((function(){e.assert(u,n+">=0","missing vertex count")}))),n}var c=u();function f(n){var a=s[n];return a?a.contextDep&&i.contextDynamic||a.propDep?a.append(e,r):a.append(e,t):t.def(o,".",n)}var h,d,p=f(ja),m=f(La),g=l();if("number"==typeof g){if(0===g)return}else r("if(",g,"){"),r.exit("}");b&&(h=f(Ha),d=e.instancing);var v=c+".type",x=s.elements&&rs(s.elements);function y(){function e(){r(d,".drawElementsInstancedANGLE(",[p,g,v,m+"<<(("+v+"-"+ea+")>>1)",h],");")}function t(){r(d,".drawArraysInstancedANGLE(",[p,m,g,h],");")}c?x?e():(r("if(",c,"){"),e(),r("}else{"),t(),r("}")):t()}function w(){function e(){r(a+".drawElements("+[p,g,v,m+"<<(("+v+"-"+ea+")>>1)"]+");")}function t(){r(a+".drawArrays("+[p,m,g]+");")}c?x?e():(r("if(",c,"){"),e(),r("}else{"),t(),r("}")):t()}b&&("number"!=typeof h||h>=0)?"string"==typeof h?(r("if(",h,">0){"),y(),r("}else if(",h,"<0){"),w(),r("}")):y():w()}function K(e,t,r,i,n){var a=z(),o=a.proc("body",n);return re.optional((function(){a.commandStr=t.commandStr,a.command=a.link(t.commandStr)})),b&&(a.instancing=o.def(a.shared.extensions,".angle_instanced_arrays")),e(a,o,r,i),a.compile().body}function J(e,t,r,i){q(e,t),r.useVAO?r.drawVAO?t(e.shared.vao,".setVAO(",r.drawVAO.append(e,t),");"):t(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(t(e.shared.vao,".setVAO(null);"),Y(e,t,r,i.attributes,(function(){return!0}))),Z(e,t,r,i.uniforms,(function(){return!0})),Q(e,t,t,r)}function ee(e,t){var r=e.proc("draw",1);q(e,r),H(e,r,t.context),U(e,r,t.framebuffer),$(e,r,t),G(e,r,t.state),X(e,r,t,!1,!0);var i=t.shader.progVar.append(e,r);if(r(e.shared.gl,".useProgram(",i,".program);"),t.shader.program)J(e,r,t,t.shader.program);else{r(e.shared.vao,".setVAO(null);");var n=e.global.def("{}"),a=r.def(i,".id"),o=r.def(n,"[",a,"]");r(e.cond(o).then(o,".call(this,a0);").else(o,"=",n,"[",a,"]=",e.link((function(r){return K(J,e,t,r,1)})),"(",i,");",o,".call(this,a0);"))}Object.keys(t.state).length>0&&r(e.shared.current,".dirty=true;")}function te(e,t,r,i){function n(){return!0}e.batchId="a1",q(e,t),Y(e,t,r,i.attributes,n),Z(e,t,r,i.uniforms,n),Q(e,t,t,r)}function ie(e,t,r,i){q(e,t);var n=r.contextDep,a=t.def(),o="a0",s="a1",u=t.def();e.shared.props=u,e.batchId=a;var l=e.scope(),c=e.scope();function f(e){return e.contextDep&&n||e.propDep}function h(e){return!f(e)}if(t(l.entry,"for(",a,"=0;",a,"<",s,";++",a,"){",u,"=",o,"[",a,"];",c,"}",l.exit),r.needsContext&&H(e,c,r.context),r.needsFramebuffer&&U(e,c,r.framebuffer),G(e,c,r.state,f),r.profile&&f(r.profile)&&X(e,c,r,!1,!0),i)r.useVAO?r.drawVAO?f(r.drawVAO)?c(e.shared.vao,".setVAO(",r.drawVAO.append(e,c),");"):l(e.shared.vao,".setVAO(",r.drawVAO.append(e,l),");"):l(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(l(e.shared.vao,".setVAO(null);"),Y(e,l,r,i.attributes,h),Y(e,c,r,i.attributes,f)),Z(e,l,r,i.uniforms,h),Z(e,c,r,i.uniforms,f),Q(e,l,c,r);else{var d=e.global.def("{}"),p=r.shader.progVar.append(e,c),m=c.def(p,".id"),g=c.def(d,"[",m,"]");c(e.shared.gl,".useProgram(",p,".program);","if(!",g,"){",g,"=",d,"[",m,"]=",e.link((function(t){return K(te,e,r,t,2)})),"(",p,");}",g,".call(this,a0[",a,"],",a,");")}}function ne(e,t){var r=e.proc("batch",2);e.batchId="0",q(e,r);var i=!1,n=!0;Object.keys(t.context).forEach((function(e){i=i||t.context[e].propDep})),i||(H(e,r,t.context),n=!1);var a=t.framebuffer,o=!1;function s(e){return e.contextDep&&i||e.propDep}a?(a.propDep?i=o=!0:a.contextDep&&i&&(o=!0),o||U(e,r,a)):U(e,r,null),t.state.viewport&&t.state.viewport.propDep&&(i=!0),$(e,r,t),G(e,r,t.state,(function(e){return!s(e)})),t.profile&&s(t.profile)||X(e,r,t,!1,"a1"),t.contextDep=i,t.needsContext=n,t.needsFramebuffer=o;var u=t.shader.progVar;if(u.contextDep&&i||u.propDep)ie(e,r,t,null);else{var l=u.append(e,r);if(r(e.shared.gl,".useProgram(",l,".program);"),t.shader.program)ie(e,r,t,t.shader.program);else{r(e.shared.vao,".setVAO(null);");var c=e.global.def("{}"),f=r.def(l,".id"),h=r.def(c,"[",f,"]");r(e.cond(h).then(h,".call(this,a0,a1);").else(h,"=",c,"[",f,"]=",e.link((function(r){return K(ie,e,t,r,2)})),"(",l,");",h,".call(this,a0,a1);"))}}Object.keys(t.state).length>0&&r(e.shared.current,".dirty=true;")}function ae(e,r){var i=e.proc("scope",3);e.batchId="a2";var n=e.shared,a=n.current;function o(t){var a=r.shader[t];a&&i.set(n.shader,"."+t,a.append(e,i))}H(e,i,r.context),r.framebuffer&&r.framebuffer.append(e,i),es(Object.keys(r.state)).forEach((function(t){var a=r.state[t].append(e,i);ur(a)?a.forEach((function(r,n){i.set(e.next[t],"["+n+"]",r)})):i.set(n.next,"."+t,a)})),X(e,i,r,!0,!0),[Fa,La,Wa,Ha,ja].forEach((function(t){var a=r.draw[t];a&&i.set(n.draw,"."+t,""+a.append(e,i))})),Object.keys(r.uniforms).forEach((function(a){i.set(n.uniforms,"["+t.id(a)+"]",r.uniforms[a].append(e,i))})),Object.keys(r.attributes).forEach((function(t){var n=r.attributes[t].append(e,i),a=e.scopeAttrib(t);Object.keys(new m).forEach((function(e){i.set(a,"."+e,n[e])}))})),r.scopeVAO&&i.set(n.vao,".targetVAO",r.scopeVAO.append(e,i)),o(Ba),o(Oa),Object.keys(r.state).length>0&&(i(a,".dirty=true;"),i.exit(a,".dirty=true;")),i("a1(",e.shared.context,",a0,",e.batchId,");")}function oe(e){if("object"==typeof e&&!ur(e)){for(var t=Object.keys(e),r=0;r<t.length;++r)if(he.isDynamic(e[t[r]]))return!0;return!1}}function se(e,t,r){var i=t.static[r];if(i&&oe(i)){var n=e.global,a=Object.keys(i),o=!1,s=!1,u=!1,l=e.global.def("{}");a.forEach((function(t){var r=i[t];if(he.isDynamic(r)){"function"==typeof r&&(r=i[t]=he.unbox(r));var a=ns(r,null);o=o||a.thisDep,u=u||a.propDep,s=s||a.contextDep}else{switch(n(l,".",t,"="),typeof r){case"number":n(r);break;case"string":n('"',r,'"');break;case"object":Array.isArray(r)&&n("[",r.join(),"]");break;default:n(e.link(r))}n(";")}})),t.dynamic[r]=new he.DynamicVariable(sa,{thisDep:o,contextDep:s,propDep:u,ref:l,append:c}),delete t.static[r]}function c(e,t){a.forEach((function(r){var n=i[r];if(he.isDynamic(n)){var a=e.invoke(t,n);t(l,".",r,"=",a,";")}}))}}function ue(e,t,r,i,n){var a=z();a.stats=a.link(n),Object.keys(t.static).forEach((function(e){se(a,t,e)})),eo.forEach((function(t){se(a,e,t)}));var o=L(e,t,r,i,a);return ee(a,o),ae(a,o),ne(a,o),a.compile()}return{next:y,current:x,procs:function(){var e=z(),t=e.proc("poll"),n=e.proc("refresh"),a=e.block();t(a),n(a);var o,s=e.shared,u=s.gl,l=s.next,c=s.current;a(c,".dirty=false;"),U(e,t),U(e,n,null,!0),b&&(o=e.link(b)),r.oes_vertex_array_object&&n(e.link(r.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var f=0;f<i.maxAttributes;++f){var h=n.def(s.attributes,"[",f,"]"),d=e.cond(h,".buffer");d.then(u,".enableVertexAttribArray(",f,");",u,".bindBuffer(",to,",",h,".buffer.buffer);",u,".vertexAttribPointer(",f,",",h,".size,",h,".type,",h,".normalized,",h,".stride,",h,".offset);").else(u,".disableVertexAttribArray(",f,");",u,".vertexAttrib4f(",f,",",h,".x,",h,".y,",h,".z,",h,".w);",h,".buffer=null;"),n(d),b&&n(o,".vertexAttribDivisorANGLE(",f,",",h,".divisor);")}return n(e.shared.vao,".currentVAO=null;",e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"),Object.keys(T).forEach((function(r){var i=T[r],o=a.def(l,".",r),s=e.block();s("if(",o,"){",u,".enable(",i,")}else{",u,".disable(",i,")}",c,".",r,"=",o,";"),n(s),t("if(",o,"!==",c,".",r,"){",s,"}")})),Object.keys(S).forEach((function(r){var i,o,s=S[r],f=x[r],h=e.block();if(h(u,".",s,"("),ur(f)){var d=f.length;i=e.global.def(l,".",r),o=e.global.def(c,".",r),h(ke(d,(function(e){return i+"["+e+"]"})),");",ke(d,(function(e){return o+"["+e+"]="+i+"["+e+"];"})).join("")),t("if(",ke(d,(function(e){return i+"["+e+"]!=="+o+"["+e+"]"})).join("||"),"){",h,"}")}else i=a.def(l,".",r),o=a.def(c,".",r),h(i,");",c,".",r,"=",i,";"),t("if(",i,"!==",o,"){",h,"}");n(h)})),e.compile()}(),compile:ue}}function ss(){return{vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0}}var us=34918,ls=34919,cs=35007,fs=function(e,t){if(!t.ext_disjoint_timer_query)return null;var r=[];function i(){return r.pop()||t.ext_disjoint_timer_query.createQueryEXT()}function n(e){r.push(e)}var a=[];function o(e){var r=i();t.ext_disjoint_timer_query.beginQueryEXT(cs,r),a.push(r),d(a.length-1,a.length,e)}function s(){t.ext_disjoint_timer_query.endQueryEXT(cs)}function u(){this.startQueryIndex=-1,this.endQueryIndex=-1,this.sum=0,this.stats=null}var l=[];function c(){return l.pop()||new u}function f(e){l.push(e)}var h=[];function d(e,t,r){var i=c();i.startQueryIndex=e,i.endQueryIndex=t,i.sum=0,i.stats=r,h.push(i)}var p=[],m=[];function g(){var e,r,i=a.length;if(0!==i){m.length=Math.max(m.length,i+1),p.length=Math.max(p.length,i+1),p[0]=0,m[0]=0;var o=0;for(e=0,r=0;r<a.length;++r){var s=a[r];t.ext_disjoint_timer_query.getQueryObjectEXT(s,ls)?(o+=t.ext_disjoint_timer_query.getQueryObjectEXT(s,us),n(s)):a[e++]=s,p[r+1]=o,m[r+1]=e}for(a.length=e,e=0,r=0;r<h.length;++r){var u=h[r],l=u.startQueryIndex,c=u.endQueryIndex;u.sum+=p[c]-p[l];var d=m[l],g=m[c];g===d?(u.stats.gpuTime+=u.sum/1e6,f(u)):(u.startQueryIndex=d,u.endQueryIndex=g,h[e++]=u)}h.length=e}}return{beginQuery:o,endQuery:s,pushScopeStats:d,update:g,getNumPendingQueries:function(){return a.length},clear:function(){r.push.apply(r,a);for(var e=0;e<r.length;e++)t.ext_disjoint_timer_query.deleteQueryEXT(r[e]);a.length=0,r.length=0},restore:function(){a.length=0,r.length=0}}},hs=16384,ds=256,ps=1024,ms=34962,gs="webglcontextlost",bs="webglcontextrestored",vs=1,xs=2,ys=3;function ws(e,t){for(var r=0;r<e.length;++r)if(e[r]===t)return r;return-1}function Ts(e){var r=Te(e);if(!r)return null;var i=r.gl,n=i.getContextAttributes(),a=i.isContextLost(),o=Se(i,r);if(!o)return null;var s=me(),u=ss(),l=o.extensions,c=fs(i,l),f=pe(),h=i.drawingBufferWidth,d=i.drawingBufferHeight,p={tick:0,time:0,viewportWidth:h,viewportHeight:d,framebufferWidth:h,framebufferHeight:d,drawingBufferWidth:h,drawingBufferHeight:d,pixelRatio:r.pixelRatio},m={},g={elements:null,primitive:4,count:-1,offset:0,instances:-1},b=yt(i,l),v=Ht(i,u,r,y),x=Fn(i,l,b,u,v);function y(e){return x.destroyBuffer(e)}var w=ir(i,l,v,u),T=Un(i,s,u,r),S=Gi(i,l,b,(function(){C.procs.poll()}),p,u,r),k=sn(i,l,b,u,r),A=Nn(i,l,b,S,k,u),C=os(i,s,l,b,v,w,S,A,m,x,T,g,p,c,r),P=Yn(i,A,C.procs.poll,p,n,l,b),R=C.next,E=i.canvas,z=[],D=[],_=[],M=[r.onDestroy],V=null;function N(){if(0===z.length)return c&&c.update(),void(V=null);V=de.next(N),q();for(var e=z.length-1;e>=0;--e){var t=z[e];t&&t(p,null,0)}i.flush(),c&&c.update()}function I(){!V&&z.length>0&&(V=de.next(N))}function B(){V&&(de.cancel(N),V=null)}function O(e){e.preventDefault(),a=!0,B(),D.forEach((function(e){e()}))}function F(e){i.getError(),a=!1,o.restore(),T.restore(),v.restore(),S.restore(),k.restore(),A.restore(),x.restore(),c&&c.restore(),C.procs.refresh(),I(),_.forEach((function(e){e()}))}function j(){z.length=0,B(),E&&(E.removeEventListener(gs,O),E.removeEventListener(bs,F)),T.clear(),A.clear(),k.clear(),S.clear(),w.clear(),v.clear(),x.clear(),c&&c.clear(),M.forEach((function(e){e()}))}function W(e){function r(e){var r=t({},e);function i(e){if(e in r){var t=r[e];delete r[e],Object.keys(t).forEach((function(i){r[e+"."+i]=t[i]}))}}return delete r.uniforms,delete r.attributes,delete r.context,delete r.vao,"stencil"in r&&r.stencil.op&&(r.stencil.opBack=r.stencil.opFront=r.stencil.op,delete r.stencil.op),i("blend"),i("depth"),i("cull"),i("stencil"),i("polygonOffset"),i("scissor"),i("sample"),"vao"in e&&(r.vao=e.vao),r}function i(e){var t={},r={};return Object.keys(e).forEach((function(i){var n=e[i];he.isDynamic(n)?r[i]=he.unbox(n,i):t[i]=n})),{dynamic:r,static:t}}re(!!e,"invalid args to regl({...})"),re.type(e,"object","invalid args to regl({...})");var n=i(e.context||{}),o=i(e.uniforms||{}),s=i(e.attributes||{}),u=i(r(e)),l={gpuTime:0,cpuTime:0,count:0},c=C.compile(u,s,o,n,l),f=c.draw,h=c.batch,d=c.scope,p=[];function m(e){for(;p.length<e;)p.push(null);return p}function g(e,t){var r;if(a&&re.raise("context lost"),"function"==typeof e)return d.call(this,null,e,0);if("function"==typeof t)if("number"==typeof e)for(r=0;r<e;++r)d.call(this,null,t,r);else{if(!Array.isArray(e))return d.call(this,e,t,0);for(r=0;r<e.length;++r)d.call(this,e[r],t,r)}else if("number"==typeof e){if(e>0)return h.call(this,m(0|e),0|e)}else{if(!Array.isArray(e))return f.call(this,e);if(e.length)return h.call(this,e,e.length)}}return t(g,{stats:l})}E&&(E.addEventListener(gs,O,!1),E.addEventListener(bs,F,!1));var L=A.setFBO=W({framebuffer:he.define.call(null,vs,"framebuffer")});function H(e,t){var r=0;C.procs.poll();var n=t.color;n&&(i.clearColor(+n[0]||0,+n[1]||0,+n[2]||0,+n[3]||0),r|=hs),"depth"in t&&(i.clearDepth(+t.depth),r|=ds),"stencil"in t&&(i.clearStencil(0|t.stencil),r|=ps),re(!!r,"called regl.clear with no buffer specified"),i.clear(r)}function U(e){if(re("object"==typeof e&&e,"regl.clear() takes an object as input"),"framebuffer"in e)if(e.framebuffer&&"framebufferCube"===e.framebuffer_reglType)for(var r=0;r<6;++r)L(t({framebuffer:e.framebuffer.faces[r]},e),H);else L(e,H);else H(null,e)}function $(e){function t(){var t=ws(z,e);function r(){var e=ws(z,r);z[e]=z[z.length-1],z.length-=1,z.length<=0&&B()}re(t>=0,"cannot cancel a frame twice"),z[t]=r}return re.type(e,"function","regl.frame() callback must be a function"),z.push(e),I(),{cancel:t}}function G(){var e=R.viewport,t=R.scissor_box;e[0]=e[1]=t[0]=t[1]=0,p.viewportWidth=p.framebufferWidth=p.drawingBufferWidth=e[2]=t[2]=i.drawingBufferWidth,p.viewportHeight=p.framebufferHeight=p.drawingBufferHeight=e[3]=t[3]=i.drawingBufferHeight}function q(){p.tick+=1,p.time=Y(),G(),C.procs.poll()}function X(){G(),C.procs.refresh(),c&&c.update()}function Y(){return(pe()-f)/1e3}function Z(e,t){var r;switch(re.type(t,"function","listener callback must be a function"),e){case"frame":return $(t);case"lost":r=D;break;case"restore":r=_;break;case"destroy":r=M;break;default:re.raise("invalid event, must be one of frame,lost,restore,destroy")}return r.push(t),{cancel:function(){for(var e=0;e<r.length;++e)if(r[e]===t)return r[e]=r[r.length-1],void r.pop()}}}X();var Q=t(W,{clear:U,prop:he.define.bind(null,vs),context:he.define.bind(null,xs),this:he.define.bind(null,ys),draw:W({}),buffer:function(e){return v.create(e,ms,!1,!1)},elements:function(e){return w.create(e,!1)},texture:S.create2D,cube:S.createCube,renderbuffer:k.create,framebuffer:A.create,framebufferCube:A.createCube,vao:x.createVAO,attributes:n,frame:$,on:Z,limits:b,hasExtension:function(e){return b.extensions.indexOf(e.toLowerCase())>=0},read:P,destroy:j,_gl:i,_refresh:X,poll:function(){q(),c&&c.update()},now:Y,stats:u});return r.onDone(null,Q),Q}return Ts}()}));const i=Object.freeze(["r","g","b","a"]),n=Object.freeze({dataChannelCount:4,desiredSwatchCapacity:1/0,attributes:[{attributeName:"TransitionTimeMs",isTimestamp:!0},{attributeName:"PositionWorld",isInterpolable:!0,components:["X","Y"]},{attributeName:"SizeWorld",isInterpolable:!0,isBroadcastable:!0,components:["Width","Height"]},{attributeName:"GeometricZoom",isInterpolable:!0,isBroadcastable:!0,components:["X","Y"]},{attributeName:"PositionPixel",isInterpolable:!0,components:["X","Y"]},{attributeName:"SizePixel",isInterpolable:!0,isBroadcastable:!0,components:["Width","Height"]},{attributeName:"MaxSizePixel",isInterpolable:!0,isBroadcastable:!0,components:["Width","Height"]},{attributeName:"MinSizePixel",isInterpolable:!0,isBroadcastable:!0,components:["Width","Height"]},{attributeName:"PositionRelative",isInterpolable:!0,components:["X","Y"]},{attributeName:"Sides"},{attributeName:"ShapeTexture",components:["U","V","Width","Height"]},{attributeName:"BorderRadiusWorld",isInterpolable:!0},{attributeName:"BorderRadiusPixel",isInterpolable:!0},{attributeName:"BorderPlacement",isInterpolable:!0},{attributeName:"BorderColor",isInterpolable:!0,components:["R","G","B","Opacity"]},{attributeName:"FillBlend",isInterpolable:!0},{attributeName:"FillColor",isInterpolable:!0,components:["R","G","B","Opacity"]},{attributeName:"FillTexture",components:["U","V","Width","Height"]}]});class a{constructor(e){const t=Object.assign({},n,e||{});if(!isFinite(t.maxTextureSize)&&!isFinite(t.desiredSwatchCapacity))throw new Error("Cannot map attributes to texture of infinite size.");this.dataChannelCount=t.dataChannelCount,this.maxTextureSize=t.maxTextureSize,this.desiredSwatchCapacity=t.desiredSwatchCapacity,this.attributes=t.attributes,this.attributeComponentIndices={},this.attributeComponentNames=[],this.isAttributeTimestamp=[];for(const e of this.attributes){const{attributeName:t,components:r}=e;for(const i of r||[""]){const r=`${t}${i}`;if(r in this.attributeComponentIndices)throw new Error(`Duplicate attribute component name detected: ${r}`);const n=this.attributeComponentNames.length;this.attributeComponentNames[n]=r,this.attributeComponentIndices[r]=n,this.isAttributeTimestamp[n]=!!e.isTimestamp}}for(const e of this.attributes){if(!e.isInterpolable)continue;const{attributeName:t,components:r}=e;for(const i of r||[""]){const r=`${t}${i}Delta`;if(r in this.attributeComponentIndices)throw new Error(`Duplicate attribute component name detected: ${r}`);const n=this.attributeComponentNames.length;this.attributeComponentNames[n]=r,this.attributeComponentIndices[r]=n,this.isAttributeTimestamp[n]=!!e.isTimestamp}}Object.freeze(this.attributeComponentIndices),Object.freeze(this.attributeComponentNames),Object.freeze(this.isAttributeTimestamp),this.texelsPerSwatch=Math.ceil(this.attributeComponentNames.length/this.dataChannelCount),this.valuesPerSwatch=this.texelsPerSwatch*this.dataChannelCount,this.bytesPerSwatch=4*this.valuesPerSwatch,this.swatchesPerRow=Math.floor(this.maxTextureSize/this.texelsPerSwatch),this.textureWidth=this.texelsPerSwatch*this.swatchesPerRow,this.textureHeight=this.maxTextureSize,this.totalSwatches=this.swatchesPerRow*this.textureHeight,this.totalSwatches>this.desiredSwatchCapacity&&(this.swatchesPerRow=Math.min(this.swatchesPerRow,Math.ceil(Math.sqrt(this.desiredSwatchCapacity/this.texelsPerSwatch))),this.textureWidth=this.texelsPerSwatch*this.swatchesPerRow,this.textureHeight=Math.min(this.textureHeight,Math.ceil(this.desiredSwatchCapacity/this.swatchesPerRow)),this.totalSwatches=this.swatchesPerRow*this.textureHeight),this.valuesPerRow=this.swatchesPerRow*this.valuesPerSwatch,this.bytesPerRow=4*this.valuesPerRow,this.totalTexels=this.textureWidth*this.textureHeight,this.totalValues=this.totalTexels*this.dataChannelCount,this.totalBytes=4*this.totalValues,Object.freeze(this)}generateTexelReaderGLSL(e="texelValues",t="dataTexture",r="instanceSwatchUv"){const i=[],n=this.texelsPerSwatch;for(let a=0;a<n;a++){const n=(a%this.texelsPerSwatch+.5)/this.texelsPerSwatch/this.swatchesPerRow,o=(Math.floor(a/this.texelsPerSwatch)+.5)/this.textureHeight;i.push(`${e}[${a}] = texture2D(${t}, ${r} + vec2(${n}, ${o}));`)}return i.join("\n")}generateAttributeDefinesGLSL(e,t="texelValues"){return[...this.attributes.map((r=>{const{attributeName:n}=r,a=(r.components||[""]).map((e=>{const r=this.attributeComponentIndices[`${n}${e}`],a=Math.floor(r/this.dataChannelCount),o=i[r%this.dataChannelCount];return`${t}[${a}].${o}`})).join(", "),o=r.components?`vec${r.components.length}(${a})`:a;return`#define ${e}${n}() ${o}`})),...this.attributes.filter((e=>e.isInterpolable)).map((r=>{const{attributeName:i}=r,n=(r.components||[""]).map((e=>{const r=this.attributeComponentIndices[`${i}${e}Delta`],n=Math.floor(r/this.dataChannelCount),a=["r","g","b","a"][r%this.dataChannelCount];return`${t}[${n}].${a}`})).join(", "),a=r.components?`vec${r.components.length}(${n})`:n;return`#define ${e}${i}Delta() ${a}`}))].join("\n")}generateRebaseFragmentGLSL(e="previousTexelValues",t="targetTexelValues",r="texelIndex",n="rebaseTs"){const a={};for(const r of this.attributes){const{attributeName:o}=r;for(const s of r.components||[""]){const u=`${o}${s}`,l=this.attributeComponentIndices[u],c=Math.floor(l/this.dataChannelCount),f=i[l%this.dataChannelCount],h=`${e}[${c}].${f}`,d=`${t}[${c}].${f}`;if(c in a||(a[c]={}),r.isTimestamp){const e=`${n};`;a[c][f]=e}else if(r.isInterpolable){const t=`${u}Delta`,r=this.attributeComponentIndices[t],o=Math.floor(r/this.dataChannelCount),s=i[r%this.dataChannelCount];o in a||(a[o]={});const l=`${e}[${o}].${s}`;a[c][f]=`computeValueAtTime(${h}, ${l}, ${d}, ${n});`,a[o][s]=`computeDeltaAtTime(${h}, ${l}, ${d}, ${n});`}else a[c][f]=`computeThresholdValue(${h}, ${d}, ${n});`}}const o=[];for(let e=0;e<this.texelsPerSwatch;e++){const t=a[e];o.push(`if (${r} < ${e}.5) {`);for(let e=0;e<this.dataChannelCount;e++){const r=i[e];r in t&&o.push(`  gl_FragColor.${r} = ${t[r]}`)}o.push("  return;"),o.push("}")}return o.join("\n")}generateInstanceSwatchUvValues(){const e=new Float32Array(2*this.totalSwatches);for(let t=0;t<this.textureHeight;t++)for(let r=0;r<this.swatchesPerRow;r++){const i=2*(t*this.swatchesPerRow+r);e[i]=r/this.swatchesPerRow,e[i+1]=t/this.textureHeight}return e}}function o(e,...t){const r=[];for(let i=0;i<t.length;i++)r.push(e[i],`${t[i]}`);return r.push(e[e.length-1]),r.join("")}const s=["float","vec2","vec3","vec4"];function u(){return o`
float range(float x, float y, float a) {
  return (a - x) / (y - x);
}
`}function l(){return o`
float cubicEaseInOut(float t) {
  return t < 0.5 ? 4.0 * t * t * t :
    4.0 * (t - 1.0) * (t - 1.0) * (t - 1.0) + 1.0;
}
`}function c(e="t",t="varyingT"){return s.map((r=>o`
${r} computeCurrentValue(
    ${r} startingValue,
    ${r} startingVelocity,
    ${r} targetValue) {
  ${r} currentValue = mix(startingValue, targetValue, ${t});
  ${r} projectedValue = startingVelocity *
    (targetTransitionTimeMs() - previousTransitionTimeMs());
  return currentValue + projectedValue *
    ${e} * (1. - ${e}) * (1. - ${e}) * (1. - ${e});
}
  `)).join("\n")}function f(){return o`
/**
 * @param positionWorld The position of the sprite in world coords.
 * @param size Size of the sprite in world coordinates.
 * @param positionRelative Offset position relative to vert coords.
 * @param positionPixel Offset position in screen pixels.
 * @param vertCoords Local coordinates for this vertex.
 * @param viewMatrix Matrix to project world coords into view space (pixels).
 */
vec2 computeViewVertexPosition(
    vec2 positionWorld,
    vec2 size,
    vec2 positionRelative,
    vec2 positionPixel,
    vec2 vertCoords,
    mat3 viewMatrix
) {
  vec2 vertexPositionWorld =
    positionWorld + size * (positionRelative + vertCoords);
  vec2 viewVertexPosition =
    (viewMatrix * vec3(vertexPositionWorld, 1.)).xy + positionPixel * 4.;
  return viewVertexPosition;
}
`}function h(){return o`
/**
 *
 * @param sizeWorld Size of the sprite in world coordinates.
 * @param sizePixel Offset size of the sprite in pixels.
 * @param geometricZoom The geometric zoom size modifier.
 * @param viewMatrixScale XY scale (world coords to pixels), and ZW inverse.
 * @param maxSizePixel Maximum allowed size in pixels.
 * @param minSizePixel Minimum allowed size in pixels.
 */
vec2 computeSize(
  vec2 sizeWorld,
  vec2 sizePixel,
  vec2 geometricZoom,
  vec4 viewMatrixScale,
  vec2 maxSizePixel,
  vec2 minSizePixel
) {
  // Combine scale with geometric zoom effect.
  vec2 zoomScale = exp(log(viewMatrixScale.xy) * (1. - geometricZoom));

  // Project the size in world coordinates to pixels to apply min/max.
  vec2 projectedSizePixel = (sizeWorld * zoomScale + sizePixel * 4.);

  // Inital computed size in world coordinates is based on projected pixel size.
  vec2 computedSize = projectedSizePixel * viewMatrixScale.zw;

  // TODO(jimbo): Add border width to size if positioned externally.

  // Compute whether max and min size components are positive, in parallel.
  // XY contains results for max, ZW contains results for min.
  bvec4 isPositive = greaterThan(vec4(maxSizePixel, minSizePixel), vec4(0.));

  // Apply maximums if set.
  bvec2 gtMax = greaterThan(projectedSizePixel, maxSizePixel);
  if (isPositive.x && gtMax.x) {
    computedSize.x = maxSizePixel.x * viewMatrixScale.z;
  }
  if (isPositive.y && gtMax.y) {
    computedSize.y = maxSizePixel.y * viewMatrixScale.w;
  }

  // Apply minimums if set.
  bvec2 ltMin = lessThan(projectedSizePixel, minSizePixel);
  if (isPositive.z && ltMin.x) {
    computedSize.x = minSizePixel.x * viewMatrixScale.z;
  }
  if (isPositive.w && ltMin.y) {
    computedSize.y = minSizePixel.y * viewMatrixScale.w;
  }

  return computedSize;
}
`}function d(){return o`
vec4 computeCurrentSizePixelAndWorld() {
  return computeCurrentValue(
    vec4(
      previousSizePixel(),
      previousSizeWorld()),
    vec4(
      previousSizePixelDelta(),
      previousSizeWorldDelta()),
    vec4(
      targetSizePixel(),
      targetSizeWorld())
  );
}
`}function p(){return o`
vec4 computeCurrentMaxAndMinSizePixel() {
  return computeCurrentValue(
    vec4(
      previousMaxSizePixel(),
      previousMinSizePixel()
    ),
    vec4(
      previousMaxSizePixelDelta(),
      previousMinSizePixelDelta()
    ),
    vec4(
      targetMaxSizePixel(),
      targetMinSizePixel()
    )
  ) * 4.;
}
`}function m(e){return o`
precision lowp float;

/**
 * Current uniform timestamp for interpolating.
 */
uniform float ts;

/**
 * Incremental clip-space Z for stacking sprites based on their instanceIndex.
 * This ensures that partial-opacity pixels of stacked sprites will be
 * alpha-blended. Without this, occluded sprites' pixels may not blend.
 */
uniform float instanceZ;

/**
 * View and projection matrices for converting from world space to clip space.
 */
uniform mat3 viewMatrix;
uniform mat3 projectionMatrix;

/**
 * Scale includes the X and Y dimensions of the viewMatrix, and their inverses
 * in the WZ components.
 */
uniform vec4 viewMatrixScale;

/**
 * Data textures holding the previous and target Sprite instance
 * attributes. The instantaneous value for each attribute is determined by
 * interpolating between the previous and target according to the ts uniform.
 */
uniform sampler2D previousValuesTexture;
uniform sampler2D targetValuesTexture;

/**
 * Per-vertex coordinates for the quad into which the sprite will be rendered.
 * XY contain the local cartesian coordinates for a unit square centered at the
 * origin. The ZW coordinates contain the y-flipped UV coordinates for orienting
 * the square against texture atlases.
 *
 *   vertexCoordinates: [
 *     [-0.5, -0.5, 0, 1],
 *     [0.5, -0.5, 1, 1],
 *     [-0.5, 0.5, 0, 0],
 *     [0.5, 0.5, 1, 0],
 *   ],
 *
 */
attribute vec4 vertexCoordinates;

/**
 * Instanced, per-sprite index and UV coordinates of the sprite's data swatch.
 */
attribute float instanceIndex;
attribute vec2 instanceSwatchUv;

/**
 * Varying time value, eased using cubic-in-out between the previous and target
 * timestamps for this Sprite.
 */
varying float varyingT;

/**
 * Interpolated vertexCoordinates for fragment shader.
 */
varying vec4 varyingVertexCoordinates;

/**
 * Threshold distance values to consider the pixel outside the shape (X) or
 * inside the shape (Y). Values between constitue the borde.
 */
varying vec2 varyingBorderThresholds;

/**
 * Aspect ratio of the sprite's renderable area (XY) and their inverses (ZW).
 * One component of each pair will be 1. For the XY pair, the other component
 * be be greater than 1. and for the inverse pair it will be smaller.
 *
 * For example, a rectangle that's twice as wide as it is tall would have
 * varyingAspectRatio equal to vec4(2., 1., .5, 1.).
 */
varying vec4 varyingAspectRatio;

/**
 * Color attributes used by fragment shader.
 */
varying vec4 varyingBorderColor;
varying vec4 varyingFillColor;

/**
 * Shape attributes used by fragment shader.
 */
varying float varyingPreviousSides;
varying float varyingTargetSides;
varying vec4 varyingPreviousShapeTexture;
varying vec4 varyingTargetShapeTexture;

// Import utility shader functions.
${u()}
${l()}

// These arrays are filled in by code generated by the AttributeMapper.
vec4 previousTexelValues[${e.texelsPerSwatch}];
vec4 targetTexelValues[${e.texelsPerSwatch}];

/**
 * Read data texel values into the previous and target arrays.
 */
void readTexels() {
    ${e.generateTexelReaderGLSL("previousTexelValues","previousValuesTexture","instanceSwatchUv")}
    ${e.generateTexelReaderGLSL("targetTexelValues","targetValuesTexture","instanceSwatchUv")}
}

// Dynamically generate #DEFINE statements to access texel attributes by name.
// These look like method invocations elsewhere in the code. For example, the
// define "targetTransitionTimeMs()" extracts the float value
// targetTexelValues[0].r.
${e.generateAttributeDefinesGLSL("previous","previousTexelValues")}
${e.generateAttributeDefinesGLSL("target","targetTexelValues")}

/**
 * Local, non-eased, normalized time value between 0 and 1, computed between the
 * previous and target timestamp according to the uniform ts.
 */
float t;

${c()}

/**
 * Precomputed constant value for converting colors in the 0-255 RGB range to
 * the GL standard 0-1 range. (1 / 255 = 0.00392156862745098)
 */
const vec4 GL_COLOR = vec4(vec3(0.00392156862745098), 1.);

/**
 * Function to compute all the varying values needed by the fragment shader.
 */
void setupVaryings() {
  // Clamp and range t value within previous and target timestamps.
  t =
    ts >= targetTransitionTimeMs() ? 1. :
    ts <= previousTransitionTimeMs() ? 0. :
    clamp(range(previousTransitionTimeMs(), targetTransitionTimeMs(), ts),
        0., 1.);

  // Compute eased varyingT.
  varyingT = cubicEaseInOut(t);

  // Copy and interpolate vertex coordinate values.
  varyingVertexCoordinates = vertexCoordinates;

  // Copy previous and target shape attributes.
  varyingPreviousSides = previousSides();
  varyingPreviousShapeTexture = previousShapeTexture();
  varyingTargetSides = targetSides();
  varyingTargetShapeTexture = targetShapeTexture();

  // Compute color attributes.
  varyingBorderColor = computeCurrentValue(
    previousBorderColor(),
    previousBorderColorDelta(),
    targetBorderColor()) * GL_COLOR;
  varyingFillColor = computeCurrentValue(
    previousFillColor(),
    previousFillColorDelta(),
    targetFillColor()) * GL_COLOR;
}

${o`
/**
 * @param size The size of the sprite.
 * @return The aspect ratio (XY) and the inverse of the aspect ratio (ZW).
 */
vec4 computeAspectRatio(vec2 size) {
  vec2 ar = size / min(size.x, size.y);
  return vec4(ar, 1. / ar);
}
`}
${p()}
${d()}
${h()}
${f()}

void main () {

  // Read data values from previous and target data textures.
  readTexels();

  // Setup varying values used both here and by the fragment shader.
  setupVaryings();

  // Compute current size component values by interpolation (parallelized).
  vec4 currentSizePixelAndWorld = computeCurrentSizePixelAndWorld();
  vec2 currentSizePixel = currentSizePixelAndWorld.xy;
  vec2 currentSizeWorld = currentSizePixelAndWorld.zw;

  vec2 currentGeometricZoom = computeCurrentValue(
      previousGeometricZoom(),
      previousGeometricZoomDelta(),
      targetGeometricZoom()
  );

  vec4 currentMaxAndMinSizePixel = computeCurrentMaxAndMinSizePixel();
  vec2 currentMaxSizePixel = currentMaxAndMinSizePixel.xy;
  vec2 currentMinSizePixel = currentMaxAndMinSizePixel.zw;

  // Compute the current size of the sprite in world units, including the effect
  // of geometric zoom and applying min and max pixel sizes.
  vec2 computedSize = computeSize(
    currentSizeWorld,
    currentSizePixel,
    currentGeometricZoom,
    viewMatrixScale,
    currentMaxSizePixel,
    currentMinSizePixel
  );

  // Compute border attributes in parallel.
  vec3 borderProperties = computeCurrentValue(
      vec3(
        previousBorderRadiusWorld(),
        previousBorderRadiusPixel(),
        previousBorderPlacement()),
      vec3(
        previousBorderRadiusWorldDelta(),
        previousBorderRadiusPixelDelta(),
        previousBorderPlacementDelta()),
      vec3(
        targetBorderRadiusWorld(),
        targetBorderRadiusPixel(),
        targetBorderPlacement())
  );

  // The fragment shader needs to know the threshold signed distances that
  // indicate whether each pixel is inside the shape, in the boreder, or outside
  // of the shape.
  vec2 projectedSizePixel = computedSize.xy * viewMatrixScale.xy;
  float edgeDistance = borderProperties.x +
    borderProperties.y * 8. / min(projectedSizePixel.x, projectedSizePixel.y);
  varyingBorderThresholds =
    vec2(0., edgeDistance) + mix(0., -edgeDistance, borderProperties.z);

  // Compute the sprite's aspect ratio and the inverse.
  varyingAspectRatio = computeAspectRatio(computedSize);

  // Compute the current position component attributes.
  vec2 currentPositionPixel = computeCurrentValue(
      previousPositionPixel(),
      previousPositionPixelDelta(),
      targetPositionPixel());

  vec2 currentPositionWorld = computeCurrentValue(
      previousPositionWorld(),
      previousPositionWorldDelta(),
      targetPositionWorld());

  vec2 currentPositionRelative = computeCurrentValue(
      previousPositionRelative(),
      previousPositionRelativeDelta(),
      targetPositionRelative());

  // Project the world position into pixel space, then add the pixel component.
  vec2 viewVertexPosition = computeViewVertexPosition(
      currentPositionWorld,
      computedSize,
      currentPositionRelative,
      currentPositionPixel,
      vertexCoordinates.xy,
      viewMatrix
  );

  // Project the pixel space coordinate into clip space.
  vec2 clipVertexPosition =
    (projectionMatrix * vec3(viewVertexPosition, 1.)).xy;

  // Align Z axis clip-space coordinate (perpendicular to screen) with instance
  // index for blending stacked sprites.
  gl_Position = vec4(clipVertexPosition, -instanceIndex * instanceZ, 1.);
}
`}function g(e,t){return o`
precision lowp float;

uniform float ts;

/**
 * Screen pixel coordinates for performing the hit test. The XY channels contain
 * the screen x and y coordinates respectively. The ZW channels hold the width
 * and height of the bounding box of interest. Currently those are ignored.
 */
uniform vec4 hitTestCoordinates;

uniform mat3 viewMatrix;

/**
 * Scale includes the X and Y dimensions of the viewMatrix, and their inverses
 * in the WZ components.
 */
uniform vec4 viewMatrixScale;

uniform sampler2D previousValuesTexture;
uniform sampler2D targetValuesTexture;

attribute vec2 vertexCoordinates;

attribute vec2 instanceSwatchUv;
attribute vec2 instanceHitTestUv;

#define TEXELS_PER_SWATCH ${e.texelsPerSwatch}.
#define TEXTURE_WIDTH ${e.textureWidth}.
#define TEXTURE_HEIGHT ${e.textureHeight}.

// The result of the hit test, written to the data texel by the fragment shader.
varying float varyingHitTestResult;

vec4 previousTexelValues[${t.texelsPerSwatch}];
vec4 targetTexelValues[${t.texelsPerSwatch}];

${t.generateAttributeDefinesGLSL("previous","previousTexelValues")}
${t.generateAttributeDefinesGLSL("target","targetTexelValues")}

float rangeT;
float easeT;

// Import utility shader functions.
${u()}
${l()}
${c("rangeT","easeT")}
${p()}
${d()}
${h()}
${f()}

void readInputTexels() {
${t.generateTexelReaderGLSL("previousTexelValues","previousValuesTexture","instanceSwatchUv")}
${t.generateTexelReaderGLSL("targetTexelValues","targetValuesTexture","instanceSwatchUv")}
}

const vec2 swatchSize =
  vec2(TEXELS_PER_SWATCH / TEXTURE_WIDTH, 1. / TEXTURE_HEIGHT);

void main () {
  readInputTexels();

  // Compute time variables.
  rangeT = clamp(
      range(previousTransitionTimeMs(), targetTransitionTimeMs(), ts),
      0., 1.);
  easeT = cubicEaseInOut(rangeT);

  // Compute current size component values by interpolation (parallelized).
  vec4 currentSizePixelAndWorld = computeCurrentSizePixelAndWorld();
  vec2 currentSizePixel = currentSizePixelAndWorld.xy;
  vec2 currentSizeWorld = currentSizePixelAndWorld.zw;

  vec2 currentGeometricZoom = computeCurrentValue(
      previousGeometricZoom(),
      previousGeometricZoomDelta(),
      targetGeometricZoom()
  );

  vec4 currentMaxAndMinSizePixel = computeCurrentMaxAndMinSizePixel();
  vec2 currentMaxSizePixel = currentMaxAndMinSizePixel.xy;
  vec2 currentMinSizePixel = currentMaxAndMinSizePixel.zw;

  // Compute the current size of the sprite in world units, including the effect
  // of geometric zoom and applying min and max pixel sizes.
  vec2 computedSize = computeSize(
    currentSizeWorld,
    currentSizePixel,
    currentGeometricZoom,
    viewMatrixScale,
    currentMaxSizePixel,
    currentMinSizePixel
  );

  // Compute the current position component attributes.
  vec2 currentPositionPixel = computeCurrentValue(
      previousPositionPixel(),
      previousPositionPixelDelta(),
      targetPositionPixel());

  vec2 currentPositionWorld = computeCurrentValue(
      previousPositionWorld(),
      previousPositionWorldDelta(),
      targetPositionWorld());

  vec2 currentPositionRelative = computeCurrentValue(
      previousPositionRelative(),
      previousPositionRelativeDelta(),
      targetPositionRelative());

  // Project the world position into pixel space for the bottom left and top
  // right corners of the sprite's quad.
  vec2 bottomLeft = computeViewVertexPosition(
      currentPositionWorld,
      computedSize,
      currentPositionRelative,
      currentPositionPixel,
      vec2(-.5, -.5),
      viewMatrix
  ) * .25;
  vec2 topRight = computeViewVertexPosition(
      currentPositionWorld,
      computedSize,
      currentPositionRelative,
      currentPositionPixel,
      vec2(.5, .5),
      viewMatrix
  ) * .25;

  // Test whether the coordinates of interest are within the sprite quad's
  // bounding box.
  // TODO (jimbo): Use ZW components to test for area of interest.
  varyingHitTestResult =
    bottomLeft.x < hitTestCoordinates.x &&
    bottomLeft.y > hitTestCoordinates.y &&
    topRight.x > hitTestCoordinates.x &&
    topRight.y < hitTestCoordinates.y ? 1. : 0.;

  vec2 swatchUv =
    instanceHitTestUv + (vertexCoordinates.xy + .5) * swatchSize;

  // Position the verts to write into the appropriate data texel.
  gl_Position = vec4(2. * swatchUv - 1., 0., 1.);
}
`}function b(e){return o`
precision lowp float;

uniform float ts;

uniform sampler2D previousValuesTexture;
uniform sampler2D targetValuesTexture;

varying float varyingTexelIndex;
varying vec2 varyingRebaseUv;

vec4 previousTexelValues[${e.texelsPerSwatch}];
vec4 targetTexelValues[${e.texelsPerSwatch}];

${e.generateAttributeDefinesGLSL("previous","previousTexelValues")}
${e.generateAttributeDefinesGLSL("target","targetTexelValues")}

// Import utility shader functions.
${u()}
${l()}

float computeValueAtTime(
    float startingValue,
    float startingDelta,
    float targetValue,
    float ts) {
  float rangeT =
    ts >= targetTransitionTimeMs() ? 1. :
    ts <= previousTransitionTimeMs() ? 0. :
    clamp(
        range(previousTransitionTimeMs(), targetTransitionTimeMs(), ts),
        0., 1.);
  float easeT = cubicEaseInOut(rangeT);

  float currentValue = mix(startingValue, targetValue, easeT);
  float projectedValue = startingDelta *
    (targetTransitionTimeMs() - previousTransitionTimeMs());

  return currentValue + projectedValue * rangeT * pow(1. - rangeT, 3.);
}

// DELTA_MS is the duration in milliseconds to use when estimating the
// 'instantaneous' change in a value. INV_DELTA_MS is its inverse.
#define DELTA_MS 1.
#define INV_DELTA_MS 1.

float computeDeltaAtTime(
    float startingValue,
    float startingDelta,
    float targetValue,
    float ts
) {
  if (ts >= targetTransitionTimeMs()) {
    return 0.;
  }
  if (ts <= previousTransitionTimeMs()) {
    return startingDelta;
  }
  return (
      computeValueAtTime(
          startingValue, startingDelta, targetValue, ts + DELTA_MS) -
      computeValueAtTime(
          startingValue, startingDelta, targetValue, ts)
      ) * INV_DELTA_MS;
}

float computeThresholdValue(
    float previousValue,
    float targetValue,
    float rebaseTs
) {
  float mid = mix(previousTransitionTimeMs(), targetTransitionTimeMs(), .5);
  return rebaseTs < mid ? previousValue : targetValue;
}

void readInputTexels() {
${e.generateTexelReaderGLSL("previousTexelValues","previousValuesTexture","varyingRebaseUv")}
${e.generateTexelReaderGLSL("targetTexelValues","targetValuesTexture","varyingRebaseUv")}
}

void setOutputTexel() {
  float rebaseTs = ts;
  ${e.generateRebaseFragmentGLSL("previousTexelValues","targetTexelValues","varyingTexelIndex","rebaseTs")}
}

void main () {
  readInputTexels();
  setOutputTexel();
}
`}function v(e){return o`
precision lowp float;

attribute vec2 vertexCoordinates;

attribute vec2 instanceRebaseUv;

#define TEXELS_PER_SWATCH ${e.texelsPerSwatch}.
#define TEXTURE_WIDTH ${e.textureWidth}.
#define TEXTURE_HEIGHT ${e.textureHeight}.

varying vec2 varyingRebaseUv;
varying float varyingTexelIndex;

const vec2 swatchSize =
  vec2(TEXELS_PER_SWATCH / TEXTURE_WIDTH, 1. / TEXTURE_HEIGHT);

void main () {
  varyingRebaseUv = instanceRebaseUv;
  varyingTexelIndex = (vertexCoordinates.x + .5) * TEXELS_PER_SWATCH - .5;
  vec2 swatchUv = instanceRebaseUv + (vertexCoordinates.xy + .5) * swatchSize;
  gl_Position = vec4(2. * swatchUv - 1., 0., 1.);
}
`}const x=Object.freeze({requestAnimationFrame:window.requestAnimationFrame.bind(window),cancelAnimationFrame:window.cancelAnimationFrame.bind(window),setTimeout:(e,t=0,...r)=>window.setTimeout(e,t,...r),clearTimeout:window.clearTimeout.bind(window),now:Date.now.bind(Date)}),y=1e20;class w{constructor(e=24,t=3,r=8,i=.25,n="sans-serif",a="normal"){this.fontSize=e,this.buffer=t,this.radius=r,this.cutoff=i,this.fontFamily=n,this.fontWeight=a;const o=this.size=this.fontSize+2*this.buffer;this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=o,this.ctx=this.canvas.getContext("2d"),this.ctx.font=this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(o*o),this.gridInner=new Float64Array(o*o),this.f=new Float64Array(o),this.z=new Float64Array(o+1),this.v=new Uint16Array(o),this.middle=Math.round(o/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}draw(e){this.ctx.clearRect(0,0,this.size,this.size),this.ctx.fillText(e,this.buffer,this.middle);const t=this.ctx.getImageData(0,0,this.size,this.size);return function({imgData:e,size:t,radius:r,cutoff:i,gridOuter:n,gridInner:a,f:o,v:s,z:u}){const l=new Uint8ClampedArray(t*t);for(let r=0;r<t*t;r++){const t=e.data[4*r+3]/255;n[r]=1===t?0:0===t?y:Math.pow(Math.max(0,.5-t),2),a[r]=1===t?y:0===t?0:Math.pow(Math.max(0,t-.5),2)}T(n,t,t,o,s,u),T(a,t,t,o,s,u);for(let e=0;e<t*t;e++){const t=Math.sqrt(n[e])-Math.sqrt(a[e]);l[e]=Math.round(255-255*(t/r+i))}return l}(Object.assign(Object.assign({},this),{imgData:t}))}}function T(e,t,r,i,n,a){k(e,t,r,i,n,a),S(e,t,r,i,n,a)}function S(e,t,r,i,n,a){for(let o=0;o<r;o++)A(e,o*t,1,t,i,n,a)}function k(e,t,r,i,n,a){for(let o=0;o<t;o++)A(e,o,t,r,i,n,a)}function A(e,t,r,i,n,a,o){let s,u,l,c;for(a[0]=0,o[0]=-y,o[1]=y,s=0;s<i;s++)n[s]=e[t+s*r];for(s=1,u=0,l=0;s<i;s++){do{c=a[u],l=(n[s]-n[c]+s*s-c*c)/(s-c)/2}while(l<=o[u]&&--u>-1);u++,a[u]=s,o[u]=l,o[u+1]=y}for(s=0,u=0;s<i;s++){for(;o[u+1]<s;)u++;c=a[u],e[t+s*r]=n[c]+(s-c)*(s-c)}}const C=Object.freeze({maxTextureSize:2048,fontSize:32,buffer:Math.ceil(8),radius:32,cutoff:.5,fontFamily:"monospace",fontWeight:"normal"});class P{constructor(e=C){this.glyphToCoordinates=new Map;const t=Object.assign({},C,e||{});this.maxTextureSize=t.maxTextureSize,this.tinySDF=new w(t.fontSize,t.buffer,t.radius,t.cutoff,t.fontFamily,t.fontWeight),this.glyphSize=this.tinySDF.size,this.glyphsPerRow=Math.floor(this.maxTextureSize/this.glyphSize),this.glyphCapacity=this.glyphsPerRow*this.glyphsPerRow,this.textureSize=this.glyphsPerRow*this.glyphSize,this.textureData=new Float32Array(this.textureSize*this.textureSize)}hasGlyph(e){return this.glyphToCoordinates.has(e)}getGlyph(e){return this.glyphToCoordinates.get(e)}addGlyph(e){if(this.hasGlyph(e))return this.getGlyph(e);const t=this.glyphToCoordinates.size;if(t>=this.glyphCapacity)throw new Error("Cannot add glyph, already at capacity.");const r=Math.floor(t/this.glyphsPerRow),i=t%this.glyphsPerRow,n=r*this.glyphSize*this.textureSize+i*this.glyphSize,{canvas:a,ctx:o,size:s,buffer:u,middle:l,radius:c,cutoff:f}=this.tinySDF;o.clearRect(0,0,s,s),o.fillText(e,u,l);const h=function(e,t,r=.5){const{width:i,height:n}=e,a=e.getContext("2d").getImageData(0,0,i,n),o=new Float64Array(i*n),s=new Float64Array(i*n),u=new Float64Array(i*n),l=new Float64Array(i*n),c=new Float64Array(i*n),f=new Float64Array(i*n),h=new Float64Array(i),d=new Float64Array(i+1),p=new Uint16Array(i);for(let e=0;e<i*n;e++){const t=a.data[4*e+3]/255;c[e]=u[e]=o[e]=1===t?0:0===t?y:Math.pow(Math.max(0,.5-t),2),f[e]=l[e]=s[e]=1===t?y:0===t?0:Math.pow(Math.max(0,t-.5),2)}T(c,i,n,h,p,d),T(f,i,n,h,p,d),S(o,i,n,h,p,d),S(s,i,n,h,p,d),k(u,i,n,h,p,d),k(l,i,n,h,p,d);const m=new Float32Array(i*n*3);for(let e=0;e<i*n;e++)m[3*e]=Math.max(0,1-((Math.sqrt(o[e])-Math.sqrt(s[e]))/t+r)),m[3*e+1]=Math.max(0,1-((Math.sqrt(u[e])-Math.sqrt(l[e]))/t+r)),m[3*e+2]=1-((Math.sqrt(c[e])-Math.sqrt(f[e]))/t+r);return m}(a,c,f);for(let e=0;e<this.glyphSize;e++)for(let t=0;t<this.glyphSize;t++){const r=3*(e*this.glyphSize+t)+2,i=n+e*this.textureSize+t;this.textureData[i]=h[r]}const d={u:i/this.glyphsPerRow,v:r/this.glyphsPerRow,width:this.glyphSize/this.textureSize,height:this.glyphSize/this.textureSize};return this.glyphToCoordinates.set(e,d),d}get glyphs(){return[...this.glyphToCoordinates.keys()]}}const R=Object.freeze({container:document.body,defaultTransitionTimeMs:250,glyphs:"!\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}",desiredSpriteCapacity:1e6,timingFunctions:x,glyphMapper:C});class E{constructor(e){this.coordinator=e,this.xValue=0,this.yValue=0}get x(){return this.xValue}set x(e){this.xValue=e,this.coordinator.queueDraw()}get y(){return this.yValue}set y(e){this.yValue=e,this.coordinator.queueDraw()}}const z=Symbol("internalProperties"),D=Symbol("dataView"),_=Symbol("sceneInternal");class M{constructor(e){this[D]=e}get TransitionTimeMs(){return this[D][0]}set TransitionTimeMs(e){if(isNaN(e))throw new RangeError("TransitionTimeMs cannot be NaN.");this[D][0]=e}get PositionWorldX(){return this[D][1]}set PositionWorldX(e){if(isNaN(e))throw new RangeError("PositionWorldX cannot be NaN.");this[D][1]=e}get PositionWorldY(){return this[D][2]}set PositionWorldY(e){if(isNaN(e))throw new RangeError("PositionWorldY cannot be NaN.");this[D][2]=e}get SizeWorldWidth(){return this[D][3]}set SizeWorldWidth(e){if(isNaN(e))throw new RangeError("SizeWorldWidth cannot be NaN.");this[D][3]=e}get SizeWorldHeight(){return this[D][4]}set SizeWorldHeight(e){if(isNaN(e))throw new RangeError("SizeWorldHeight cannot be NaN.");this[D][4]=e}get GeometricZoomX(){return this[D][5]}set GeometricZoomX(e){if(isNaN(e))throw new RangeError("GeometricZoomX cannot be NaN.");this[D][5]=e}get GeometricZoomY(){return this[D][6]}set GeometricZoomY(e){if(isNaN(e))throw new RangeError("GeometricZoomY cannot be NaN.");this[D][6]=e}get PositionPixelX(){return this[D][7]}set PositionPixelX(e){if(isNaN(e))throw new RangeError("PositionPixelX cannot be NaN.");this[D][7]=e}get PositionPixelY(){return this[D][8]}set PositionPixelY(e){if(isNaN(e))throw new RangeError("PositionPixelY cannot be NaN.");this[D][8]=e}get SizePixelWidth(){return this[D][9]}set SizePixelWidth(e){if(isNaN(e))throw new RangeError("SizePixelWidth cannot be NaN.");this[D][9]=e}get SizePixelHeight(){return this[D][10]}set SizePixelHeight(e){if(isNaN(e))throw new RangeError("SizePixelHeight cannot be NaN.");this[D][10]=e}get MaxSizePixelWidth(){return this[D][11]}set MaxSizePixelWidth(e){if(isNaN(e))throw new RangeError("MaxSizePixelWidth cannot be NaN.");this[D][11]=e}get MaxSizePixelHeight(){return this[D][12]}set MaxSizePixelHeight(e){if(isNaN(e))throw new RangeError("MaxSizePixelHeight cannot be NaN.");this[D][12]=e}get MinSizePixelWidth(){return this[D][13]}set MinSizePixelWidth(e){if(isNaN(e))throw new RangeError("MinSizePixelWidth cannot be NaN.");this[D][13]=e}get MinSizePixelHeight(){return this[D][14]}set MinSizePixelHeight(e){if(isNaN(e))throw new RangeError("MinSizePixelHeight cannot be NaN.");this[D][14]=e}get PositionRelativeX(){return this[D][15]}set PositionRelativeX(e){if(isNaN(e))throw new RangeError("PositionRelativeX cannot be NaN.");this[D][15]=e}get PositionRelativeY(){return this[D][16]}set PositionRelativeY(e){if(isNaN(e))throw new RangeError("PositionRelativeY cannot be NaN.");this[D][16]=e}get Sides(){return this[D][17]}set Sides(e){if(isNaN(e))throw new RangeError("Sides cannot be NaN.");this[D][17]=e}get ShapeTextureU(){return this[D][18]}set ShapeTextureU(e){if(isNaN(e))throw new RangeError("ShapeTextureU cannot be NaN.");this[D][18]=e}get ShapeTextureV(){return this[D][19]}set ShapeTextureV(e){if(isNaN(e))throw new RangeError("ShapeTextureV cannot be NaN.");this[D][19]=e}get ShapeTextureWidth(){return this[D][20]}set ShapeTextureWidth(e){if(isNaN(e))throw new RangeError("ShapeTextureWidth cannot be NaN.");this[D][20]=e}get ShapeTextureHeight(){return this[D][21]}set ShapeTextureHeight(e){if(isNaN(e))throw new RangeError("ShapeTextureHeight cannot be NaN.");this[D][21]=e}get BorderRadiusWorld(){return this[D][22]}set BorderRadiusWorld(e){if(isNaN(e))throw new RangeError("BorderRadiusWorld cannot be NaN.");this[D][22]=e}get BorderRadiusPixel(){return this[D][23]}set BorderRadiusPixel(e){if(isNaN(e))throw new RangeError("BorderRadiusPixel cannot be NaN.");this[D][23]=e}get BorderPlacement(){return this[D][24]}set BorderPlacement(e){if(isNaN(e))throw new RangeError("BorderPlacement cannot be NaN.");this[D][24]=e}get BorderColorR(){return this[D][25]}set BorderColorR(e){if(isNaN(e))throw new RangeError("BorderColorR cannot be NaN.");this[D][25]=e}get BorderColorG(){return this[D][26]}set BorderColorG(e){if(isNaN(e))throw new RangeError("BorderColorG cannot be NaN.");this[D][26]=e}get BorderColorB(){return this[D][27]}set BorderColorB(e){if(isNaN(e))throw new RangeError("BorderColorB cannot be NaN.");this[D][27]=e}get BorderColorOpacity(){return this[D][28]}set BorderColorOpacity(e){if(isNaN(e))throw new RangeError("BorderColorOpacity cannot be NaN.");this[D][28]=e}get FillBlend(){return this[D][29]}set FillBlend(e){if(isNaN(e))throw new RangeError("FillBlend cannot be NaN.");this[D][29]=e}get FillColorR(){return this[D][30]}set FillColorR(e){if(isNaN(e))throw new RangeError("FillColorR cannot be NaN.");this[D][30]=e}get FillColorG(){return this[D][31]}set FillColorG(e){if(isNaN(e))throw new RangeError("FillColorG cannot be NaN.");this[D][31]=e}get FillColorB(){return this[D][32]}set FillColorB(e){if(isNaN(e))throw new RangeError("FillColorB cannot be NaN.");this[D][32]=e}get FillColorOpacity(){return this[D][33]}set FillColorOpacity(e){if(isNaN(e))throw new RangeError("FillColorOpacity cannot be NaN.");this[D][33]=e}get FillTextureU(){return this[D][34]}set FillTextureU(e){if(isNaN(e))throw new RangeError("FillTextureU cannot be NaN.");this[D][34]=e}get FillTextureV(){return this[D][35]}set FillTextureV(e){if(isNaN(e))throw new RangeError("FillTextureV cannot be NaN.");this[D][35]=e}get FillTextureWidth(){return this[D][36]}set FillTextureWidth(e){if(isNaN(e))throw new RangeError("FillTextureWidth cannot be NaN.");this[D][36]=e}get FillTextureHeight(){return this[D][37]}set FillTextureHeight(e){if(isNaN(e))throw new RangeError("FillTextureHeight cannot be NaN.");this[D][37]=e}set PositionWorld(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.PositionWorldX=e[0],t=!0),"1"in e&&(this.PositionWorldY=e[1],t=!0),!t)throw new TypeError("No PositionWorld component index values were found.")}else{if("object"!=typeof e)throw new TypeError("Argument must be an array or object.");{let t=!1;if("x"in e&&(this.PositionWorldX=e.x,t=!0),"y"in e&&(this.PositionWorldY=e.y,t=!0),!t)throw new TypeError("No PositionWorld component key values were found.")}}}set SizeWorld(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.SizeWorldWidth=e[0],t=!0),"1"in e&&(this.SizeWorldHeight=e[1],t=!0),!t)throw new TypeError("No SizeWorld component index values were found.")}else if("object"!=typeof e)this.SizeWorldWidth=e,this.SizeWorldHeight=e;else{let t=!1;if("width"in e&&(this.SizeWorldWidth=e.width,t=!0),"height"in e&&(this.SizeWorldHeight=e.height,t=!0),!t)throw new TypeError("No SizeWorld component key values were found.")}}set GeometricZoom(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.GeometricZoomX=e[0],t=!0),"1"in e&&(this.GeometricZoomY=e[1],t=!0),!t)throw new TypeError("No GeometricZoom component index values were found.")}else if("object"!=typeof e)this.GeometricZoomX=e,this.GeometricZoomY=e;else{let t=!1;if("x"in e&&(this.GeometricZoomX=e.x,t=!0),"y"in e&&(this.GeometricZoomY=e.y,t=!0),!t)throw new TypeError("No GeometricZoom component key values were found.")}}set PositionPixel(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.PositionPixelX=e[0],t=!0),"1"in e&&(this.PositionPixelY=e[1],t=!0),!t)throw new TypeError("No PositionPixel component index values were found.")}else{if("object"!=typeof e)throw new TypeError("Argument must be an array or object.");{let t=!1;if("x"in e&&(this.PositionPixelX=e.x,t=!0),"y"in e&&(this.PositionPixelY=e.y,t=!0),!t)throw new TypeError("No PositionPixel component key values were found.")}}}set SizePixel(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.SizePixelWidth=e[0],t=!0),"1"in e&&(this.SizePixelHeight=e[1],t=!0),!t)throw new TypeError("No SizePixel component index values were found.")}else if("object"!=typeof e)this.SizePixelWidth=e,this.SizePixelHeight=e;else{let t=!1;if("width"in e&&(this.SizePixelWidth=e.width,t=!0),"height"in e&&(this.SizePixelHeight=e.height,t=!0),!t)throw new TypeError("No SizePixel component key values were found.")}}set MaxSizePixel(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.MaxSizePixelWidth=e[0],t=!0),"1"in e&&(this.MaxSizePixelHeight=e[1],t=!0),!t)throw new TypeError("No MaxSizePixel component index values were found.")}else if("object"!=typeof e)this.MaxSizePixelWidth=e,this.MaxSizePixelHeight=e;else{let t=!1;if("width"in e&&(this.MaxSizePixelWidth=e.width,t=!0),"height"in e&&(this.MaxSizePixelHeight=e.height,t=!0),!t)throw new TypeError("No MaxSizePixel component key values were found.")}}set MinSizePixel(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.MinSizePixelWidth=e[0],t=!0),"1"in e&&(this.MinSizePixelHeight=e[1],t=!0),!t)throw new TypeError("No MinSizePixel component index values were found.")}else if("object"!=typeof e)this.MinSizePixelWidth=e,this.MinSizePixelHeight=e;else{let t=!1;if("width"in e&&(this.MinSizePixelWidth=e.width,t=!0),"height"in e&&(this.MinSizePixelHeight=e.height,t=!0),!t)throw new TypeError("No MinSizePixel component key values were found.")}}set PositionRelative(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.PositionRelativeX=e[0],t=!0),"1"in e&&(this.PositionRelativeY=e[1],t=!0),!t)throw new TypeError("No PositionRelative component index values were found.")}else{if("object"!=typeof e)throw new TypeError("Argument must be an array or object.");{let t=!1;if("x"in e&&(this.PositionRelativeX=e.x,t=!0),"y"in e&&(this.PositionRelativeY=e.y,t=!0),!t)throw new TypeError("No PositionRelative component key values were found.")}}}set ShapeTexture(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.ShapeTextureU=e[0],t=!0),"1"in e&&(this.ShapeTextureV=e[1],t=!0),"2"in e&&(this.ShapeTextureWidth=e[2],t=!0),"3"in e&&(this.ShapeTextureHeight=e[3],t=!0),!t)throw new TypeError("No ShapeTexture component index values were found.")}else{if("object"!=typeof e)throw new TypeError("Argument must be an array or object.");{let t=!1;if("u"in e&&(this.ShapeTextureU=e.u,t=!0),"v"in e&&(this.ShapeTextureV=e.v,t=!0),"width"in e&&(this.ShapeTextureWidth=e.width,t=!0),"height"in e&&(this.ShapeTextureHeight=e.height,t=!0),!t)throw new TypeError("No ShapeTexture component key values were found.")}}}set BorderColor(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.BorderColorR=e[0],t=!0),"1"in e&&(this.BorderColorG=e[1],t=!0),"2"in e&&(this.BorderColorB=e[2],t=!0),"3"in e&&(this.BorderColorOpacity=e[3],t=!0),!t)throw new TypeError("No BorderColor component index values were found.")}else{if("object"!=typeof e)throw new TypeError("Argument must be an array or object.");{let t=!1;if("r"in e&&(this.BorderColorR=e.r,t=!0),"g"in e&&(this.BorderColorG=e.g,t=!0),"b"in e&&(this.BorderColorB=e.b,t=!0),"opacity"in e&&(this.BorderColorOpacity=e.opacity,t=!0),!t)throw new TypeError("No BorderColor component key values were found.")}}}set FillColor(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.FillColorR=e[0],t=!0),"1"in e&&(this.FillColorG=e[1],t=!0),"2"in e&&(this.FillColorB=e[2],t=!0),"3"in e&&(this.FillColorOpacity=e[3],t=!0),!t)throw new TypeError("No FillColor component index values were found.")}else{if("object"!=typeof e)throw new TypeError("Argument must be an array or object.");{let t=!1;if("r"in e&&(this.FillColorR=e.r,t=!0),"g"in e&&(this.FillColorG=e.g,t=!0),"b"in e&&(this.FillColorB=e.b,t=!0),"opacity"in e&&(this.FillColorOpacity=e.opacity,t=!0),!t)throw new TypeError("No FillColor component key values were found.")}}}set FillTexture(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.FillTextureU=e[0],t=!0),"1"in e&&(this.FillTextureV=e[1],t=!0),"2"in e&&(this.FillTextureWidth=e[2],t=!0),"3"in e&&(this.FillTextureHeight=e[3],t=!0),!t)throw new TypeError("No FillTexture component index values were found.")}else{if("object"!=typeof e)throw new TypeError("Argument must be an array or object.");{let t=!1;if("u"in e&&(this.FillTextureU=e.u,t=!0),"v"in e&&(this.FillTextureV=e.v,t=!0),"width"in e&&(this.FillTextureWidth=e.width,t=!0),"height"in e&&(this.FillTextureHeight=e.height,t=!0),!t)throw new TypeError("No FillTexture component key values were found.")}}}}var V;function N(e,t){return e===t?NaN:1<<5*e+t-+(t>e)}!function(e){e[e.Created=0]="Created",e[e.Rest=1]="Rest",e[e.HasCallback=2]="HasCallback",e[e.NeedsRebase=3]="NeedsRebase",e[e.NeedsTextureSync=4]="NeedsTextureSync",e[e.Removed=5]="Removed"}(V||(V={}));const I=function(){const{Created:e,Rest:t,HasCallback:r,NeedsRebase:i,NeedsTextureSync:n,Removed:a}=V;let o=0;return o|=N(e,t),o|=N(e,a),o|=N(t,r),o|=N(t,n),o|=N(r,i),o|=N(r,n),o|=N(i,n),o|=N(n,t),o|=N(n,r),o|=N(n,a),o}();class B{constructor(){this.isDefined=!1,this.lowBound=NaN,this.highBound=NaN}clear(){this.isDefined=!1,this.lowBound=NaN,this.highBound=NaN}expandToInclude(e){if(!this.isDefined)return this.lowBound=e,this.highBound=e,void(this.isDefined=!0);e<this.lowBound&&(this.lowBound=e),e>this.highBound&&(this.highBound=e)}truncateToWithin(e,t){if(isNaN(+e)||isNaN(+t))throw new Error("Both values must be numbers");if(t<e)throw new Error("High bound must be greater than or equal to low bound.");this.isDefined&&(e>this.highBound||t<this.lowBound?this.clear():(this.lowBound<e&&(this.lowBound=e),this.highBound>t&&(this.highBound=t)))}overlaps(e){return this.isDefined&&e.isDefined&&this.lowBound<=e.highBound&&this.highBound>=e.lowBound}}class O{constructor(e,t,r){this.stepsBetweenChecks=e,this.renderer=t,this.workScheduler=r,this.sprites=[],this.boundData=[]}onBind(e){return this.bindCallback=e,this}onInit(e){return this.initCallback=e,this}onEnter(e){return this.enterCallback=e,this}onUpdate(e){return this.updateCallback=e,this}onExit(e){return this.exitCallback=e,this}bind(e){let t=0;const r=e.length;let i=this.boundData.length;const n=n=>{for(;i<r;){t++;const r=i++,a=e[r],o=this.renderer.createSprite();this.boundData[r]=a,this.sprites[r]=o;const{initCallback:s,enterCallback:u,bindCallback:l}=this;if((s||l)&&o.enter((e=>{l&&l(e,a),s&&s(e,a),e.TransitionTimeMs=0})),(u||l)&&o.update((e=>{l&&l(e,a),u&&u(e,a)})),t%this.stepsBetweenChecks==0&&n()<=0)break}return i>=r};let a=0;const o=Math.min(r,this.boundData.length),s=r=>{for(;a<o;){t++;const i=a++,n=e[i],o=this.sprites[i];this.boundData[i]=n;const{updateCallback:s,bindCallback:u}=this;if((s||u)&&o.update((e=>{u&&u(e,n),s&&s(e,n)})),t%this.stepsBetweenChecks==0&&r()<=0)break}return a>=o},u=e=>{let i=r;for(;i<this.boundData.length;){t++;const r=this.boundData[i],n=this.sprites[i];if(i++,n.isAbandoned||n.isActive||n.isRemoved){const{exitCallback:e,bindCallback:t}=this;(e||t)&&n.exit((i=>{t&&t(i,r),e&&e(i,r)}))}else n.abandon();if(t%this.stepsBetweenChecks==0&&e()<=0)break}return i>r&&(this.boundData.splice(r,i-r),this.sprites.splice(r,i-r)),this.boundData.length<=r},l={id:this,callback:e=>(t=0,u(e)&&s(e)&&n(e)),runUntilDone:!0};return this.workScheduler.scheduleUniqueTask(l),this}}class F{constructor(){this.internalLifecyclePhase=V.Created}get hasCallback(){return!!(this.enterCallback||this.updateCallback||this.exitCallback)}get lifecyclePhase(){return this.internalLifecyclePhase}set lifecyclePhase(e){!function(e,t){if(!(N(e,t)&I))throw new Error("Illegal sprite lifecycle phase transition.")}(this.internalLifecyclePhase,e),this.internalLifecyclePhase=e}}class j{constructor(e){this.coordinator=e,this[z]=new F}enter(e){if(this.isAbandoned)throw new Error("Cannot add enter callback to abondend sprite.");if(this.isRemoved)throw new Error("Cannot add enter callback to Removed sprite.");const t=this[z];return t.enterCallback=e,t.lifecyclePhase===V.Rest&&(this.coordinator.markSpriteCallback(t.index),t.lifecyclePhase=V.HasCallback),this}update(e){if(this.isAbandoned)throw new Error("Cannot add update callback to abandoned sprite.");if(this.isRemoved)throw new Error("Cannot add update callback to Removed sprite.");const t=this[z];return t.updateCallback=e,t.lifecyclePhase===V.Rest&&(this.coordinator.markSpriteCallback(t.index),t.lifecyclePhase=V.HasCallback),this}exit(e){if(this.isAbandoned)throw new Error("Cannot add exit callback to abandoned sprite.");if(this.isRemoved)throw new Error("Cannot add exit callback to Removed sprite.");const t=this[z];return t.exitCallback=e,t.toBeRemoved=!0,t.lifecyclePhase===V.Rest&&(this.coordinator.markSpriteCallback(t.index),t.lifecyclePhase=V.HasCallback),this}abandon(){if(this.isAbandoned)throw new Error("Cannot abandon a Sprite already marked abandoned.");if(this.isRemoved)throw new Error("Cannot abandon a Sprite that has been removed.");if(this.isActive)throw new Error("Cannot abandon an active Sprite.");const e=this[z];e.isAbandoned=!0,e.enterCallback=void 0,e.updateCallback=void 0,e.exitCallback=void 0,e.toBeRemoved=!0,e.lifecyclePhase=V.Removed}get isActive(){const e=this[z].lifecyclePhase;return e!==V.Created&&e!==V.Removed}get isAbandoned(){return!!this[z].isAbandoned}get isRemoved(){return this[z].lifecyclePhase===V.Removed}}function W(e,t){const r=new B;if(!e.isDefined)return r;const{lowBound:i,highBound:n}=e,a=Math.floor(i/t),o=Math.floor(n/t)+1;return r.expandToInclude(a*t),r.expandToInclude(o*t-1),r}const L="center",H="middle";class U{constructor(e,t,r,i){this.stepsBetweenChecks=e,this.renderer=t,this.workScheduler=r,this.glyphMapper=i,this.selections=[],this.boundData=[],this.textCallback=e=>`${e}`,this.alignCallback=()=>L,this.verticalAlignCallback=()=>H}text(e){return this.textCallback=e,this}align(e){return this.alignCallback=e,this}verticalAlign(e){return this.verticalAlignCallback=e,this}onBind(e){return this.bindCallback=e,this}onInit(e){return this.initCallback=e,this}onEnter(e){return this.enterCallback=e,this}onUpdate(e){return this.updateCallback=e,this}onExit(e){return this.exitCallback=e,this}datumToGlyphs(e){const t=(this.textCallback?this.textCallback.call(e,e):`${e}`).trim(),r=this.alignCallback&&this.alignCallback(e)||L,i=this.verticalAlignCallback&&this.verticalAlignCallback(e)||H,n=[];for(let a=0;a<t.length;a++){let o,s;o="left"===r?.5*(a+1):"right"===r?.5*(a+1-t.length):.5*(a+.75-.5*t.length),s="top"===i?-.5:"bottom"===i?.5:0;const u=this.glyphMapper.getGlyph(t.charAt(a));u&&n.push({datum:e,coords:u,position:{x:o,y:s}})}return n}bind(e){let t=0;const r=e.length;let i=this.boundData.length;const n=n=>{for(;i<r;){t++;const r=i++,a=e[r],o=this.renderer.createSelection();if(this.boundData.push(a),this.selections.push(o),o.onInit(((e,t)=>{this.initCallback&&this.initCallback(e,t.datum)})),o.onEnter(((e,t)=>{this.enterCallback&&this.enterCallback(e,t.datum)})),o.onUpdate(((e,t)=>{this.updateCallback&&this.updateCallback(e,t.datum)})),o.onExit(((e,t)=>{this.exitCallback&&this.exitCallback(e,t.datum)})),o.onBind(((e,t)=>{e.Sides=0,e.ShapeTexture=t.coords,e.PositionRelative=t.position,this.bindCallback&&this.bindCallback(e,t.datum)})),o.bind(this.datumToGlyphs(a)),t%this.stepsBetweenChecks==0&&n()<=0)return!1}return i>=r};let a=0;const o=Math.min(r,this.boundData.length),s=r=>{for(;a<o;){t++;const i=a++,n=e[i],o=this.selections[i];if(this.boundData[i]=n,o.bind(this.datumToGlyphs(n)),t%this.stepsBetweenChecks==0&&r()<=0)return!1}return a>=o},u=e=>{for(;r<this.boundData.length;){t++,this.boundData.pop();if(this.selections.pop().bind([]),t%this.stepsBetweenChecks==0&&e()<=0)return!1}return r>=this.boundData.length},l={id:this,callback:e=>(t=0,u(e)&&s(e)&&n(e)),runUntilDone:!0};return this.workScheduler.scheduleUniqueTask(l),this}}function $(e){return!(!e||!(e instanceof Function||e.callback instanceof Function))}function G(e){if(!$(e))throw new Error("Provided object was not a work task or function.");return e instanceof Function?e:void 0!==e.id?e.id:e.callback}function q(e){if(!$(e))throw new Error("Provided object was not a work task or function.");return e instanceof Function?{callback:e,id:e}:void 0!==e.id?e:Object.assign(Object.assign({},e),{id:e.callback})}class X{constructor(){this.idSet=new Set,this.taskList=[]}get length(){return this.taskList.length}hasTaskId(e){return this.idSet.has(e)}hasTask(e){return this.hasTaskId(G(e))}getTaskById(e){if(!this.hasTaskId(e))return;const t=this.findTaskIndexById(e);if(-1===t)throw new Error("Could not find matching task in task list.");return this.taskList[t]}enqueueTask(e){if(this.hasTask(e))return;const t=q(e);this.idSet.add(t.id),this.taskList.push(t)}dequeueTask(){if(!this.length)throw new Error("No tasks remain to dequeue.");const e=this.taskList.shift();return this.idSet.delete(e.id),e}removeTaskById(e){if(!this.hasTaskId(e))return;const t=this.findTaskIndexById(e);if(-1===t)throw new Error("Could not find matching task in task list.");const[r]=this.taskList.splice(t,1);return this.idSet.delete(r.id),r}removeTask(e){return this.removeTaskById(G(e))}findTaskIndexById(e){let t=-1;for(let r=0;r<this.taskList.length;r++)if(this.taskList[r].id===e){if(-1!==t)throw new Error("Duplicate task found in task list.");t=r}return t}}const Y=function*(){}.constructor,Z=Object.freeze({timingFunctions:x,maxWorkTimeMs:20,timeoutMs:0});class Q{constructor(e=Z){this.isEnabled=!1,this.isPerformingWork=!1,this.isPerformingAnimationFrameWork=!1,this.isPerformingTimoutWork=!1,this.presentWorkQueue=new X,this.futureWorkQueue=new X;const t=Object.assign({},Z,e||{});this.timingFunctions=Object.freeze(Object.assign({},x,t&&t.timingFunctions||{})),this.maxWorkTimeMs=t.maxWorkTimeMs,this.timeoutMs=t.timeoutMs,this.enable()}scheduleTask(e){const t=q(e);return this.presentWorkQueue.hasTask(t)||this.futureWorkQueue.hasTask(t)||(this.isPerformingWork&&!t.beginImmediately?this.futureWorkQueue.enqueueTask(t):this.presentWorkQueue.enqueueTask(t)),this.updateTimers(),t}getTask(e){const t=G(e),r=this.presentWorkQueue.getTaskById(t),i=this.futureWorkQueue.getTaskById(t);if(r&&i)throw new Error("Found two matching tasks when at most one is allowed.");return r||i||void 0}unscheduleTask(e){const t=G(e),r=this.presentWorkQueue.removeTaskById(t),i=this.futureWorkQueue.removeTaskById(t);if(r&&i)throw new Error("Found two matching tasks when at most one is allowed.");return this.updateTimers(),r||i||void 0}isScheduledTask(e){return this.isScheduledId(G(e))}isScheduledId(e){return this.presentWorkQueue.hasTaskId(e)||this.futureWorkQueue.hasTaskId(e)}scheduleUniqueTask(e){const t=q(e);return this.unscheduleTask(t),this.scheduleTask(t),t}enable(){return this.isEnabled=!0,this.updateTimers(),this}disable(){return this.isEnabled=!1,this.updateTimers(),this}updateTimers(){const{requestAnimationFrame:e,cancelAnimationFrame:t,setTimeout:r,clearTimeout:i}=this.timingFunctions;if(!this.isEnabled||!this.presentWorkQueue.length&&!this.futureWorkQueue.length)return void 0!==this.animationFrameTimer&&(t(this.animationFrameTimer),this.animationFrameTimer=void 0),void(void 0!==this.timeoutTimer&&(i(this.timeoutTimer),this.timeoutTimer=void 0));if(void 0===this.animationFrameTimer){const t=()=>{this.isEnabled?(this.animationFrameTimer=e(t),this.performAnimationFrameWork()):this.animationFrameTimer=void 0};this.animationFrameTimer=e(t)}if(void 0===this.timeoutTimer){const e=()=>{this.isEnabled?(this.timeoutTimer=r(e,this.timeoutMs),this.performTimeoutWork()):this.timeoutTimer=void 0};this.timeoutTimer=r(e,this.timeoutMs)}}performWork(){if(this.isPerformingWork)throw new Error("Only one invocation of performWork is allowed at a time.");this.isPerformingWork=!0;const{now:e}=this.timingFunctions;let t=0;try{const r=e(),i=()=>this.maxWorkTimeMs+r-e();for(;this.presentWorkQueue.length&&!(t>0&&i()<=0);){let e=this.presentWorkQueue.dequeueTask();if(!this.isPerformingAnimationFrameWork&&(void 0===e.animationOnly||e.animationOnly)){this.futureWorkQueue.enqueueTask(e);continue}if(t++,!e.iterator){const t=e.callback.call(null,i);if(e.callback.constructor!==Y){if(!e.runUntilDone||t)continue;let r=t;for(;!r&&i()>0;)r=e.callback.call(null,i);r||this.futureWorkQueue.enqueueTask(e);continue}if(!(t&&"object"==typeof t&&null!==t&&t.constructor instanceof Function&&t.constructor.constructor===Y))throw new Error("Generator function did not return an iterator.");const r=t;e=Object.freeze(Object.assign(Object.assign({},e),{iterator:r}))}let r=!1;for(;!(r||(r=e.iterator.next().done,i()<=0)););r||this.futureWorkQueue.enqueueTask(e)}}finally{this.isPerformingWork=!1}for(;this.futureWorkQueue.length;){const e=this.futureWorkQueue.dequeueTask();this.scheduleTask(e)}}performAnimationFrameWork(){if(this.isPerformingAnimationFrameWork)throw new Error("Only one invocation of performAnimationFrameWork at a time.");this.isPerformingAnimationFrameWork=!0;try{this.performWork()}finally{this.isPerformingAnimationFrameWork=!1}}performTimeoutWork(){if(this.isPerformingTimoutWork)throw new Error("Only one invocation of performTimoutWork at a time.");this.isPerformingTimoutWork=!0;try{this.performWork()}finally{this.isPerformingTimoutWork=!1}}}const K=500;class J{constructor(e={}){this.scale=new E(this),this.offset=new E(this),this.sprites=[],this.waitingSprites=[],this.instanceCount=0,this.callbacksIndexRange=new B,this.needsTextureSyncIndexRange=new B,this.needsRebaseIndexRange=new B,this.toBeRemovedIndexRange=new B,this.toBeRemovedTsRange=new B,this.removedIndexRange=new B,this.toDrawTsRange=new B,this.drawTaskId=Symbol("drawTask"),this.textureSyncTaskId=Symbol("textureSyncTask"),this.rebaseCount=0,this.runRemovalTaskId=Symbol("runRemovalTaskId"),this.runAssignWaitingTaskId=Symbol("runAssignWaitingTask"),this.rebaseTaskId=Symbol("rebaseTask"),this.runCallbacksTaskId=Symbol("runCallbacksTask"),this.hitTestTaskId=Symbol("hitTestTask"),this.hitTestParameters={x:0,y:0,width:0,height:0,inclusive:!0};const t=Object.assign({},R,e||{}),i=Object.assign({},R.timingFunctions,t.timingFunctions||{}),{now:n}=i;this.basisTs=n(),this.elapsedTimeMs=()=>n()-this.basisTs,this.workScheduler=new Q({timingFunctions:i}),this.container=t.container,this.defaultTransitionTimeMs=t.defaultTransitionTimeMs;const s=new Set(Array.from(this.container.children)),l=window,c=l.REGL||l.createREGL||r;if(!c)throw new Error("Could not find REGL.");const f=this.regl=c({container:this.container,extensions:["angle_instanced_arrays","EXT_blend_minmax","OES_texture_float","OES_texture_float_linear"]}),h=Array.from(this.container.children).filter((e=>e instanceof HTMLCanvasElement&&!s.has(e)));if(!h.length)throw new Error("Container is missing an inserted canvas.");this.canvas=h[0];const{width:d,height:p}=this.canvas.getBoundingClientRect(),x=Math.min(d,p)||Math.max(d,p)||Math.min(window.innerWidth,window.innerHeight);this.scale.x=x,this.scale.y=x,this.offset.x=d/2,this.offset.y=p/2;const y=this.attributeMapper=new a({maxTextureSize:f.limits.maxTextureSize,desiredSwatchCapacity:t.desiredSpriteCapacity,dataChannelCount:4});this.previousValuesFramebuffer=f.framebuffer({color:f.texture({width:y.textureWidth,height:y.textureHeight,channels:y.dataChannelCount,type:"float32",mag:"nearest",min:"nearest"}),depthStencil:!1}),this.previousValuesTexture=f.texture({width:y.textureWidth,height:y.textureHeight,channels:y.dataChannelCount,type:"float32",mag:"nearest",min:"nearest"}),this.targetValuesArray=new Float32Array(y.totalValues),this.targetValuesTexture=f.texture({width:y.textureWidth,height:y.textureHeight,channels:y.dataChannelCount,data:this.targetValuesArray,type:"float32",mag:"nearest",min:"nearest"}),this.instanceSwatchUvValues=y.generateInstanceSwatchUvValues(),this.instanceIndexValues=new Float32Array(y.totalSwatches);for(let e=0;e<y.totalSwatches;e++)this.instanceIndexValues[e]=e;const w=this.hitTestAttributeMapper=new a({maxTextureSize:f.limits.maxTextureSize,desiredSwatchCapacity:y.totalSwatches,dataChannelCount:4,attributes:[{attributeName:"Hit"}]});this.instanceHitTestUvValues=this.hitTestAttributeMapper.generateInstanceSwatchUvValues(),this.hitTestValuesFramebuffer=f.framebuffer({color:f.texture({width:w.textureWidth,height:w.textureHeight,channels:w.dataChannelCount,type:"uint8",mag:"nearest",min:"nearest"}),depthStencil:!1}),this.hitTestValues=new Uint8Array(w.dataChannelCount*w.totalSwatches),this.glyphMapper=new P(t.glyphMapper);for(const e of t.glyphs.split(""))this.glyphMapper.addGlyph(e);var T;this.sdfTexture=f.texture({height:this.glyphMapper.textureSize,width:this.glyphMapper.textureSize,min:"linear",mag:"linear",wrap:"clamp",data:this.glyphMapper.textureData,format:"luminance",type:"float32"}),this.instanceSwatchUvBuffer=this.regl.buffer(this.instanceSwatchUvValues),this.instanceIndexBuffer=this.regl.buffer(this.instanceIndexValues),this.instanceHitTestUvBuffer=this.regl.buffer(this.instanceHitTestUvValues),this.instanceRebaseUvValues=new Float32Array(this.instanceSwatchUvValues.length),this.instanceRebaseUvBuffer=this.regl.buffer({usage:"dynamic",type:"float",data:this.instanceRebaseUvValues}),this.drawCommand=(0,(T=this).regl)({blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:1},equation:{rgb:"add",alpha:"max"}},frag:o`
precision lowp float;

/**
 * View matrix for converting from world space to clip space.
 */
uniform mat3 viewMatrix;

/**
 * Signed-distance field (SDF) texture. Sampled for implementing glyphs of text.
 */
uniform sampler2D sdfTexture;

/**
 * Varying time value, eased using cubic-in-out between the previous and target
 * timestamps for this Sprite.
 */
varying float varyingT;

/**
 * Interpolated, per-vertex coordinate attributes for the quad into which the
 * sprite will be rendered.
 */
varying vec4 varyingVertexCoordinates;

/**
 * Threshold distance values to consider the pixel outside the shape (X) or
 * inside the shape (Y). Values between constitue the borde.
 */
varying vec2 varyingBorderThresholds;

/**
 * Aspect ratio of the sprite's renderable area (XY) and their inverses (ZW).
 * One component of each pair will be 1. For the XY pair, the other component
 * be be greater than 1. and for the inverse pair it will be smaller.
 *
 * For example, a rectangle that's twice as wide as it is tall wolud have
 * varyingAspectRatio equal to vec4(2., 1., .5, 1.).
 */
varying vec4 varyingAspectRatio;

/**
 * Color attributes.
 */
varying vec4 varyingBorderColor;
varying vec4 varyingFillColor;

/**
 * Shape attributes used by fragment shader.
 */
varying float varyingPreviousSides;
varying float varyingTargetSides;
varying vec4 varyingPreviousShapeTexture;
varying vec4 varyingTargetShapeTexture;

// Import utility shader functions).
${u()}

const float PI = 3.1415926535897932384626433832795;

/**
 * Given a line segment described by two points (a,b), find the point along that
 * line segment nearest to a point of interest (p).
 */
vec2 closestPoint(vec2 a, vec2 b, vec2 p) {
  vec2 pa = p - a;
  vec2 ba = b - a;
  vec2 baNorm = normalize(ba);
  float baLen = length(ba);
  float projectedLen = dot(baNorm, pa);
  vec2 closest =
    projectedLen < 0. ? a :
    projectedLen > baLen ? b :
    a + baNorm * projectedLen;
  return closest;
}

/**
 * Matrix to flip XY coordinates for theta computation. To orient polygons and
 * stars pointing upwards, we compute angles counter-clockwise from vertical.
 */
const mat2 FLIP_MATRIX = mat2(vec2(0., 1.), vec2(-1., 0.));

/**
 * Given a point in the range (-1,-1) to (1,1), compute the angle to that point,
 * going counter-clockwise from vertical.
 */
float computeTheta(vec2 point) {
  vec2 f = FLIP_MATRIX * point;
  return atan(f.y, f.x) + PI;
}

/**
 * Given the varying coordinates of interest, the dimensions of the shape's
 * bounding box, the number of sides, and a list of repeating offset radii,
 * determine the signed distance from the coordinates to the nearest edge of the
 * shape.
 *
 * @param sides Number of sides of the polygon or star.
 * @param radii List of four repeating offset radii to render stars. If all
 * values are 0., then the rendered distance will be a regular polygon.
 */
float getDistStar(int sides, vec4 radii) {
  float fSides = float(sides);

  // Flip radii (0. means align with unit circle, 1. means center of shape).
  radii = 1. - radii;

  // Angle to cut through the midpoint of a regular polygon's side.
  float piSides = PI / fSides;

  // With the polygon pointed up, this is the angle (counter-clockwise from top)
  // to the point just before crossing the X-axis. For a triangle, this will
  // just be the same as piSides.
  float wideAngle = floor(fSides * .5) * piSides;

  // Compute radius for dilation to fill bounding box.
  float dilation = 1. / max(sin(wideAngle), sin(piSides));

  // Compute the height of the shape, for centering.
  float height = dilation * (1. + max(cos(PI - 2. * wideAngle), cos(piSides)));

  // The point of interest starts with the varyingVertexCoordinates, but shifted
  // to center the shape vertically.
  vec2 poi = 2. * varyingVertexCoordinates.xy + vec2(0., 2. - height);

  // Compute theta for point of interest, counter-clockwise from vertical.
  float theta = computeTheta(poi);

  // Incorporate aspect ratio calculation. This ensures that distances to
  // borders do not stretch with the shape.
  vec2 aspect = varyingAspectRatio.xy;
  poi *= aspect;

  // Compute which side of the star we're on, and use this to compute adjustment
  // to a and b points. This creates the star effect.
  float side = floor(theta / PI * .5 * fSides);

  float minDistance = 1.e20;
  float distanceSign;

  // Look at sides to the left/right (clockwise) to find the closest.
  for (int i = -1; i < 2; i++) {
    float thisSide = side + float(i);
    float m = mod(thisSide + 4., 4.);

    vec2 adjust =
      m < 1. ? radii.xy :
      m < 2. ? radii.yz :
      m < 3. ? radii.zw :
      radii.wx;

    // Find the ab line segment endpoints.
    float thetaA = 2. * thisSide * piSides;
    float thetaB = thetaA + 2. * piSides;
    vec2 a = aspect * dilation * adjust.x * vec2(-sin(thetaA), cos(thetaA));
    vec2 b = aspect * dilation * adjust.y * vec2(-sin(thetaB), cos(thetaB));

    // Find the closest point on the segment and update minDistance.
    vec2 c = closestPoint(a, b, poi).xy;
    minDistance = min(minDistance, distance(poi, c));

    // If we're in our own segment, capture the distance sign.
    if (i == 0) {
      // Use cross product to determine if we're inside or outside the line.
      distanceSign = sign(cross(vec3(b - a, 0.), vec3(poi - c, 0.)).z);
    }
  }

  return minDistance * distanceSign;
}

/**
 * Convenience method for calling getDistStar() with a fixed size array of 0.
 * values to create a regular polygon.
 */
float getDistPolygon(int sides) {
  return getDistStar(sides, vec4(0.));
}

/**
 * Estimate the distance from the varying vertex coordinate to the nearest point
 * on an ellipse of the specified aspect ratio. Mathematically, a closed-form
 * solution for this problem has not yet been discovered.
 *
 * Higher accuracy estimates of ellipse distance are possible with more
 * computation steps, but the procedure used here yields sufficient accurancy
 * for data visualization purposes.
 */
float getDistEllipse() {
  // All quadrants can be treated the same, so use the absolute value of the
  // vertex coordinates, and flip if needed so that the X dimension is always
  // the greater.
  bool flipped = varyingAspectRatio.x < varyingAspectRatio.y;
  vec4 aspectRatio = flipped ? varyingAspectRatio.yxwz : varyingAspectRatio;

  // Point of interest in the expanded circle (before aspect ratio stretching).
  vec2 circlePoint = 2. * abs(
      flipped ? varyingVertexCoordinates.yx : varyingVertexCoordinates.xy);

  // Capture length for inside/outside checking.
  float len = length(circlePoint);

  // Point of interest in the ellipse (after aspect ratio stretching).
  vec2 ellipsePoint = circlePoint * aspectRatio.xy;

  // Compute the angle from the x-axis up to the point of interest.
  float theta = PI - atan(circlePoint.y, -circlePoint.x);

  // Find the point where a ray from the origin through c hits the ellipse.
  vec2 p1 = aspectRatio.xy * vec2(cos(theta), sin(theta));

  // Find a second point by casting up from the x-axis. If the point of interest
  // is outside the ellipse and past the tip, use the tip coordinate.
  float invAr2 = aspectRatio.z * aspectRatio.z;
  vec2 p2 = ellipsePoint.x > aspectRatio.x ? vec2(aspectRatio.x, 0.) :
    vec2(ellipsePoint.x, sqrt(1. - ellipsePoint.x * ellipsePoint.x * invAr2));

  // Take the minimum distance between ray intersection point and vertical.
  float dist = min(distance(ellipsePoint, p1), distance(ellipsePoint, p2));

  // If the point of interest is outside of the ellipse, smooth by checking the
  // distance to one more point: the point on the ellipse between p1 and p2 such
  // that its X coordinate is half way between.
  if (len > 1.) {
    vec2 pm = mix(p1, p2, .5);
    pm.y = sqrt(1. - pm.x * pm.x * invAr2);
    dist = min(dist, distance(ellipsePoint, pm));
  }

  // Return signed distance.
  return dist * sign(1. - len);
}

/**
 * Compute the signed distance from the point of interest to the nearest edge of
 * the sprite bonding box.
 */
float getDistRect() {
  // All quadrants can be treated the same, so we limit our computation to the
  // top right.
  vec2 ar = varyingAspectRatio.xy;
  vec2 p = ar * 2. * abs(varyingVertexCoordinates.xy);

  // If the point of intrest is beyond the top corner, return the negative
  // distance to that corner.
  if (all(greaterThan(p, ar))) {
    return -distance(p, ar);
  }

  // Determine distance to nearest edge.
  vec2 d = ar - p;
  vec2 dabs = abs(d);
  return dabs.x < dabs.y ? d.x : d.y;
}

/**
 * Sample the distance from the sdfTexture. The texture is assumed to have
 * one-dimensional distances in the X and Y componets and two-dimensional
 * distance in the Z component.
 *
 * @param shapeTexture UV coordinates and width/height of the region of the SDF
 * texture within which to sample (corresponds to the glyph being rendered).
 */
float getDistSDF(vec4 shapeTexture) {
  vec2 textureUv =
      shapeTexture.xy +
      shapeTexture.zw * varyingVertexCoordinates.zw;
  return 2. * texture2D(sdfTexture, textureUv).z - 1.;
}

/**
 * Generic distance function that calls through to one of the more specific
 * distance functions.
 *
 * @param sides Number of sides of the polygon/star, or special value:
 *  s < 0      : Reserved / Undefined.
 *  s == 0     : Use SDF texture coordinates.
 *  s == 1     : Circle.
 *  s == 2     : Filled rectangle.
 *  s > 2      : Polygon / Star.
 * @param textureUv Offset into SDF texture.
 */
float getDist(int sides, vec4 shapeTexture) {
  return
    sides == 0 ? getDistSDF(shapeTexture) :
    sides == 1 ? getDistEllipse() :
    sides == 2 ? getDistRect() :
    sides > 2 ? getDistPolygon(sides) :
    1.; // Reserved / undefined.
}

void main () {
  int previousSides = int(varyingPreviousSides);
  int targetSides = int(varyingTargetSides);

  float previousDistance = getDist(previousSides, varyingPreviousShapeTexture);
  float targetDistance = getDist(targetSides, varyingTargetShapeTexture);
  float signedDistance = mix(previousDistance, targetDistance, varyingT);

  gl_FragColor =
    signedDistance < varyingBorderThresholds.x ? vec4(0.) :
    signedDistance < varyingBorderThresholds.y ? varyingBorderColor :
    varyingFillColor;
}
`,vert:m(T.attributeMapper),attributes:{vertexCoordinates:[[-.5,-.5,0,1],[.5,-.5,1,1],[-.5,.5,0,0],[.5,.5,1,0]],instanceSwatchUv:{buffer:T.instanceSwatchUvBuffer,divisor:1},instanceIndex:{buffer:T.instanceIndexBuffer,divisor:1}},uniforms:{ts:()=>T.elapsedTimeMs(),instanceZ:()=>1/(1+T.instanceCount),viewMatrix:()=>T.getViewMatrix(),viewMatrixScale:()=>T.getViewMatrixScale(),projectionMatrix:e=>T.getProjectionMatrix(e),sdfTexture:T.sdfTexture,previousValuesTexture:T.previousValuesFramebuffer,targetValuesTexture:T.targetValuesTexture},primitive:"triangle strip",count:4,instances:()=>T.instanceCount}),this.rebaseCommand=function(e){const{regl:t,attributeMapper:r}=e;return t({frag:b(r),vert:v(r),attributes:{vertexCoordinates:[[-.5,-.5],[.5,-.5],[-.5,.5],[.5,.5]],instanceRebaseUv:{buffer:()=>e.instanceRebaseUvBuffer,divisor:1}},uniforms:{ts:()=>e.elapsedTimeMs(),targetValuesTexture:e.targetValuesTexture,previousValuesTexture:e.previousValuesTexture},primitive:"triangle strip",count:4,instances:()=>e.rebaseCount,framebuffer:()=>e.previousValuesFramebuffer})}(this),this.hitTestCommand=function(e){const{regl:t,attributeMapper:r,hitTestAttributeMapper:i}=e;return t({frag:o`
precision lowp float;

varying float varyingHitTestResult;

void main () {
  gl_FragColor = vec4(vec3(varyingHitTestResult), 1.);
}
`,vert:g(i,r),attributes:{vertexCoordinates:[[-.5,-.5],[.5,-.5],[-.5,.5],[.5,.5]],instanceSwatchUv:{buffer:e.instanceSwatchUvBuffer,divisor:1},instanceHitTestUv:{buffer:e.instanceHitTestUvBuffer,divisor:1}},uniforms:{ts:()=>e.elapsedTimeMs(),hitTestCoordinates:()=>[e.hitTestParameters.x,e.hitTestParameters.y,e.hitTestParameters.width,e.hitTestParameters.height],inclusive:()=>e.hitTestParameters.inclusive?1:0,viewMatrix:()=>e.getViewMatrix(),viewMatrixScale:()=>e.getViewMatrixScale(),targetValuesTexture:e.targetValuesTexture,previousValuesTexture:e.previousValuesTexture},primitive:"triangle strip",count:4,instances:()=>e.instanceCount,framebuffer:()=>e.hitTestValuesFramebuffer})}(this),this.queueDraw()}hitTest(e,t,r=0,i=0,n=!0){if(this.hitTestParameters.x=e,this.hitTestParameters.y=t,this.hitTestParameters.width=r,this.hitTestParameters.height=i,this.hitTestParameters.inclusive=n,this.hitTestPromise)return this.hitTestPromise;let a;this.hitTestPromise=new Promise(((e,t)=>{a={resolve:e,reject:t}}));const o={id:this.hitTestTaskId,callback:()=>{try{const e=this.performHitTest();a.resolve(e)}catch(e){a.reject(e)}finally{delete this.hitTestPromise}}};return this.hitTestPromise.cancel=()=>{this.workScheduler.unscheduleTask(o),delete this.hitTestPromise,a.reject(new Error("HitTest Cancelled."))},this.workScheduler.scheduleUniqueTask(o),this.hitTestPromise}performHitTest(){this.hitTestCommand(),this.regl.read({x:0,y:0,width:this.hitTestAttributeMapper.textureWidth,height:this.hitTestAttributeMapper.textureHeight,data:this.hitTestValues,framebuffer:this.hitTestValuesFramebuffer});const e=[];for(let t=0;t<this.instanceCount;t++)if(this.hitTestValues[4*t]>0){this.sprites[t][z].lifecyclePhase!==V.Removed&&e.push(this.sprites[t])}return{parameters:this.hitTestParameters,hits:e}}doDraw(){const e=this.elapsedTimeMs();try{this.drawCommand()}finally{this.toDrawTsRange.truncateToWithin(e,1/0),this.toDrawTsRange.isDefined&&this.queueDraw(!1)}}queueDraw(e=!0){this.queueTask(this.drawTaskId,(()=>this.doDraw()),e)}snapshot(){return t(this,void 0,void 0,(function*(){return this.drawCommand(),new Promise(((e,t)=>{this.canvas.toBlob((r=>r?e(r):t(r)))}))}))}getViewMatrix(){return[4*this.scale.x,0,0,0,-4*this.scale.y,0,4*this.offset.x,4*this.offset.y,1]}getViewMatrixScale(){return[4*this.scale.x,4*this.scale.y,.25/this.scale.x,.25/this.scale.y]}getProjectionMatrix({viewportWidth:e,viewportHeight:t}){return[1/e,0,0,0,-1/t,0,-1,1,1]}getNextIndex(){if(!this.removedIndexRange.isDefined)return this.sprites.length<this.attributeMapper.totalSwatches?this.sprites.length:void 0;const{lowBound:e,highBound:t}=this.removedIndexRange;for(let r=e;r<=t;r++){if(this.sprites[r][z].lifecyclePhase===V.Removed)return r===t?this.removedIndexRange.clear():this.removedIndexRange.truncateToWithin(r+1,t),r}throw new Error("No removed sprites found in removed index range.")}createSprite(){const e=Object.seal(new j(this));return this.waitingSprites.length>0||!this.removedIndexRange.isDefined&&this.sprites.length>=this.attributeMapper.totalSwatches?this.waitingSprites.push(e):this.assignSpriteToIndex(e,this.getNextIndex()),e}assignSpriteToIndex(e,t){const r=e[z];if(r.lifecyclePhase!==V.Created)throw new Error("Only sprites in the Created phase can be assigned indices");const{valuesPerSwatch:i}=this.attributeMapper,n=this.targetValuesArray.subarray(t*i,(t+1)*i);n.fill(0),r.lifecyclePhase=V.Rest,r.index=t,r.spriteView=Object.seal(new M(n)),this.sprites[t]=e,this.instanceCount<=t+1&&(this.instanceCount=t+1)}markSpriteCallback(e){this.callbacksIndexRange.expandToInclude(e),this.queueRunCallbacks()}removeSprite(e){if(e.isRemoved)throw new Error("Sprite can be removed only once.");const t=e[z];t.index===this.instanceCount-1&&this.instanceCount--,t.lifecyclePhase=V.Removed,t.spriteView[D]=void 0,this.removedIndexRange.expandToInclude(t.index)}queueTask(e,t,r=!1){this.workScheduler.isScheduledId(e)||this.workScheduler.scheduleTask({id:e,callback:t.bind(this),beginImmediately:r})}queueRebase(){this.queueTask(this.rebaseTaskId,(()=>function(e){if(!e.needsRebaseIndexRange.isDefined)throw new Error("No sprites are queued for rebase.");e.rebaseCount=0;const{lowBound:t,highBound:r}=e.needsRebaseIndexRange;for(let i=t;i<=r;i++){const t=e.sprites[i][z];t.lifecyclePhase===V.NeedsRebase&&(e.needsTextureSyncIndexRange.expandToInclude(i),t.lifecyclePhase=V.NeedsTextureSync,e.instanceRebaseUvValues[2*e.rebaseCount]=e.instanceSwatchUvValues[2*i],e.instanceRebaseUvValues[2*e.rebaseCount+1]=e.instanceSwatchUvValues[2*i+1],e.rebaseCount++)}if(!e.rebaseCount)throw new Error("No sprites were found to need rebase.");e.queueTextureSync(),e.instanceRebaseUvBuffer(e.instanceRebaseUvValues.subarray(0,2*e.rebaseCount)),e.rebaseCommand(),e.previousValuesFramebuffer.use((()=>e.previousValuesTexture({copy:!0}))),e.needsRebaseIndexRange.clear()}(this)))}queueAssignWaiting(){this.queueTask(this.runAssignWaitingTaskId,this.runAssignWaiting)}runAssignWaiting(e){return function(e,t,r){const{removedIndexRange:i,sprites:n,waitingSprites:a}=e;if(!i.isDefined)throw new Error("No removed indices available to assign.");if(!a.length)throw new Error("No waiting sprites to assign.");let o=0,s=i.lowBound,u=1,l=!1;for(;o<a.length&&s<=i.highBound&&!(o>0&&u++%r==0&&t()<=0);){for(;o<a.length&&a[o][z].isAbandoned;)o++;if(o>=a.length)break;for(;s<=i.highBound&&!n[s].isRemoved;)s++;if(s>i.highBound)throw new Error("Removed index range ended on a non-removed sprite.");const t=a[o],r=n[s];e.assignSpriteToIndex(t,r[z].index);const u=t[z];u.hasCallback&&(l=!0,u.lifecyclePhase=V.HasCallback,e.callbacksIndexRange.expandToInclude(u.index)),o++,s++}a.splice(0,o),s>i.highBound?i.clear():i.truncateToWithin(s,i.highBound),l&&e.queueRunCallbacks(),a.length&&i.isDefined&&e.queueAssignWaiting()}(this,e,K)}queueRunCallbacks(){this.queueTask(this.runCallbacksTaskId,this.runCallbacks)}runCallbacks(e){return function(e,t,r){if(!e.callbacksIndexRange.isDefined)throw new Error("Running callbacks requires a range of indices.");const{lowBound:i,highBound:n}=e.callbacksIndexRange;let a,o;e.callbacksIndexRange.clear();let s=!1,u=!1;const l=e.elapsedTimeMs(),c=()=>{if(!o)throw new Error("Attempted to re-run afterCallback steps.");const t=o.spriteView;t.TransitionTimeMs+=l,e.toDrawTsRange.expandToInclude(t.TransitionTimeMs),t.TransitionTimeMs>l?(s=!0,o.lifecyclePhase=V.NeedsRebase,e.needsRebaseIndexRange.expandToInclude(o.index)):(u=!0,o.lifecyclePhase=V.NeedsTextureSync,e.needsTextureSyncIndexRange.expandToInclude(o.index),o.toBeRemoved&&!o.hasCallback&&t[D].fill(0)),a=void 0,o=void 0};let f=i;try{let l=1;for(;f<=n&&!(f>i&&l++%r==0&&t()<=0);){if(a=e.sprites[f],o=a[z],f++,o.lifecyclePhase!==V.HasCallback)continue;let t;if(o.enterCallback)t=o.enterCallback,o.enterCallback=void 0;else if(o.updateCallback)t=o.updateCallback,o.updateCallback=void 0;else{if(!o.exitCallback)throw new Error("Sprite in HasCallback state missing callbacks.");t=o.exitCallback,o.exitCallback=void 0}o.spriteView.TransitionTimeMs=e.defaultTransitionTimeMs,l=0,t.call(a,o.spriteView),c()}}catch(e){throw o&&o.lifecyclePhase===V.HasCallback&&c(),e}finally{s&&e.queueRebase(),u&&e.queueTextureSync(),f<=n&&(e.callbacksIndexRange.expandToInclude(f),e.callbacksIndexRange.expandToInclude(n)),e.callbacksIndexRange.isDefined&&e.queueRunCallbacks(),e.toDrawTsRange.isDefined&&e.queueDraw()}return!0}(this,e,K)}queueRemovalTask(){this.queueTask(this.runRemovalTaskId,this.runRemoval)}runRemoval(e){return function(e,t,r){if(!e.toBeRemovedIndexRange.isDefined||!e.toBeRemovedTsRange.isDefined)throw new Error("No sprites are queued for removal.");const i=e.elapsedTimeMs();if(i<e.toBeRemovedTsRange.lowBound)return e.queueRemovalTask(),!0;let{lowBound:n,highBound:a}=e.toBeRemovedIndexRange;e.toBeRemovedIndexRange.clear(),e.toBeRemovedTsRange.clear();let o=n;try{let s=1;for(;o<=a&&!(o>n&&s++%r==0&&t()<=0);o++){const t=e.sprites[o][z];t.toBeRemoved&&t.lifecyclePhase===V.Rest&&(t.spriteView.TransitionTimeMs>i?(e.toBeRemovedIndexRange.expandToInclude(o),e.toBeRemovedTsRange.expandToInclude(t.spriteView.TransitionTimeMs)):(t.spriteView[D].fill(0),t.lifecyclePhase=V.NeedsTextureSync,e.needsTextureSyncIndexRange.expandToInclude(t.index)))}}finally{if(e.needsTextureSyncIndexRange.isDefined&&e.queueTextureSync(),o<a){e.toBeRemovedIndexRange.expandToInclude(o+1),e.toBeRemovedIndexRange.expandToInclude(a);for(let t=o+1;t<=a;t++){const r=e.sprites[t][z];!0===r.toBeRemoved&&r.lifecyclePhase===V.Rest&&e.toBeRemovedTsRange.expandToInclude(r.spriteView.TransitionTimeMs)}}e.toBeRemovedIndexRange.isDefined&&e.queueRemovalTask()}return!0}(this,e,K)}queueTextureSync(){this.queueTask(this.textureSyncTaskId,(()=>function(e){if(!e.needsTextureSyncIndexRange.isDefined)throw new Error("No sprites are in need of texture sync.");const{swatchesPerRow:t,textureWidth:r,valuesPerRow:i}=e.attributeMapper;if(e.needsRebaseIndexRange.isDefined){const r=W(e.needsRebaseIndexRange,t);if(W(e.needsTextureSyncIndexRange,t).overlaps(r))return e.queueRebase(),e.queueTextureSync(),!0}const{lowBound:n,highBound:a}=e.needsTextureSyncIndexRange,o=Math.floor(n/t),s=Math.floor(a/t)+1,u=s-o,l=e.targetValuesArray.subarray(o*i,s*i);let c=!1,f=!1;const h=e.elapsedTimeMs(),d=o*t,p=Math.min(s*t-1,e.sprites.length-1);for(let t=d;t<=p;t++){const r=e.sprites[t],i=r[z];if(i.lifecyclePhase===V.NeedsRebase)throw new Error("Sprite is in the wrong lifecycle phase for sync.");i.lifecyclePhase===V.NeedsTextureSync&&(i.hasCallback?(c=!0,i.lifecyclePhase=V.HasCallback,e.callbacksIndexRange.expandToInclude(t)):i.toBeRemoved?i.spriteView.TransitionTimeMs<=h?e.removeSprite(r):(f=!0,i.lifecyclePhase=V.Rest,e.toBeRemovedIndexRange.expandToInclude(t),e.toBeRemovedTsRange.expandToInclude(i.spriteView.TransitionTimeMs)):i.lifecyclePhase=V.Rest)}e.waitingSprites.length&&e.removedIndexRange.isDefined&&e.queueAssignWaiting(),c&&e.queueRunCallbacks(),f&&e.queueRemovalTask(),e.needsTextureSyncIndexRange.clear();const m={data:l,width:r,height:u};return e.targetValuesTexture.subimage(m,0,o),!0}(this)))}createSelection(){return new O(K,this,this.workScheduler)}createTextSelection(){return new U(K,this,this.workScheduler,this.glyphMapper)}}e.Scene=class{constructor(e={}){this[_]=new J(e)}get scale(){return this[_].scale}get offset(){return this[_].offset}get canvas(){return this[_].canvas}elapsedTimeMs(){return this[_].elapsedTimeMs()}createSprite(){return this[_].createSprite()}hitTest(e,t,r=0,i=0,n=!0){return this[_].hitTest(e,t,r,i,n)}createSelection(){return this[_].createSelection()}createTextSelection(){return this[_].createTextSelection()}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=megaplot-v0.1.1.bundle.es2015.min.js.map
