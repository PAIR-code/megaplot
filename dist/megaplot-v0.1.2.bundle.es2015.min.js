/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright © 2016-2017 Mapbox, Inc.
 * This code available under the terms of the BSD 2-Clause license.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS “AS IS”
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */
/**
 * @license
 * The MIT License (MIT)
 *
 * Copyright (c) 2016 Mikola Lysenko
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).megaplot=e.megaplot||{})}(this,(function(e){"use strict";function t(e,t,r,i){return new(r||(r=Promise))((function(n,a){function o(e){try{u(i.next(e))}catch(e){a(e)}}function s(e){try{u(i.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,s)}u((i=i.apply(e,t||[])).next())}))}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var r=function(e){var t={exports:{}};return e(t,t.exports),t.exports}((function(e,t){e.exports=function(){var e=function(e){return e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Float32Array||e instanceof Float64Array||e instanceof Uint8ClampedArray},t=function(e,t){for(var r=Object.keys(t),i=0;i<r.length;++i)e[r[i]]=t[r[i]];return e},r="\n";function i(e){return"undefined"!=typeof atob?atob(e):"base64:"+e}function n(e){var t=new Error("(regl) "+e);throw console.error(t),t}function a(e,t){e||n(t)}function o(e){return e?": "+e:""}function s(e,t,r){e in t||n("unknown parameter ("+e+")"+o(r)+". possible values: "+Object.keys(t).join())}function u(t,r){e(t)||n("invalid parameter type"+o(r)+". must be a typed array")}function l(e,t){switch(t){case"number":return"number"==typeof e;case"object":return"object"==typeof e;case"string":return"string"==typeof e;case"boolean":return"boolean"==typeof e;case"function":return"function"==typeof e;case"undefined":return void 0===e;case"symbol":return"symbol"==typeof e}}function c(e,t,r){l(e,t)||n("invalid parameter type"+o(r)+". expected "+t+", got "+typeof e)}function f(e,t){e>=0&&(0|e)===e||n("invalid parameter type, ("+e+")"+o(t)+". must be a nonnegative integer")}function d(e,t,r){t.indexOf(e)<0&&n("invalid value"+o(r)+". must be one of: "+t)}var h=["gl","canvas","container","attributes","pixelRatio","extensions","optionalExtensions","profile","onDone"];function p(e){Object.keys(e).forEach((function(e){h.indexOf(e)<0&&n('invalid regl constructor argument "'+e+'". must be one of '+h)}))}function m(e,t){for(e+="";e.length<t;)e=" "+e;return e}function g(){this.name="unknown",this.lines=[],this.index={},this.hasErrors=!1}function v(e,t){this.number=e,this.line=t,this.errors=[]}function b(e,t,r){this.file=e,this.line=t,this.message=r}function x(){var e=new Error,t=(e.stack||e).toString(),r=/compileProcedure.*\n\s*at.*\((.*)\)/.exec(t);if(r)return r[1];var i=/compileProcedure.*\n\s*at\s+(.*)(\n|$)/.exec(t);return i?i[1]:"unknown"}function y(){var e=new Error,t=(e.stack||e).toString(),r=/at REGLCommand.*\n\s+at.*\((.*)\)/.exec(t);if(r)return r[1];var i=/at REGLCommand.*\n\s+at\s+(.*)\n/.exec(t);return i?i[1]:"unknown"}function w(e,t){var r=e.split("\n"),n=1,a=0,o={unknown:new g,0:new g};o.unknown.name=o[0].name=t||x(),o.unknown.lines.push(new v(0,""));for(var s=0;s<r.length;++s){var u=r[s],l=/^\s*#\s*(\w+)\s+(.+)\s*$/.exec(u);if(l)switch(l[1]){case"line":var c=/(\d+)(\s+\d+)?/.exec(l[2]);c&&(n=0|c[1],c[2]&&((a=0|c[2])in o||(o[a]=new g)));break;case"define":var f=/SHADER_NAME(_B64)?\s+(.*)$/.exec(l[2]);f&&(o[a].name=f[1]?i(f[2]):f[2])}o[a].lines.push(new v(n++,u))}return Object.keys(o).forEach((function(e){var t=o[e];t.lines.forEach((function(e){t.index[e.number]=e}))})),o}function T(e){var t=[];return e.split("\n").forEach((function(e){if(!(e.length<5)){var r=/^ERROR:\s+(\d+):(\d+):\s*(.*)$/.exec(e);r?t.push(new b(0|r[1],0|r[2],r[3].trim())):e.length>0&&t.push(new b("unknown",0,e))}})),t}function S(e,t){t.forEach((function(t){var r=e[t.file];if(r){var i=r.index[t.line];if(i)return i.errors.push(t),void(r.hasErrors=!0)}e.unknown.hasErrors=!0,e.unknown.lines[0].errors.push(t)}))}function k(e,t,i,n,o){if(!e.getShaderParameter(t,e.COMPILE_STATUS)){var s=e.getShaderInfoLog(t),u=n===e.FRAGMENT_SHADER?"fragment":"vertex";z(i,"string",u+" shader source must be a string",o);var l=w(i,o),c=T(s);S(l,c),Object.keys(l).forEach((function(e){var t=l[e];if(t.hasErrors){var i=[""],n=[""];a("file number "+e+": "+t.name+"\n","color:red;text-decoration:underline;font-weight:bold"),t.lines.forEach((function(e){if(e.errors.length>0){a(m(e.number,4)+"|  ","background-color:yellow; font-weight:bold"),a(e.line+r,"color:red; background-color:yellow; font-weight:bold");var t=0;e.errors.forEach((function(i){var n=i.message,o=/^\s*'(.*)'\s*:\s*(.*)$/.exec(n);if(o){var s=o[1];n=o[2],"assign"===s&&(s="="),t=Math.max(e.line.indexOf(s,t),0)}else t=0;a(m("| ",6)),a(m("^^^",t+3)+r,"font-weight:bold"),a(m("| ",6)),a(n+r,"font-weight:bold")})),a(m("| ",6)+r)}else a(m(e.number,4)+"|  "),a(e.line+r,"color:red")})),"undefined"==typeof document||window.chrome?console.log(i.join("")):(n[0]=i.join("%c"),console.log.apply(console,n))}function a(e,t){i.push(e),n.push(t||"")}})),a.raise("Error compiling "+u+" shader, "+l[0].name)}}function A(e,t,i,n,o){if(!e.getProgramParameter(t,e.LINK_STATUS)){var s=e.getProgramInfoLog(t),u=w(i,o),l='Error linking program with vertex shader, "'+w(n,o)[0].name+'", and fragment shader "'+u[0].name+'"';"undefined"!=typeof document?console.log("%c"+l+r+"%c"+s,"color:red;text-decoration:underline;font-weight:bold","color:red"):console.log(l+r+s),a.raise(l)}}function C(e){e._commandRef=x()}function P(e,t,r,i){function n(e){return e?i.id(e):0}function a(e,t){Object.keys(t).forEach((function(t){e[i.id(t)]=!0}))}C(e),e._fragId=n(e.static.frag),e._vertId=n(e.static.vert);var o=e._uniformSet={};a(o,t.static),a(o,t.dynamic);var s=e._attributeSet={};a(s,r.static),a(s,r.dynamic),e._hasCount="count"in e.static||"count"in e.dynamic||"elements"in e.static||"elements"in e.dynamic}function R(e,t){var r=y();n(e+" in command "+(t||x())+("unknown"===r?"":" called from "+r))}function E(e,t,r){e||R(t,r||x())}function D(e,t,r,i){e in t||R("unknown parameter ("+e+")"+o(r)+". possible values: "+Object.keys(t).join(),i||x())}function z(e,t,r,i){l(e,t)||R("invalid parameter type"+o(r)+". expected "+t+", got "+typeof e,i||x())}function I(e){e()}function B(e,t,r){e.texture?d(e.texture._texture.internalformat,t,"unsupported texture format for attachment"):d(e.renderbuffer._renderbuffer.format,r,"unsupported renderbuffer format for attachment")}var V=33071,_=9728,N=9984,O=9985,M=9986,j=9987,F=5121,W=5122,L=5123,U=5124,H=5125,G=5126,$=32819,q=32820,Z=33635,X=34042,Y=36193,Q={};function K(e,t){return e===q||e===$||e===Z?2:e===X?4:Q[e]*t}function J(e){return!(e&e-1||!e)}function ee(e,t,r){var i,n=t.width,o=t.height,s=t.channels;a(n>0&&n<=r.maxTextureSize&&o>0&&o<=r.maxTextureSize,"invalid texture shape"),e.wrapS===V&&e.wrapT===V||a(J(n)&&J(o),"incompatible wrap mode for texture, both width and height must be power of 2"),1===t.mipmask?1!==n&&1!==o&&a(e.minFilter!==N&&e.minFilter!==M&&e.minFilter!==O&&e.minFilter!==j,"min filter requires mipmap"):(a(J(n)&&J(o),"texture must be a square power of 2 to support mipmapping"),a(t.mipmask===(n<<1)-1,"missing or incomplete mipmap data")),t.type===G&&(r.extensions.indexOf("oes_texture_float_linear")<0&&a(e.minFilter===_&&e.magFilter===_,"filter not supported, must enable oes_texture_float_linear"),a(!e.genMipmaps,"mipmap generation not supported with float textures"));var u=t.images;for(i=0;i<16;++i)if(u[i]){var l=n>>i,c=o>>i;a(t.mipmask&1<<i,"missing mipmap data");var f=u[i];if(a(f.width===l&&f.height===c,"invalid shape for mip images"),a(f.format===t.format&&f.internalformat===t.internalformat&&f.type===t.type,"incompatible type for mip image"),f.compressed);else if(f.data){var d=Math.ceil(K(f.type,s)*l/f.unpackAlignment)*f.unpackAlignment;a(f.data.byteLength===d*c,"invalid data for image, buffer size is inconsistent with image format")}else f.element||f.copy}else e.genMipmaps||a(0==(t.mipmask&1<<i),"extra mipmap data");t.compressed&&a(!e.genMipmaps,"mipmap generation for compressed images not supported")}function te(e,t,r,i){var n=e.width,o=e.height,s=e.channels;a(n>0&&n<=i.maxTextureSize&&o>0&&o<=i.maxTextureSize,"invalid texture shape"),a(n===o,"cube map must be square"),a(t.wrapS===V&&t.wrapT===V,"wrap mode not supported by cube map");for(var u=0;u<r.length;++u){var l=r[u];a(l.width===n&&l.height===o,"inconsistent cube map face shape"),t.genMipmaps&&(a(!l.compressed,"can not generate mipmap for compressed textures"),a(1===l.mipmask,"can not specify mipmaps and generate mipmaps"));for(var c=l.images,f=0;f<16;++f){var d=c[f];if(d){var h=n>>f,p=o>>f;a(l.mipmask&1<<f,"missing mipmap data"),a(d.width===h&&d.height===p,"invalid shape for mip images"),a(d.format===e.format&&d.internalformat===e.internalformat&&d.type===e.type,"incompatible type for mip image"),d.compressed||(d.data?a(d.data.byteLength===h*p*Math.max(K(d.type,s),d.unpackAlignment),"invalid data for image, buffer size is inconsistent with image format"):d.element||d.copy)}}}}Q[5120]=Q[F]=1,Q[W]=Q[L]=Q[Y]=Q[Z]=Q[$]=Q[q]=2,Q[U]=Q[H]=Q[G]=Q[X]=4;var re=t(a,{optional:I,raise:n,commandRaise:R,command:E,parameter:s,commandParameter:D,constructor:p,type:c,commandType:z,isTypedArray:u,nni:f,oneOf:d,shaderError:k,linkError:A,callSite:y,saveCommandRef:C,saveDrawInfo:P,framebufferFormat:B,guessCommand:x,texture2D:ee,textureCube:te}),ie=0,ne=0,ae=5,oe=6;function se(e,t){this.id=ie++,this.type=e,this.data=t}function ue(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function le(e){if(0===e.length)return[];var t=e.charAt(0),r=e.charAt(e.length-1);if(e.length>1&&t===r&&('"'===t||"'"===t))return['"'+ue(e.substr(1,e.length-2))+'"'];var i=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(e);if(i)return le(e.substr(0,i.index)).concat(le(i[1])).concat(le(e.substr(i.index+i[0].length)));var n=e.split(".");if(1===n.length)return['"'+ue(e)+'"'];for(var a=[],o=0;o<n.length;++o)a=a.concat(le(n[o]));return a}function ce(e){return"["+le(e).join("][")+"]"}function fe(e,t){return new se(e,ce(t+""))}function de(e){return"function"==typeof e&&!e._reglType||e instanceof se}function he(e,t){return"function"==typeof e?new se(ne,e):"number"==typeof e||"boolean"==typeof e?new se(ae,e):Array.isArray(e)?new se(oe,e.map((function(e,r){return he(e,t+"["+r+"]")}))):e instanceof se?e:void re(!1,"invalid option type in uniform "+t)}var pe={DynamicVariable:se,define:fe,isDynamic:de,unbox:he,accessor:ce},me={next:"function"==typeof requestAnimationFrame?function(e){return requestAnimationFrame(e)}:function(e){return setTimeout(e,16)},cancel:"function"==typeof cancelAnimationFrame?function(e){return cancelAnimationFrame(e)}:clearTimeout},ge="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date};function ve(){var e={"":0},t=[""];return{id:function(r){var i=e[r];return i||(i=e[r]=t.length,t.push(r),i)},str:function(e){return t[e]}}}function be(e,r,i){var n,a=document.createElement("canvas");function o(){var t=window.innerWidth,r=window.innerHeight;if(e!==document.body){var n=a.getBoundingClientRect();t=n.right-n.left,r=n.bottom-n.top}a.width=i*t,a.height=i*r}function s(){n?n.disconnect():window.removeEventListener("resize",o),e.removeChild(a)}return t(a.style,{border:0,margin:0,padding:0,top:0,left:0,width:"100%",height:"100%"}),e.appendChild(a),e===document.body&&(a.style.position="absolute",t(e.style,{margin:0,padding:0})),e!==document.body&&"function"==typeof ResizeObserver?(n=new ResizeObserver((function(){setTimeout(o)}))).observe(e):window.addEventListener("resize",o,!1),o(),{canvas:a,onDestroy:s}}function xe(e,t){function r(r){try{return e.getContext(r,t)}catch(e){return null}}return r("webgl")||r("experimental-webgl")||r("webgl-experimental")}function ye(e){return"string"==typeof e.nodeName&&"function"==typeof e.appendChild&&"function"==typeof e.getBoundingClientRect}function we(e){return"function"==typeof e.drawArrays||"function"==typeof e.drawElements}function Te(e){return"string"==typeof e?e.split():(re(Array.isArray(e),"invalid extension array"),e)}function Se(e){return"string"==typeof e?(re("undefined"!=typeof document,"not supported outside of DOM"),document.querySelector(e)):e}function ke(e){var t,r,i,n,a=e||{},o={},s=[],u=[],l="undefined"==typeof window?1:window.devicePixelRatio,c=!1,f=function(e){e&&re.raise(e)},d=function(){};if("string"==typeof a?(re("undefined"!=typeof document,"selector queries only supported in DOM enviroments"),t=document.querySelector(a),re(t,"invalid query string for element")):"object"==typeof a?ye(a)?t=a:we(a)?i=(n=a).canvas:(re.constructor(a),"gl"in a?n=a.gl:"canvas"in a?i=Se(a.canvas):"container"in a&&(r=Se(a.container)),"attributes"in a&&(o=a.attributes,re.type(o,"object","invalid context attributes")),"extensions"in a&&(s=Te(a.extensions)),"optionalExtensions"in a&&(u=Te(a.optionalExtensions)),"onDone"in a&&(re.type(a.onDone,"function","invalid or missing onDone callback"),f=a.onDone),"profile"in a&&(c=!!a.profile),"pixelRatio"in a&&(l=+a.pixelRatio,re(l>0,"invalid pixel ratio"))):re.raise("invalid arguments to regl"),t&&("canvas"===t.nodeName.toLowerCase()?i=t:r=t),!n){if(!i){re("undefined"!=typeof document,"must manually specify webgl context outside of DOM environments");var h=be(r||document.body,f,l);if(!h)return null;i=h.canvas,d=h.onDestroy}void 0===o.premultipliedAlpha&&(o.premultipliedAlpha=!0),n=xe(i,o)}return n?{gl:n,canvas:i,container:r,extensions:s,optionalExtensions:u,pixelRatio:l,profile:c,onDone:f,onDestroy:d}:(d(),f("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function Ae(e,t){var r={};function i(t){re.type(t,"string","extension name must be string");var i,n=t.toLowerCase();try{i=r[n]=e.getExtension(n)}catch(e){}return!!i}for(var n=0;n<t.extensions.length;++n){var a=t.extensions[n];if(!i(a))return t.onDestroy(),t.onDone('"'+a+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return t.optionalExtensions.forEach(i),{extensions:r,restore:function(){Object.keys(r).forEach((function(e){if(r[e]&&!i(e))throw new Error("(regl): error restoring extension "+e)}))}}}function Ce(e,t){for(var r=Array(e),i=0;i<e;++i)r[i]=t(i);return r}var Pe=5120,Re=5121,Ee=5122,De=5123,ze=5124,Ie=5125,Be=5126;function Ve(e){for(var t=16;t<=1<<28;t*=16)if(e<=t)return t;return 0}function _e(e){var t,r;return t=(e>65535)<<4,t|=r=((e>>>=t)>255)<<3,t|=r=((e>>>=r)>15)<<2,(t|=r=((e>>>=r)>3)<<1)|(e>>>=r)>>1}function Ne(){var e=Ce(8,(function(){return[]}));function t(t){var r=Ve(t),i=e[_e(r)>>2];return i.length>0?i.pop():new ArrayBuffer(r)}function r(t){e[_e(t.byteLength)>>2].push(t)}function i(e,r){var i=null;switch(e){case Pe:i=new Int8Array(t(r),0,r);break;case Re:i=new Uint8Array(t(r),0,r);break;case Ee:i=new Int16Array(t(2*r),0,r);break;case De:i=new Uint16Array(t(2*r),0,r);break;case ze:i=new Int32Array(t(4*r),0,r);break;case Ie:i=new Uint32Array(t(4*r),0,r);break;case Be:i=new Float32Array(t(4*r),0,r);break;default:return null}return i.length!==r?i.subarray(0,r):i}function n(e){r(e.buffer)}return{alloc:t,free:r,allocType:i,freeType:n}}var Oe=Ne();Oe.zero=Ne();var Me=3408,je=3410,Fe=3411,We=3412,Le=3413,Ue=3414,He=3415,Ge=33901,$e=33902,qe=3379,Ze=3386,Xe=34921,Ye=36347,Qe=36348,Ke=35661,Je=35660,et=34930,tt=36349,rt=34076,it=34024,nt=7936,at=7937,ot=7938,st=35724,ut=34047,lt=36063,ct=34852,ft=3553,dt=34067,ht=34069,pt=33984,mt=6408,gt=5126,vt=5121,bt=36160,xt=36053,yt=36064,wt=16384,Tt=function(e,t){var r=1;t.ext_texture_filter_anisotropic&&(r=e.getParameter(ut));var i=1,n=1;t.webgl_draw_buffers&&(i=e.getParameter(ct),n=e.getParameter(lt));var a=!!t.oes_texture_float;if(a){var o=e.createTexture();e.bindTexture(ft,o),e.texImage2D(ft,0,mt,1,1,0,mt,gt,null);var s=e.createFramebuffer();if(e.bindFramebuffer(bt,s),e.framebufferTexture2D(bt,yt,ft,o,0),e.bindTexture(ft,null),e.checkFramebufferStatus(bt)!==xt)a=!1;else{e.viewport(0,0,1,1),e.clearColor(1,0,0,1),e.clear(wt);var u=Oe.allocType(gt,4);e.readPixels(0,0,1,1,mt,gt,u),e.getError()?a=!1:(e.deleteFramebuffer(s),e.deleteTexture(o),a=1===u[0]),Oe.freeType(u)}}var l=!0;if("undefined"==typeof navigator||!(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent))){var c=e.createTexture(),f=Oe.allocType(vt,36);e.activeTexture(pt),e.bindTexture(dt,c),e.texImage2D(ht,0,mt,3,3,0,mt,vt,f),Oe.freeType(f),e.bindTexture(dt,null),e.deleteTexture(c),l=!e.getError()}return{colorBits:[e.getParameter(je),e.getParameter(Fe),e.getParameter(We),e.getParameter(Le)],depthBits:e.getParameter(Ue),stencilBits:e.getParameter(He),subpixelBits:e.getParameter(Me),extensions:Object.keys(t).filter((function(e){return!!t[e]})),maxAnisotropic:r,maxDrawbuffers:i,maxColorAttachments:n,pointSizeDims:e.getParameter(Ge),lineWidthDims:e.getParameter($e),maxViewportDims:e.getParameter(Ze),maxCombinedTextureUnits:e.getParameter(Ke),maxCubeMapSize:e.getParameter(rt),maxRenderbufferSize:e.getParameter(it),maxTextureUnits:e.getParameter(et),maxTextureSize:e.getParameter(qe),maxAttributes:e.getParameter(Xe),maxVertexUniforms:e.getParameter(Ye),maxVertexTextureUnits:e.getParameter(Je),maxVaryingVectors:e.getParameter(Qe),maxFragmentUniforms:e.getParameter(tt),glsl:e.getParameter(st),renderer:e.getParameter(at),vendor:e.getParameter(nt),version:e.getParameter(ot),readFloat:a,npotTextureCube:l}};function St(t){return!!t&&"object"==typeof t&&Array.isArray(t.shape)&&Array.isArray(t.stride)&&"number"==typeof t.offset&&t.shape.length===t.stride.length&&(Array.isArray(t.data)||e(t.data))}var kt=function(e){return Object.keys(e).map((function(t){return e[t]}))},At={shape:zt,flatten:Dt};function Ct(e,t,r){for(var i=0;i<t;++i)r[i]=e[i]}function Pt(e,t,r,i){for(var n=0,a=0;a<t;++a)for(var o=e[a],s=0;s<r;++s)i[n++]=o[s]}function Rt(e,t,r,i,n,a){for(var o=a,s=0;s<t;++s)for(var u=e[s],l=0;l<r;++l)for(var c=u[l],f=0;f<i;++f)n[o++]=c[f]}function Et(e,t,r,i,n){for(var a=1,o=r+1;o<t.length;++o)a*=t[o];var s=t[r];if(t.length-r==4){var u=t[r+1],l=t[r+2],c=t[r+3];for(o=0;o<s;++o)Rt(e[o],u,l,c,i,n),n+=a}else for(o=0;o<s;++o)Et(e[o],t,r+1,i,n),n+=a}function Dt(e,t,r,i){var n=1;if(t.length)for(var a=0;a<t.length;++a)n*=t[a];else n=0;var o=i||Oe.allocType(r,n);switch(t.length){case 0:break;case 1:Ct(e,t[0],o);break;case 2:Pt(e,t[0],t[1],o);break;case 3:Rt(e,t[0],t[1],t[2],o,0);break;default:Et(e,t,0,o,0)}return o}function zt(e){for(var t=[],r=e;r.length;r=r[0])t.push(r.length);return t}var It={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},Bt={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126},Vt={dynamic:35048,stream:35040,static:35044},_t=At.flatten,Nt=At.shape,Ot=35044,Mt=35040,jt=5121,Ft=5126,Wt=[];function Lt(e){return 0|It[Object.prototype.toString.call(e)]}function Ut(e,t){for(var r=0;r<t.length;++r)e[r]=t[r]}function Ht(e,t,r,i,n,a,o){for(var s=0,u=0;u<r;++u)for(var l=0;l<i;++l)e[s++]=t[n*u+a*l+o]}function Gt(t,r,i,n){var a=0,o={};function s(e){this.id=a++,this.buffer=t.createBuffer(),this.type=e,this.usage=Ot,this.byteLength=0,this.dimension=1,this.dtype=jt,this.persistentData=null,i.profile&&(this.stats={size:0})}s.prototype.bind=function(){t.bindBuffer(this.type,this.buffer)},s.prototype.destroy=function(){h(this)};var u=[];function l(e,t){var r=u.pop();return r||(r=new s(e)),r.bind(),d(r,t,Mt,0,1,!1),r}function c(e){u.push(e)}function f(e,r,i){e.byteLength=r.byteLength,t.bufferData(e.type,r,i)}function d(t,r,i,n,a,o){var s,u;if(t.usage=i,Array.isArray(r)){if(t.dtype=n||Ft,r.length>0)if(Array.isArray(r[0])){s=Nt(r);for(var l=1,c=1;c<s.length;++c)l*=s[c];t.dimension=l,f(t,u=_t(r,s,t.dtype),i),o?t.persistentData=u:Oe.freeType(u)}else if("number"==typeof r[0]){t.dimension=a;var d=Oe.allocType(t.dtype,r.length);Ut(d,r),f(t,d,i),o?t.persistentData=d:Oe.freeType(d)}else e(r[0])?(t.dimension=r[0].length,t.dtype=n||Lt(r[0])||Ft,f(t,u=_t(r,[r.length,r[0].length],t.dtype),i),o?t.persistentData=u:Oe.freeType(u)):re.raise("invalid buffer data")}else if(e(r))t.dtype=n||Lt(r),t.dimension=a,f(t,r,i),o&&(t.persistentData=new Uint8Array(new Uint8Array(r.buffer)));else if(St(r)){s=r.shape;var h=r.stride,p=r.offset,m=0,g=0,v=0,b=0;1===s.length?(m=s[0],g=1,v=h[0],b=0):2===s.length?(m=s[0],g=s[1],v=h[0],b=h[1]):re.raise("invalid shape"),t.dtype=n||Lt(r.data)||Ft,t.dimension=g;var x=Oe.allocType(t.dtype,m*g);Ht(x,r.data,m,g,v,b,p),f(t,x,i),o?t.persistentData=x:Oe.freeType(x)}else r instanceof ArrayBuffer?(t.dtype=jt,t.dimension=a,f(t,r,i),o&&(t.persistentData=new Uint8Array(new Uint8Array(r)))):re.raise("invalid buffer data")}function h(e){r.bufferCount--,n(e);var i=e.buffer;re(i,"buffer must not be deleted already"),t.deleteBuffer(i),e.buffer=null,delete o[e.id]}function p(n,a,u,l){r.bufferCount++;var c=new s(a);function f(r){var n=Ot,a=null,o=0,s=0,u=1;return Array.isArray(r)||e(r)||St(r)||r instanceof ArrayBuffer?a=r:"number"==typeof r?o=0|r:r&&(re.type(r,"object","buffer arguments must be an object, a number or an array"),"data"in r&&(re(null===a||Array.isArray(a)||e(a)||St(a),"invalid data for buffer"),a=r.data),"usage"in r&&(re.parameter(r.usage,Vt,"invalid buffer usage"),n=Vt[r.usage]),"type"in r&&(re.parameter(r.type,Bt,"invalid buffer type"),s=Bt[r.type]),"dimension"in r&&(re.type(r.dimension,"number","invalid dimension"),u=0|r.dimension),"length"in r&&(re.nni(o,"buffer length must be a nonnegative integer"),o=0|r.length)),c.bind(),a?d(c,a,n,s,u,l):(o&&t.bufferData(c.type,o,n),c.dtype=s||jt,c.usage=n,c.dimension=u,c.byteLength=o),i.profile&&(c.stats.size=c.byteLength*Wt[c.dtype]),f}function p(e,r){re(r+e.byteLength<=c.byteLength,"invalid buffer subdata call, buffer is too small.  Can't write data of size "+e.byteLength+" starting from offset "+r+" to a buffer of size "+c.byteLength),t.bufferSubData(c.type,r,e)}function m(t,r){var i,n=0|(r||0);if(c.bind(),e(t)||t instanceof ArrayBuffer)p(t,n);else if(Array.isArray(t)){if(t.length>0)if("number"==typeof t[0]){var a=Oe.allocType(c.dtype,t.length);Ut(a,t),p(a,n),Oe.freeType(a)}else if(Array.isArray(t[0])||e(t[0])){i=Nt(t);var o=_t(t,i,c.dtype);p(o,n),Oe.freeType(o)}else re.raise("invalid buffer data")}else if(St(t)){i=t.shape;var s=t.stride,u=0,l=0,d=0,h=0;1===i.length?(u=i[0],l=1,d=s[0],h=0):2===i.length?(u=i[0],l=i[1],d=s[0],h=s[1]):re.raise("invalid shape");var m=Array.isArray(t.data)?c.dtype:Lt(t.data),g=Oe.allocType(m,u*l);Ht(g,t.data,u,l,d,h,t.offset),p(g,n),Oe.freeType(g)}else re.raise("invalid data for buffer subdata");return f}return o[c.id]=c,u||f(n),f._reglType="buffer",f._buffer=c,f.subdata=m,i.profile&&(f.stats=c.stats),f.destroy=function(){h(c)},f}function m(){kt(o).forEach((function(e){e.buffer=t.createBuffer(),t.bindBuffer(e.type,e.buffer),t.bufferData(e.type,e.persistentData||e.byteLength,e.usage)}))}return i.profile&&(r.getTotalBufferSize=function(){var e=0;return Object.keys(o).forEach((function(t){e+=o[t].stats.size})),e}),{create:p,createStream:l,destroyStream:c,clear:function(){kt(o).forEach(h),u.forEach(h)},getBuffer:function(e){return e&&e._buffer instanceof s?e._buffer:null},restore:m,_initBuffer:d}}Wt[5120]=1,Wt[5122]=2,Wt[5124]=4,Wt[5121]=1,Wt[5123]=2,Wt[5125]=4,Wt[5126]=4;var $t={points:0,point:0,lines:1,line:1,triangles:4,triangle:4,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},qt=0,Zt=1,Xt=4,Yt=5120,Qt=5121,Kt=5122,Jt=5123,er=5124,tr=5125,rr=34963,ir=35040,nr=35044;function ar(t,r,i,n){var a={},o=0,s={uint8:Qt,uint16:Jt};function u(e){this.id=o++,a[this.id]=this,this.buffer=e,this.primType=Xt,this.vertCount=0,this.type=0}r.oes_element_index_uint&&(s.uint32=tr),u.prototype.bind=function(){this.buffer.bind()};var l=[];function c(e){var t=l.pop();return t||(t=new u(i.create(null,rr,!0,!1)._buffer)),d(t,e,ir,-1,-1,0,0),t}function f(e){l.push(e)}function d(n,a,o,s,u,l,c){var f;if(n.buffer.bind(),a){var d=c;c||e(a)&&(!St(a)||e(a.data))||(d=r.oes_element_index_uint?tr:Jt),i._initBuffer(n.buffer,a,o,d,3)}else t.bufferData(rr,l,o),n.buffer.dtype=f||Qt,n.buffer.usage=o,n.buffer.dimension=3,n.buffer.byteLength=l;if(f=c,!c){switch(n.buffer.dtype){case Qt:case Yt:f=Qt;break;case Jt:case Kt:f=Jt;break;case tr:case er:f=tr;break;default:re.raise("unsupported type for element array")}n.buffer.dtype=f}n.type=f,re(f!==tr||!!r.oes_element_index_uint,"32 bit element buffers not supported, enable oes_element_index_uint first");var h=u;h<0&&(h=n.buffer.byteLength,f===Jt?h>>=1:f===tr&&(h>>=2)),n.vertCount=h;var p=s;if(s<0){p=Xt;var m=n.buffer.dimension;1===m&&(p=qt),2===m&&(p=Zt),3===m&&(p=Xt)}n.primType=p}function h(e){n.elementsCount--,re(null!==e.buffer,"must not double destroy elements"),delete a[e.id],e.buffer.destroy(),e.buffer=null}function p(t,r){var a=i.create(null,rr,!0),o=new u(a._buffer);function l(t){if(t)if("number"==typeof t)a(t),o.primType=Xt,o.vertCount=0|t,o.type=Qt;else{var r=null,i=nr,n=-1,u=-1,c=0,f=0;Array.isArray(t)||e(t)||St(t)?r=t:(re.type(t,"object","invalid arguments for elements"),"data"in t&&(r=t.data,re(Array.isArray(r)||e(r)||St(r),"invalid data for element buffer")),"usage"in t&&(re.parameter(t.usage,Vt,"invalid element buffer usage"),i=Vt[t.usage]),"primitive"in t&&(re.parameter(t.primitive,$t,"invalid element buffer primitive"),n=$t[t.primitive]),"count"in t&&(re("number"==typeof t.count&&t.count>=0,"invalid vertex count for elements"),u=0|t.count),"type"in t&&(re.parameter(t.type,s,"invalid buffer type"),f=s[t.type]),"length"in t?c=0|t.length:(c=u,f===Jt||f===Kt?c*=2:f!==tr&&f!==er||(c*=4))),d(o,r,i,n,u,c,f)}else a(),o.primType=Xt,o.vertCount=0,o.type=Qt;return l}return n.elementsCount++,l(t),l._reglType="elements",l._elements=o,l.subdata=function(e,t){return a.subdata(e,t),l},l.destroy=function(){h(o)},l}return{create:p,createStream:c,destroyStream:f,getElements:function(e){return"function"==typeof e&&e._elements instanceof u?e._elements:null},clear:function(){kt(a).forEach(h)}}}var or=new Float32Array(1),sr=new Uint32Array(or.buffer),ur=5123;function lr(e){for(var t=Oe.allocType(ur,e.length),r=0;r<e.length;++r)if(isNaN(e[r]))t[r]=65535;else if(e[r]===1/0)t[r]=31744;else if(e[r]===-1/0)t[r]=64512;else{or[0]=e[r];var i=sr[0],n=i>>>31<<15,a=(i<<1>>>24)-127,o=i>>13&1023;if(a<-24)t[r]=n;else if(a<-14){var s=-14-a;t[r]=n+(o+1024>>s)}else t[r]=a>15?n+31744:n+(a+15<<10)+o}return t}function cr(t){return Array.isArray(t)||e(t)}var fr=function(e){return!(e&e-1||!e)},dr=34467,hr=3553,pr=34067,mr=34069,gr=6408,vr=6406,br=6407,xr=6409,yr=6410,wr=32854,Tr=32855,Sr=36194,kr=32819,Ar=32820,Cr=33635,Pr=34042,Rr=6402,Er=34041,Dr=35904,zr=35906,Ir=36193,Br=33776,Vr=33777,_r=33778,Nr=33779,Or=35986,Mr=35987,jr=34798,Fr=35840,Wr=35841,Lr=35842,Ur=35843,Hr=36196,Gr=5121,$r=5123,qr=5125,Zr=5126,Xr=10242,Yr=10243,Qr=10497,Kr=33071,Jr=33648,ei=10240,ti=10241,ri=9728,ii=9729,ni=9984,ai=9985,oi=9986,si=9987,ui=33170,li=4352,ci=4353,fi=4354,di=34046,hi=3317,pi=37440,mi=37441,gi=37443,vi=37444,bi=33984,xi=[ni,oi,ai,si],yi=[0,xr,yr,br,gr],wi={};function Ti(e){return"[object "+e+"]"}wi[xr]=wi[vr]=wi[Rr]=1,wi[Er]=wi[yr]=2,wi[br]=wi[Dr]=3,wi[gr]=wi[zr]=4;var Si=Ti("HTMLCanvasElement"),ki=Ti("OffscreenCanvas"),Ai=Ti("CanvasRenderingContext2D"),Ci=Ti("ImageBitmap"),Pi=Ti("HTMLImageElement"),Ri=Ti("HTMLVideoElement"),Ei=Object.keys(It).concat([Si,ki,Ai,Ci,Pi,Ri]),Di=[];Di[Gr]=1,Di[Zr]=4,Di[Ir]=2,Di[$r]=2,Di[qr]=4;var zi=[];function Ii(e){return Array.isArray(e)&&(0===e.length||"number"==typeof e[0])}function Bi(e){return!!Array.isArray(e)&&!(0===e.length||!cr(e[0]))}function Vi(e){return Object.prototype.toString.call(e)}function _i(e){return Vi(e)===Si}function Ni(e){return Vi(e)===ki}function Oi(e){return Vi(e)===Ai}function Mi(e){return Vi(e)===Ci}function ji(e){return Vi(e)===Pi}function Fi(e){return Vi(e)===Ri}function Wi(e){if(!e)return!1;var t=Vi(e);return Ei.indexOf(t)>=0||Ii(e)||Bi(e)||St(e)}function Li(e){return 0|It[Object.prototype.toString.call(e)]}function Ui(e,t){var r=t.length;switch(e.type){case Gr:case $r:case qr:case Zr:var i=Oe.allocType(e.type,r);i.set(t),e.data=i;break;case Ir:e.data=lr(t);break;default:re.raise("unsupported texture type, must specify a typed array")}}function Hi(e,t){return Oe.allocType(e.type===Ir?Zr:e.type,t)}function Gi(e,t){e.type===Ir?(e.data=lr(t),Oe.freeType(t)):e.data=t}function $i(e,t,r,i,n,a){for(var o=e.width,s=e.height,u=e.channels,l=Hi(e,o*s*u),c=0,f=0;f<s;++f)for(var d=0;d<o;++d)for(var h=0;h<u;++h)l[c++]=t[r*d+i*f+n*h+a];Gi(e,l)}function qi(e,t,r,i,n,a){var o;if(o=void 0!==zi[e]?zi[e]:wi[e]*Di[t],a&&(o*=6),n){for(var s=0,u=r;u>=1;)s+=o*u*u,u/=2;return s}return o*r*i}function Zi(r,i,n,a,o,s,u){var l={"don't care":li,"dont care":li,nice:fi,fast:ci},c={repeat:Qr,clamp:Kr,mirror:Jr},f={nearest:ri,linear:ii},d=t({mipmap:si,"nearest mipmap nearest":ni,"linear mipmap nearest":ai,"nearest mipmap linear":oi,"linear mipmap linear":si},f),h={none:0,browser:vi},p={uint8:Gr,rgba4:kr,rgb565:Cr,"rgb5 a1":Ar},m={alpha:vr,luminance:xr,"luminance alpha":yr,rgb:br,rgba:gr,rgba4:wr,"rgb5 a1":Tr,rgb565:Sr},g={};i.ext_srgb&&(m.srgb=Dr,m.srgba=zr),i.oes_texture_float&&(p.float32=p.float=Zr),i.oes_texture_half_float&&(p.float16=p["half float"]=Ir),i.webgl_depth_texture&&(t(m,{depth:Rr,"depth stencil":Er}),t(p,{uint16:$r,uint32:qr,"depth stencil":Pr})),i.webgl_compressed_texture_s3tc&&t(g,{"rgb s3tc dxt1":Br,"rgba s3tc dxt1":Vr,"rgba s3tc dxt3":_r,"rgba s3tc dxt5":Nr}),i.webgl_compressed_texture_atc&&t(g,{"rgb atc":Or,"rgba atc explicit alpha":Mr,"rgba atc interpolated alpha":jr}),i.webgl_compressed_texture_pvrtc&&t(g,{"rgb pvrtc 4bppv1":Fr,"rgb pvrtc 2bppv1":Wr,"rgba pvrtc 4bppv1":Lr,"rgba pvrtc 2bppv1":Ur}),i.webgl_compressed_texture_etc1&&(g["rgb etc1"]=Hr);var v=Array.prototype.slice.call(r.getParameter(dr));Object.keys(g).forEach((function(e){var t=g[e];v.indexOf(t)>=0&&(m[e]=t)}));var b=Object.keys(m);n.textureFormats=b;var x=[];Object.keys(m).forEach((function(e){var t=m[e];x[t]=e}));var y=[];Object.keys(p).forEach((function(e){var t=p[e];y[t]=e}));var w=[];Object.keys(f).forEach((function(e){var t=f[e];w[t]=e}));var T=[];Object.keys(d).forEach((function(e){var t=d[e];T[t]=e}));var S=[];Object.keys(c).forEach((function(e){var t=c[e];S[t]=e}));var k=b.reduce((function(e,t){var r=m[t];return r===xr||r===vr||r===xr||r===yr||r===Rr||r===Er||i.ext_srgb&&(r===Dr||r===zr)?e[r]=r:r===Tr||t.indexOf("rgba")>=0?e[r]=gr:e[r]=br,e}),{});function A(){this.internalformat=gr,this.format=gr,this.type=Gr,this.compressed=!1,this.premultiplyAlpha=!1,this.flipY=!1,this.unpackAlignment=1,this.colorSpace=vi,this.width=0,this.height=0,this.channels=0}function C(e,t){e.internalformat=t.internalformat,e.format=t.format,e.type=t.type,e.compressed=t.compressed,e.premultiplyAlpha=t.premultiplyAlpha,e.flipY=t.flipY,e.unpackAlignment=t.unpackAlignment,e.colorSpace=t.colorSpace,e.width=t.width,e.height=t.height,e.channels=t.channels}function P(e,t){if("object"==typeof t&&t){if("premultiplyAlpha"in t&&(re.type(t.premultiplyAlpha,"boolean","invalid premultiplyAlpha"),e.premultiplyAlpha=t.premultiplyAlpha),"flipY"in t&&(re.type(t.flipY,"boolean","invalid texture flip"),e.flipY=t.flipY),"alignment"in t&&(re.oneOf(t.alignment,[1,2,4,8],"invalid texture unpack alignment"),e.unpackAlignment=t.alignment),"colorSpace"in t&&(re.parameter(t.colorSpace,h,"invalid colorSpace"),e.colorSpace=h[t.colorSpace]),"type"in t){var r=t.type;re(i.oes_texture_float||!("float"===r||"float32"===r),"you must enable the OES_texture_float extension in order to use floating point textures."),re(i.oes_texture_half_float||!("half float"===r||"float16"===r),"you must enable the OES_texture_half_float extension in order to use 16-bit floating point textures."),re(i.webgl_depth_texture||!("uint16"===r||"uint32"===r||"depth stencil"===r),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),re.parameter(r,p,"invalid texture type"),e.type=p[r]}var a=e.width,o=e.height,s=e.channels,u=!1;"shape"in t?(re(Array.isArray(t.shape)&&t.shape.length>=2,"shape must be an array"),a=t.shape[0],o=t.shape[1],3===t.shape.length&&(s=t.shape[2],re(s>0&&s<=4,"invalid number of channels"),u=!0),re(a>=0&&a<=n.maxTextureSize,"invalid width"),re(o>=0&&o<=n.maxTextureSize,"invalid height")):("radius"in t&&(a=o=t.radius,re(a>=0&&a<=n.maxTextureSize,"invalid radius")),"width"in t&&(a=t.width,re(a>=0&&a<=n.maxTextureSize,"invalid width")),"height"in t&&(o=t.height,re(o>=0&&o<=n.maxTextureSize,"invalid height")),"channels"in t&&(s=t.channels,re(s>0&&s<=4,"invalid number of channels"),u=!0)),e.width=0|a,e.height=0|o,e.channels=0|s;var l=!1;if("format"in t){var c=t.format;re(i.webgl_depth_texture||!("depth"===c||"depth stencil"===c),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),re.parameter(c,m,"invalid texture format");var f=e.internalformat=m[c];e.format=k[f],c in p&&("type"in t||(e.type=p[c])),c in g&&(e.compressed=!0),l=!0}!u&&l?e.channels=wi[e.format]:u&&!l?e.channels!==yi[e.format]&&(e.format=e.internalformat=yi[e.channels]):l&&u&&re(e.channels===wi[e.format],"number of channels inconsistent with specified format")}}function R(e){r.pixelStorei(pi,e.flipY),r.pixelStorei(mi,e.premultiplyAlpha),r.pixelStorei(gi,e.colorSpace),r.pixelStorei(hi,e.unpackAlignment)}function E(){A.call(this),this.xOffset=0,this.yOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function D(t,r){var i=null;if(Wi(r)?i=r:r&&(re.type(r,"object","invalid pixel data type"),P(t,r),"x"in r&&(t.xOffset=0|r.x),"y"in r&&(t.yOffset=0|r.y),Wi(r.data)&&(i=r.data)),re(!t.compressed||i instanceof Uint8Array,"compressed texture data must be stored in a uint8array"),r.copy){re(!i,"can not specify copy and data field for the same texture");var a=o.viewportWidth,s=o.viewportHeight;t.width=t.width||a-t.xOffset,t.height=t.height||s-t.yOffset,t.needsCopy=!0,re(t.xOffset>=0&&t.xOffset<a&&t.yOffset>=0&&t.yOffset<s&&t.width>0&&t.width<=a&&t.height>0&&t.height<=s,"copy texture read out of bounds")}else if(i){if(e(i))t.channels=t.channels||4,t.data=i,"type"in r||t.type!==Gr||(t.type=Li(i));else if(Ii(i))t.channels=t.channels||4,Ui(t,i),t.alignment=1,t.needsFree=!0;else if(St(i)){var u=i.data;Array.isArray(u)||t.type!==Gr||(t.type=Li(u));var l,c,f,d,h,p,m=i.shape,g=i.stride;3===m.length?(f=m[2],p=g[2]):(re(2===m.length,"invalid ndarray pixel data, must be 2 or 3D"),f=1,p=1),l=m[0],c=m[1],d=g[0],h=g[1],t.alignment=1,t.width=l,t.height=c,t.channels=f,t.format=t.internalformat=yi[f],t.needsFree=!0,$i(t,u,d,h,p,i.offset)}else if(_i(i)||Ni(i)||Oi(i))_i(i)||Ni(i)?t.element=i:t.element=i.canvas,t.width=t.element.width,t.height=t.element.height,t.channels=4;else if(Mi(i))t.element=i,t.width=i.width,t.height=i.height,t.channels=4;else if(ji(i))t.element=i,t.width=i.naturalWidth,t.height=i.naturalHeight,t.channels=4;else if(Fi(i))t.element=i,t.width=i.videoWidth,t.height=i.videoHeight,t.channels=4;else if(Bi(i)){var v=t.width||i[0].length,b=t.height||i.length,x=t.channels;x=cr(i[0][0])?x||i[0][0].length:x||1;for(var y=At.shape(i),w=1,T=0;T<y.length;++T)w*=y[T];var S=Hi(t,w);At.flatten(i,y,"",S),Gi(t,S),t.alignment=1,t.width=v,t.height=b,t.channels=x,t.format=t.internalformat=yi[x],t.needsFree=!0}}else t.width=t.width||1,t.height=t.height||1,t.channels=t.channels||4;t.type===Zr?re(n.extensions.indexOf("oes_texture_float")>=0,"oes_texture_float extension not enabled"):t.type===Ir&&re(n.extensions.indexOf("oes_texture_half_float")>=0,"oes_texture_half_float extension not enabled")}function z(e,t,i){var n=e.element,o=e.data,s=e.internalformat,u=e.format,l=e.type,c=e.width,f=e.height;R(e),n?r.texImage2D(t,i,u,u,l,n):e.compressed?r.compressedTexImage2D(t,i,s,c,f,0,o):e.needsCopy?(a(),r.copyTexImage2D(t,i,u,e.xOffset,e.yOffset,c,f,0)):r.texImage2D(t,i,u,c,f,0,u,l,o||null)}function I(e,t,i,n,o){var s=e.element,u=e.data,l=e.internalformat,c=e.format,f=e.type,d=e.width,h=e.height;R(e),s?r.texSubImage2D(t,o,i,n,c,f,s):e.compressed?r.compressedTexSubImage2D(t,o,i,n,l,d,h,u):e.needsCopy?(a(),r.copyTexSubImage2D(t,o,i,n,e.xOffset,e.yOffset,d,h)):r.texSubImage2D(t,o,i,n,d,h,c,f,u)}var B=[];function V(){return B.pop()||new E}function _(e){e.needsFree&&Oe.freeType(e.data),E.call(e),B.push(e)}function N(){A.call(this),this.genMipmaps=!1,this.mipmapHint=li,this.mipmask=0,this.images=Array(16)}function O(e,t,r){var i=e.images[0]=V();e.mipmask=1,i.width=e.width=t,i.height=e.height=r,i.channels=e.channels=4}function M(e,t){var r=null;if(Wi(t))C(r=e.images[0]=V(),e),D(r,t),e.mipmask=1;else if(P(e,t),Array.isArray(t.mipmap))for(var i=t.mipmap,n=0;n<i.length;++n)C(r=e.images[n]=V(),e),r.width>>=n,r.height>>=n,D(r,i[n]),e.mipmask|=1<<n;else C(r=e.images[0]=V(),e),D(r,t),e.mipmask=1;C(e,e.images[0]),!e.compressed||e.internalformat!==Br&&e.internalformat!==Vr&&e.internalformat!==_r&&e.internalformat!==Nr||re(e.width%4==0&&e.height%4==0,"for compressed texture formats, mipmap level 0 must have width and height that are a multiple of 4")}function j(e,t){for(var r=e.images,i=0;i<r.length;++i){if(!r[i])return;z(r[i],t,i)}}var F=[];function W(){var e=F.pop()||new N;A.call(e),e.mipmask=0;for(var t=0;t<16;++t)e.images[t]=null;return e}function L(e){for(var t=e.images,r=0;r<t.length;++r)t[r]&&_(t[r]),t[r]=null;F.push(e)}function U(){this.minFilter=ri,this.magFilter=ri,this.wrapS=Kr,this.wrapT=Kr,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=li}function H(e,t){if("min"in t){var r=t.min;re.parameter(r,d),e.minFilter=d[r],xi.indexOf(e.minFilter)>=0&&!("faces"in t)&&(e.genMipmaps=!0)}if("mag"in t){var i=t.mag;re.parameter(i,f),e.magFilter=f[i]}var a=e.wrapS,o=e.wrapT;if("wrap"in t){var s=t.wrap;"string"==typeof s?(re.parameter(s,c),a=o=c[s]):Array.isArray(s)&&(re.parameter(s[0],c),re.parameter(s[1],c),a=c[s[0]],o=c[s[1]])}else{if("wrapS"in t){var u=t.wrapS;re.parameter(u,c),a=c[u]}if("wrapT"in t){var h=t.wrapT;re.parameter(h,c),o=c[h]}}if(e.wrapS=a,e.wrapT=o,"anisotropic"in t){var p=t.anisotropic;re("number"==typeof p&&p>=1&&p<=n.maxAnisotropic,"aniso samples must be between 1 and "),e.anisotropic=t.anisotropic}if("mipmap"in t){var m=!1;switch(typeof t.mipmap){case"string":re.parameter(t.mipmap,l,"invalid mipmap hint"),e.mipmapHint=l[t.mipmap],e.genMipmaps=!0,m=!0;break;case"boolean":m=e.genMipmaps=t.mipmap;break;case"object":re(Array.isArray(t.mipmap),"invalid mipmap type"),e.genMipmaps=!1,m=!0;break;default:re.raise("invalid mipmap type")}m&&!("min"in t)&&(e.minFilter=ni)}}function G(e,t){r.texParameteri(t,ti,e.minFilter),r.texParameteri(t,ei,e.magFilter),r.texParameteri(t,Xr,e.wrapS),r.texParameteri(t,Yr,e.wrapT),i.ext_texture_filter_anisotropic&&r.texParameteri(t,di,e.anisotropic),e.genMipmaps&&(r.hint(ui,e.mipmapHint),r.generateMipmap(t))}var $=0,q={},Z=n.maxTextureUnits,X=Array(Z).map((function(){return null}));function Y(e){A.call(this),this.mipmask=0,this.internalformat=gr,this.id=$++,this.refCount=1,this.target=e,this.texture=r.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new U,u.profile&&(this.stats={size:0})}function Q(e){r.activeTexture(bi),r.bindTexture(e.target,e.texture)}function K(){var e=X[0];e?r.bindTexture(e.target,e.texture):r.bindTexture(hr,null)}function J(e){var t=e.texture;re(t,"must not double destroy texture");var i=e.unit,n=e.target;i>=0&&(r.activeTexture(bi+i),r.bindTexture(n,null),X[i]=null),r.deleteTexture(t),e.texture=null,e.params=null,e.pixels=null,e.refCount=0,delete q[e.id],s.textureCount--}function ee(e,t){var i=new Y(hr);function a(e,t){var r=i.texInfo;U.call(r);var o=W();return"number"==typeof e?O(o,0|e,"number"==typeof t?0|t:0|e):e?(re.type(e,"object","invalid arguments to regl.texture"),H(r,e),M(o,e)):O(o,1,1),r.genMipmaps&&(o.mipmask=(o.width<<1)-1),i.mipmask=o.mipmask,C(i,o),re.texture2D(r,o,n),i.internalformat=o.internalformat,a.width=o.width,a.height=o.height,Q(i),j(o,hr),G(r,hr),K(),L(o),u.profile&&(i.stats.size=qi(i.internalformat,i.type,o.width,o.height,r.genMipmaps,!1)),a.format=x[i.internalformat],a.type=y[i.type],a.mag=w[r.magFilter],a.min=T[r.minFilter],a.wrapS=S[r.wrapS],a.wrapT=S[r.wrapT],a}function o(e,t,r,n){re(!!e,"must specify image data");var o=0|t,s=0|r,u=0|n,l=V();return C(l,i),l.width=0,l.height=0,D(l,e),l.width=l.width||(i.width>>u)-o,l.height=l.height||(i.height>>u)-s,re(i.type===l.type&&i.format===l.format&&i.internalformat===l.internalformat,"incompatible format for texture.subimage"),re(o>=0&&s>=0&&o+l.width<=i.width&&s+l.height<=i.height,"texture.subimage write out of bounds"),re(i.mipmask&1<<u,"missing mipmap data"),re(l.data||l.element||l.needsCopy,"missing image data"),Q(i),I(l,hr,o,s,u),K(),_(l),a}function l(e,t){var n=0|e,o=0|t||n;if(n===i.width&&o===i.height)return a;a.width=i.width=n,a.height=i.height=o,Q(i);for(var s=0;i.mipmask>>s;++s){var l=n>>s,c=o>>s;if(!l||!c)break;r.texImage2D(hr,s,i.format,l,c,0,i.format,i.type,null)}return K(),u.profile&&(i.stats.size=qi(i.internalformat,i.type,n,o,!1,!1)),a}return q[i.id]=i,s.textureCount++,a(e,t),a.subimage=o,a.resize=l,a._reglType="texture2d",a._texture=i,u.profile&&(a.stats=i.stats),a.destroy=function(){i.decRef()},a}function te(e,t,i,a,o,l){var c=new Y(pr);q[c.id]=c,s.cubeCount++;var f=new Array(6);function d(e,t,r,i,a,o){var s,l=c.texInfo;for(U.call(l),s=0;s<6;++s)f[s]=W();if("number"!=typeof e&&e)if("object"==typeof e)if(t)M(f[0],e),M(f[1],t),M(f[2],r),M(f[3],i),M(f[4],a),M(f[5],o);else if(H(l,e),P(c,e),"faces"in e){var h=e.faces;for(re(Array.isArray(h)&&6===h.length,"cube faces must be a length 6 array"),s=0;s<6;++s)re("object"==typeof h[s]&&!!h[s],"invalid input for cube map face"),C(f[s],c),M(f[s],h[s])}else for(s=0;s<6;++s)M(f[s],e);else re.raise("invalid arguments to cube map");else{var p=0|e||1;for(s=0;s<6;++s)O(f[s],p,p)}for(C(c,f[0]),re.optional((function(){n.npotTextureCube||re(fr(c.width)&&fr(c.height),"your browser does not support non power or two texture dimensions")})),l.genMipmaps?c.mipmask=(f[0].width<<1)-1:c.mipmask=f[0].mipmask,re.textureCube(c,l,f,n),c.internalformat=f[0].internalformat,d.width=f[0].width,d.height=f[0].height,Q(c),s=0;s<6;++s)j(f[s],mr+s);for(G(l,pr),K(),u.profile&&(c.stats.size=qi(c.internalformat,c.type,d.width,d.height,l.genMipmaps,!0)),d.format=x[c.internalformat],d.type=y[c.type],d.mag=w[l.magFilter],d.min=T[l.minFilter],d.wrapS=S[l.wrapS],d.wrapT=S[l.wrapT],s=0;s<6;++s)L(f[s]);return d}function h(e,t,r,i,n){re(!!t,"must specify image data"),re("number"==typeof e&&e===(0|e)&&e>=0&&e<6,"invalid face");var a=0|r,o=0|i,s=0|n,u=V();return C(u,c),u.width=0,u.height=0,D(u,t),u.width=u.width||(c.width>>s)-a,u.height=u.height||(c.height>>s)-o,re(c.type===u.type&&c.format===u.format&&c.internalformat===u.internalformat,"incompatible format for texture.subimage"),re(a>=0&&o>=0&&a+u.width<=c.width&&o+u.height<=c.height,"texture.subimage write out of bounds"),re(c.mipmask&1<<s,"missing mipmap data"),re(u.data||u.element||u.needsCopy,"missing image data"),Q(c),I(u,mr+e,a,o,s),K(),_(u),d}function p(e){var t=0|e;if(t!==c.width){d.width=c.width=t,d.height=c.height=t,Q(c);for(var i=0;i<6;++i)for(var n=0;c.mipmask>>n;++n)r.texImage2D(mr+i,n,c.format,t>>n,t>>n,0,c.format,c.type,null);return K(),u.profile&&(c.stats.size=qi(c.internalformat,c.type,d.width,d.height,!1,!0)),d}}return d(e,t,i,a,o,l),d.subimage=h,d.resize=p,d._reglType="textureCube",d._texture=c,u.profile&&(d.stats=c.stats),d.destroy=function(){c.decRef()},d}function ie(){for(var e=0;e<Z;++e)r.activeTexture(bi+e),r.bindTexture(hr,null),X[e]=null;kt(q).forEach(J),s.cubeCount=0,s.textureCount=0}function ne(){for(var e=0;e<Z;++e){var t=X[e];t&&(t.bindCount=0,t.unit=-1,X[e]=null)}kt(q).forEach((function(e){e.texture=r.createTexture(),r.bindTexture(e.target,e.texture);for(var t=0;t<32;++t)if(0!=(e.mipmask&1<<t))if(e.target===hr)r.texImage2D(hr,t,e.internalformat,e.width>>t,e.height>>t,0,e.internalformat,e.type,null);else for(var i=0;i<6;++i)r.texImage2D(mr+i,t,e.internalformat,e.width>>t,e.height>>t,0,e.internalformat,e.type,null);G(e.texInfo,e.target)}))}function ae(){for(var e=0;e<Z;++e){var t=X[e];t&&(t.bindCount=0,t.unit=-1,X[e]=null),r.activeTexture(bi+e),r.bindTexture(hr,null),r.bindTexture(pr,null)}}return t(Y.prototype,{bind:function(){var e=this;e.bindCount+=1;var t=e.unit;if(t<0){for(var i=0;i<Z;++i){var n=X[i];if(n){if(n.bindCount>0)continue;n.unit=-1}X[i]=e,t=i;break}t>=Z&&re.raise("insufficient number of texture units"),u.profile&&s.maxTextureUnits<t+1&&(s.maxTextureUnits=t+1),e.unit=t,r.activeTexture(bi+t),r.bindTexture(e.target,e.texture)}return t},unbind:function(){this.bindCount-=1},decRef:function(){--this.refCount<=0&&J(this)}}),u.profile&&(s.getTotalTextureSize=function(){var e=0;return Object.keys(q).forEach((function(t){e+=q[t].stats.size})),e}),{create2D:ee,createCube:te,clear:ie,getTexture:function(e){return null},restore:ne,refresh:ae}}zi[wr]=2,zi[Tr]=2,zi[Sr]=2,zi[Er]=4,zi[Br]=.5,zi[Vr]=.5,zi[_r]=1,zi[Nr]=1,zi[Or]=.5,zi[Mr]=1,zi[jr]=1,zi[Fr]=.5,zi[Wr]=.25,zi[Lr]=.5,zi[Ur]=.25,zi[Hr]=.5;var Xi=36161,Yi=32854,Qi=32855,Ki=36194,Ji=33189,en=36168,tn=34041,rn=35907,nn=34836,an=34842,on=34843,sn=[];function un(e,t,r){return sn[e]*t*r}sn[Yi]=2,sn[Qi]=2,sn[Ki]=2,sn[Ji]=2,sn[en]=1,sn[tn]=4,sn[rn]=4,sn[nn]=16,sn[an]=8,sn[on]=6;var ln=function(e,t,r,i,n){var a={rgba4:Yi,rgb565:Ki,"rgb5 a1":Qi,depth:Ji,stencil:en,"depth stencil":tn};t.ext_srgb&&(a.srgba=rn),t.ext_color_buffer_half_float&&(a.rgba16f=an,a.rgb16f=on),t.webgl_color_buffer_float&&(a.rgba32f=nn);var o=[];Object.keys(a).forEach((function(e){var t=a[e];o[t]=e}));var s=0,u={};function l(e){this.id=s++,this.refCount=1,this.renderbuffer=e,this.format=Yi,this.width=0,this.height=0,n.profile&&(this.stats={size:0})}function c(t){var r=t.renderbuffer;re(r,"must not double destroy renderbuffer"),e.bindRenderbuffer(Xi,null),e.deleteRenderbuffer(r),t.renderbuffer=null,t.refCount=0,delete u[t.id],i.renderbufferCount--}function f(t,s){var c=new l(e.createRenderbuffer());function f(t,i){var s=0,u=0,l=Yi;if("object"==typeof t&&t){var d=t;if("shape"in d){var h=d.shape;re(Array.isArray(h)&&h.length>=2,"invalid renderbuffer shape"),s=0|h[0],u=0|h[1]}else"radius"in d&&(s=u=0|d.radius),"width"in d&&(s=0|d.width),"height"in d&&(u=0|d.height);"format"in d&&(re.parameter(d.format,a,"invalid renderbuffer format"),l=a[d.format])}else"number"==typeof t?(s=0|t,u="number"==typeof i?0|i:s):t?re.raise("invalid arguments to renderbuffer constructor"):s=u=1;if(re(s>0&&u>0&&s<=r.maxRenderbufferSize&&u<=r.maxRenderbufferSize,"invalid renderbuffer size"),s!==c.width||u!==c.height||l!==c.format)return f.width=c.width=s,f.height=c.height=u,c.format=l,e.bindRenderbuffer(Xi,c.renderbuffer),e.renderbufferStorage(Xi,l,s,u),re(0===e.getError(),"invalid render buffer format"),n.profile&&(c.stats.size=un(c.format,c.width,c.height)),f.format=o[c.format],f}function d(t,i){var a=0|t,o=0|i||a;return a===c.width&&o===c.height||(re(a>0&&o>0&&a<=r.maxRenderbufferSize&&o<=r.maxRenderbufferSize,"invalid renderbuffer size"),f.width=c.width=a,f.height=c.height=o,e.bindRenderbuffer(Xi,c.renderbuffer),e.renderbufferStorage(Xi,c.format,a,o),re(0===e.getError(),"invalid render buffer format"),n.profile&&(c.stats.size=un(c.format,c.width,c.height))),f}return u[c.id]=c,i.renderbufferCount++,f(t,s),f.resize=d,f._reglType="renderbuffer",f._renderbuffer=c,n.profile&&(f.stats=c.stats),f.destroy=function(){c.decRef()},f}function d(){kt(u).forEach((function(t){t.renderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(Xi,t.renderbuffer),e.renderbufferStorage(Xi,t.format,t.width,t.height)})),e.bindRenderbuffer(Xi,null)}return l.prototype.decRef=function(){--this.refCount<=0&&c(this)},n.profile&&(i.getTotalRenderbufferSize=function(){var e=0;return Object.keys(u).forEach((function(t){e+=u[t].stats.size})),e}),{create:f,clear:function(){kt(u).forEach(c)},restore:d}},cn=36160,fn=36161,dn=3553,hn=34069,pn=36064,mn=36096,gn=36128,vn=33306,bn=36053,xn=36054,yn=36055,wn=36057,Tn=36061,Sn=36193,kn=5121,An=5126,Cn=6407,Pn=6408,Rn=6402,En=[Cn,Pn],Dn=[];Dn[Pn]=4,Dn[Cn]=3;var zn=[];zn[kn]=1,zn[An]=4,zn[Sn]=2;var In=33189,Bn=36168,Vn=34041,_n=[32854,32855,36194,35907,34842,34843,34836],Nn={};function On(e,r,i,n,a,o){var s={cur:null,next:null,dirty:!1,setFBO:null},u=["rgba"],l=["rgba4","rgb565","rgb5 a1"];r.ext_srgb&&l.push("srgba"),r.ext_color_buffer_half_float&&l.push("rgba16f","rgb16f"),r.webgl_color_buffer_float&&l.push("rgba32f");var c=["uint8"];function f(e,t,r){this.target=e,this.texture=t,this.renderbuffer=r;var i=0,n=0;t?(i=t.width,n=t.height):r&&(i=r.width,n=r.height),this.width=i,this.height=n}function d(e){e&&(e.texture&&e.texture._texture.decRef(),e.renderbuffer&&e.renderbuffer._renderbuffer.decRef())}function h(e,t,r){if(e)if(e.texture){var i=e.texture._texture,n=Math.max(1,i.width),a=Math.max(1,i.height);re(n===t&&a===r,"inconsistent width/height for supplied texture"),i.refCount+=1}else{var o=e.renderbuffer._renderbuffer;re(o.width===t&&o.height===r,"inconsistent width/height for renderbuffer"),o.refCount+=1}}function p(t,r){r&&(r.texture?e.framebufferTexture2D(cn,t,r.target,r.texture._texture.texture,0):e.framebufferRenderbuffer(cn,t,fn,r.renderbuffer._renderbuffer.renderbuffer))}function m(e){var t=dn,r=null,i=null,n=e;"object"==typeof e&&(n=e.data,"target"in e&&(t=0|e.target)),re.type(n,"function","invalid attachment data");var a=n._reglType;return"texture2d"===a?(r=n,re(t===dn)):"textureCube"===a?(r=n,re(t>=hn&&t<hn+6,"invalid cube map target")):"renderbuffer"===a?(i=n,t=fn):re.raise("invalid regl object for attachment"),new f(t,r,i)}function g(e,t,r,i,o){if(r){var s=n.create2D({width:e,height:t,format:i,type:o});return s._texture.refCount=0,new f(dn,s,null)}var u=a.create({width:e,height:t,format:i});return u._renderbuffer.refCount=0,new f(fn,null,u)}function v(e){return e&&(e.texture||e.renderbuffer)}function b(e,t,r){e&&(e.texture?e.texture.resize(t,r):e.renderbuffer&&e.renderbuffer.resize(t,r),e.width=t,e.height=r)}r.oes_texture_half_float&&c.push("half float","float16"),r.oes_texture_float&&c.push("float","float32");var x=0,y={};function w(){this.id=x++,y[this.id]=this,this.framebuffer=e.createFramebuffer(),this.width=0,this.height=0,this.colorAttachments=[],this.depthAttachment=null,this.stencilAttachment=null,this.depthStencilAttachment=null}function T(e){e.colorAttachments.forEach(d),d(e.depthAttachment),d(e.stencilAttachment),d(e.depthStencilAttachment)}function S(t){var r=t.framebuffer;re(r,"must not double destroy framebuffer"),e.deleteFramebuffer(r),t.framebuffer=null,o.framebufferCount--,delete y[t.id]}function k(t){var r;e.bindFramebuffer(cn,t.framebuffer);var n=t.colorAttachments;for(r=0;r<n.length;++r)p(pn+r,n[r]);for(r=n.length;r<i.maxColorAttachments;++r)e.framebufferTexture2D(cn,pn+r,dn,null,0);e.framebufferTexture2D(cn,vn,dn,null,0),e.framebufferTexture2D(cn,mn,dn,null,0),e.framebufferTexture2D(cn,gn,dn,null,0),p(mn,t.depthAttachment),p(gn,t.stencilAttachment),p(vn,t.depthStencilAttachment);var a=e.checkFramebufferStatus(cn);e.isContextLost()||a===bn||re.raise("framebuffer configuration not supported, status = "+Nn[a]),e.bindFramebuffer(cn,s.next?s.next.framebuffer:null),s.cur=s.next,e.getError()}function A(e,n){var a=new w;function f(e,t){var n;re(s.next!==a,"can not update framebuffer which is currently in use");var o=0,d=0,p=!0,b=!0,x=null,y=!0,w="rgba",S="uint8",A=1,C=null,P=null,R=null,E=!1;if("number"==typeof e)o=0|e,d=0|t||o;else if(e){re.type(e,"object","invalid arguments for framebuffer");var D=e;if("shape"in D){var z=D.shape;re(Array.isArray(z)&&z.length>=2,"invalid shape for framebuffer"),o=z[0],d=z[1]}else"radius"in D&&(o=d=D.radius),"width"in D&&(o=D.width),"height"in D&&(d=D.height);("color"in D||"colors"in D)&&(x=D.color||D.colors,Array.isArray(x)&&re(1===x.length||r.webgl_draw_buffers,"multiple render targets not supported")),x||("colorCount"in D&&(A=0|D.colorCount,re(A>0,"invalid color buffer count")),"colorTexture"in D&&(y=!!D.colorTexture,w="rgba4"),"colorType"in D&&(S=D.colorType,y?(re(r.oes_texture_float||!("float"===S||"float32"===S),"you must enable OES_texture_float in order to use floating point framebuffer objects"),re(r.oes_texture_half_float||!("half float"===S||"float16"===S),"you must enable OES_texture_half_float in order to use 16-bit floating point framebuffer objects")):"half float"===S||"float16"===S?(re(r.ext_color_buffer_half_float,"you must enable EXT_color_buffer_half_float to use 16-bit render buffers"),w="rgba16f"):"float"!==S&&"float32"!==S||(re(r.webgl_color_buffer_float,"you must enable WEBGL_color_buffer_float in order to use 32-bit floating point renderbuffers"),w="rgba32f"),re.oneOf(S,c,"invalid color type")),"colorFormat"in D&&(w=D.colorFormat,u.indexOf(w)>=0?y=!0:l.indexOf(w)>=0?y=!1:re.optional((function(){y?re.oneOf(D.colorFormat,u,"invalid color format for texture"):re.oneOf(D.colorFormat,l,"invalid color format for renderbuffer")})))),("depthTexture"in D||"depthStencilTexture"in D)&&(E=!(!D.depthTexture&&!D.depthStencilTexture),re(!E||r.webgl_depth_texture,"webgl_depth_texture extension not supported")),"depth"in D&&("boolean"==typeof D.depth?p=D.depth:(C=D.depth,b=!1)),"stencil"in D&&("boolean"==typeof D.stencil?b=D.stencil:(P=D.stencil,p=!1)),"depthStencil"in D&&("boolean"==typeof D.depthStencil?p=b=D.depthStencil:(R=D.depthStencil,p=!1,b=!1))}else o=d=1;var I=null,B=null,V=null,_=null;if(Array.isArray(x))I=x.map(m);else if(x)I=[m(x)];else for(I=new Array(A),n=0;n<A;++n)I[n]=g(o,d,y,w,S);re(r.webgl_draw_buffers||I.length<=1,"you must enable the WEBGL_draw_buffers extension in order to use multiple color buffers."),re(I.length<=i.maxColorAttachments,"too many color attachments, not supported"),o=o||I[0].width,d=d||I[0].height,C?B=m(C):p&&!b&&(B=g(o,d,E,"depth","uint32")),P?V=m(P):b&&!p&&(V=g(o,d,!1,"stencil","uint8")),R?_=m(R):!C&&!P&&b&&p&&(_=g(o,d,E,"depth stencil","depth stencil")),re(!!C+!!P+!!R<=1,"invalid framebuffer configuration, can specify exactly one depth/stencil attachment");var N=null;for(n=0;n<I.length;++n)if(h(I[n],o,d),re(!I[n]||I[n].texture&&En.indexOf(I[n].texture._texture.format)>=0||I[n].renderbuffer&&_n.indexOf(I[n].renderbuffer._renderbuffer.format)>=0,"framebuffer color attachment "+n+" is invalid"),I[n]&&I[n].texture){var O=Dn[I[n].texture._texture.format]*zn[I[n].texture._texture.type];null===N?N=O:re(N===O,"all color attachments much have the same number of bits per pixel.")}return h(B,o,d),re(!B||B.texture&&B.texture._texture.format===Rn||B.renderbuffer&&B.renderbuffer._renderbuffer.format===In,"invalid depth attachment for framebuffer object"),h(V,o,d),re(!V||V.renderbuffer&&V.renderbuffer._renderbuffer.format===Bn,"invalid stencil attachment for framebuffer object"),h(_,o,d),re(!_||_.texture&&_.texture._texture.format===Vn||_.renderbuffer&&_.renderbuffer._renderbuffer.format===Vn,"invalid depth-stencil attachment for framebuffer object"),T(a),a.width=o,a.height=d,a.colorAttachments=I,a.depthAttachment=B,a.stencilAttachment=V,a.depthStencilAttachment=_,f.color=I.map(v),f.depth=v(B),f.stencil=v(V),f.depthStencil=v(_),f.width=a.width,f.height=a.height,k(a),f}function d(e,t){re(s.next!==a,"can not resize a framebuffer which is currently in use");var r=Math.max(0|e,1),i=Math.max(0|t||r,1);if(r===a.width&&i===a.height)return f;for(var n=a.colorAttachments,o=0;o<n.length;++o)b(n[o],r,i);return b(a.depthAttachment,r,i),b(a.stencilAttachment,r,i),b(a.depthStencilAttachment,r,i),a.width=f.width=r,a.height=f.height=i,k(a),f}return o.framebufferCount++,f(e,n),t(f,{resize:d,_reglType:"framebuffer",_framebuffer:a,destroy:function(){S(a),T(a)},use:function(e){s.setFBO({framebuffer:f},e)}})}function C(e){var a=Array(6);function o(e){var i;re(a.indexOf(s.next)<0,"can not update framebuffer which is currently in use");var l,f={color:null},d=0,h=null,p="rgba",m="uint8",g=1;if("number"==typeof e)d=0|e;else if(e){re.type(e,"object","invalid arguments for framebuffer");var v=e;if("shape"in v){var b=v.shape;re(Array.isArray(b)&&b.length>=2,"invalid shape for framebuffer"),re(b[0]===b[1],"cube framebuffer must be square"),d=b[0]}else"radius"in v&&(d=0|v.radius),"width"in v?(d=0|v.width,"height"in v&&re(v.height===d,"must be square")):"height"in v&&(d=0|v.height);("color"in v||"colors"in v)&&(h=v.color||v.colors,Array.isArray(h)&&re(1===h.length||r.webgl_draw_buffers,"multiple render targets not supported")),h||("colorCount"in v&&(g=0|v.colorCount,re(g>0,"invalid color buffer count")),"colorType"in v&&(re.oneOf(v.colorType,c,"invalid color type"),m=v.colorType),"colorFormat"in v&&(p=v.colorFormat,re.oneOf(v.colorFormat,u,"invalid color format for texture"))),"depth"in v&&(f.depth=v.depth),"stencil"in v&&(f.stencil=v.stencil),"depthStencil"in v&&(f.depthStencil=v.depthStencil)}else d=1;if(h)if(Array.isArray(h))for(l=[],i=0;i<h.length;++i)l[i]=h[i];else l=[h];else{l=Array(g);var x={radius:d,format:p,type:m};for(i=0;i<g;++i)l[i]=n.createCube(x)}for(f.color=Array(l.length),i=0;i<l.length;++i){var y=l[i];re("function"==typeof y&&"textureCube"===y._reglType,"invalid cube map"),d=d||y.width,re(y.width===d&&y.height===d,"invalid cube map shape"),f.color[i]={target:hn,data:l[i]}}for(i=0;i<6;++i){for(var w=0;w<l.length;++w)f.color[w].target=hn+i;i>0&&(f.depth=a[0].depth,f.stencil=a[0].stencil,f.depthStencil=a[0].depthStencil),a[i]?a[i](f):a[i]=A(f)}return t(o,{width:d,height:d,color:l})}function l(e){var t,r=0|e;if(re(r>0&&r<=i.maxCubeMapSize,"invalid radius for cube fbo"),r===o.width)return o;var n=o.color;for(t=0;t<n.length;++t)n[t].resize(r);for(t=0;t<6;++t)a[t].resize(r);return o.width=o.height=r,o}return o(e),t(o,{faces:a,resize:l,_reglType:"framebufferCube",destroy:function(){a.forEach((function(e){e.destroy()}))}})}function P(){s.cur=null,s.next=null,s.dirty=!0,kt(y).forEach((function(t){t.framebuffer=e.createFramebuffer(),k(t)}))}return t(s,{getFramebuffer:function(e){if("function"==typeof e&&"framebuffer"===e._reglType){var t=e._framebuffer;if(t instanceof w)return t}return null},create:A,createCube:C,clear:function(){kt(y).forEach(S)},restore:P})}Nn[bn]="complete",Nn[xn]="incomplete attachment",Nn[wn]="incomplete dimensions",Nn[yn]="incomplete, missing attachment",Nn[Tn]="unsupported";var Mn=5126,jn=34962,Fn=34963,Wn=["attributes","elements","offset","count","primitive","instances"];function Ln(){this.state=0,this.x=0,this.y=0,this.z=0,this.w=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=Mn,this.offset=0,this.stride=0,this.divisor=0}function Un(t,r,i,n,a,o,s){for(var u=i.maxAttributes,l=new Array(u),c=0;c<u;++c)l[c]=new Ln;var f=0,d={},h={Record:Ln,scope:{},state:l,currentVAO:null,targetVAO:null,restore:m()?T:function(){},createVAO:S,getVAO:v,destroyBuffer:p,setVAO:m()?b:x,clear:m()?y:function(){}};function p(e){for(var r=0;r<l.length;++r){var i=l[r];i.buffer===e&&(t.disableVertexAttribArray(r),i.buffer=null)}}function m(){return r.oes_vertex_array_object}function g(){return r.angle_instanced_arrays}function v(e){return"function"==typeof e&&e._vao?e._vao:null}function b(e){if(e!==h.currentVAO){var t=m();e?t.bindVertexArrayOES(e.vao):t.bindVertexArrayOES(null),h.currentVAO=e}}function x(e){if(e!==h.currentVAO){if(e)e.bindAttrs();else{for(var r=g(),i=0;i<l.length;++i){var n=l[i];n.buffer?(t.enableVertexAttribArray(i),n.buffer.bind(),t.vertexAttribPointer(i,n.size,n.type,n.normalized,n.stride,n.offfset),r&&n.divisor&&r.vertexAttribDivisorANGLE(i,n.divisor)):(t.disableVertexAttribArray(i),t.vertexAttrib4f(i,n.x,n.y,n.z,n.w))}s.elements?t.bindBuffer(Fn,s.elements.buffer.buffer):t.bindBuffer(Fn,null)}h.currentVAO=e}}function y(){kt(d).forEach((function(e){e.destroy()}))}function w(){this.id=++f,this.attributes=[],this.elements=null,this.ownsElements=!1,this.count=0,this.offset=0,this.instances=-1,this.primitive=4;var e=m();this.vao=e?e.createVertexArrayOES():null,d[this.id]=this,this.buffers=[]}function T(){m()&&kt(d).forEach((function(e){e.refresh()}))}function S(t){var i=new w;function s(t){var n;if(Array.isArray(t))n=t,i.elements&&i.ownsElements&&i.elements.destroy(),i.elements=null,i.ownsElements=!1,i.offset=0,i.count=0,i.instances=-1,i.primitive=4;else{if(re("object"==typeof t,"invalid arguments for create vao"),re("attributes"in t,"must specify attributes for vao"),t.elements){var l=t.elements;i.ownsElements?"function"==typeof l&&"elements"===l._reglType?(i.elements.destroy(),i.ownsElements=!1):(i.elements(l),i.ownsElements=!1):o.getElements(t.elements)?(i.elements=t.elements,i.ownsElements=!1):(i.elements=o.create(t.elements),i.ownsElements=!0)}else i.elements=null,i.ownsElements=!1;n=t.attributes,i.offset=0,i.count=-1,i.instances=-1,i.primitive=4,i.elements&&(i.count=i.elements._elements.vertCount,i.primitive=i.elements._elements.primType),"offset"in t&&(i.offset=0|t.offset),"count"in t&&(i.count=0|t.count),"instances"in t&&(i.instances=0|t.instances),"primitive"in t&&(re(t.primitive in $t,"bad primitive type: "+t.primitive),i.primitive=$t[t.primitive]),re.optional((()=>{for(var e=Object.keys(t),r=0;r<e.length;++r)re(Wn.indexOf(e[r])>=0,'invalid option for vao: "'+e[r]+'" valid options are '+Wn)})),re(Array.isArray(n),"attributes must be an array")}re(n.length<u,"too many attributes"),re(n.length>0,"must specify at least one attribute");var c={},f=i.attributes;f.length=n.length;for(var d=0;d<n.length;++d){var h,p=n[d],m=f[d]=new Ln,g=p.data||p;Array.isArray(g)||e(g)||St(g)?(i.buffers[d]&&(h=i.buffers[d],e(g)&&h._buffer.byteLength>=g.byteLength?h.subdata(g):(h.destroy(),i.buffers[d]=null)),i.buffers[d]||(h=i.buffers[d]=a.create(p,jn,!1,!0)),m.buffer=a.getBuffer(h),m.size=0|m.buffer.dimension,m.normalized=!1,m.type=m.buffer.dtype,m.offset=0,m.stride=0,m.divisor=0,m.state=1,c[d]=1):a.getBuffer(p)?(m.buffer=a.getBuffer(p),m.size=0|m.buffer.dimension,m.normalized=!1,m.type=m.buffer.dtype,m.offset=0,m.stride=0,m.divisor=0,m.state=1):a.getBuffer(p.buffer)?(m.buffer=a.getBuffer(p.buffer),m.size=0|(+p.size||m.buffer.dimension),m.normalized=!!p.normalized||!1,"type"in p?(re.parameter(p.type,Bt,"invalid buffer type"),m.type=Bt[p.type]):m.type=m.buffer.dtype,m.offset=0|(p.offset||0),m.stride=0|(p.stride||0),m.divisor=0|(p.divisor||0),m.state=1,re(m.size>=1&&m.size<=4,"size must be between 1 and 4"),re(m.offset>=0,"invalid offset"),re(m.stride>=0&&m.stride<=255,"stride must be between 0 and 255"),re(m.divisor>=0,"divisor must be positive"),re(!m.divisor||!!r.angle_instanced_arrays,"ANGLE_instanced_arrays must be enabled to use divisor")):"x"in p?(re(d>0,"first attribute must not be a constant"),m.x=+p.x||0,m.y=+p.y||0,m.z=+p.z||0,m.w=+p.w||0,m.state=2):re(!1,"invalid attribute spec for location "+d)}for(var v=0;v<i.buffers.length;++v)!c[v]&&i.buffers[v]&&(i.buffers[v].destroy(),i.buffers[v]=null);return i.refresh(),s}return n.vaoCount+=1,s.destroy=function(){for(var e=0;e<i.buffers.length;++e)i.buffers[e]&&i.buffers[e].destroy();i.buffers.length=0,i.ownsElements&&(i.elements.destroy(),i.elements=null,i.ownsElements=!1),i.destroy()},s._vao=i,s._reglType="vao",s(t)}return w.prototype.bindAttrs=function(){for(var e=g(),r=this.attributes,i=0;i<r.length;++i){var n=r[i];n.buffer?(t.enableVertexAttribArray(i),t.bindBuffer(jn,n.buffer.buffer),t.vertexAttribPointer(i,n.size,n.type,n.normalized,n.stride,n.offset),e&&n.divisor&&e.vertexAttribDivisorANGLE(i,n.divisor)):(t.disableVertexAttribArray(i),t.vertexAttrib4f(i,n.x,n.y,n.z,n.w))}for(var a=r.length;a<u;++a)t.disableVertexAttribArray(a);var s=o.getElements(this.elements);s?t.bindBuffer(Fn,s.buffer.buffer):t.bindBuffer(Fn,null)},w.prototype.refresh=function(){var e=m();e&&(e.bindVertexArrayOES(this.vao),this.bindAttrs(),h.currentVAO=null,e.bindVertexArrayOES(null))},w.prototype.destroy=function(){if(this.vao){var e=m();this===h.currentVAO&&(h.currentVAO=null,e.bindVertexArrayOES(null)),e.deleteVertexArrayOES(this.vao),this.vao=null}this.ownsElements&&(this.elements.destroy(),this.elements=null,this.ownsElements=!1),d[this.id]&&(delete d[this.id],n.vaoCount-=1)},h}var Hn=35632,Gn=35633,$n=35718,qn=35721;function Zn(e,r,i,n){var a={},o={};function s(e,t,r,i){this.name=e,this.id=t,this.location=r,this.info=i}function u(e,t){for(var r=0;r<e.length;++r)if(e[r].id===t.id)return void(e[r].location=t.location);e.push(t)}function l(t,i,n){var s=t===Hn?a:o,u=s[i];if(!u){var l=r.str(i);u=e.createShader(t),e.shaderSource(u,l),e.compileShader(u),re.shaderError(e,u,l,t,n),s[i]=u}return u}var c={},f=[],d=0;function h(e,t){this.id=d++,this.fragId=e,this.vertId=t,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,n.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function p(t,i,a){var o,c,f=l(Hn,t.fragId),d=l(Gn,t.vertId),h=t.program=e.createProgram();if(e.attachShader(h,f),e.attachShader(h,d),a)for(o=0;o<a.length;++o){var p=a[o];e.bindAttribLocation(h,p[0],p[1])}e.linkProgram(h),re.linkError(e,h,r.str(t.fragId),r.str(t.vertId),i);var m=e.getProgramParameter(h,$n);n.profile&&(t.stats.uniformsCount=m);var g=t.uniforms;for(o=0;o<m;++o)if(c=e.getActiveUniform(h,o)){if(c.size>1)for(var v=0;v<c.size;++v){var b=c.name.replace("[0]","["+v+"]");u(g,new s(b,r.id(b),e.getUniformLocation(h,b),c))}var x=c.name;c.size>1&&(x=x.replace("[0]","")),u(g,new s(x,r.id(x),e.getUniformLocation(h,x),c))}var y=e.getProgramParameter(h,qn);n.profile&&(t.stats.attributesCount=y);var w=t.attributes;for(o=0;o<y;++o)(c=e.getActiveAttrib(h,o))&&u(w,new s(c.name,r.id(c.name),e.getAttribLocation(h,c.name),c))}function m(){a={},o={};for(var e=0;e<f.length;++e)p(f[e],null,f[e].attributes.map((function(e){return[e.location,e.name]})))}return n.profile&&(i.getMaxUniformsCount=function(){var e=0;return f.forEach((function(t){t.stats.uniformsCount>e&&(e=t.stats.uniformsCount)})),e},i.getMaxAttributesCount=function(){var e=0;return f.forEach((function(t){t.stats.attributesCount>e&&(e=t.stats.attributesCount)})),e}),{clear:function(){var t=e.deleteShader.bind(e);kt(a).forEach(t),a={},kt(o).forEach(t),o={},f.forEach((function(t){e.deleteProgram(t.program)})),f.length=0,c={},i.shaderCount=0},program:function(r,n,s,u){re.command(r>=0,"missing vertex shader",s),re.command(n>=0,"missing fragment shader",s);var l=c[n];l||(l=c[n]={});var d=l[r];if(d&&(d.refCount++,!u))return d;var m=new h(n,r);return i.shaderCount++,p(m,s,u),d||(l[r]=m),f.push(m),t(m,{destroy:function(){if(m.refCount--,m.refCount<=0){e.deleteProgram(m.program);var t=f.indexOf(m);f.splice(t,1),i.shaderCount--}l[m.vertId].refCount<=0&&(e.deleteShader(o[m.vertId]),delete o[m.vertId],delete c[m.fragId][m.vertId]),Object.keys(c[m.fragId]).length||(e.deleteShader(a[m.fragId]),delete a[m.fragId],delete c[m.fragId])}})},restore:m,shader:l,frag:-1,vert:-1}}var Xn=6408,Yn=5121,Qn=3333,Kn=5126;function Jn(t,r,i,n,a,o,s){function u(u){var l;null===r.next?(re(a.preserveDrawingBuffer,'you must create a webgl context with "preserveDrawingBuffer":true in order to read pixels from the drawing buffer'),l=Yn):(re(null!==r.next.colorAttachments[0].texture,"You cannot read from a renderbuffer"),l=r.next.colorAttachments[0].texture._texture.type,re.optional((function(){o.oes_texture_float?(re(l===Yn||l===Kn,"Reading from a framebuffer is only allowed for the types 'uint8' and 'float'"),l===Kn&&re(s.readFloat,"Reading 'float' values is not permitted in your browser. For a fallback, please see: https://www.npmjs.com/package/glsl-read-float")):re(l===Yn,"Reading from a framebuffer is only allowed for the type 'uint8'")})));var c=0,f=0,d=n.framebufferWidth,h=n.framebufferHeight,p=null;e(u)?p=u:u&&(re.type(u,"object","invalid arguments to regl.read()"),c=0|u.x,f=0|u.y,re(c>=0&&c<n.framebufferWidth,"invalid x offset for regl.read"),re(f>=0&&f<n.framebufferHeight,"invalid y offset for regl.read"),d=0|(u.width||n.framebufferWidth-c),h=0|(u.height||n.framebufferHeight-f),p=u.data||null),p&&(l===Yn?re(p instanceof Uint8Array,"buffer must be 'Uint8Array' when reading from a framebuffer of type 'uint8'"):l===Kn&&re(p instanceof Float32Array,"buffer must be 'Float32Array' when reading from a framebuffer of type 'float'")),re(d>0&&d+c<=n.framebufferWidth,"invalid width for read pixels"),re(h>0&&h+f<=n.framebufferHeight,"invalid height for read pixels"),i();var m=d*h*4;return p||(l===Yn?p=new Uint8Array(m):l===Kn&&(p=p||new Float32Array(m))),re.isTypedArray(p,"data buffer for regl.read() must be a typedarray"),re(p.byteLength>=m,"data buffer for regl.read() too small"),t.pixelStorei(Qn,4),t.readPixels(c,f,d,h,Xn,l,p),p}function l(e){var t;return r.setFBO({framebuffer:e.framebuffer},(function(){t=u(e)})),t}function c(e){return e&&"framebuffer"in e?l(e):u(e)}return c}function ea(e){return Array.prototype.slice.call(e)}function ta(e){return ea(e).join("")}function ra(){var e=0,r=[],i=[];function n(t){for(var n=0;n<i.length;++n)if(i[n]===t)return r[n];var a="g"+e++;return r.push(a),i.push(t),a}function a(){var r=[];function i(){r.push.apply(r,ea(arguments))}var n=[];function a(){var t="v"+e++;return n.push(t),arguments.length>0&&(r.push(t,"="),r.push.apply(r,ea(arguments)),r.push(";")),t}return t(i,{def:a,toString:function(){return ta([n.length>0?"var "+n.join(",")+";":"",ta(r)])}})}function o(){var e=a(),r=a(),i=e.toString,n=r.toString;function o(t,i){r(t,i,"=",e.def(t,i),";")}return t((function(){e.apply(e,ea(arguments))}),{def:e.def,entry:e,exit:r,save:o,set:function(t,r,i){o(t,r),e(t,r,"=",i,";")},toString:function(){return i()+n()}})}function s(){var e=ta(arguments),r=o(),i=o(),n=r.toString,a=i.toString;return t(r,{then:function(){return r.apply(r,ea(arguments)),this},else:function(){return i.apply(i,ea(arguments)),this},toString:function(){var t=a();return t&&(t="else{"+t+"}"),ta(["if(",e,"){",n(),"}",t])}})}var u=a(),l={};function c(e,r){var i=[];function n(){var e="a"+i.length;return i.push(e),e}r=r||0;for(var a=0;a<r;++a)n();var s=o(),u=s.toString;return l[e]=t(s,{arg:n,toString:function(){return ta(["function(",i.join(),"){",u(),"}"])}})}function f(){var e=['"use strict";',u,"return {"];Object.keys(l).forEach((function(t){e.push('"',t,'":',l[t].toString(),",")})),e.push("}");var t=ta(e).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n");return Function.apply(null,r.concat(t)).apply(null,i)}return{global:u,link:n,block:a,proc:c,scope:o,cond:s,compile:f}}var ia="xyzw".split(""),na=5121,aa=1,oa=2,sa=0,ua=1,la=2,ca=3,fa=4,da=5,ha=6,pa="dither",ma="blend.enable",ga="blend.color",va="blend.equation",ba="blend.func",xa="depth.enable",ya="depth.func",wa="depth.range",Ta="depth.mask",Sa="colorMask",ka="cull.enable",Aa="cull.face",Ca="frontFace",Pa="lineWidth",Ra="polygonOffset.enable",Ea="polygonOffset.offset",Da="sample.alpha",za="sample.enable",Ia="sample.coverage",Ba="stencil.enable",Va="stencil.mask",_a="stencil.func",Na="stencil.opFront",Oa="stencil.opBack",Ma="scissor.enable",ja="scissor.box",Fa="viewport",Wa="profile",La="framebuffer",Ua="vert",Ha="frag",Ga="elements",$a="primitive",qa="count",Za="offset",Xa="instances",Ya="vao",Qa="Width",Ka="Height",Ja=La+Qa,eo=La+Ka,to=Fa+Qa,ro=Fa+Ka,io="drawingBuffer",no=io+Qa,ao=io+Ka,oo=[ba,va,_a,Na,Oa,Ia,Fa,ja,Ea],so=34962,uo=34963,lo=3553,co=34067,fo=2884,ho=3042,po=3024,mo=2960,go=2929,vo=3089,bo=32823,xo=32926,yo=32928,wo=5126,To=35664,So=35665,ko=35666,Ao=5124,Co=35667,Po=35668,Ro=35669,Eo=35670,Do=35671,zo=35672,Io=35673,Bo=35674,Vo=35675,_o=35676,No=35678,Oo=35680,Mo=4,jo=1028,Fo=1029,Wo=2304,Lo=2305,Uo=32775,Ho=32776,Go=519,$o=7680,qo=0,Zo=1,Xo=32774,Yo=513,Qo=36160,Ko=36064,Jo={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},es=["constant color, constant alpha","one minus constant color, constant alpha","constant color, one minus constant alpha","one minus constant color, one minus constant alpha","constant alpha, constant color","constant alpha, one minus constant color","one minus constant alpha, constant color","one minus constant alpha, one minus constant color"],ts={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},rs={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},is={frag:35632,vert:35633},ns={cw:Wo,ccw:Lo};function as(t){return Array.isArray(t)||e(t)||St(t)}function os(e){return e.sort((function(e,t){return e===Fa?-1:t===Fa?1:e<t?-1:1}))}function ss(e,t,r,i){this.thisDep=e,this.contextDep=t,this.propDep=r,this.append=i}function us(e){return e&&!(e.thisDep||e.contextDep||e.propDep)}function ls(e){return new ss(!1,!1,!1,e)}function cs(e,t){var r=e.type;if(r===sa){var i=e.data.length;return new ss(!0,i>=1,i>=2,t)}if(r===fa){var n=e.data;return new ss(n.thisDep,n.contextDep,n.propDep,t)}if(r===da)return new ss(!1,!1,!1,t);if(r===ha){for(var a=!1,o=!1,s=!1,u=0;u<e.data.length;++u){var l=e.data[u];if(l.type===ua)s=!0;else if(l.type===la)o=!0;else if(l.type===ca)a=!0;else if(l.type===sa){a=!0;var c=l.data;c>=1&&(o=!0),c>=2&&(s=!0)}else l.type===fa&&(a=a||l.data.thisDep,o=o||l.data.contextDep,s=s||l.data.propDep)}return new ss(a,o,s,t)}return new ss(r===ca,r===la,r===ua,t)}var fs=new ss(!1,!1,!1,(function(){}));function ds(e,r,i,n,a,o,s,u,l,c,f,d,h,p,m){var g=c.Record,v={add:32774,subtract:32778,"reverse subtract":32779};i.ext_blend_minmax&&(v.min=Uo,v.max=Ho);var b=i.angle_instanced_arrays,x=i.webgl_draw_buffers,y=i.oes_vertex_array_object,w={dirty:!0,profile:m.profile},T={},S=[],k={},A={};function C(e){return e.replace(".","_")}function P(e,t,r){var i=C(e);S.push(e),T[i]=w[i]=!!r,k[i]=t}function R(e,t,r){var i=C(e);S.push(e),Array.isArray(r)?(w[i]=r.slice(),T[i]=r.slice()):w[i]=T[i]=r,A[i]=t}P(pa,po),P(ma,ho),R(ga,"blendColor",[0,0,0,0]),R(va,"blendEquationSeparate",[Xo,Xo]),R(ba,"blendFuncSeparate",[Zo,qo,Zo,qo]),P(xa,go,!0),R(ya,"depthFunc",Yo),R(wa,"depthRange",[0,1]),R(Ta,"depthMask",!0),R(Sa,Sa,[!0,!0,!0,!0]),P(ka,fo),R(Aa,"cullFace",Fo),R(Ca,Ca,Lo),R(Pa,Pa,1),P(Ra,bo),R(Ea,"polygonOffset",[0,0]),P(Da,xo),P(za,yo),R(Ia,"sampleCoverage",[1,!1]),P(Ba,mo),R(Va,"stencilMask",-1),R(_a,"stencilFunc",[Go,0,-1]),R(Na,"stencilOpSeparate",[jo,$o,$o,$o]),R(Oa,"stencilOpSeparate",[Fo,$o,$o,$o]),P(Ma,vo),R(ja,"scissor",[0,0,e.drawingBufferWidth,e.drawingBufferHeight]),R(Fa,Fa,[0,0,e.drawingBufferWidth,e.drawingBufferHeight]);var E={gl:e,context:h,strings:r,next:T,current:w,draw:d,elements:o,buffer:a,shader:f,attributes:c.state,vao:c,uniforms:l,framebuffer:u,extensions:i,timer:p,isBufferArgs:as},D={primTypes:$t,compareFuncs:ts,blendFuncs:Jo,blendEquations:v,stencilOps:rs,glTypes:Bt,orientationType:ns};re.optional((function(){E.isArrayLike=cr})),x&&(D.backBuffer=[Fo],D.drawBuffer=Ce(n.maxDrawbuffers,(function(e){return 0===e?[0]:Ce(e,(function(e){return Ko+e}))})));var z=0;function I(){var e=ra(),t=e.link,i=e.global;e.id=z++,e.batchId="0";var n=t(E),a=e.shared={props:"a0"};Object.keys(E).forEach((function(e){a[e]=i.def(n,".",e)})),re.optional((function(){e.CHECK=t(re),e.commandStr=re.guessCommand(),e.command=t(e.commandStr),e.assert=function(e,r,i){e("if(!(",r,"))",this.CHECK,".commandRaise(",t(i),",",this.command,");")},D.invalidBlendCombinations=es}));var o=e.next={},s=e.current={};Object.keys(A).forEach((function(e){Array.isArray(w[e])&&(o[e]=i.def(a.next,".",e),s[e]=i.def(a.current,".",e))}));var u=e.constants={};Object.keys(D).forEach((function(e){u[e]=i.def(JSON.stringify(D[e]))})),e.invoke=function(r,i){switch(i.type){case sa:var n=["this",a.context,a.props,e.batchId];return r.def(t(i.data),".call(",n.slice(0,Math.max(i.data.length+1,4)),")");case ua:return r.def(a.props,i.data);case la:return r.def(a.context,i.data);case ca:return r.def("this",i.data);case fa:return i.data.append(e,r),i.data.ref;case da:return i.data.toString();case ha:return i.data.map((function(t){return e.invoke(r,t)}))}},e.attribCache={};var l={};return e.scopeAttrib=function(e){var i=r.id(e);if(i in l)return l[i];var n=c.scope[i];return n||(n=c.scope[i]=new g),l[i]=t(n)},e}function B(e){var t,r=e.static,i=e.dynamic;if(Wa in r){var n=!!r[Wa];(t=ls((function(e,t){return n}))).enable=n}else if(Wa in i){var a=i[Wa];t=cs(a,(function(e,t){return e.invoke(t,a)}))}return t}function V(e,t){var r=e.static,i=e.dynamic;if(La in r){var n=r[La];return n?(n=u.getFramebuffer(n),re.command(n,"invalid framebuffer object"),ls((function(e,t){var r=e.link(n),i=e.shared;t.set(i.framebuffer,".next",r);var a=i.context;return t.set(a,"."+Ja,r+".width"),t.set(a,"."+eo,r+".height"),r}))):ls((function(e,t){var r=e.shared;t.set(r.framebuffer,".next","null");var i=r.context;return t.set(i,"."+Ja,i+"."+no),t.set(i,"."+eo,i+"."+ao),"null"}))}if(La in i){var a=i[La];return cs(a,(function(e,t){var r=e.invoke(t,a),i=e.shared,n=i.framebuffer,o=t.def(n,".getFramebuffer(",r,")");re.optional((function(){e.assert(t,"!"+r+"||"+o,"invalid framebuffer object")})),t.set(n,".next",o);var s=i.context;return t.set(s,"."+Ja,o+"?"+o+".width:"+s+"."+no),t.set(s,"."+eo,o+"?"+o+".height:"+s+"."+ao),o}))}return null}function _(e,t,r){var i=e.static,n=e.dynamic;function a(e){if(e in i){var a=i[e];re.commandType(a,"object","invalid "+e,r.commandStr);var o,s,u=!0,l=0|a.x,c=0|a.y;return"width"in a?(o=0|a.width,re.command(o>=0,"invalid "+e,r.commandStr)):u=!1,"height"in a?(s=0|a.height,re.command(s>=0,"invalid "+e,r.commandStr)):u=!1,new ss(!u&&t&&t.thisDep,!u&&t&&t.contextDep,!u&&t&&t.propDep,(function(e,t){var r=e.shared.context,i=o;"width"in a||(i=t.def(r,".",Ja,"-",l));var n=s;return"height"in a||(n=t.def(r,".",eo,"-",c)),[l,c,i,n]}))}if(e in n){var f=n[e],d=cs(f,(function(t,r){var i=t.invoke(r,f);re.optional((function(){t.assert(r,i+"&&typeof "+i+'==="object"',"invalid "+e)}));var n=t.shared.context,a=r.def(i,".x|0"),o=r.def(i,".y|0"),s=r.def('"width" in ',i,"?",i,".width|0:","(",n,".",Ja,"-",a,")"),u=r.def('"height" in ',i,"?",i,".height|0:","(",n,".",eo,"-",o,")");return re.optional((function(){t.assert(r,s+">=0&&"+u+">=0","invalid "+e)})),[a,o,s,u]}));return t&&(d.thisDep=d.thisDep||t.thisDep,d.contextDep=d.contextDep||t.contextDep,d.propDep=d.propDep||t.propDep),d}return t?new ss(t.thisDep,t.contextDep,t.propDep,(function(e,t){var r=e.shared.context;return[0,0,t.def(r,".",Ja),t.def(r,".",eo)]})):null}var o=a(Fa);if(o){var s=o;o=new ss(o.thisDep,o.contextDep,o.propDep,(function(e,t){var r=s.append(e,t),i=e.shared.context;return t.set(i,"."+to,r[2]),t.set(i,"."+ro,r[3]),r}))}return{viewport:o,scissor_box:a(ja)}}function N(e,t){var r=e.static;if("string"==typeof r[Ha]&&"string"==typeof r[Ua]){if(Object.keys(t.dynamic).length>0)return null;var i=t.static,n=Object.keys(i);if(n.length>0&&"number"==typeof i[n[0]]){for(var a=[],o=0;o<n.length;++o)re("number"==typeof i[n[o]],"must specify all vertex attribute locations when using vaos"),a.push([0|i[n[o]],n[o]]);return a}}return null}function O(e,t,i){var n=e.static,a=e.dynamic;function o(e){if(e in n){var t=r.id(n[e]);re.optional((function(){f.shader(is[e],t,re.guessCommand())}));var i=ls((function(){return t}));return i.id=t,i}if(e in a){var o=a[e];return cs(o,(function(t,r){var i=t.invoke(r,o),n=r.def(t.shared.strings,".id(",i,")");return re.optional((function(){r(t.shared.shader,".shader(",is[e],",",n,",",t.command,");")})),n}))}return null}var s,u=o(Ha),l=o(Ua),c=null;return us(u)&&us(l)?(c=f.program(l.id,u.id,null,i),s=ls((function(e,t){return e.link(c)}))):s=new ss(u&&u.thisDep||l&&l.thisDep,u&&u.contextDep||l&&l.contextDep,u&&u.propDep||l&&l.propDep,(function(e,t){var r,i=e.shared.shader;r=u?u.append(e,t):t.def(i,".",Ha);var n=i+".program("+(l?l.append(e,t):t.def(i,".",Ua))+","+r;return re.optional((function(){n+=","+e.command})),t.def(n+")")})),{frag:u,vert:l,progVar:s,program:c}}function M(e,t){var r=e.static,i=e.dynamic,n={},a=!1;function s(){if(Ya in r){var e=r[Ya];return null!==e&&null===c.getVAO(e)&&(e=c.createVAO(e)),a=!0,n.vao=e,ls((function(t){var r=c.getVAO(e);return r?t.link(r):"null"}))}if(Ya in i){a=!0;var t=i[Ya];return cs(t,(function(e,r){var i=e.invoke(r,t);return r.def(e.shared.vao+".getVAO("+i+")")}))}return null}var u=s(),l=!1;function f(){if(Ga in r){var e=r[Ga];if(n.elements=e,as(e)){var s=n.elements=o.create(e,!0);e=o.getElements(s),l=!0}else e&&(e=o.getElements(e),l=!0,re.command(e,"invalid elements",t.commandStr));var c=ls((function(t,r){if(e){var i=t.link(e);return t.ELEMENTS=i,i}return t.ELEMENTS=null,null}));return c.value=e,c}if(Ga in i){l=!0;var f=i[Ga];return cs(f,(function(e,t){var r=e.shared,i=r.isBufferArgs,n=r.elements,a=e.invoke(t,f),o=t.def("null"),s=t.def(i,"(",a,")"),u=e.cond(s).then(o,"=",n,".createStream(",a,");").else(o,"=",n,".getElements(",a,");");return re.optional((function(){e.assert(u.else,"!"+a+"||"+o,"invalid elements")})),t.entry(u),t.exit(e.cond(s).then(n,".destroyStream(",o,");")),e.ELEMENTS=o,o}))}return a?new ss(u.thisDep,u.contextDep,u.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.elements+".getElements("+e.shared.vao+".currentVAO.elements):null")})):null}var d=f();function h(){if($a in r){var e=r[$a];return n.primitive=e,re.commandParameter(e,$t,"invalid primitve",t.commandStr),ls((function(t,r){return $t[e]}))}if($a in i){var o=i[$a];return cs(o,(function(e,t){var r=e.constants.primTypes,i=e.invoke(t,o);return re.optional((function(){e.assert(t,i+" in "+r,"invalid primitive, must be one of "+Object.keys($t))})),t.def(r,"[",i,"]")}))}return l?us(d)?d.value?ls((function(e,t){return t.def(e.ELEMENTS,".primType")})):ls((function(){return Mo})):new ss(d.thisDep,d.contextDep,d.propDep,(function(e,t){var r=e.ELEMENTS;return t.def(r,"?",r,".primType:",Mo)})):a?new ss(u.thisDep,u.contextDep,u.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.primitive:"+Mo)})):null}function p(e,o){if(e in r){var s=0|r[e];return o?n.offset=s:n.instances=s,re.command(!o||s>=0,"invalid "+e,t.commandStr),ls((function(e,t){return o&&(e.OFFSET=s),s}))}if(e in i){var c=i[e];return cs(c,(function(t,r){var i=t.invoke(r,c);return o&&(t.OFFSET=i,re.optional((function(){t.assert(r,i+">=0","invalid "+e)}))),i}))}if(o){if(l)return ls((function(e,t){return e.OFFSET=0,0}));if(a)return new ss(u.thisDep,u.contextDep,u.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.offset:0")}))}else if(a)return new ss(u.thisDep,u.contextDep,u.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.instances:-1")}));return null}var m=p(Za,!0);function g(){if(qa in r){var e=0|r[qa];return n.count=e,re.command("number"==typeof e&&e>=0,"invalid vertex count",t.commandStr),ls((function(){return e}))}if(qa in i){var o=i[qa];return cs(o,(function(e,t){var r=e.invoke(t,o);return re.optional((function(){e.assert(t,"typeof "+r+'==="number"&&'+r+">=0&&"+r+"===("+r+"|0)","invalid vertex count")})),r}))}if(l){if(us(d)){if(d)return m?new ss(m.thisDep,m.contextDep,m.propDep,(function(e,t){var r=t.def(e.ELEMENTS,".vertCount-",e.OFFSET);return re.optional((function(){e.assert(t,r+">=0","invalid vertex offset/element buffer too small")})),r})):ls((function(e,t){return t.def(e.ELEMENTS,".vertCount")}));var s=ls((function(){return-1}));return re.optional((function(){s.MISSING=!0})),s}var c=new ss(d.thisDep||m.thisDep,d.contextDep||m.contextDep,d.propDep||m.propDep,(function(e,t){var r=e.ELEMENTS;return e.OFFSET?t.def(r,"?",r,".vertCount-",e.OFFSET,":-1"):t.def(r,"?",r,".vertCount:-1")}));return re.optional((function(){c.DYNAMIC=!0})),c}if(a){var f=new ss(u.thisDep,u.contextDep,u.propDep,(function(e,t){return t.def(e.shared.vao,".currentVAO?",e.shared.vao,".currentVAO.count:-1")}));return f}return null}var v=h(),b=g(),x=p(Xa,!1);return{elements:d,primitive:v,count:b,instances:x,offset:m,vao:u,vaoActive:a,elementsActive:l,static:n}}function j(e,t){var r=e.static,i=e.dynamic,a={};return S.forEach((function(e){var o=C(e);function s(t,n){if(e in r){var s=t(r[e]);a[o]=ls((function(){return s}))}else if(e in i){var u=i[e];a[o]=cs(u,(function(e,t){return n(e,t,e.invoke(t,u))}))}}switch(e){case ka:case ma:case pa:case Ba:case xa:case Ma:case Ra:case Da:case za:case Ta:return s((function(r){return re.commandType(r,"boolean",e,t.commandStr),r}),(function(t,r,i){return re.optional((function(){t.assert(r,"typeof "+i+'==="boolean"',"invalid flag "+e,t.commandStr)})),i}));case ya:return s((function(r){return re.commandParameter(r,ts,"invalid "+e,t.commandStr),ts[r]}),(function(t,r,i){var n=t.constants.compareFuncs;return re.optional((function(){t.assert(r,i+" in "+n,"invalid "+e+", must be one of "+Object.keys(ts))})),r.def(n,"[",i,"]")}));case wa:return s((function(e){return re.command(cr(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]&&e[0]<=e[1],"depth range is 2d array",t.commandStr),e}),(function(e,t,r){return re.optional((function(){e.assert(t,e.shared.isArrayLike+"("+r+")&&"+r+".length===2&&typeof "+r+'[0]==="number"&&typeof '+r+'[1]==="number"&&'+r+"[0]<="+r+"[1]","depth range must be a 2d array")})),[t.def("+",r,"[0]"),t.def("+",r,"[1]")]}));case ba:return s((function(e){re.commandType(e,"object","blend.func",t.commandStr);var r="srcRGB"in e?e.srcRGB:e.src,i="srcAlpha"in e?e.srcAlpha:e.src,n="dstRGB"in e?e.dstRGB:e.dst,a="dstAlpha"in e?e.dstAlpha:e.dst;return re.commandParameter(r,Jo,o+".srcRGB",t.commandStr),re.commandParameter(i,Jo,o+".srcAlpha",t.commandStr),re.commandParameter(n,Jo,o+".dstRGB",t.commandStr),re.commandParameter(a,Jo,o+".dstAlpha",t.commandStr),re.command(-1===es.indexOf(r+", "+n),"unallowed blending combination (srcRGB, dstRGB) = ("+r+", "+n+")",t.commandStr),[Jo[r],Jo[n],Jo[i],Jo[a]]}),(function(t,r,i){var n=t.constants.blendFuncs;function a(a,o){var s=r.def('"',a,o,'" in ',i,"?",i,".",a,o,":",i,".",a);return re.optional((function(){t.assert(r,s+" in "+n,"invalid "+e+"."+a+o+", must be one of "+Object.keys(Jo))})),s}re.optional((function(){t.assert(r,i+"&&typeof "+i+'==="object"',"invalid blend func, must be an object")}));var o=a("src","RGB"),s=a("dst","RGB");re.optional((function(){var e=t.constants.invalidBlendCombinations;t.assert(r,e+".indexOf("+o+'+", "+'+s+") === -1 ","unallowed blending combination for (srcRGB, dstRGB)")}));var u=r.def(n,"[",o,"]"),l=r.def(n,"[",a("src","Alpha"),"]");return[u,r.def(n,"[",s,"]"),l,r.def(n,"[",a("dst","Alpha"),"]")]}));case va:return s((function(r){return"string"==typeof r?(re.commandParameter(r,v,"invalid "+e,t.commandStr),[v[r],v[r]]):"object"==typeof r?(re.commandParameter(r.rgb,v,e+".rgb",t.commandStr),re.commandParameter(r.alpha,v,e+".alpha",t.commandStr),[v[r.rgb],v[r.alpha]]):void re.commandRaise("invalid blend.equation",t.commandStr)}),(function(t,r,i){var n=t.constants.blendEquations,a=r.def(),o=r.def(),s=t.cond("typeof ",i,'==="string"');return re.optional((function(){function r(e,r,i){t.assert(e,i+" in "+n,"invalid "+r+", must be one of "+Object.keys(v))}r(s.then,e,i),t.assert(s.else,i+"&&typeof "+i+'==="object"',"invalid "+e),r(s.else,e+".rgb",i+".rgb"),r(s.else,e+".alpha",i+".alpha")})),s.then(a,"=",o,"=",n,"[",i,"];"),s.else(a,"=",n,"[",i,".rgb];",o,"=",n,"[",i,".alpha];"),r(s),[a,o]}));case ga:return s((function(e){return re.command(cr(e)&&4===e.length,"blend.color must be a 4d array",t.commandStr),Ce(4,(function(t){return+e[t]}))}),(function(e,t,r){return re.optional((function(){e.assert(t,e.shared.isArrayLike+"("+r+")&&"+r+".length===4","blend.color must be a 4d array")})),Ce(4,(function(e){return t.def("+",r,"[",e,"]")}))}));case Va:return s((function(e){return re.commandType(e,"number",o,t.commandStr),0|e}),(function(e,t,r){return re.optional((function(){e.assert(t,"typeof "+r+'==="number"',"invalid stencil.mask")})),t.def(r,"|0")}));case _a:return s((function(r){re.commandType(r,"object",o,t.commandStr);var i=r.cmp||"keep",n=r.ref||0,a="mask"in r?r.mask:-1;return re.commandParameter(i,ts,e+".cmp",t.commandStr),re.commandType(n,"number",e+".ref",t.commandStr),re.commandType(a,"number",e+".mask",t.commandStr),[ts[i],n,a]}),(function(e,t,r){var i=e.constants.compareFuncs;return re.optional((function(){function n(){e.assert(t,Array.prototype.join.call(arguments,""),"invalid stencil.func")}n(r+"&&typeof ",r,'==="object"'),n('!("cmp" in ',r,")||(",r,".cmp in ",i,")")})),[t.def('"cmp" in ',r,"?",i,"[",r,".cmp]",":",$o),t.def(r,".ref|0"),t.def('"mask" in ',r,"?",r,".mask|0:-1")]}));case Na:case Oa:return s((function(r){re.commandType(r,"object",o,t.commandStr);var i=r.fail||"keep",n=r.zfail||"keep",a=r.zpass||"keep";return re.commandParameter(i,rs,e+".fail",t.commandStr),re.commandParameter(n,rs,e+".zfail",t.commandStr),re.commandParameter(a,rs,e+".zpass",t.commandStr),[e===Oa?Fo:jo,rs[i],rs[n],rs[a]]}),(function(t,r,i){var n=t.constants.stencilOps;function a(a){return re.optional((function(){t.assert(r,'!("'+a+'" in '+i+")||("+i+"."+a+" in "+n+")","invalid "+e+"."+a+", must be one of "+Object.keys(rs))})),r.def('"',a,'" in ',i,"?",n,"[",i,".",a,"]:",$o)}return re.optional((function(){t.assert(r,i+"&&typeof "+i+'==="object"',"invalid "+e)})),[e===Oa?Fo:jo,a("fail"),a("zfail"),a("zpass")]}));case Ea:return s((function(e){re.commandType(e,"object",o,t.commandStr);var r=0|e.factor,i=0|e.units;return re.commandType(r,"number",o+".factor",t.commandStr),re.commandType(i,"number",o+".units",t.commandStr),[r,i]}),(function(t,r,i){return re.optional((function(){t.assert(r,i+"&&typeof "+i+'==="object"',"invalid "+e)})),[r.def(i,".factor|0"),r.def(i,".units|0")]}));case Aa:return s((function(e){var r=0;return"front"===e?r=jo:"back"===e&&(r=Fo),re.command(!!r,o,t.commandStr),r}),(function(e,t,r){return re.optional((function(){e.assert(t,r+'==="front"||'+r+'==="back"',"invalid cull.face")})),t.def(r,'==="front"?',jo,":",Fo)}));case Pa:return s((function(e){return re.command("number"==typeof e&&e>=n.lineWidthDims[0]&&e<=n.lineWidthDims[1],"invalid line width, must be a positive number between "+n.lineWidthDims[0]+" and "+n.lineWidthDims[1],t.commandStr),e}),(function(e,t,r){return re.optional((function(){e.assert(t,"typeof "+r+'==="number"&&'+r+">="+n.lineWidthDims[0]+"&&"+r+"<="+n.lineWidthDims[1],"invalid line width")})),r}));case Ca:return s((function(e){return re.commandParameter(e,ns,o,t.commandStr),ns[e]}),(function(e,t,r){return re.optional((function(){e.assert(t,r+'==="cw"||'+r+'==="ccw"',"invalid frontFace, must be one of cw,ccw")})),t.def(r+'==="cw"?'+Wo+":"+Lo)}));case Sa:return s((function(e){return re.command(cr(e)&&4===e.length,"color.mask must be length 4 array",t.commandStr),e.map((function(e){return!!e}))}),(function(e,t,r){return re.optional((function(){e.assert(t,e.shared.isArrayLike+"("+r+")&&"+r+".length===4","invalid color.mask")})),Ce(4,(function(e){return"!!"+r+"["+e+"]"}))}));case Ia:return s((function(e){re.command("object"==typeof e&&e,o,t.commandStr);var r="value"in e?e.value:1,i=!!e.invert;return re.command("number"==typeof r&&r>=0&&r<=1,"sample.coverage.value must be a number between 0 and 1",t.commandStr),[r,i]}),(function(e,t,r){return re.optional((function(){e.assert(t,r+"&&typeof "+r+'==="object"',"invalid sample.coverage")})),[t.def('"value" in ',r,"?+",r,".value:1"),t.def("!!",r,".invert")]}))}})),a}function F(e,t){var r=e.static,i=e.dynamic,n={};return Object.keys(r).forEach((function(e){var i,a=r[e];if("number"==typeof a||"boolean"==typeof a)i=ls((function(){return a}));else if("function"==typeof a){var o=a._reglType;"texture2d"===o||"textureCube"===o?i=ls((function(e){return e.link(a)})):"framebuffer"===o||"framebufferCube"===o?(re.command(a.color.length>0,'missing color attachment for framebuffer sent to uniform "'+e+'"',t.commandStr),i=ls((function(e){return e.link(a.color[0])}))):re.commandRaise('invalid data for uniform "'+e+'"',t.commandStr)}else cr(a)?i=ls((function(t){return t.global.def("[",Ce(a.length,(function(r){return re.command("number"==typeof a[r]||"boolean"==typeof a[r],"invalid uniform "+e,t.commandStr),a[r]})),"]")})):re.commandRaise('invalid or missing data for uniform "'+e+'"',t.commandStr);i.value=a,n[e]=i})),Object.keys(i).forEach((function(e){var t=i[e];n[e]=cs(t,(function(e,r){return e.invoke(r,t)}))})),n}function W(e,t){var i=e.static,n=e.dynamic,o={};return Object.keys(i).forEach((function(e){var n=i[e],s=r.id(e),u=new g;if(as(n))u.state=aa,u.buffer=a.getBuffer(a.create(n,so,!1,!0)),u.type=0;else{var l=a.getBuffer(n);if(l)u.state=aa,u.buffer=l,u.type=0;else if(re.command("object"==typeof n&&n,"invalid data for attribute "+e,t.commandStr),"constant"in n){var c=n.constant;u.buffer="null",u.state=oa,"number"==typeof c?u.x=c:(re.command(cr(c)&&c.length>0&&c.length<=4,"invalid constant for attribute "+e,t.commandStr),ia.forEach((function(e,t){t<c.length&&(u[e]=c[t])})))}else{l=as(n.buffer)?a.getBuffer(a.create(n.buffer,so,!1,!0)):a.getBuffer(n.buffer),re.command(!!l,'missing buffer for attribute "'+e+'"',t.commandStr);var f=0|n.offset;re.command(f>=0,'invalid offset for attribute "'+e+'"',t.commandStr);var d=0|n.stride;re.command(d>=0&&d<256,'invalid stride for attribute "'+e+'", must be integer betweeen [0, 255]',t.commandStr);var h=0|n.size;re.command(!("size"in n)||h>0&&h<=4,'invalid size for attribute "'+e+'", must be 1,2,3,4',t.commandStr);var p=!!n.normalized,m=0;"type"in n&&(re.commandParameter(n.type,Bt,"invalid type for attribute "+e,t.commandStr),m=Bt[n.type]);var v=0|n.divisor;re.optional((function(){"divisor"in n&&(re.command(0===v||b,'cannot specify divisor for attribute "'+e+'", instancing not supported',t.commandStr),re.command(v>=0,'invalid divisor for attribute "'+e+'"',t.commandStr));var r=t.commandStr,i=["buffer","offset","divisor","normalized","type","size","stride"];Object.keys(n).forEach((function(t){re.command(i.indexOf(t)>=0,'unknown parameter "'+t+'" for attribute pointer "'+e+'" (valid parameters are '+i+")",r)}))})),u.buffer=l,u.state=aa,u.size=h,u.normalized=p,u.type=m||l.dtype,u.offset=f,u.stride=d,u.divisor=v}}o[e]=ls((function(e,t){var r=e.attribCache;if(s in r)return r[s];var i={isStream:!1};return Object.keys(u).forEach((function(e){i[e]=u[e]})),u.buffer&&(i.buffer=e.link(u.buffer),i.type=i.type||i.buffer+".dtype"),r[s]=i,i}))})),Object.keys(n).forEach((function(e){var t=n[e];function r(r,i){var n=r.invoke(i,t),a=r.shared,o=r.constants,s=a.isBufferArgs,u=a.buffer;re.optional((function(){r.assert(i,n+"&&(typeof "+n+'==="object"||typeof '+n+'==="function")&&('+s+"("+n+")||"+u+".getBuffer("+n+")||"+u+".getBuffer("+n+".buffer)||"+s+"("+n+'.buffer)||("constant" in '+n+"&&(typeof "+n+'.constant==="number"||'+a.isArrayLike+"("+n+".constant))))",'invalid dynamic attribute "'+e+'"')}));var l={isStream:i.def(!1)},c=new g;c.state=aa,Object.keys(c).forEach((function(e){l[e]=i.def(""+c[e])}));var f=l.buffer,d=l.type;function h(e){i(l[e],"=",n,".",e,"|0;")}return i("if(",s,"(",n,")){",l.isStream,"=true;",f,"=",u,".createStream(",so,",",n,");",d,"=",f,".dtype;","}else{",f,"=",u,".getBuffer(",n,");","if(",f,"){",d,"=",f,".dtype;",'}else if("constant" in ',n,"){",l.state,"=",oa,";","if(typeof "+n+'.constant === "number"){',l[ia[0]],"=",n,".constant;",ia.slice(1).map((function(e){return l[e]})).join("="),"=0;","}else{",ia.map((function(e,t){return l[e]+"="+n+".constant.length>"+t+"?"+n+".constant["+t+"]:0;"})).join(""),"}}else{","if(",s,"(",n,".buffer)){",f,"=",u,".createStream(",so,",",n,".buffer);","}else{",f,"=",u,".getBuffer(",n,".buffer);","}",d,'="type" in ',n,"?",o.glTypes,"[",n,".type]:",f,".dtype;",l.normalized,"=!!",n,".normalized;"),h("size"),h("offset"),h("stride"),h("divisor"),i("}}"),i.exit("if(",l.isStream,"){",u,".destroyStream(",f,");","}"),l}o[e]=cs(t,r)})),o}function L(e){var t=e.static,r=e.dynamic,i={};return Object.keys(t).forEach((function(e){var r=t[e];i[e]=ls((function(e,t){return"number"==typeof r||"boolean"==typeof r?""+r:e.link(r)}))})),Object.keys(r).forEach((function(e){var t=r[e];i[e]=cs(t,(function(e,r){return e.invoke(r,t)}))})),i}function U(e,t,r,n,a){var o=e.static,s=e.dynamic;re.optional((function(){var e=[La,Ua,Ha,Ga,$a,Za,qa,Xa,Wa,Ya].concat(S);function t(t){Object.keys(t).forEach((function(t){re.command(e.indexOf(t)>=0,'unknown parameter "'+t+'"',a.commandStr)}))}t(o),t(s)}));var u=N(e,t),l=V(e),f=_(e,l,a),d=M(e,a),h=j(e,a),p=O(e,a,u);function m(e){var t=f[e];t&&(h[e]=t)}m(Fa),m(C(ja));var g=Object.keys(h).length>0,v={framebuffer:l,draw:d,shader:p,state:h,dirty:g,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}};if(v.profile=B(e),v.uniforms=F(r,a),v.drawVAO=v.scopeVAO=d.vao,!v.drawVAO&&p.program&&!u&&i.angle_instanced_arrays&&d.static.elements){var b=!0,x=p.program.attributes.map((function(e){var r=t.static[e];return b=b&&!!r,r}));if(b&&x.length>0){var y=c.getVAO(c.createVAO({attributes:x,elements:d.static.elements}));v.drawVAO=new ss(null,null,null,(function(e,t){return e.link(y)})),v.useVAO=!0}}return u?v.useVAO=!0:v.attributes=W(t,a),v.context=L(n),v}function H(e,t,r){var i=e.shared.context,n=e.scope();Object.keys(r).forEach((function(a){t.save(i,"."+a);var o=r[a].append(e,t);Array.isArray(o)?n(i,".",a,"=[",o.join(),"];"):n(i,".",a,"=",o,";")})),t(n)}function G(e,t,r,i){var n,a=e.shared,o=a.gl,s=a.framebuffer;x&&(n=t.def(a.extensions,".webgl_draw_buffers"));var u,l=e.constants,c=l.drawBuffer,f=l.backBuffer;u=r?r.append(e,t):t.def(s,".next"),i||t("if(",u,"!==",s,".cur){"),t("if(",u,"){",o,".bindFramebuffer(",Qo,",",u,".framebuffer);"),x&&t(n,".drawBuffersWEBGL(",c,"[",u,".colorAttachments.length]);"),t("}else{",o,".bindFramebuffer(",Qo,",null);"),x&&t(n,".drawBuffersWEBGL(",f,");"),t("}",s,".cur=",u,";"),i||t("}")}function $(e,t,r){var i=e.shared,n=i.gl,a=e.current,o=e.next,s=i.current,u=i.next,l=e.cond(s,".dirty");S.forEach((function(t){var i,c,f=C(t);if(!(f in r.state))if(f in o){i=o[f],c=a[f];var d=Ce(w[f].length,(function(e){return l.def(i,"[",e,"]")}));l(e.cond(d.map((function(e,t){return e+"!=="+c+"["+t+"]"})).join("||")).then(n,".",A[f],"(",d,");",d.map((function(e,t){return c+"["+t+"]="+e})).join(";"),";"))}else{i=l.def(u,".",f);var h=e.cond(i,"!==",s,".",f);l(h),f in k?h(e.cond(i).then(n,".enable(",k[f],");").else(n,".disable(",k[f],");"),s,".",f,"=",i,";"):h(n,".",A[f],"(",i,");",s,".",f,"=",i,";")}})),0===Object.keys(r.state).length&&l(s,".dirty=false;"),t(l)}function q(e,t,r,i){var n=e.shared,a=e.current,o=n.current,s=n.gl;os(Object.keys(r)).forEach((function(n){var u=r[n];if(!i||i(u)){var l=u.append(e,t);if(k[n]){var c=k[n];us(u)?t(s,l?".enable(":".disable(",c,");"):t(e.cond(l).then(s,".enable(",c,");").else(s,".disable(",c,");")),t(o,".",n,"=",l,";")}else if(cr(l)){var f=a[n];t(s,".",A[n],"(",l,");",l.map((function(e,t){return f+"["+t+"]="+e})).join(";"),";")}else t(s,".",A[n],"(",l,");",o,".",n,"=",l,";")}}))}function Z(e,t){b&&(e.instancing=t.def(e.shared.extensions,".angle_instanced_arrays"))}function X(e,t,r,i,n){var a,o,s,u=e.shared,l=e.stats,c=u.current,f=u.timer,d=r.profile;function h(){return"undefined"==typeof performance?"Date.now()":"performance.now()"}function m(e){e(a=t.def(),"=",h(),";"),"string"==typeof n?e(l,".count+=",n,";"):e(l,".count++;"),p&&(i?e(o=t.def(),"=",f,".getNumPendingQueries();"):e(f,".beginQuery(",l,");"))}function g(e){e(l,".cpuTime+=",h(),"-",a,";"),p&&(i?e(f,".pushScopeStats(",o,",",f,".getNumPendingQueries(),",l,");"):e(f,".endQuery();"))}function v(e){var r=t.def(c,".profile");t(c,".profile=",e,";"),t.exit(c,".profile=",r,";")}if(d){if(us(d))return void(d.enable?(m(t),g(t.exit),v("true")):v("false"));v(s=d.append(e,t))}else s=t.def(c,".profile");var b=e.block();m(b),t("if(",s,"){",b,"}");var x=e.block();g(x),t.exit("if(",s,"){",x,"}")}function Y(e,t,r,i,n){var a=e.shared;function o(e){switch(e){case To:case Co:case Do:return 2;case So:case Po:case zo:return 3;case ko:case Ro:case Io:return 4;default:return 1}}function s(r,i,n){var o=a.gl,s=t.def(r,".location"),u=t.def(a.attributes,"[",s,"]"),l=n.state,c=n.buffer,f=[n.x,n.y,n.z,n.w],d=["buffer","normalized","offset","stride"];function h(){t("if(!",u,".buffer){",o,".enableVertexAttribArray(",s,");}");var r,a=n.type;if(r=n.size?t.def(n.size,"||",i):i,t("if(",u,".type!==",a,"||",u,".size!==",r,"||",d.map((function(e){return u+"."+e+"!=="+n[e]})).join("||"),"){",o,".bindBuffer(",so,",",c,".buffer);",o,".vertexAttribPointer(",[s,r,a,n.normalized,n.stride,n.offset],");",u,".type=",a,";",u,".size=",r,";",d.map((function(e){return u+"."+e+"="+n[e]+";"})).join(""),"}"),b){var l=n.divisor;t("if(",u,".divisor!==",l,"){",e.instancing,".vertexAttribDivisorANGLE(",[s,l],");",u,".divisor=",l,";}")}}function p(){t("if(",u,".buffer){",o,".disableVertexAttribArray(",s,");",u,".buffer=null;","}if(",ia.map((function(e,t){return u+"."+e+"!=="+f[t]})).join("||"),"){",o,".vertexAttrib4f(",s,",",f,");",ia.map((function(e,t){return u+"."+e+"="+f[t]+";"})).join(""),"}")}l===aa?h():l===oa?p():(t("if(",l,"===",aa,"){"),h(),t("}else{"),p(),t("}"))}i.forEach((function(i){var a,u=i.name,l=r.attributes[u];if(l){if(!n(l))return;a=l.append(e,t)}else{if(!n(fs))return;var c=e.scopeAttrib(u);re.optional((function(){e.assert(t,c+".state","missing attribute "+u)})),a={},Object.keys(new g).forEach((function(e){a[e]=t.def(c,".",e)}))}s(e.link(i),o(i.info.type),a)}))}function Q(e,t,i,n,a,o){for(var s,u=e.shared,l=u.gl,c={},f=0;f<n.length;++f){var d=n[f],h=d.name,p=d.info.type,m=d.info.size,g=i.uniforms[h];if(m>1){if(!g)continue;var v=h.replace("[0]","");if(c[v])continue;c[v]=1}var b,x=e.link(d)+".location";if(g){if(!a(g))continue;if(us(g)){var y=g.value;if(re.command(null!=y,'missing uniform "'+h+'"',e.commandStr),p===No||p===Oo){re.command("function"==typeof y&&(p===No&&("texture2d"===y._reglType||"framebuffer"===y._reglType)||p===Oo&&("textureCube"===y._reglType||"framebufferCube"===y._reglType)),"invalid texture for uniform "+h,e.commandStr);var w=e.link(y._texture||y.color[0]._texture);t(l,".uniform1i(",x,",",w+".bind());"),t.exit(w,".unbind();")}else if(p===Bo||p===Vo||p===_o){re.optional((function(){re.command(cr(y),"invalid matrix for uniform "+h,e.commandStr),re.command(p===Bo&&4===y.length||p===Vo&&9===y.length||p===_o&&16===y.length,"invalid length for matrix uniform "+h,e.commandStr)}));var T=e.global.def("new Float32Array(["+Array.prototype.slice.call(y)+"])"),S=2;p===Vo?S=3:p===_o&&(S=4),t(l,".uniformMatrix",S,"fv(",x,",false,",T,");")}else{switch(p){case wo:1===m?re.commandType(y,"number","uniform "+h,e.commandStr):re.command(cr(y)&&y.length===m,"uniform "+h,e.commandStr),s="1f";break;case To:re.command(cr(y)&&y.length&&y.length%2==0&&y.length<=2*m,"uniform "+h,e.commandStr),s="2f";break;case So:re.command(cr(y)&&y.length&&y.length%3==0&&y.length<=3*m,"uniform "+h,e.commandStr),s="3f";break;case ko:re.command(cr(y)&&y.length&&y.length%4==0&&y.length<=4*m,"uniform "+h,e.commandStr),s="4f";break;case Eo:1===m?re.commandType(y,"boolean","uniform "+h,e.commandStr):re.command(cr(y)&&y.length===m,"uniform "+h,e.commandStr),s="1i";break;case Ao:1===m?re.commandType(y,"number","uniform "+h,e.commandStr):re.command(cr(y)&&y.length===m,"uniform "+h,e.commandStr),s="1i";break;case Do:case Co:re.command(cr(y)&&y.length&&y.length%2==0&&y.length<=2*m,"uniform "+h,e.commandStr),s="2i";break;case zo:case Po:re.command(cr(y)&&y.length&&y.length%3==0&&y.length<=3*m,"uniform "+h,e.commandStr),s="3i";break;case Io:case Ro:re.command(cr(y)&&y.length&&y.length%4==0&&y.length<=4*m,"uniform "+h,e.commandStr),s="4i"}m>1?(s+="v",y=e.global.def("["+Array.prototype.slice.call(y)+"]")):y=cr(y)?Array.prototype.slice.call(y):y,t(l,".uniform",s,"(",x,",",y,");")}continue}b=g.append(e,t)}else{if(!a(fs))continue;b=t.def(u.uniforms,"[",r.id(h),"]")}p===No?(re(!Array.isArray(b),"must specify a scalar prop for textures"),t("if(",b,"&&",b,'._reglType==="framebuffer"){',b,"=",b,".color[0];","}")):p===Oo&&(re(!Array.isArray(b),"must specify a scalar prop for cube maps"),t("if(",b,"&&",b,'._reglType==="framebufferCube"){',b,"=",b,".color[0];","}")),re.optional((function(){function r(r,i){e.assert(t,r,'bad data or missing for uniform "'+h+'".  '+i)}function i(e,t){1===t&&re(!Array.isArray(b),"must not specify an array type for uniform"),r("Array.isArray("+b+") && typeof "+b+'[0]===" '+e+'" || typeof '+b+'==="'+e+'"',"invalid type, expected "+e)}function n(t,i,n){Array.isArray(b)?re(b.length&&b.length%t==0&&b.length<=t*n,"must have length of "+(1===n?"":"n * ")+t):r(u.isArrayLike+"("+b+")&&"+b+".length && "+b+".length % "+t+" === 0 && "+b+".length<="+t*n,"invalid vector, should have length of "+(1===n?"":"n * ")+t,e.commandStr)}function a(t){re(!Array.isArray(b),"must not specify a value type"),r("typeof "+b+'==="function"&&'+b+'._reglType==="texture'+(t===lo?"2d":"Cube")+'"',"invalid texture type",e.commandStr)}switch(p){case Ao:i("number",m);break;case Co:n(2,"number",m);break;case Po:n(3,"number",m);break;case Ro:n(4,"number",m);break;case wo:i("number",m);break;case To:n(2,"number",m);break;case So:n(3,"number",m);break;case ko:n(4,"number",m);break;case Eo:i("boolean",m);break;case Do:n(2,"boolean",m);break;case zo:n(3,"boolean",m);break;case Io:n(4,"boolean",m);break;case Bo:n(4,"number",m);break;case Vo:n(9,"number",m);break;case _o:n(16,"number",m);break;case No:a(lo);break;case Oo:a(co)}}));var k=1;switch(p){case No:case Oo:var A=t.def(b,"._texture");t(l,".uniform1i(",x,",",A,".bind());"),t.exit(A,".unbind();");continue;case Ao:case Eo:s="1i";break;case Co:case Do:s="2i",k=2;break;case Po:case zo:s="3i",k=3;break;case Ro:case Io:s="4i",k=4;break;case wo:s="1f";break;case To:s="2f",k=2;break;case So:s="3f",k=3;break;case ko:s="4f",k=4;break;case Bo:s="Matrix2fv";break;case Vo:s="Matrix3fv";break;case _o:s="Matrix4fv"}if(-1===s.indexOf("Matrix")&&m>1&&(s+="v",k=1),"M"===s.charAt(0)){t(l,".uniform",s,"(",x,",");var C=Math.pow(p-Bo+2,2),P=e.global.def("new Float32Array(",C,")");Array.isArray(b)?t("false,(",Ce(C,(function(e){return P+"["+e+"]="+b[e]})),",",P,")"):t("false,(Array.isArray(",b,")||",b," instanceof Float32Array)?",b,":(",Ce(C,(function(e){return P+"["+e+"]="+b+"["+e+"]"})),",",P,")"),t(");")}else if(k>1){for(var R=[],E=[],D=0;D<k;++D)Array.isArray(b)?E.push(b[D]):E.push(t.def(b+"["+D+"]")),o&&R.push(t.def());o&&t("if(!",e.batchId,"||",R.map((function(e,t){return e+"!=="+E[t]})).join("||"),"){",R.map((function(e,t){return e+"="+E[t]+";"})).join("")),t(l,".uniform",s,"(",x,",",E.join(","),");"),o&&t("}")}else{if(re(!Array.isArray(b),"uniform value must not be an array"),o){var z=t.def();t("if(!",e.batchId,"||",z,"!==",b,"){",z,"=",b,";")}t(l,".uniform",s,"(",x,",",b,");"),o&&t("}")}}}function K(e,t,r,i){var n=e.shared,a=n.gl,o=n.draw,s=i.draw;function u(){var u,l=s.elements,c=t;return l?((l.contextDep&&i.contextDynamic||l.propDep)&&(c=r),u=l.append(e,c),s.elementsActive&&c("if("+u+")"+a+".bindBuffer("+uo+","+u+".buffer.buffer);")):(u=c.def(),c(u,"=",o,".",Ga,";","if(",u,"){",a,".bindBuffer(",uo,",",u,".buffer.buffer);}","else if(",n.vao,".currentVAO){",u,"=",e.shared.elements+".getElements("+n.vao,".currentVAO.elements);",y?"":"if("+u+")"+a+".bindBuffer("+uo+","+u+".buffer.buffer);","}")),u}function l(){var n,a=s.count,u=t;return a?((a.contextDep&&i.contextDynamic||a.propDep)&&(u=r),n=a.append(e,u),re.optional((function(){a.MISSING&&e.assert(t,"false","missing vertex count"),a.DYNAMIC&&e.assert(u,n+">=0","missing vertex count")}))):(n=u.def(o,".",qa),re.optional((function(){e.assert(u,n+">=0","missing vertex count")}))),n}var c=u();function f(n){var a=s[n];return a?a.contextDep&&i.contextDynamic||a.propDep?a.append(e,r):a.append(e,t):t.def(o,".",n)}var d,h,p=f($a),m=f(Za),g=l();if("number"==typeof g){if(0===g)return}else r("if(",g,"){"),r.exit("}");b&&(d=f(Xa),h=e.instancing);var v=c+".type",x=s.elements&&us(s.elements)&&!s.vaoActive;function w(){function e(){r(h,".drawElementsInstancedANGLE(",[p,g,v,m+"<<(("+v+"-"+na+")>>1)",d],");")}function t(){r(h,".drawArraysInstancedANGLE(",[p,m,g,d],");")}c&&"null"!==c?x?e():(r("if(",c,"){"),e(),r("}else{"),t(),r("}")):t()}function T(){function e(){r(a+".drawElements("+[p,g,v,m+"<<(("+v+"-"+na+")>>1)"]+");")}function t(){r(a+".drawArrays("+[p,m,g]+");")}c&&"null"!==c?x?e():(r("if(",c,"){"),e(),r("}else{"),t(),r("}")):t()}b&&("number"!=typeof d||d>=0)?"string"==typeof d?(r("if(",d,">0){"),w(),r("}else if(",d,"<0){"),T(),r("}")):w():T()}function J(e,t,r,i,n){var a=I(),o=a.proc("body",n);return re.optional((function(){a.commandStr=t.commandStr,a.command=a.link(t.commandStr)})),b&&(a.instancing=o.def(a.shared.extensions,".angle_instanced_arrays")),e(a,o,r,i),a.compile().body}function ee(e,t,r,i){Z(e,t),r.useVAO?r.drawVAO?t(e.shared.vao,".setVAO(",r.drawVAO.append(e,t),");"):t(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(t(e.shared.vao,".setVAO(null);"),Y(e,t,r,i.attributes,(function(){return!0}))),Q(e,t,r,i.uniforms,(function(){return!0}),!1),K(e,t,t,r)}function te(e,t){var r=e.proc("draw",1);Z(e,r),H(e,r,t.context),G(e,r,t.framebuffer),$(e,r,t),q(e,r,t.state),X(e,r,t,!1,!0);var i=t.shader.progVar.append(e,r);if(r(e.shared.gl,".useProgram(",i,".program);"),t.shader.program)ee(e,r,t,t.shader.program);else{r(e.shared.vao,".setVAO(null);");var n=e.global.def("{}"),a=r.def(i,".id"),o=r.def(n,"[",a,"]");r(e.cond(o).then(o,".call(this,a0);").else(o,"=",n,"[",a,"]=",e.link((function(r){return J(ee,e,t,r,1)})),"(",i,");",o,".call(this,a0);"))}Object.keys(t.state).length>0&&r(e.shared.current,".dirty=true;"),e.shared.vao&&r(e.shared.vao,".setVAO(null);")}function ie(e,t,r,i){function n(){return!0}e.batchId="a1",Z(e,t),Y(e,t,r,i.attributes,n),Q(e,t,r,i.uniforms,n,!1),K(e,t,t,r)}function ne(e,t,r,i){Z(e,t);var n=r.contextDep,a=t.def(),o="a0",s="a1",u=t.def();e.shared.props=u,e.batchId=a;var l=e.scope(),c=e.scope();function f(e){return e.contextDep&&n||e.propDep}function d(e){return!f(e)}if(t(l.entry,"for(",a,"=0;",a,"<",s,";++",a,"){",u,"=",o,"[",a,"];",c,"}",l.exit),r.needsContext&&H(e,c,r.context),r.needsFramebuffer&&G(e,c,r.framebuffer),q(e,c,r.state,f),r.profile&&f(r.profile)&&X(e,c,r,!1,!0),i)r.useVAO?r.drawVAO?f(r.drawVAO)?c(e.shared.vao,".setVAO(",r.drawVAO.append(e,c),");"):l(e.shared.vao,".setVAO(",r.drawVAO.append(e,l),");"):l(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(l(e.shared.vao,".setVAO(null);"),Y(e,l,r,i.attributes,d),Y(e,c,r,i.attributes,f)),Q(e,l,r,i.uniforms,d,!1),Q(e,c,r,i.uniforms,f,!0),K(e,l,c,r);else{var h=e.global.def("{}"),p=r.shader.progVar.append(e,c),m=c.def(p,".id"),g=c.def(h,"[",m,"]");c(e.shared.gl,".useProgram(",p,".program);","if(!",g,"){",g,"=",h,"[",m,"]=",e.link((function(t){return J(ie,e,r,t,2)})),"(",p,");}",g,".call(this,a0[",a,"],",a,");")}}function ae(e,t){var r=e.proc("batch",2);e.batchId="0",Z(e,r);var i=!1,n=!0;Object.keys(t.context).forEach((function(e){i=i||t.context[e].propDep})),i||(H(e,r,t.context),n=!1);var a=t.framebuffer,o=!1;function s(e){return e.contextDep&&i||e.propDep}a?(a.propDep?i=o=!0:a.contextDep&&i&&(o=!0),o||G(e,r,a)):G(e,r,null),t.state.viewport&&t.state.viewport.propDep&&(i=!0),$(e,r,t),q(e,r,t.state,(function(e){return!s(e)})),t.profile&&s(t.profile)||X(e,r,t,!1,"a1"),t.contextDep=i,t.needsContext=n,t.needsFramebuffer=o;var u=t.shader.progVar;if(u.contextDep&&i||u.propDep)ne(e,r,t,null);else{var l=u.append(e,r);if(r(e.shared.gl,".useProgram(",l,".program);"),t.shader.program)ne(e,r,t,t.shader.program);else{r(e.shared.vao,".setVAO(null);");var c=e.global.def("{}"),f=r.def(l,".id"),d=r.def(c,"[",f,"]");r(e.cond(d).then(d,".call(this,a0,a1);").else(d,"=",c,"[",f,"]=",e.link((function(r){return J(ne,e,t,r,2)})),"(",l,");",d,".call(this,a0,a1);"))}}Object.keys(t.state).length>0&&r(e.shared.current,".dirty=true;"),e.shared.vao&&r(e.shared.vao,".setVAO(null);")}function oe(e,t){var i=e.proc("scope",3);e.batchId="a2";var n=e.shared,a=n.current;function o(r){var a=t.shader[r];a&&i.set(n.shader,"."+r,a.append(e,i))}H(e,i,t.context),t.framebuffer&&t.framebuffer.append(e,i),os(Object.keys(t.state)).forEach((function(r){var a=t.state[r].append(e,i);cr(a)?a.forEach((function(t,n){i.set(e.next[r],"["+n+"]",t)})):i.set(n.next,"."+r,a)})),X(e,i,t,!0,!0),[Ga,Za,qa,Xa,$a].forEach((function(r){var a=t.draw[r];a&&i.set(n.draw,"."+r,""+a.append(e,i))})),Object.keys(t.uniforms).forEach((function(a){var o=t.uniforms[a].append(e,i);Array.isArray(o)&&(o="["+o.join()+"]"),i.set(n.uniforms,"["+r.id(a)+"]",o)})),Object.keys(t.attributes).forEach((function(r){var n=t.attributes[r].append(e,i),a=e.scopeAttrib(r);Object.keys(new g).forEach((function(e){i.set(a,"."+e,n[e])}))})),t.scopeVAO&&i.set(n.vao,".targetVAO",t.scopeVAO.append(e,i)),o(Ua),o(Ha),Object.keys(t.state).length>0&&(i(a,".dirty=true;"),i.exit(a,".dirty=true;")),i("a1(",e.shared.context,",a0,",e.batchId,");")}function se(e){if("object"==typeof e&&!cr(e)){for(var t=Object.keys(e),r=0;r<t.length;++r)if(pe.isDynamic(e[t[r]]))return!0;return!1}}function ue(e,t,r){var i=t.static[r];if(i&&se(i)){var n=e.global,a=Object.keys(i),o=!1,s=!1,u=!1,l=e.global.def("{}");a.forEach((function(t){var r=i[t];if(pe.isDynamic(r)){"function"==typeof r&&(r=i[t]=pe.unbox(r));var a=cs(r,null);o=o||a.thisDep,u=u||a.propDep,s=s||a.contextDep}else{switch(n(l,".",t,"="),typeof r){case"number":n(r);break;case"string":n('"',r,'"');break;case"object":Array.isArray(r)&&n("[",r.join(),"]");break;default:n(e.link(r))}n(";")}})),t.dynamic[r]=new pe.DynamicVariable(fa,{thisDep:o,contextDep:s,propDep:u,ref:l,append:c}),delete t.static[r]}function c(e,t){a.forEach((function(r){var n=i[r];if(pe.isDynamic(n)){var a=e.invoke(t,n);t(l,".",r,"=",a,";")}}))}}function le(e,r,i,n,a){var o=I();o.stats=o.link(a),Object.keys(r.static).forEach((function(e){ue(o,r,e)})),oo.forEach((function(t){ue(o,e,t)}));var s=U(e,r,i,n,o);return te(o,s),oe(o,s),ae(o,s),t(o.compile(),{destroy:function(){s.shader.program.destroy()}})}return{next:T,current:w,procs:function(){var e=I(),t=e.proc("poll"),r=e.proc("refresh"),a=e.block();t(a),r(a);var o,s=e.shared,u=s.gl,l=s.next,c=s.current;a(c,".dirty=false;"),G(e,t),G(e,r,null,!0),b&&(o=e.link(b)),i.oes_vertex_array_object&&r(e.link(i.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var f=0;f<n.maxAttributes;++f){var d=r.def(s.attributes,"[",f,"]"),h=e.cond(d,".buffer");h.then(u,".enableVertexAttribArray(",f,");",u,".bindBuffer(",so,",",d,".buffer.buffer);",u,".vertexAttribPointer(",f,",",d,".size,",d,".type,",d,".normalized,",d,".stride,",d,".offset);").else(u,".disableVertexAttribArray(",f,");",u,".vertexAttrib4f(",f,",",d,".x,",d,".y,",d,".z,",d,".w);",d,".buffer=null;"),r(h),b&&r(o,".vertexAttribDivisorANGLE(",f,",",d,".divisor);")}return r(e.shared.vao,".currentVAO=null;",e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"),Object.keys(k).forEach((function(i){var n=k[i],o=a.def(l,".",i),s=e.block();s("if(",o,"){",u,".enable(",n,")}else{",u,".disable(",n,")}",c,".",i,"=",o,";"),r(s),t("if(",o,"!==",c,".",i,"){",s,"}")})),Object.keys(A).forEach((function(i){var n,o,s=A[i],f=w[i],d=e.block();if(d(u,".",s,"("),cr(f)){var h=f.length;n=e.global.def(l,".",i),o=e.global.def(c,".",i),d(Ce(h,(function(e){return n+"["+e+"]"})),");",Ce(h,(function(e){return o+"["+e+"]="+n+"["+e+"];"})).join("")),t("if(",Ce(h,(function(e){return n+"["+e+"]!=="+o+"["+e+"]"})).join("||"),"){",d,"}")}else n=a.def(l,".",i),o=a.def(c,".",i),d(n,");",c,".",i,"=",n,";"),t("if(",n,"!==",o,"){",d,"}");r(d)})),e.compile()}(),compile:le}}function hs(){return{vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0}}var ps=34918,ms=34919,gs=35007,vs=function(e,t){if(!t.ext_disjoint_timer_query)return null;var r=[];function i(){return r.pop()||t.ext_disjoint_timer_query.createQueryEXT()}function n(e){r.push(e)}var a=[];function o(e){var r=i();t.ext_disjoint_timer_query.beginQueryEXT(gs,r),a.push(r),h(a.length-1,a.length,e)}function s(){t.ext_disjoint_timer_query.endQueryEXT(gs)}function u(){this.startQueryIndex=-1,this.endQueryIndex=-1,this.sum=0,this.stats=null}var l=[];function c(){return l.pop()||new u}function f(e){l.push(e)}var d=[];function h(e,t,r){var i=c();i.startQueryIndex=e,i.endQueryIndex=t,i.sum=0,i.stats=r,d.push(i)}var p=[],m=[];function g(){var e,r,i=a.length;if(0!==i){m.length=Math.max(m.length,i+1),p.length=Math.max(p.length,i+1),p[0]=0,m[0]=0;var o=0;for(e=0,r=0;r<a.length;++r){var s=a[r];t.ext_disjoint_timer_query.getQueryObjectEXT(s,ms)?(o+=t.ext_disjoint_timer_query.getQueryObjectEXT(s,ps),n(s)):a[e++]=s,p[r+1]=o,m[r+1]=e}for(a.length=e,e=0,r=0;r<d.length;++r){var u=d[r],l=u.startQueryIndex,c=u.endQueryIndex;u.sum+=p[c]-p[l];var h=m[l],g=m[c];g===h?(u.stats.gpuTime+=u.sum/1e6,f(u)):(u.startQueryIndex=h,u.endQueryIndex=g,d[e++]=u)}d.length=e}}return{beginQuery:o,endQuery:s,pushScopeStats:h,update:g,getNumPendingQueries:function(){return a.length},clear:function(){r.push.apply(r,a);for(var e=0;e<r.length;e++)t.ext_disjoint_timer_query.deleteQueryEXT(r[e]);a.length=0,r.length=0},restore:function(){a.length=0,r.length=0}}},bs=16384,xs=256,ys=1024,ws=34962,Ts="webglcontextlost",Ss="webglcontextrestored",ks=1,As=2,Cs=3;function Ps(e,t){for(var r=0;r<e.length;++r)if(e[r]===t)return r;return-1}function Rs(e){var r=ke(e);if(!r)return null;var i=r.gl,n=i.getContextAttributes(),a=i.isContextLost(),o=Ae(i,r);if(!o)return null;var s=ve(),u=hs(),l=o.extensions,c=vs(i,l),f=ge(),d=i.drawingBufferWidth,h=i.drawingBufferHeight,p={tick:0,time:0,viewportWidth:d,viewportHeight:h,framebufferWidth:d,framebufferHeight:h,drawingBufferWidth:d,drawingBufferHeight:h,pixelRatio:r.pixelRatio},m={},g={elements:null,primitive:4,count:-1,offset:0,instances:-1},v=Tt(i,l),b=Gt(i,u,r,w),x=ar(i,l,b,u),y=Un(i,l,v,u,b,x,g);function w(e){return y.destroyBuffer(e)}var T=Zn(i,s,u,r),S=Zi(i,l,v,(function(){C.procs.poll()}),p,u,r),k=ln(i,l,v,u,r),A=On(i,l,v,S,k,u),C=ds(i,s,l,v,b,x,S,A,m,y,T,g,p,c,r),P=Jn(i,A,C.procs.poll,p,n,l,v),R=C.next,E=i.canvas,D=[],z=[],I=[],B=[r.onDestroy],V=null;function _(){if(0===D.length)return c&&c.update(),void(V=null);V=me.next(_),q();for(var e=D.length-1;e>=0;--e){var t=D[e];t&&t(p,null,0)}i.flush(),c&&c.update()}function N(){!V&&D.length>0&&(V=me.next(_))}function O(){V&&(me.cancel(_),V=null)}function M(e){e.preventDefault(),a=!0,O(),z.forEach((function(e){e()}))}function j(e){i.getError(),a=!1,o.restore(),T.restore(),b.restore(),S.restore(),k.restore(),A.restore(),y.restore(),c&&c.restore(),C.procs.refresh(),N(),I.forEach((function(e){e()}))}function F(){D.length=0,O(),E&&(E.removeEventListener(Ts,M),E.removeEventListener(Ss,j)),T.clear(),A.clear(),k.clear(),y.clear(),S.clear(),x.clear(),b.clear(),c&&c.clear(),B.forEach((function(e){e()}))}function W(e){function r(e){var r=t({},e);function i(e){if(e in r){var t=r[e];delete r[e],Object.keys(t).forEach((function(i){r[e+"."+i]=t[i]}))}}return delete r.uniforms,delete r.attributes,delete r.context,delete r.vao,"stencil"in r&&r.stencil.op&&(r.stencil.opBack=r.stencil.opFront=r.stencil.op,delete r.stencil.op),i("blend"),i("depth"),i("cull"),i("stencil"),i("polygonOffset"),i("scissor"),i("sample"),"vao"in e&&(r.vao=e.vao),r}function i(e,t){var r={},i={};return Object.keys(e).forEach((function(n){var a=e[n];if(pe.isDynamic(a))i[n]=pe.unbox(a,n);else{if(t&&Array.isArray(a))for(var o=0;o<a.length;++o)if(pe.isDynamic(a[o]))return void(i[n]=pe.unbox(a,n));r[n]=a}})),{dynamic:i,static:r}}re(!!e,"invalid args to regl({...})"),re.type(e,"object","invalid args to regl({...})");var n=i(e.context||{},!0),o=i(e.uniforms||{},!0),s=i(e.attributes||{},!1),u=i(r(e),!1),l={gpuTime:0,cpuTime:0,count:0},c=C.compile(u,s,o,n,l),f=c.draw,d=c.batch,h=c.scope,p=[];function m(e){for(;p.length<e;)p.push(null);return p}function g(e,t){var r;if(a&&re.raise("context lost"),"function"==typeof e)return h.call(this,null,e,0);if("function"==typeof t)if("number"==typeof e)for(r=0;r<e;++r)h.call(this,null,t,r);else{if(!Array.isArray(e))return h.call(this,e,t,0);for(r=0;r<e.length;++r)h.call(this,e[r],t,r)}else if("number"==typeof e){if(e>0)return d.call(this,m(0|e),0|e)}else{if(!Array.isArray(e))return f.call(this,e);if(e.length)return d.call(this,e,e.length)}}return t(g,{stats:l,destroy:function(){c.destroy()}})}E&&(E.addEventListener(Ts,M,!1),E.addEventListener(Ss,j,!1));var L=A.setFBO=W({framebuffer:pe.define.call(null,ks,"framebuffer")});function U(e,t){var r=0;C.procs.poll();var n=t.color;n&&(i.clearColor(+n[0]||0,+n[1]||0,+n[2]||0,+n[3]||0),r|=bs),"depth"in t&&(i.clearDepth(+t.depth),r|=xs),"stencil"in t&&(i.clearStencil(0|t.stencil),r|=ys),re(!!r,"called regl.clear with no buffer specified"),i.clear(r)}function H(e){if(re("object"==typeof e&&e,"regl.clear() takes an object as input"),"framebuffer"in e)if(e.framebuffer&&"framebufferCube"===e.framebuffer_reglType)for(var r=0;r<6;++r)L(t({framebuffer:e.framebuffer.faces[r]},e),U);else L(e,U);else U(null,e)}function G(e){function t(){var t=Ps(D,e);function r(){var e=Ps(D,r);D[e]=D[D.length-1],D.length-=1,D.length<=0&&O()}re(t>=0,"cannot cancel a frame twice"),D[t]=r}return re.type(e,"function","regl.frame() callback must be a function"),D.push(e),N(),{cancel:t}}function $(){var e=R.viewport,t=R.scissor_box;e[0]=e[1]=t[0]=t[1]=0,p.viewportWidth=p.framebufferWidth=p.drawingBufferWidth=e[2]=t[2]=i.drawingBufferWidth,p.viewportHeight=p.framebufferHeight=p.drawingBufferHeight=e[3]=t[3]=i.drawingBufferHeight}function q(){p.tick+=1,p.time=X(),$(),C.procs.poll()}function Z(){S.refresh(),$(),C.procs.refresh(),c&&c.update()}function X(){return(ge()-f)/1e3}function Y(e,t){var r;switch(re.type(t,"function","listener callback must be a function"),e){case"frame":return G(t);case"lost":r=z;break;case"restore":r=I;break;case"destroy":r=B;break;default:re.raise("invalid event, must be one of frame,lost,restore,destroy")}return r.push(t),{cancel:function(){for(var e=0;e<r.length;++e)if(r[e]===t)return r[e]=r[r.length-1],void r.pop()}}}Z();var Q=t(W,{clear:H,prop:pe.define.bind(null,ks),context:pe.define.bind(null,As),this:pe.define.bind(null,Cs),draw:W({}),buffer:function(e){return b.create(e,ws,!1,!1)},elements:function(e){return x.create(e,!1)},texture:S.create2D,cube:S.createCube,renderbuffer:k.create,framebuffer:A.create,framebufferCube:A.createCube,vao:y.createVAO,attributes:n,frame:G,on:Y,limits:v,hasExtension:function(e){return v.extensions.indexOf(e.toLowerCase())>=0},read:P,destroy:F,_gl:i,_refresh:Z,poll:function(){q(),c&&c.update()},now:X,stats:u});return r.onDone(null,Q),Q}return Rs}()}));const i=Object.freeze(["r","g","b","a"]),n=Object.freeze({dataChannelCount:4,desiredSwatchCapacity:1/0,attributes:[{attributeName:"TransitionTimeMs",isTimestamp:!0},{attributeName:"PositionWorld",isInterpolable:!0,components:["X","Y"]},{attributeName:"SizeWorld",isInterpolable:!0,isBroadcastable:!0,components:["Width","Height"]},{attributeName:"OrderZ",isInterpolable:!0,minValue:0,maxValue:1},{attributeName:"GeometricZoom",isInterpolable:!0,isBroadcastable:!0,components:["X","Y"]},{attributeName:"PositionPixel",isInterpolable:!0,components:["X","Y"]},{attributeName:"SizePixel",isInterpolable:!0,isBroadcastable:!0,components:["Width","Height"]},{attributeName:"MaxSizePixel",isInterpolable:!0,isBroadcastable:!0,components:["Width","Height"]},{attributeName:"MinSizePixel",isInterpolable:!0,isBroadcastable:!0,components:["Width","Height"]},{attributeName:"PositionRelative",isInterpolable:!0,components:["X","Y"]},{attributeName:"Sides"},{attributeName:"ShapeTexture",components:["U","V","Width","Height"]},{attributeName:"BorderRadiusPixel",isInterpolable:!0},{attributeName:"BorderRadiusRelative",isInterpolable:!0},{attributeName:"BorderPlacement",isInterpolable:!0},{attributeName:"BorderColor",isInterpolable:!0,components:["R","G","B","Opacity"]},{attributeName:"FillBlend",isInterpolable:!0},{attributeName:"FillColor",isInterpolable:!0,components:["R","G","B","Opacity"]},{attributeName:"FillTexture",components:["U","V","Width","Height"]}]});class a{constructor(e){const t=Object.assign({},n,e||{});if(!isFinite(t.maxTextureSize)&&!isFinite(t.desiredSwatchCapacity))throw new RangeError("Cannot map attributes to texture of infinite size");this.dataChannelCount=t.dataChannelCount,this.maxTextureSize=t.maxTextureSize,this.desiredSwatchCapacity=t.desiredSwatchCapacity,this.attributes=t.attributes,this.attributeComponentIndices={},this.attributeComponentNames=[],this.componentToAttributeMap={},this.isAttributeTimestamp=[];for(const e of this.attributes){const{attributeName:t,components:r}=e;for(const i of r||[""]){const r=`${t}${i}`;if(r in this.attributeComponentIndices)throw new Error(`Duplicate attribute component name detected: ${r}`);const n=this.attributeComponentNames.length;this.attributeComponentNames[n]=r,this.attributeComponentIndices[r]=n,this.componentToAttributeMap[r]=e,this.isAttributeTimestamp[n]=!!e.isTimestamp}}for(const e of this.attributes){if(!e.isInterpolable)continue;const{attributeName:t,components:r}=e;for(const i of r||[""]){const r=`${t}${i}Delta`;if(r in this.attributeComponentIndices)throw new Error(`Duplicate attribute component name detected: ${r}`);const n=this.attributeComponentNames.length;this.attributeComponentNames[n]=r,this.attributeComponentIndices[r]=n,this.isAttributeTimestamp[n]=!!e.isTimestamp}}Object.freeze(this.attributeComponentIndices),Object.freeze(this.attributeComponentNames),Object.freeze(this.isAttributeTimestamp),this.texelsPerSwatch=Math.ceil(this.attributeComponentNames.length/this.dataChannelCount),this.valuesPerSwatch=this.texelsPerSwatch*this.dataChannelCount,this.bytesPerSwatch=4*this.valuesPerSwatch,this.swatchesPerRow=Math.floor(this.maxTextureSize/this.texelsPerSwatch),this.textureWidth=this.texelsPerSwatch*this.swatchesPerRow,this.textureHeight=this.maxTextureSize,this.totalSwatches=this.swatchesPerRow*this.textureHeight,this.totalSwatches>this.desiredSwatchCapacity&&(this.swatchesPerRow=Math.min(this.swatchesPerRow,Math.ceil(Math.sqrt(this.desiredSwatchCapacity/this.texelsPerSwatch))),this.textureWidth=this.texelsPerSwatch*this.swatchesPerRow,this.textureHeight=Math.min(this.textureHeight,Math.ceil(this.desiredSwatchCapacity/this.swatchesPerRow)),this.totalSwatches=this.swatchesPerRow*this.textureHeight),this.valuesPerRow=this.swatchesPerRow*this.valuesPerSwatch,this.bytesPerRow=4*this.valuesPerRow,this.totalTexels=this.textureWidth*this.textureHeight,this.totalValues=this.totalTexels*this.dataChannelCount,this.totalBytes=4*this.totalValues,Object.freeze(this)}generateTexelReaderGLSL(e="texelValues",t="dataTexture",r="instanceSwatchUv"){const i=[],n=this.texelsPerSwatch;for(let a=0;a<n;a++){const n=(a%this.texelsPerSwatch+.5)/this.texelsPerSwatch/this.swatchesPerRow,o=(Math.floor(a/this.texelsPerSwatch)+.5)/this.textureHeight;i.push(`${e}[${a}] = texture2D(${t}, ${r} + vec2(${n}, ${o}));`)}return i.join("\n")}generateAttributeDefinesGLSL(e,t="texelValues"){return[...this.attributes.map((r=>{const{attributeName:n}=r,a=(r.components||[""]).map((e=>{const r=this.attributeComponentIndices[`${n}${e}`],a=Math.floor(r/this.dataChannelCount),o=i[r%this.dataChannelCount];return`${t}[${a}].${o}`})).join(", "),o=r.components?`vec${r.components.length}(${a})`:a;return`#define ${e}${n}() ${o}`})),...this.attributes.filter((e=>e.isInterpolable)).map((r=>{const{attributeName:i}=r,n=(r.components||[""]).map((e=>{const r=this.attributeComponentIndices[`${i}${e}Delta`],n=Math.floor(r/this.dataChannelCount),a=["r","g","b","a"][r%this.dataChannelCount];return`${t}[${n}].${a}`})).join(", "),a=r.components?`vec${r.components.length}(${n})`:n;return`#define ${e}${i}Delta() ${a}`}))].join("\n")}generateRebaseFragmentGLSL(e="previousTexelValues",t="targetTexelValues",r="texelIndex",n="rebaseTs"){const a={};for(const r of this.attributes){const{attributeName:o}=r;for(const s of r.components||[""]){const u=`${o}${s}`,l=this.attributeComponentIndices[u],c=Math.floor(l/this.dataChannelCount),f=i[l%this.dataChannelCount],d=`${e}[${c}].${f}`,h=`${t}[${c}].${f}`;if(c in a||(a[c]={}),r.isTimestamp){const e=`${n};`;a[c][f]=e}else if(r.isInterpolable){const t=`${u}Delta`,r=this.attributeComponentIndices[t],o=Math.floor(r/this.dataChannelCount),s=i[r%this.dataChannelCount];o in a||(a[o]={});const l=`${e}[${o}].${s}`;a[c][f]=`computeValueAtTime(${d}, ${l}, ${h}, ${n});`,a[o][s]=`computeDeltaAtTime(${d}, ${l}, ${h}, ${n});`}else a[c][f]=`computeThresholdValue(${d}, ${h}, ${n});`}}const o=[];for(let e=0;e<this.texelsPerSwatch;e++){const t=a[e];o.push(`if (${r} < ${e}.5) {`);for(let e=0;e<this.dataChannelCount;e++){const r=i[e];r in t&&o.push(`  gl_FragColor.${r} = ${t[r]}`)}o.push("  return;"),o.push("}")}return o.join("\n")}generateInstanceSwatchUvValues(){const e=new Float32Array(2*this.totalSwatches);for(let t=0;t<this.textureHeight;t++)for(let r=0;r<this.swatchesPerRow;r++){const i=2*(t*this.swatchesPerRow+r);e[i]=r/this.swatchesPerRow,e[i+1]=t/this.textureHeight}return e}}class o{constructor(e){this.callbackFn=e,this.xValue=0,this.yValue=0}get x(){return this.xValue}set x(e){if(isNaN(+e))throw new RangeError("x cannot be NaN");this.xValue=e,this.callbackFn()}get y(){return this.yValue}set y(e){if(isNaN(+e))throw new RangeError("y cannot be NaN");this.yValue=e,this.callbackFn()}}function s(e,...t){const r=[];for(let i=0;i<t.length;i++)r.push(e[i],`${t[i]}`);return r.push(e[e.length-1]),r.join("")}const u=["float","vec2","vec3","vec4"];function l(){return s`
float range(float x, float y, float a) {
  return (a - x) / (y - x);
}
`}function c(){return s`
float cubicEaseInOut(float t) {
  return t < 0.5 ? 4.0 * t * t * t :
    4.0 * (t - 1.0) * (t - 1.0) * (t - 1.0) + 1.0;
}
`}function f(e="t",t="varyingT"){return u.map((r=>s`
${r} computeCurrentValue(
    ${r} startingValue,
    ${r} startingVelocity,
    ${r} targetValue) {
  ${r} currentValue = mix(startingValue, targetValue, ${t});
  ${r} projectedValue = startingVelocity *
    (targetTransitionTimeMs() - previousTransitionTimeMs());
  return currentValue + projectedValue *
    ${e} * (1. - ${e}) * (1. - ${e}) * (1. - ${e});
}
  `)).join("\n")}function d(){return s`
/**
 * @param positionWorld The position of the sprite in world coords.
 * @param size Size of the sprite in world coordinates.
 * @param positionRelative Offset position relative to vert coords.
 * @param positionPixel Offset position in screen pixels.
 * @param vertCoords Local coordinates for this vertex.
 * @param viewMatrix Matrix to project world coords into view space (pixels).
 */
vec2 computeViewVertexPosition(
    vec2 positionWorld,
    vec2 size,
    vec2 positionRelative,
    vec2 positionPixel,
    vec2 vertCoords,
    mat3 viewMatrix
) {
  vec2 vertexPositionWorld =
    positionWorld + size * (positionRelative + vertCoords);
  vec2 viewVertexPosition =
    (viewMatrix * vec3(vertexPositionWorld, 1.)).xy + positionPixel * 4.;
  return viewVertexPosition;
}
`}function h(){return s`
/**
 *
 * @param sizeWorld Size of the sprite in world coordinates.
 * @param sizePixel Offset size of the sprite in pixels.
 * @param geometricZoom The geometric zoom size modifier.
 * @param viewMatrixScale XY scale (world coords to pixels), and ZW inverse.
 * @param maxSizePixel Maximum allowed size in pixels.
 * @param minSizePixel Minimum allowed size in pixels.
 */
vec2 computeSize(
  vec2 sizeWorld,
  vec2 sizePixel,
  vec2 geometricZoom,
  vec4 viewMatrixScale,
  vec2 maxSizePixel,
  vec2 minSizePixel
) {
  // Combine scale with geometric zoom effect.
  vec2 zoomScale = exp(log(viewMatrixScale.xy) * (1. - geometricZoom));

  // Project the size in world coordinates to pixels to apply min/max.
  vec2 projectedSizePixel = (sizeWorld * zoomScale + sizePixel * 4.);

  // Inital computed size in world coordinates is based on projected pixel size.
  vec2 computedSize = projectedSizePixel * viewMatrixScale.zw;

  // TODO(jimbo): Add border width to size if positioned externally.

  // Compute whether max and min size components are positive, in parallel.
  // XY contains results for max, ZW contains results for min.
  bvec4 isPositive = greaterThan(vec4(maxSizePixel, minSizePixel), vec4(0.));

  // Apply maximums if set.
  bvec2 gtMax = greaterThan(projectedSizePixel, maxSizePixel);
  if (isPositive.x && gtMax.x) {
    computedSize.x = maxSizePixel.x * viewMatrixScale.z;
  }
  if (isPositive.y && gtMax.y) {
    computedSize.y = maxSizePixel.y * viewMatrixScale.w;
  }

  // Apply minimums if set.
  bvec2 ltMin = lessThan(projectedSizePixel, minSizePixel);
  if (isPositive.z && ltMin.x) {
    computedSize.x = minSizePixel.x * viewMatrixScale.z;
  }
  if (isPositive.w && ltMin.y) {
    computedSize.y = minSizePixel.y * viewMatrixScale.w;
  }

  return computedSize;
}
`}function p(){return s`
vec4 computeCurrentSizePixelAndWorld() {
  return computeCurrentValue(
    vec4(
      previousSizePixel(),
      previousSizeWorld()),
    vec4(
      previousSizePixelDelta(),
      previousSizeWorldDelta()),
    vec4(
      targetSizePixel(),
      targetSizeWorld())
  );
}
`}function m(){return s`
vec4 computeCurrentMaxAndMinSizePixel() {
  return computeCurrentValue(
    vec4(
      previousMaxSizePixel(),
      previousMinSizePixel()
    ),
    vec4(
      previousMaxSizePixelDelta(),
      previousMinSizePixelDelta()
    ),
    vec4(
      targetMaxSizePixel(),
      targetMinSizePixel()
    )
  ) * 4.;
}
`}function g(e){return s`
precision lowp float;

/**
 * WebGL vertex shaders output coordinates in clip space, which is a 3D volume
 * where each component is clipped to the range (-1,1). The distance from
 * edge-to-edge is therefore 2.
 */
const float CLIP_SPACE_RANGE = 2.;

/**
 * Each sprite receives the same vertex coordinates, which describe a unit
 * square centered at the origin. However, the distance calculations performed
 * by the fragment shader use a distance of 1 to mean the dead center of a
 * circle, which implies a diameter of 2. So to convert from sprite vertex
 * coordinate space to edge distance space requires a dilation of 2.
 */
const float EDGE_DISTANCE_DILATION = 2.;

/**
 * Current uniform timestamp for interpolating.
 */
uniform float ts;

/**
 * Effective devicePixelRatio.
 */
uniform float devicePixelRatio;

/**
 * Total number of sprite instances being rendered this pass. Used to compute
 * clip-space Z for stacking sprites based on their instanceIndex.
 * This ensures that partial-opacity pixels of stacked sprites will be
 * alpha-blended. Without this, occluded sprites' pixels may not blend.
 */
uniform float instanceCount;

/**
 * Granularity expected in the value of OrderZ values. The higher the
 * granularity, the more control the user has over the Z position of sprites.
 * However, this leaves less precision for correctly positioning sprites which
 * have exactly the same OrderZ value.
 */
uniform float orderZGranularity;

/**
 * View and projection matrices for converting from world space to clip space.
 */
uniform mat3 viewMatrix;
uniform mat3 projectionMatrix;

/**
 * Scale includes the X and Y dimensions of the viewMatrix, and their inverses
 * in the WZ components.
 */
uniform vec4 viewMatrixScale;

/**
 * Data textures holding the previous and target Sprite instance
 * attributes. The instantaneous value for each attribute is determined by
 * interpolating between the previous and target according to the ts uniform.
 */
uniform sampler2D previousValuesTexture;
uniform sampler2D targetValuesTexture;

/**
 * Per-vertex coordinates for the quad into which the sprite will be rendered.
 * XY contain the local cartesian coordinates for a unit square centered at the
 * origin.
 *
 *   vertexCoordinates: [
 *     [-0.5, -0.5],
 *     [0.5, -0.5],
 *     [-0.5, 0.5],
 *     [0.5, 0.5],
 *   ],
 *
 */
attribute vec2 vertexCoordinates;

/**
 * Instanced, per-sprite index and UV coordinates of the sprite's data swatch.
 */
attribute float instanceIndex;
attribute vec2 instanceSwatchUv;

/**
 * Varying time value, eased using cubic-in-out between the previous and target
 * timestamps for this Sprite.
 */
varying float varyingT;

/**
 * Interpolated vertexCoordinates for fragment shader.
 */
varying vec2 varyingVertexCoordinates;

/**
 * Threshold distance values to consider the pixel outside the shape (X) or
 * inside the shape (Y). Values between constitute the border.
 */
varying vec2 varyingBorderThresholds;

/**
 * Aspect ratio of the sprite's renderable area (XY) and their inverses (ZW).
 * One component of each pair will be 1. For the XY pair, the other component
 * be be greater than 1. and for the inverse pair it will be smaller.
 *
 * For example, a rectangle that's twice as wide as it is tall would have
 * varyingAspectRatio equal to vec4(2., 1., .5, 1.).
 */
varying vec4 varyingAspectRatio;

/**
 * Color attributes used by fragment shader.
 */
varying vec4 varyingBorderColor;
varying vec4 varyingFillColor;

/**
 * Shape attributes used by fragment shader.
 */
varying float varyingPreviousSides;
varying float varyingTargetSides;
varying vec4 varyingPreviousShapeTexture;
varying vec4 varyingTargetShapeTexture;

// Import utility shader functions.
${l()}
${c()}

// These arrays are filled in by code generated by the AttributeMapper.
vec4 previousTexelValues[${e.texelsPerSwatch}];
vec4 targetTexelValues[${e.texelsPerSwatch}];

/**
 * Read data texel values into the previous and target arrays.
 */
void readTexels() {
    ${e.generateTexelReaderGLSL("previousTexelValues","previousValuesTexture","instanceSwatchUv")}
    ${e.generateTexelReaderGLSL("targetTexelValues","targetValuesTexture","instanceSwatchUv")}
}

// Dynamically generate #DEFINE statements to access texel attributes by name.
// These look like method invocations elsewhere in the code. For example, the
// define "targetTransitionTimeMs()" extracts the float value
// targetTexelValues[0].r.
${e.generateAttributeDefinesGLSL("previous","previousTexelValues")}
${e.generateAttributeDefinesGLSL("target","targetTexelValues")}

/**
 * Local, non-eased, normalized time value between 0 and 1, computed between the
 * previous and target timestamp according to the uniform ts.
 */
float t;

${f()}

/**
 * Precomputed constant value for converting colors in the 0-255 RGB range to
 * the GL standard 0-1 range. (1 / 255 = 0.00392156862745098)
 */
const vec4 GL_COLOR = vec4(vec3(0.00392156862745098), 1.);

/**
 * Function to compute all the varying values needed by the fragment shader.
 */
void setupVaryings() {
  // Clamp and range t value within previous and target timestamps.
  t =
    ts >= targetTransitionTimeMs() ? 1. :
    ts <= previousTransitionTimeMs() ? 0. :
    clamp(range(previousTransitionTimeMs(), targetTransitionTimeMs(), ts),
        0., 1.);

  // Compute eased varyingT.
  varyingT = cubicEaseInOut(t);

  // Copy and interpolate vertex coordinate values.
  varyingVertexCoordinates = vertexCoordinates;

  // Copy previous and target shape attributes.
  varyingPreviousSides = previousSides();
  varyingPreviousShapeTexture = previousShapeTexture();
  varyingTargetSides = targetSides();
  varyingTargetShapeTexture = targetShapeTexture();

  // Compute color attributes.
  varyingBorderColor = computeCurrentValue(
    previousBorderColor(),
    previousBorderColorDelta(),
    targetBorderColor()) * GL_COLOR;
  varyingFillColor = computeCurrentValue(
    previousFillColor(),
    previousFillColorDelta(),
    targetFillColor()) * GL_COLOR;
}

${s`
/**
 * @param size The size of the sprite.
 * @return The aspect ratio (XY) and the inverse of the aspect ratio (ZW).
 */
vec4 computeAspectRatio(vec2 size) {
  vec2 ar = size / min(size.x, size.y);
  return vec4(ar, 1. / ar);
}
`}
${m()}
${p()}
${h()}
${d()}

void main () {

  // Read data values from previous and target data textures.
  readTexels();

  // Setup varying values used both here and by the fragment shader.
  setupVaryings();

  // Compute current size component values by interpolation (parallelized).
  vec4 currentSizePixelAndWorld = computeCurrentSizePixelAndWorld();
  vec2 currentSizePixel = currentSizePixelAndWorld.xy;
  vec2 currentSizeWorld = currentSizePixelAndWorld.zw;

  vec2 currentGeometricZoom = computeCurrentValue(
      previousGeometricZoom(),
      previousGeometricZoomDelta(),
      targetGeometricZoom()
  );

  vec4 currentMaxAndMinSizePixel = computeCurrentMaxAndMinSizePixel();
  vec2 currentMaxSizePixel = currentMaxAndMinSizePixel.xy;
  vec2 currentMinSizePixel = currentMaxAndMinSizePixel.zw;

  // Compute the current size of the sprite in world units, including the effect
  // of geometric zoom and applying min and max pixel sizes.
  vec2 computedSize = computeSize(
    currentSizeWorld,
    currentSizePixel,
    currentGeometricZoom,
    viewMatrixScale,
    currentMaxSizePixel,
    currentMinSizePixel
  );

  // Compute border attributes in parallel.
  vec3 borderProperties = computeCurrentValue(
      vec3(
        previousBorderRadiusPixel(),
        previousBorderRadiusRelative(),
        previousBorderPlacement()),
      vec3(
        previousBorderRadiusPixelDelta(),
        previousBorderRadiusRelativeDelta(),
        previousBorderPlacementDelta()),
      vec3(
        targetBorderRadiusPixel(),
        targetBorderRadiusRelative(),
        targetBorderPlacement())
  );
  float currentBorderRadiusPixel = borderProperties.x;
  float currentBorderRadiusRelative = borderProperties.y;
  float currentBorderPlacement = borderProperties.z;

  // Project the computed size into pixels by using the viewMatrixScale. Note
  // that this already includes the effect of the devicePixelRatio, and a 2x
  // multiplier for clip-space, which goes from -1 to 1 in all dimensions.
  vec2 projectedSizePixel = computedSize.xy * viewMatrixScale.xy;

  // The fragment shader needs to know the threshold signed distances that
  // indicate whether each pixel is inside the shape, in the boreder, or outside
  // of the shape. A point right on the edge of the shape will have a distance
  // of 0. In edge-distance space, a distance of 1 would be the dead center of a
  // circle.
  float edgeDistance = currentBorderRadiusRelative + (
      currentBorderRadiusPixel *
      CLIP_SPACE_RANGE *
      EDGE_DISTANCE_DILATION *
      devicePixelRatio /
      min(projectedSizePixel.x, projectedSizePixel.y)
    );
  varyingBorderThresholds =
    vec2(0., edgeDistance) + mix(0., -edgeDistance, currentBorderPlacement);

  // Shift the quad vertices outward to account for borders, which may expand
  // the bounding box of the sprite.
  varyingVertexCoordinates *= (1. - varyingBorderThresholds.x);

  // Compute the sprite's aspect ratio and the inverse.
  varyingAspectRatio = computeAspectRatio(computedSize);

  // Compute the current position component attributes.
  vec2 currentPositionPixel = computeCurrentValue(
      previousPositionPixel(),
      previousPositionPixelDelta(),
      targetPositionPixel());

  vec2 currentPositionWorld = computeCurrentValue(
      previousPositionWorld(),
      previousPositionWorldDelta(),
      targetPositionWorld());

  vec2 currentPositionRelative = computeCurrentValue(
      previousPositionRelative(),
      previousPositionRelativeDelta(),
      targetPositionRelative());

  // Project the world position into pixel space, then add the pixel component.
  vec2 viewVertexPosition = computeViewVertexPosition(
      currentPositionWorld,
      computedSize,
      currentPositionRelative,
      currentPositionPixel,
      varyingVertexCoordinates,
      viewMatrix
  );

  // Project the pixel space coordinate into clip space.
  vec2 clipVertexPosition =
    (projectionMatrix * vec3(viewVertexPosition, 1.)).xy;

  // Compute the current user-specified OrderZ value.
  float currentOrderZ = computeCurrentValue(
      previousOrderZ(),
      previousOrderZDelta(),
      targetOrderZ());

  // Compute the stacking Z value for index-order blending.
  float stackZ = (1. + instanceIndex) / (1. + instanceCount);

  // Use provided granularity to combine current and stack Z values.
  float gInv = 1. / orderZGranularity;

  float combinedZ =
    mix(0., 1. - gInv, currentOrderZ) +
    mix(0., gInv, stackZ);

  // Project combined Z into clip space.
  float clipZ = mix(1., -1., combinedZ);

  gl_Position = vec4(clipVertexPosition, clipZ, 1.);
}
`}function v(e){return s`
precision lowp float;

attribute vec2 vertexCoordinates;

attribute vec2 instanceRebaseUv;

#define TEXELS_PER_SWATCH ${e.texelsPerSwatch}.
#define TEXTURE_WIDTH ${e.textureWidth}.
#define TEXTURE_HEIGHT ${e.textureHeight}.

varying vec2 varyingRebaseUv;
varying float varyingTexelIndex;

const vec2 swatchSize =
  vec2(TEXELS_PER_SWATCH / TEXTURE_WIDTH, 1. / TEXTURE_HEIGHT);

void main () {
  varyingRebaseUv = instanceRebaseUv;
  varyingTexelIndex = (vertexCoordinates.x + .5) * TEXELS_PER_SWATCH - .5;
  vec2 swatchUv = instanceRebaseUv + (vertexCoordinates.xy + .5) * swatchSize;
  gl_Position = vec4(2. * swatchUv - 1., 0., 1.);
}
`}const b=Object.freeze({requestAnimationFrame:e=>window.requestAnimationFrame(e),cancelAnimationFrame:e=>{window.cancelAnimationFrame(e)},now:()=>Date.now()}),x=1e20;class y{constructor(e=24,t=3,r=8,i=.25,n="sans-serif",a="normal"){this.fontSize=e,this.buffer=t,this.radius=r,this.cutoff=i,this.fontFamily=n,this.fontWeight=a;const o=this.size=this.fontSize+2*this.buffer;this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=o;const s=this.canvas.getContext("2d");if(!s)throw new Error("Could not get canvas 2d context");this.ctx=s,this.ctx.font=`${this.fontWeight} ${this.fontSize}px ${this.fontFamily}`,this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(o*o),this.gridInner=new Float64Array(o*o),this.f=new Float64Array(o),this.z=new Float64Array(o+1),this.v=new Uint16Array(o),this.middle=Math.round(o/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}draw(e){this.ctx.clearRect(0,0,this.size,this.size),this.ctx.fillText(e,this.buffer,this.middle);const t=this.ctx.getImageData(0,0,this.size,this.size);return function({imgData:e,size:t,radius:r,cutoff:i,gridOuter:n,gridInner:a,f:o,v:s,z:u}){const l=new Uint8ClampedArray(t*t);for(let r=0;r<t*t;r++){const t=e.data[4*r+3]/255;n[r]=1===t?0:0===t?x:Math.pow(Math.max(0,.5-t),2),a[r]=1===t?x:0===t?0:Math.pow(Math.max(0,t-.5),2)}w(n,t,t,o,s,u),w(a,t,t,o,s,u);for(let e=0;e<t*t;e++){const t=Math.sqrt(n[e])-Math.sqrt(a[e]);l[e]=Math.round(255-255*(t/r+i))}return l}(Object.assign(Object.assign({},this),{imgData:t}))}}function w(e,t,r,i,n,a){S(e,t,r,i,n,a),T(e,t,r,i,n,a)}function T(e,t,r,i,n,a){for(let o=0;o<r;o++)k(e,o*t,1,t,i,n,a)}function S(e,t,r,i,n,a){for(let o=0;o<t;o++)k(e,o,t,r,i,n,a)}function k(e,t,r,i,n,a,o){let s,u,l,c;for(a[0]=0,o[0]=-x,o[1]=x,s=0;s<i;s++)n[s]=e[t+s*r];for(s=1,u=0,l=0;s<i;s++){do{c=a[u],l=(n[s]-n[c]+s*s-c*c)/(s-c)/2}while(l<=o[u]&&--u>-1);u++,a[u]=s,o[u]=l,o[u+1]=x}for(s=0,u=0;s<i;s++){for(;o[u+1]<s;)u++;c=a[u],e[t+s*r]=n[c]+(s-c)*(s-c)}}const A=Object.freeze({maxTextureSize:2048,fontSize:32,buffer:32,radius:32,cutoff:1,fontFamily:"monospace",fontWeight:"normal"});class C{constructor(e=A){this.glyphToCoordinates=new Map;const t=Object.assign({},A,e||{});this.maxTextureSize=t.maxTextureSize,this.tinySDF=new y(t.fontSize,t.buffer,t.radius,t.cutoff,t.fontFamily,t.fontWeight),this.glyphSize=this.tinySDF.size,this.glyphsPerRow=Math.floor(this.maxTextureSize/this.glyphSize),this.glyphCapacity=this.glyphsPerRow*this.glyphsPerRow,this.textureSize=this.glyphsPerRow*this.glyphSize,this.textureData=new Float32Array(this.textureSize*this.textureSize)}hasGlyph(e){return this.glyphToCoordinates.has(e)}getGlyph(e){return this.glyphToCoordinates.get(e)}addGlyph(e){const t=this.getGlyph(e);if(t)return t;const r=this.glyphToCoordinates.size;if(r>=this.glyphCapacity)throw new Error("Cannot add glyph, already at capacity");const i=Math.floor(r/this.glyphsPerRow),n=r%this.glyphsPerRow,a=i*this.glyphSize*this.textureSize+n*this.glyphSize,{canvas:o,ctx:s,size:u,buffer:l,middle:c,radius:f,cutoff:d}=this.tinySDF;s.clearRect(0,0,u,u),s.fillText(e,l,c);const h=function(e,t,r=.5){const{width:i,height:n}=e,a=e.getContext("2d");if(!a)throw new Error("Could not get canvas 2d context");const o=a.getImageData(0,0,i,n),s=new Float64Array(i*n),u=new Float64Array(i*n),l=new Float64Array(i*n),c=new Float64Array(i*n),f=new Float64Array(i*n),d=new Float64Array(i*n),h=new Float64Array(i),p=new Float64Array(i+1),m=new Uint16Array(i);for(let e=0;e<i*n;e++){const t=o.data[4*e+3]/255;f[e]=l[e]=s[e]=1===t?0:0===t?x:Math.pow(Math.max(0,.5-t),2),d[e]=c[e]=u[e]=1===t?x:0===t?0:Math.pow(Math.max(0,t-.5),2)}w(f,i,n,h,m,p),w(d,i,n,h,m,p),T(s,i,n,h,m,p),T(u,i,n,h,m,p),S(l,i,n,h,m,p),S(c,i,n,h,m,p);const g=new Float32Array(i*n*3);for(let e=0;e<i*n;e++)g[3*e]=Math.max(0,1-((Math.sqrt(s[e])-Math.sqrt(u[e]))/t+r)),g[3*e+1]=Math.max(0,1-((Math.sqrt(l[e])-Math.sqrt(c[e]))/t+r)),g[3*e+2]=1-((Math.sqrt(f[e])-Math.sqrt(d[e]))/t+r);return g}(o,f,d);for(let e=0;e<this.glyphSize;e++)for(let t=0;t<this.glyphSize;t++){const r=3*(e*this.glyphSize+t)+2,i=a+e*this.textureSize+t;this.textureData[i]=h[r]}const p=Object.freeze({u:n/this.glyphsPerRow,v:i/this.glyphsPerRow,width:this.glyphSize/this.textureSize,height:this.glyphSize/this.textureSize});return this.glyphToCoordinates.set(e,p),p}get glyphs(){return[...this.glyphToCoordinates.keys()]}}const P=Object.freeze({container:document.body,defaultTransitionTimeMs:250,desiredSpriteCapacity:1e6,devicePixelRatio:void 0,glyphs:"!\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}",glyphMapper:A,orderZGranularity:10,timingFunctions:b}),R=Symbol("internalProperties"),E=Symbol("dataView"),D=Symbol("sceneInternal");class z{constructor(e){this[E]=e}get TransitionTimeMs(){return this[E][0]}set TransitionTimeMs(e){if(isNaN(e))throw new RangeError("TransitionTimeMs cannot be NaN");this[E][0]=e}get PositionWorldX(){return this[E][1]}set PositionWorldX(e){if(isNaN(e))throw new RangeError("PositionWorldX cannot be NaN");this[E][1]=e}get PositionWorldY(){return this[E][2]}set PositionWorldY(e){if(isNaN(e))throw new RangeError("PositionWorldY cannot be NaN");this[E][2]=e}get SizeWorldWidth(){return this[E][3]}set SizeWorldWidth(e){if(isNaN(e))throw new RangeError("SizeWorldWidth cannot be NaN");this[E][3]=e}get SizeWorldHeight(){return this[E][4]}set SizeWorldHeight(e){if(isNaN(e))throw new RangeError("SizeWorldHeight cannot be NaN");this[E][4]=e}get OrderZ(){return this[E][5]}set OrderZ(e){if(isNaN(e))throw new RangeError("OrderZ cannot be NaN");if(e<0)throw new RangeError("OrderZ cannot be less than 0");if(e>1)throw new RangeError("OrderZ cannot be greater than 1");this[E][5]=e}get GeometricZoomX(){return this[E][6]}set GeometricZoomX(e){if(isNaN(e))throw new RangeError("GeometricZoomX cannot be NaN");this[E][6]=e}get GeometricZoomY(){return this[E][7]}set GeometricZoomY(e){if(isNaN(e))throw new RangeError("GeometricZoomY cannot be NaN");this[E][7]=e}get PositionPixelX(){return this[E][8]}set PositionPixelX(e){if(isNaN(e))throw new RangeError("PositionPixelX cannot be NaN");this[E][8]=e}get PositionPixelY(){return this[E][9]}set PositionPixelY(e){if(isNaN(e))throw new RangeError("PositionPixelY cannot be NaN");this[E][9]=e}get SizePixelWidth(){return this[E][10]}set SizePixelWidth(e){if(isNaN(e))throw new RangeError("SizePixelWidth cannot be NaN");this[E][10]=e}get SizePixelHeight(){return this[E][11]}set SizePixelHeight(e){if(isNaN(e))throw new RangeError("SizePixelHeight cannot be NaN");this[E][11]=e}get MaxSizePixelWidth(){return this[E][12]}set MaxSizePixelWidth(e){if(isNaN(e))throw new RangeError("MaxSizePixelWidth cannot be NaN");this[E][12]=e}get MaxSizePixelHeight(){return this[E][13]}set MaxSizePixelHeight(e){if(isNaN(e))throw new RangeError("MaxSizePixelHeight cannot be NaN");this[E][13]=e}get MinSizePixelWidth(){return this[E][14]}set MinSizePixelWidth(e){if(isNaN(e))throw new RangeError("MinSizePixelWidth cannot be NaN");this[E][14]=e}get MinSizePixelHeight(){return this[E][15]}set MinSizePixelHeight(e){if(isNaN(e))throw new RangeError("MinSizePixelHeight cannot be NaN");this[E][15]=e}get PositionRelativeX(){return this[E][16]}set PositionRelativeX(e){if(isNaN(e))throw new RangeError("PositionRelativeX cannot be NaN");this[E][16]=e}get PositionRelativeY(){return this[E][17]}set PositionRelativeY(e){if(isNaN(e))throw new RangeError("PositionRelativeY cannot be NaN");this[E][17]=e}get Sides(){return this[E][18]}set Sides(e){if(isNaN(e))throw new RangeError("Sides cannot be NaN");this[E][18]=e}get ShapeTextureU(){return this[E][19]}set ShapeTextureU(e){if(isNaN(e))throw new RangeError("ShapeTextureU cannot be NaN");this[E][19]=e}get ShapeTextureV(){return this[E][20]}set ShapeTextureV(e){if(isNaN(e))throw new RangeError("ShapeTextureV cannot be NaN");this[E][20]=e}get ShapeTextureWidth(){return this[E][21]}set ShapeTextureWidth(e){if(isNaN(e))throw new RangeError("ShapeTextureWidth cannot be NaN");this[E][21]=e}get ShapeTextureHeight(){return this[E][22]}set ShapeTextureHeight(e){if(isNaN(e))throw new RangeError("ShapeTextureHeight cannot be NaN");this[E][22]=e}get BorderRadiusPixel(){return this[E][23]}set BorderRadiusPixel(e){if(isNaN(e))throw new RangeError("BorderRadiusPixel cannot be NaN");this[E][23]=e}get BorderRadiusRelative(){return this[E][24]}set BorderRadiusRelative(e){if(isNaN(e))throw new RangeError("BorderRadiusRelative cannot be NaN");this[E][24]=e}get BorderPlacement(){return this[E][25]}set BorderPlacement(e){if(isNaN(e))throw new RangeError("BorderPlacement cannot be NaN");this[E][25]=e}get BorderColorR(){return this[E][26]}set BorderColorR(e){if(isNaN(e))throw new RangeError("BorderColorR cannot be NaN");this[E][26]=e}get BorderColorG(){return this[E][27]}set BorderColorG(e){if(isNaN(e))throw new RangeError("BorderColorG cannot be NaN");this[E][27]=e}get BorderColorB(){return this[E][28]}set BorderColorB(e){if(isNaN(e))throw new RangeError("BorderColorB cannot be NaN");this[E][28]=e}get BorderColorOpacity(){return this[E][29]}set BorderColorOpacity(e){if(isNaN(e))throw new RangeError("BorderColorOpacity cannot be NaN");this[E][29]=e}get FillBlend(){return this[E][30]}set FillBlend(e){if(isNaN(e))throw new RangeError("FillBlend cannot be NaN");this[E][30]=e}get FillColorR(){return this[E][31]}set FillColorR(e){if(isNaN(e))throw new RangeError("FillColorR cannot be NaN");this[E][31]=e}get FillColorG(){return this[E][32]}set FillColorG(e){if(isNaN(e))throw new RangeError("FillColorG cannot be NaN");this[E][32]=e}get FillColorB(){return this[E][33]}set FillColorB(e){if(isNaN(e))throw new RangeError("FillColorB cannot be NaN");this[E][33]=e}get FillColorOpacity(){return this[E][34]}set FillColorOpacity(e){if(isNaN(e))throw new RangeError("FillColorOpacity cannot be NaN");this[E][34]=e}get FillTextureU(){return this[E][35]}set FillTextureU(e){if(isNaN(e))throw new RangeError("FillTextureU cannot be NaN");this[E][35]=e}get FillTextureV(){return this[E][36]}set FillTextureV(e){if(isNaN(e))throw new RangeError("FillTextureV cannot be NaN");this[E][36]=e}get FillTextureWidth(){return this[E][37]}set FillTextureWidth(e){if(isNaN(e))throw new RangeError("FillTextureWidth cannot be NaN");this[E][37]=e}get FillTextureHeight(){return this[E][38]}set FillTextureHeight(e){if(isNaN(e))throw new RangeError("FillTextureHeight cannot be NaN");this[E][38]=e}set PositionWorld(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.PositionWorldX=e[0],t=!0),"1"in e&&(this.PositionWorldY=e[1],t=!0),!t)throw new TypeError("No PositionWorld component index values were found")}else{if("object"!=typeof e)throw new TypeError("PositionWorld setter argument must be an array or object");{let t=!1;if("x"in e&&(this.PositionWorldX=e.x,t=!0),"y"in e&&(this.PositionWorldY=e.y,t=!0),!t)throw new TypeError("No PositionWorld component key values were found")}}}set SizeWorld(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.SizeWorldWidth=e[0],t=!0),"1"in e&&(this.SizeWorldHeight=e[1],t=!0),!t)throw new TypeError("No SizeWorld component index values were found")}else if("object"!=typeof e)this.SizeWorldWidth=e,this.SizeWorldHeight=e;else{let t=!1;if("width"in e&&(this.SizeWorldWidth=e.width,t=!0),"height"in e&&(this.SizeWorldHeight=e.height,t=!0),!t)throw new TypeError("No SizeWorld component key values were found")}}set GeometricZoom(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.GeometricZoomX=e[0],t=!0),"1"in e&&(this.GeometricZoomY=e[1],t=!0),!t)throw new TypeError("No GeometricZoom component index values were found")}else if("object"!=typeof e)this.GeometricZoomX=e,this.GeometricZoomY=e;else{let t=!1;if("x"in e&&(this.GeometricZoomX=e.x,t=!0),"y"in e&&(this.GeometricZoomY=e.y,t=!0),!t)throw new TypeError("No GeometricZoom component key values were found")}}set PositionPixel(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.PositionPixelX=e[0],t=!0),"1"in e&&(this.PositionPixelY=e[1],t=!0),!t)throw new TypeError("No PositionPixel component index values were found")}else{if("object"!=typeof e)throw new TypeError("PositionPixel setter argument must be an array or object");{let t=!1;if("x"in e&&(this.PositionPixelX=e.x,t=!0),"y"in e&&(this.PositionPixelY=e.y,t=!0),!t)throw new TypeError("No PositionPixel component key values were found")}}}set SizePixel(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.SizePixelWidth=e[0],t=!0),"1"in e&&(this.SizePixelHeight=e[1],t=!0),!t)throw new TypeError("No SizePixel component index values were found")}else if("object"!=typeof e)this.SizePixelWidth=e,this.SizePixelHeight=e;else{let t=!1;if("width"in e&&(this.SizePixelWidth=e.width,t=!0),"height"in e&&(this.SizePixelHeight=e.height,t=!0),!t)throw new TypeError("No SizePixel component key values were found")}}set MaxSizePixel(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.MaxSizePixelWidth=e[0],t=!0),"1"in e&&(this.MaxSizePixelHeight=e[1],t=!0),!t)throw new TypeError("No MaxSizePixel component index values were found")}else if("object"!=typeof e)this.MaxSizePixelWidth=e,this.MaxSizePixelHeight=e;else{let t=!1;if("width"in e&&(this.MaxSizePixelWidth=e.width,t=!0),"height"in e&&(this.MaxSizePixelHeight=e.height,t=!0),!t)throw new TypeError("No MaxSizePixel component key values were found")}}set MinSizePixel(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.MinSizePixelWidth=e[0],t=!0),"1"in e&&(this.MinSizePixelHeight=e[1],t=!0),!t)throw new TypeError("No MinSizePixel component index values were found")}else if("object"!=typeof e)this.MinSizePixelWidth=e,this.MinSizePixelHeight=e;else{let t=!1;if("width"in e&&(this.MinSizePixelWidth=e.width,t=!0),"height"in e&&(this.MinSizePixelHeight=e.height,t=!0),!t)throw new TypeError("No MinSizePixel component key values were found")}}set PositionRelative(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.PositionRelativeX=e[0],t=!0),"1"in e&&(this.PositionRelativeY=e[1],t=!0),!t)throw new TypeError("No PositionRelative component index values were found")}else{if("object"!=typeof e)throw new TypeError("PositionRelative setter argument must be an array or object");{let t=!1;if("x"in e&&(this.PositionRelativeX=e.x,t=!0),"y"in e&&(this.PositionRelativeY=e.y,t=!0),!t)throw new TypeError("No PositionRelative component key values were found")}}}set ShapeTexture(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.ShapeTextureU=e[0],t=!0),"1"in e&&(this.ShapeTextureV=e[1],t=!0),"2"in e&&(this.ShapeTextureWidth=e[2],t=!0),"3"in e&&(this.ShapeTextureHeight=e[3],t=!0),!t)throw new TypeError("No ShapeTexture component index values were found")}else{if("object"!=typeof e)throw new TypeError("ShapeTexture setter argument must be an array or object");{let t=!1;if("u"in e&&(this.ShapeTextureU=e.u,t=!0),"v"in e&&(this.ShapeTextureV=e.v,t=!0),"width"in e&&(this.ShapeTextureWidth=e.width,t=!0),"height"in e&&(this.ShapeTextureHeight=e.height,t=!0),!t)throw new TypeError("No ShapeTexture component key values were found")}}}set BorderColor(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.BorderColorR=e[0],t=!0),"1"in e&&(this.BorderColorG=e[1],t=!0),"2"in e&&(this.BorderColorB=e[2],t=!0),"3"in e&&(this.BorderColorOpacity=e[3],t=!0),!t)throw new TypeError("No BorderColor component index values were found")}else{if("object"!=typeof e)throw new TypeError("BorderColor setter argument must be an array or object");{let t=!1;if("r"in e&&(this.BorderColorR=e.r,t=!0),"g"in e&&(this.BorderColorG=e.g,t=!0),"b"in e&&(this.BorderColorB=e.b,t=!0),"opacity"in e&&(this.BorderColorOpacity=e.opacity,t=!0),!t)throw new TypeError("No BorderColor component key values were found")}}}set FillColor(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.FillColorR=e[0],t=!0),"1"in e&&(this.FillColorG=e[1],t=!0),"2"in e&&(this.FillColorB=e[2],t=!0),"3"in e&&(this.FillColorOpacity=e[3],t=!0),!t)throw new TypeError("No FillColor component index values were found")}else{if("object"!=typeof e)throw new TypeError("FillColor setter argument must be an array or object");{let t=!1;if("r"in e&&(this.FillColorR=e.r,t=!0),"g"in e&&(this.FillColorG=e.g,t=!0),"b"in e&&(this.FillColorB=e.b,t=!0),"opacity"in e&&(this.FillColorOpacity=e.opacity,t=!0),!t)throw new TypeError("No FillColor component key values were found")}}}set FillTexture(e){if(Array.isArray(e)){let t=!1;if("0"in e&&(this.FillTextureU=e[0],t=!0),"1"in e&&(this.FillTextureV=e[1],t=!0),"2"in e&&(this.FillTextureWidth=e[2],t=!0),"3"in e&&(this.FillTextureHeight=e[3],t=!0),!t)throw new TypeError("No FillTexture component index values were found")}else{if("object"!=typeof e)throw new TypeError("FillTexture setter argument must be an array or object");{let t=!1;if("u"in e&&(this.FillTextureU=e.u,t=!0),"v"in e&&(this.FillTextureV=e.v,t=!0),"width"in e&&(this.FillTextureWidth=e.width,t=!0),"height"in e&&(this.FillTextureHeight=e.height,t=!0),!t)throw new TypeError("No FillTexture component key values were found")}}}}class I extends Error{}var B;function V(e,t){return e===t?NaN:1<<5*e+t-+(t>e)}!function(e){e[e.Created=0]="Created",e[e.Rest=1]="Rest",e[e.HasCallback=2]="HasCallback",e[e.NeedsRebase=3]="NeedsRebase",e[e.NeedsTextureSync=4]="NeedsTextureSync",e[e.Removed=5]="Removed"}(B||(B={}));const _=function(){const{Created:e,Rest:t,HasCallback:r,NeedsRebase:i,NeedsTextureSync:n,Removed:a}=B;let o=0;return o|=V(e,t),o|=V(e,a),o|=V(t,r),o|=V(t,n),o|=V(r,i),o|=V(r,n),o|=V(i,n),o|=V(n,t),o|=V(n,r),o|=V(n,a),o}();class N{constructor(){this.isDefined=!1,this.lowBound=NaN,this.highBound=NaN}clear(){this.isDefined=!1,this.lowBound=NaN,this.highBound=NaN}expandToInclude(e){if(!this.isDefined)return this.lowBound=e,this.highBound=e,void(this.isDefined=!0);e<this.lowBound&&(this.lowBound=e),e>this.highBound&&(this.highBound=e)}truncateToWithin(e,t){if(isNaN(+e)||isNaN(+t))throw new RangeError("Both values must be numbers");if(t<e)throw new RangeError("High bound must be greater than or equal to low bound");this.isDefined&&(e>this.highBound||t<this.lowBound?this.clear():(this.lowBound<e&&(this.lowBound=e),this.highBound>t&&(this.highBound=t)))}overlaps(e){return this.isDefined&&e.isDefined&&this.lowBound<=e.highBound&&this.highBound>=e.lowBound}}var O;!function(e){e[e.None=0]="None",e[e.Blocked=1]="Blocked",e[e.Scheduled=2]="Scheduled",e[e.Started=3]="Started"}(O||(O={}));class M{constructor(e,t){this.stepsBetweenChecks=e,this.coordinator=t,this.sprites=[],this.boundData=[],this.bindingState=O.None,this.hasWarned=!1,this.bindingTaskId=Symbol("bindingTask"),this.clearingTaskId=Symbol("clearingTask")}onBind(e){return this.bindCallback=e,this}onInit(e){return this.initCallback=e,this}onEnter(e){return this.enterCallback=e,this}onUpdate(e){return this.updateCallback=e,this}onExit(e){return this.exitCallback=e,this}bind(e,t){if(t)throw new Error("keyFn mapping is not yet supported");if(this.hasWarned||this.bindingState!==O.Scheduled||(console.warn("Possibly conflicting .bind() invocations detected"),this.hasWarned=!0),this.clearingTask)return this.bindingState=O.Blocked,this.coordinator.workScheduler.scheduleUniqueTask({id:this.bindingTaskId,callback:()=>{this.bindingState=O.None,this.bind(e,t)}}),this;let r=0;const i=e.length;let n=this.boundData.length;const a=t=>{for(;n<i;){r++;const i=n++,a=e[i],o=this.coordinator.createSprite();this.boundData[i]=a,this.sprites[i]=o;const{initCallback:s,enterCallback:u,bindCallback:l}=this;if((s||l)&&o.enter((e=>{l&&l(e,a),s&&s(e,a),e.TransitionTimeMs=0})),(u||l)&&o.update((e=>{l&&l(e,a),u&&u(e,a)})),r%this.stepsBetweenChecks==0&&t()<=0)break}return n>=i};let o=0;const s=Math.min(i,this.boundData.length),u=t=>{for(;o<s;){r++;const i=o++,n=e[i],a=this.sprites[i];this.boundData[i]=n;const{updateCallback:s,bindCallback:u}=this;if((s||u)&&a.update((e=>{u&&u(e,n),s&&s(e,n)})),r%this.stepsBetweenChecks==0&&t()<=0)break}return o>=s},l=e=>{let t=i;for(;t<this.boundData.length;){r++;const i=this.boundData[t],n=this.sprites[t];if(t++,n.isAbandoned||n.isActive||n.isRemoved){const{exitCallback:e,bindCallback:t}=this;n.exit((r=>{t&&t(r,i),e&&e(r,i)}))}else n.abandon();if(r%this.stepsBetweenChecks==0&&e()<=0)break}return t>i&&(this.boundData.splice(i,t-i),this.sprites.splice(i,t-i)),this.boundData.length<=i};return this.bindingTask={id:this.bindingTaskId,callback:e=>{this.bindingState=O.Started,r=0;const t=l(e)&&u(e)&&a(e);return t&&(delete this.bindingTask,this.bindingState=O.None),t},runUntilDone:!0},this.coordinator.workScheduler.scheduleUniqueTask(this.bindingTask),this.bindingState=O.Scheduled,this}clear(){let e=0;const{exitCallback:t,bindCallback:r}=this,i=i=>{let n=0;for(;n<this.boundData.length;){e++;const a=this.boundData[n],o=this.sprites[n];if(n++,o.isAbandoned||o.isActive||o.isRemoved?o.exit((e=>{r&&r(e,a),t&&t(e,a)})):o.abandon(),e%this.stepsBetweenChecks==0&&i()<=0)break}return this.boundData.splice(0,n),this.sprites.splice(0,n),!this.boundData.length};return this.clearingTask={id:this.clearingTaskId,callback:t=>{e=0;const r=i(t);return r&&delete this.clearingTask,r},runUntilDone:!0},this.bindingTask&&(this.coordinator.workScheduler.unscheduleTask(this.bindingTask),delete this.bindingTask),this.coordinator.workScheduler.scheduleUniqueTask(this.clearingTask),this.bindingState=O.None,this}hitTest(e){const t=this.coordinator.hitTest(Object.assign(Object.assign({},e),{sprites:this.sprites})),r=new Uint32Array(t.length);let i=0;for(let e=0;e<t.length;e++){t[e]>=0&&(r[i++]=e)}if(!i)return[];(void 0===e.sortResults||e.sortResults)&&r.subarray(0,i).sort(((e,r)=>t[e]-t[r]));const n=new Array(i);for(let e=0;e<i;e++)n[e]=this.boundData[r[e]];return n}}class j{constructor(){this.internalLifecyclePhase=B.Created}get hasCallback(){return!!(this.enterCallback||this.updateCallback||this.exitCallback)}get lifecyclePhase(){return this.internalLifecyclePhase}set lifecyclePhase(e){!function(e,t){if(!(V(e,t)&_))throw new I("Illegal sprite lifecycle phase transition")}(this.internalLifecyclePhase,e),this.internalLifecyclePhase=e}}class F{constructor(e){this.coordinator=e,this[R]=new j}enter(e){if(this.isAbandoned)throw new Error("Cannot add enter callback to abandoned sprite");if(this.isRemoved)throw new Error("Cannot add enter callback to Removed sprite");const t=this[R];if(t.enterCallback=e,t.lifecyclePhase===B.Rest){if(void 0===t.index)throw new I("Sprite lacks index");this.coordinator.markSpriteCallback(t.index),t.lifecyclePhase=B.HasCallback}return this}update(e){if(this.isAbandoned)throw new Error("Cannot add update callback to abandoned sprite");if(this.isRemoved)throw new Error("Cannot add update callback to Removed sprite");const t=this[R];if(t.updateCallback=e,t.lifecyclePhase===B.Rest){if(void 0===t.index)throw new I("Sprite lacks index");this.coordinator.markSpriteCallback(t.index),t.lifecyclePhase=B.HasCallback}return this}exit(e){if(this.isAbandoned)throw new Error("Cannot add exit callback to abandoned sprite");if(this.isRemoved)throw new Error("Cannot add exit callback to Removed sprite");const t=this[R];if(t.exitCallback=e,t.toBeRemoved=!0,t.lifecyclePhase===B.Rest){if(void 0===t.index)throw new I("Sprite lacks index");this.coordinator.markSpriteCallback(t.index),t.lifecyclePhase=B.HasCallback}return this}abandon(){if(this.isAbandoned)throw new Error("Cannot abandon a Sprite already marked abandoned");if(this.isRemoved)throw new Error("Cannot abandon a Sprite that has been removed");if(this.isActive)throw new Error("Cannot abandon an active Sprite");const e=this[R];e.isAbandoned=!0,e.enterCallback=void 0,e.updateCallback=void 0,e.exitCallback=void 0,e.toBeRemoved=!0,e.lifecyclePhase=B.Removed}get isActive(){const e=this[R].lifecyclePhase;return e!==B.Created&&e!==B.Removed}get isAbandoned(){return!!this[R].isAbandoned}get isRemoved(){return this[R].lifecyclePhase===B.Removed}}function W(e,t){const r=new N;if(!e.isDefined)return r;const{lowBound:i,highBound:n}=e,a=Math.floor(i/t),o=Math.floor(n/t)+1;return r.expandToInclude(a*t),r.expandToInclude(o*t-1),r}const L="center",U="middle";class H{constructor(e,t,r,i){this.stepsBetweenChecks=e,this.renderer=t,this.workScheduler=r,this.glyphMapper=i,this.selections=[],this.boundData=[],this.bindingTaskId=Symbol("bindingTask"),this.clearingTaskId=Symbol("clearingTask"),this.textCallback=e=>`${e}`,this.alignCallback=()=>L,this.verticalAlignCallback=()=>U}text(e){return this.textCallback=e,this}align(e){return this.alignCallback=e,this}verticalAlign(e){return this.verticalAlignCallback=e,this}onBind(e){return this.bindCallback=e,this}onInit(e){return this.initCallback=e,this}onEnter(e){return this.enterCallback=e,this}onUpdate(e){return this.updateCallback=e,this}onExit(e){return this.exitCallback=e,this}datumToGlyphs(e){const t=(this.textCallback?this.textCallback.call(e,e):`${e}`).trim(),r=this.alignCallback&&this.alignCallback(e)||L,i=this.verticalAlignCallback&&this.verticalAlignCallback(e)||U,n=[];for(let a=0;a<t.length;a++){let o,s;o="left"===r?.5*(a+1):"right"===r?.5*(a+1-t.length):.5*(a+.75-.5*t.length),s="top"===i?-.5:"bottom"===i?.5:0;const u=this.glyphMapper.getGlyph(t.charAt(a));u&&n.push({datum:e,coords:u,position:{x:o,y:s}})}return n}bind(e,t){if(t)throw new Error("keyFn mapping is not yet supported");if(this.clearingTask)return this.workScheduler.scheduleUniqueTask({id:this.bindingTaskId,callback:()=>this.bind(e,t)}),this;let r=0;const i=e.length;let n=this.boundData.length;const a=t=>{for(;n<i;){r++;const i=n++,a=e[i],o=this.renderer.createSelection();if(this.boundData.push(a),this.selections.push(o),o.onInit(((e,t)=>{this.initCallback&&this.initCallback(e,t.datum)})),o.onEnter(((e,t)=>{this.enterCallback&&this.enterCallback(e,t.datum)})),o.onUpdate(((e,t)=>{this.updateCallback&&this.updateCallback(e,t.datum)})),o.onExit(((e,t)=>{this.exitCallback&&this.exitCallback(e,t.datum)})),o.onBind(((e,t)=>{e.Sides=0,e.ShapeTexture=t.coords,e.PositionRelative=t.position,this.bindCallback&&this.bindCallback(e,t.datum)})),o.bind(this.datumToGlyphs(a)),r%this.stepsBetweenChecks==0&&t()<=0)break}return n>=i};let o=0;const s=Math.min(i,this.boundData.length),u=t=>{for(;o<s;){r++;const i=o++,n=e[i],a=this.selections[i];if(this.boundData[i]=n,a.bind(this.datumToGlyphs(n)),r%this.stepsBetweenChecks==0&&t()<=0)return!1}return o>=s},l=e=>{let t=i;for(;t<this.boundData.length;){r++;const i=this.selections[t];if(t++,i.bind([]),r%this.stepsBetweenChecks==0&&e()<=0)break}return this.boundData.splice(i,t-i),this.selections.splice(i,t-i),i>=this.boundData.length};return this.bindingTask={id:this,callback:e=>(r=0,l(e)&&u(e)&&a(e)),runUntilDone:!0},this.workScheduler.scheduleUniqueTask(this.bindingTask),this}clear(){let e=0;const t=t=>{let r=0;for(;r<this.boundData.length;){e++;const i=this.selections[r];if(r++,i.clear(),e%this.stepsBetweenChecks==0&&t()<=0)break}return this.boundData.splice(0,r),this.selections.splice(0,r),!this.boundData.length};return this.clearingTask={id:this.clearingTaskId,callback:r=>{e=0;const i=t(r);return i&&delete this.clearingTask,i},runUntilDone:!0},this.bindingTask&&(this.workScheduler.unscheduleTask(this.bindingTask),delete this.bindingTask),this.workScheduler.scheduleUniqueTask(this.clearingTask),this}hitTest(e){throw new Error("Not yet implemented")}}function G(e){return!(!e||!(e instanceof Function||e.callback instanceof Function))}function $(e){if(!G(e))throw new Error("Provided object was not a work task or function");return e instanceof Function?e:void 0!==e.id?e.id:e.callback}function q(e){if(!G(e))throw new Error("Provided object was not a work task or function");return e instanceof Function?{callback:e,id:e}:void 0!==e.id?e:Object.assign(Object.assign({},e),{id:e.callback})}class Z{constructor(){this.idSet=new Set,this.taskList=[]}get length(){return this.taskList.length}hasTaskId(e){return this.idSet.has(e)}hasTask(e){return this.hasTaskId($(e))}getTaskById(e){if(!this.hasTaskId(e))return;const t=this.findTaskIndexById(e);if(-1===t)throw new I("Could not find matching task in task list");return this.taskList[t]}enqueueTask(e){if(this.hasTask(e))return;const t=q(e);this.idSet.add(t.id),this.taskList.push(t)}dequeueTask(){const e=this.taskList.shift();if(!e)throw new Error("No tasks remain to dequeue");return this.idSet.delete(e.id),e}removeTaskById(e){if(!this.hasTaskId(e))return;const t=this.findTaskIndexById(e);if(-1===t)throw new I("Could not find matching task in task list");const[r]=this.taskList.splice(t,1);return this.idSet.delete(r.id),r}removeTask(e){return this.removeTaskById($(e))}findTaskIndexById(e){let t=-1;for(let r=0;r<this.taskList.length;r++)if(this.taskList[r].id===e){if(-1!==t)throw new I("Duplicate task found in task list");t=r}return t}}const X=Object.freeze({timingFunctions:b,maxWorkTimeMs:20});class Y{constructor(e=X){this.isEnabled=!1,this.isPerformingWork=!1,this.presentWorkQueue=new Z,this.futureWorkQueue=new Z;const t=Object.assign({},X,e||{});this.timingFunctions=Object.freeze(Object.assign({},b,t&&t.timingFunctions||{})),this.maxWorkTimeMs=t.maxWorkTimeMs,this.enable()}scheduleTask(e){const t=q(e);return this.presentWorkQueue.hasTask(t)||this.futureWorkQueue.hasTask(t)||(this.isPerformingWork&&!t.beginImmediately?this.futureWorkQueue.enqueueTask(t):this.presentWorkQueue.enqueueTask(t)),this.updateTimer(),t}getTask(e){const t=$(e),r=this.presentWorkQueue.getTaskById(t),i=this.futureWorkQueue.getTaskById(t);if(r&&i)throw new I("Found two matching tasks when at most one is allowed");return r||i||void 0}unscheduleTask(e){const t=$(e),r=this.presentWorkQueue.removeTaskById(t),i=this.futureWorkQueue.removeTaskById(t);if(r&&i)throw new I("Found two matching tasks when at most one is allowed");return this.updateTimer(),r||i||void 0}isScheduledTask(e){return this.isScheduledId($(e))}isScheduledId(e){return this.presentWorkQueue.hasTaskId(e)||this.futureWorkQueue.hasTaskId(e)}scheduleUniqueTask(e){const t=q(e);return this.unscheduleTask(t),this.scheduleTask(t),t}enable(){return this.isEnabled=!0,this.updateTimer(),this}disable(){return this.isEnabled=!1,this.updateTimer(),this}updateTimer(){if(this.isEnabled&&this.presentWorkQueue.length){if(void 0===this.animationFrameTimer){const{requestAnimationFrame:e}=this.timingFunctions;this.animationFrameTimer=e((()=>{this.animationFrameTimer=void 0,this.performWork()}))}}else if(void 0!==this.animationFrameTimer){const{cancelAnimationFrame:e}=this.timingFunctions;e(this.animationFrameTimer),this.animationFrameTimer=void 0}}performWork(){if(this.isPerformingWork)throw new I("Only one invocation of performWork is allowed at a time");this.isPerformingWork=!0;const{now:e}=this.timingFunctions;let t=0;const r=e(),i=()=>this.maxWorkTimeMs+r-e();try{for(;this.presentWorkQueue.length&&!(t>0&&i()<=0);){const e=this.presentWorkQueue.dequeueTask();t++;const r=e.callback.call(null,i);if(!e.runUntilDone||r)continue;let n=r;for(;!n&&i()>0;)n=e.callback.call(null,i);if(!n){this.futureWorkQueue.enqueueTask(e);break}}}finally{for(this.isPerformingWork=!1;this.futureWorkQueue.length;){const e=this.futureWorkQueue.dequeueTask();this.scheduleTask(e)}this.updateTimer()}}}const Q=500;class K{constructor(e={}){this.scale=new o((()=>{this.handleViewChange()})),this.offset=new o((()=>{this.handleViewChange()})),this.sprites=[],this.waitingSprites=[],this.instanceCount=0,this.callbacksIndexRange=new N,this.needsTextureSyncIndexRange=new N,this.needsRebaseIndexRange=new N,this.toBeRemovedIndexRange=new N,this.toBeRemovedTsRange=new N,this.removedIndexRange=new N,this.toDrawTsRange=new N,this.drawTaskId=Symbol("drawTask"),this.textureSyncTaskId=Symbol("textureSyncTask"),this.rebaseCount=0,this.hitTestCount=0,this.runRemovalTaskId=Symbol("runRemovalTaskId"),this.runAssignWaitingTaskId=Symbol("runAssignWaitingTask"),this.rebaseTaskId=Symbol("rebaseTask"),this.runCallbacksTaskId=Symbol("runCallbacksTask"),this.isViewInitialized=!1;const t=Object.assign({},P,e),{timingFunctions:i}=t,{now:n}=i;if(this.basisTs=n(),this.elapsedTimeMs=()=>n()-this.basisTs,this.workScheduler=new Y({timingFunctions:i}),"function"==typeof t.devicePixelRatio){const e=t.devicePixelRatio;this.getDevicePixelRatio=()=>{const t=e();if(isNaN(t)||t<=0)throw new RangeError("Callback returned invalid devicePixelRatio");return t}}else if("number"==typeof t.devicePixelRatio){const{devicePixelRatio:e}=t;if(isNaN(e)||e<=0)throw new RangeError("Provided devicePixelRatio value is invalid");this.getDevicePixelRatio=()=>e}this.container=t.container,this.defaultTransitionTimeMs=t.defaultTransitionTimeMs,this.orderZGranularity=t.orderZGranularity;const u=window.createREGL||r;if(!u)throw new Error("Could not find REGL");this.canvas=document.createElement("canvas"),Object.assign(this.canvas.style,{border:0,height:"100%",left:0,margin:0,padding:0,top:0,width:"100%"}),this.container.appendChild(this.canvas);const{width:b,height:x}=this.canvas.getBoundingClientRect(),y=this.getDevicePixelRatio();this.canvas.height=x*y,this.canvas.width=b*y;const w=this.regl=u({attributes:{preserveDrawingBuffer:!0},canvas:this.canvas,extensions:["angle_instanced_arrays","OES_texture_float","OES_texture_float_linear"]});this.initView();const T=this.attributeMapper=new a({maxTextureSize:w.limits.maxTextureSize,desiredSwatchCapacity:t.desiredSpriteCapacity,dataChannelCount:4});this.previousValuesFramebuffer=w.framebuffer({color:w.texture({width:T.textureWidth,height:T.textureHeight,channels:T.dataChannelCount,type:"float32",mag:"nearest",min:"nearest"}),depthStencil:!1}),this.previousValuesTexture=w.texture({width:T.textureWidth,height:T.textureHeight,channels:T.dataChannelCount,type:"float32",mag:"nearest",min:"nearest"}),this.targetValuesArray=new Float32Array(T.totalValues),this.targetValuesTexture=w.texture({width:T.textureWidth,height:T.textureHeight,channels:T.dataChannelCount,data:this.targetValuesArray,type:"float32",mag:"nearest",min:"nearest"}),this.instanceSwatchUvValues=T.generateInstanceSwatchUvValues(),this.instanceIndexValues=new Float32Array(T.totalSwatches);for(let e=0;e<T.totalSwatches;e++)this.instanceIndexValues[e]=e;const S=this.hitTestAttributeMapper=new a({maxTextureSize:w.limits.maxTextureSize,desiredSwatchCapacity:T.totalSwatches,dataChannelCount:4,attributes:[{attributeName:"Hit"}]});this.instanceHitTestOutputUvValues=this.hitTestAttributeMapper.generateInstanceSwatchUvValues(),this.instanceHitTestInputUvValues=new Float32Array(this.instanceSwatchUvValues.length),this.instanceHitTestInputIndexActiveValues=new Float32Array(2*T.totalSwatches),this.hitTestOutputValuesFramebuffer=w.framebuffer({color:w.texture({width:S.textureWidth,height:S.textureHeight,channels:S.dataChannelCount,type:"uint8",mag:"nearest",min:"nearest"}),depthStencil:!1}),this.hitTestOutputValues=new Uint8Array(S.dataChannelCount*S.totalSwatches),this.hitTestOutputResults=new Float32Array(S.totalSwatches),this.glyphMapper=new C(t.glyphMapper);for(const e of t.glyphs.split(""))this.glyphMapper.addGlyph(e);this.sdfTexture=w.texture({height:this.glyphMapper.textureSize,width:this.glyphMapper.textureSize,min:"linear",mag:"linear",wrap:"clamp",data:this.glyphMapper.textureData,format:"luminance",type:"float32"}),this.instanceSwatchUvBuffer=this.regl.buffer(this.instanceSwatchUvValues),this.instanceIndexBuffer=this.regl.buffer(this.instanceIndexValues),this.instanceHitTestInputUvBuffer=this.regl.buffer(this.instanceHitTestInputUvValues),this.instanceHitTestInputIndexActiveBuffer=this.regl.buffer(this.instanceHitTestInputIndexActiveValues),this.instanceHitTestOutputUvBuffer=this.regl.buffer(this.instanceHitTestOutputUvValues),this.instanceRebaseUvValues=new Float32Array(this.instanceSwatchUvValues.length),this.instanceRebaseUvBuffer=this.regl.buffer({usage:"dynamic",type:"float",data:this.instanceRebaseUvValues}),this.drawCommand=function(e){const t={blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[0,0,0,0]},viewport:()=>({x:0,y:0,width:e.canvas.width,height:e.canvas.height}),frag:s`
precision lowp float;

/**
 * Each sprite receives the same vertex coordinates, which describe a unit
 * square centered at the origin. However, the distance calculations performed
 * by the fragment shader use a distance of 1 to mean the dead center of a
 * circle, which implies a diameter of 2. So to convert from sprite vertex
 * coordinate space to edge distance space requires a dilation of 2.
 */
const float EDGE_DISTANCE_DILATION = 2.;

/**
 * View matrix for converting from world space to clip space.
 */
uniform mat3 viewMatrix;

/**
 * Signed-distance field (SDF) texture. Sampled for implementing glyphs of text.
 */
uniform sampler2D sdfTexture;

/**
 * Varying time value, eased using cubic-in-out between the previous and target
 * timestamps for this Sprite.
 */
varying float varyingT;

/**
 * Interpolated, per-vertex coordinate attributes for the quad into which the
 * sprite will be rendered.
 */
varying vec2 varyingVertexCoordinates;

/**
 * Threshold distance values to consider the pixel outside the shape (X) or
 * inside the shape (Y). Values between constitute the border.
 */
varying vec2 varyingBorderThresholds;

/**
 * Aspect ratio of the sprite's renderable area (XY) and their inverses (ZW).
 * One component of each pair will be 1. For the XY pair, the other component
 * be be greater than 1. and for the inverse pair it will be smaller.
 *
 * For example, a rectangle that's twice as wide as it is tall wolud have
 * varyingAspectRatio equal to vec4(2., 1., .5, 1.).
 */
varying vec4 varyingAspectRatio;

/**
 * Color attributes.
 */
varying vec4 varyingBorderColor;
varying vec4 varyingFillColor;

/**
 * Shape attributes used by fragment shader.
 */
varying float varyingPreviousSides;
varying float varyingTargetSides;
varying vec4 varyingPreviousShapeTexture;
varying vec4 varyingTargetShapeTexture;

// Import utility shader functions).
${l()}

const float PI = 3.1415926535897932384626433832795;

/**
 * Given a line segment described by two points (a,b), find the point along that
 * line segment nearest to a point of interest (p).
 */
vec2 closestPoint(vec2 a, vec2 b, vec2 p) {
  vec2 pa = p - a;
  vec2 ba = b - a;
  vec2 baNorm = normalize(ba);
  float baLen = length(ba);
  float projectedLen = dot(baNorm, pa);
  vec2 closest =
    projectedLen < 0. ? a :
    projectedLen > baLen ? b :
    a + baNorm * projectedLen;
  return closest;
}

/**
 * Matrix to flip XY coordinates for theta computation. To orient polygons and
 * stars pointing upwards, we compute angles counter-clockwise from vertical.
 */
const mat2 FLIP_MATRIX = mat2(vec2(0., 1.), vec2(-1., 0.));

/**
 * Given a point in the range (-1,-1) to (1,1), compute the angle to that point,
 * going counter-clockwise from vertical.
 */
float computeTheta(vec2 point) {
  vec2 f = FLIP_MATRIX * point;
  return atan(f.y, f.x) + PI;
}

/**
 * Given the varying coordinates of interest, the dimensions of the shape's
 * bounding box, the number of sides, and a list of repeating offset radii,
 * determine the signed distance from the coordinates to the nearest edge of the
 * shape.
 *
 * @param sides Number of sides of the polygon or star.
 * @param radii List of four repeating offset radii to render stars. If all
 * values are 0., then the rendered distance will be a regular polygon.
 */
float getDistStar(int sides, vec4 radii) {
  float fSides = float(sides);

  // Flip radii (0. means align with unit circle, 1. means center of shape).
  radii = 1. - radii;

  // Angle to cut through the midpoint of a regular polygon's side.
  float piSides = PI / fSides;

  // With the polygon pointed up, this is the angle (counter-clockwise from top)
  // to the point just before crossing the X-axis. For a triangle, this will
  // just be the same as piSides.
  float wideAngle = floor(fSides * .5) * piSides;

  // Compute radius for dilation to fill bounding box.
  float dilation = 1. / max(sin(wideAngle), sin(piSides));

  // Compute the height of the shape, for centering.
  float height = dilation * (1. + max(cos(PI - 2. * wideAngle), cos(piSides)));

  // The point of interest starts with the varyingVertexCoordinates, but shifted
  // to center the shape vertically.
  vec2 poi = EDGE_DISTANCE_DILATION * varyingVertexCoordinates +
    vec2(0., EDGE_DISTANCE_DILATION - height);

  // Compute theta for point of interest, counter-clockwise from vertical.
  float theta = computeTheta(poi);

  // Incorporate aspect ratio calculation. This ensures that distances to
  // borders do not stretch with the shape.
  vec2 aspect = varyingAspectRatio.xy;
  poi *= aspect;

  // Compute which side of the star we're on, and use this to compute adjustment
  // to a and b points. This creates the star effect.
  float side = floor(theta / PI * .5 * fSides);

  float minDistance = 1.e20;
  float distanceSign;

  // Look at sides to the left/right (clockwise) to find the closest.
  for (int i = -1; i < 2; i++) {
    float thisSide = side + float(i);
    float m = mod(thisSide + 4., 4.);

    vec2 adjust =
      m < 1. ? radii.xy :
      m < 2. ? radii.yz :
      m < 3. ? radii.zw :
      radii.wx;

    // Find the ab line segment endpoints.
    float thetaA = 2. * thisSide * piSides;
    float thetaB = thetaA + 2. * piSides;
    vec2 a = aspect * dilation * adjust.x * vec2(-sin(thetaA), cos(thetaA));
    vec2 b = aspect * dilation * adjust.y * vec2(-sin(thetaB), cos(thetaB));

    // Find the closest point on the segment and update minDistance.
    vec2 c = closestPoint(a, b, poi).xy;
    minDistance = min(minDistance, distance(poi, c));

    // If we're in our own segment, capture the distance sign.
    if (i == 0) {
      // Use cross product to determine if we're inside or outside the line.
      distanceSign = sign(cross(vec3(b - a, 0.), vec3(poi - c, 0.)).z);
    }
  }

  return minDistance * distanceSign;
}

/**
 * Convenience method for calling getDistStar() with a fixed size array of 0.
 * values to create a regular polygon.
 */
float getDistPolygon(int sides) {
  return getDistStar(sides, vec4(0.));
}

/**
 * Estimate the distance from the varying vertex coordinate to the nearest point
 * on an ellipse of the specified aspect ratio. Mathematically, a closed-form
 * solution for this problem has not yet been discovered.
 *
 * Higher accuracy estimates of ellipse distance are possible with more
 * computation steps, but the procedure used here yields sufficient accurancy
 * for data visualization purposes.
 */
float getDistEllipse() {
  // All quadrants can be treated the same, so use the absolute value of the
  // vertex coordinates, and flip if needed so that the X dimension is always
  // the greater.
  bool flipped = varyingAspectRatio.x < varyingAspectRatio.y;
  vec4 aspectRatio = flipped ? varyingAspectRatio.yxwz : varyingAspectRatio;

  // Point of interest in the expanded circle (before aspect ratio stretching).
  vec2 circlePoint = EDGE_DISTANCE_DILATION * abs(
      flipped ? varyingVertexCoordinates.yx : varyingVertexCoordinates);

  // Capture length for inside/outside checking.
  float len = length(circlePoint);

  // Point of interest in the ellipse (after aspect ratio stretching).
  vec2 ellipsePoint = circlePoint * aspectRatio.xy;

  // Compute the angle from the x-axis up to the point of interest.
  float theta = PI - atan(circlePoint.y, -circlePoint.x);

  // Find the point where a ray from the origin through c hits the ellipse.
  vec2 p1 = aspectRatio.xy * vec2(cos(theta), sin(theta));

  // Find a second point by casting up from the x-axis. If the point of interest
  // is outside the ellipse and past the tip, use the tip coordinate.
  float invAr2 = aspectRatio.z * aspectRatio.z;
  vec2 p2 = ellipsePoint.x > aspectRatio.x ? vec2(aspectRatio.x, 0.) :
    vec2(ellipsePoint.x, sqrt(1. - ellipsePoint.x * ellipsePoint.x * invAr2));

  // Take the minimum distance between ray intersection point and vertical.
  float dist = min(distance(ellipsePoint, p1), distance(ellipsePoint, p2));

  // If the point of interest is outside of the ellipse, smooth by checking the
  // distance to one more point: the point on the ellipse between p1 and p2 such
  // that its X coordinate is half way between.
  if (len > 1.) {
    vec2 pm = mix(p1, p2, .5);
    pm.y = sqrt(1. - pm.x * pm.x * invAr2);
    dist = min(dist, distance(ellipsePoint, pm));
  }

  // Return signed distance.
  return dist * sign(1. - len);
}

/**
 * Compute the signed distance from the point of interest to the nearest edge of
 * the sprite bonding box.
 */
float getDistRect() {
  // All quadrants can be treated the same, so we limit our computation to the
  // top right.
  vec2 ar = varyingAspectRatio.xy;
  vec2 p = ar * EDGE_DISTANCE_DILATION * abs(varyingVertexCoordinates);

  // If the point of intrest is beyond the top corner, return the negative
  // distance to that corner.
  bvec2 gt = greaterThan(p, ar);
  if (all(gt)) {
    return -distance(p, ar);
  }
  if (gt.x) {
    return ar.x - p.x;
  }
  if (gt.y) {
    return ar.y - p.y;
  }

  // Determine distance to nearest edge.
  vec2 d = ar - p;
  vec2 dabs = abs(d);
  return dabs.x < dabs.y ? d.x : d.y;
}

/**
 * Sample the distance from the sdfTexture. The texture is assumed to have
 * one-dimensional distances in the X and Y componets and two-dimensional
 * distance in the Z component.
 *
 * @param shapeTexture UV coordinates and width/height of the region of the SDF
 * texture within which to sample (corresponds to the glyph being rendered).
 */
float getDistSDF(vec4 shapeTexture) {
  // Clamp vertex coordinates to the -1 to 1 range.
  vec2 clamped = clamp(varyingVertexCoordinates, -1., 1.);

  // For sampling, UV coordinates are Y-flipped and shifted.
  vec2 coordUv = clamped * vec2(1., -1.) + .5;

  // Focus on the middle 50% of the UV space. Assumes glyphs were rendered with
  // buffer roughly equal to the font size.
  //
  //   +------+       .      .
  //   |      |         +--+
  //   |  k   |  =>     |k |
  //   |      |         +--+
  //   +------+       .      .
  //
  coordUv *= .5;
  coordUv += .25;

  // Offset into the texture according to the shapeTexture's location and size.
  vec2 textureUv =
      shapeTexture.xy +
      shapeTexture.zw * coordUv;

  return texture2D(sdfTexture, textureUv).z;
}

/**
 * Generic distance function that calls through to one of the more specific
 * distance functions.
 *
 * @param sides Number of sides of the polygon/star, or special value:
 *  s < 0      : Reserved / Undefined.
 *  s == 0     : Use SDF texture coordinates.
 *  s == 1     : Circle.
 *  s == 2     : Filled rectangle.
 *  s > 2      : Polygon / Star.
 * @param textureUv Offset into SDF texture.
 */
float getDist(int sides, vec4 shapeTexture) {
  return
    sides == 0 ? getDistSDF(shapeTexture) :
    sides == 1 ? getDistEllipse() :
    sides == 2 ? getDistRect() :
    sides > 2 ? getDistPolygon(sides) :
    1.; // Reserved / undefined.
}

void main () {
  int previousSides = int(varyingPreviousSides);
  int targetSides = int(varyingTargetSides);

  float previousDistance = getDist(previousSides, varyingPreviousShapeTexture);
  float targetDistance = getDist(targetSides, varyingTargetShapeTexture);
  float signedDistance = mix(previousDistance, targetDistance, varyingT);

  vec4 color =
    signedDistance < varyingBorderThresholds.x ? vec4(0.) :
    signedDistance < varyingBorderThresholds.y ? varyingBorderColor :
    varyingFillColor;

  if (color.a < .01) {
    discard;
    return;
  }

  gl_FragColor = color;
}
`,vert:g(e.attributeMapper),attributes:{vertexCoordinates:[[-.5,-.5],[.5,-.5],[-.5,.5],[.5,.5]],instanceSwatchUv:{buffer:e.instanceSwatchUvBuffer,divisor:1},instanceIndex:{buffer:e.instanceIndexBuffer,divisor:1}},uniforms:{ts:()=>e.elapsedTimeMs(),devicePixelRatio:()=>e.getDevicePixelRatio(),instanceCount:()=>e.instanceCount,orderZGranularity:()=>e.orderZGranularity,viewMatrix:()=>e.getViewMatrix(),viewMatrixScale:()=>e.getViewMatrixScale(),projectionMatrix:t=>e.getProjectionMatrix(t),sdfTexture:e.sdfTexture,previousValuesTexture:e.previousValuesFramebuffer,targetValuesTexture:e.targetValuesTexture},primitive:"triangle strip",count:4,instances:()=>e.instanceCount},r=e.regl(t);return()=>{e.regl.clear({color:[0,0,0,0],depth:1,framebuffer:null,stencil:0}),r.apply(null)}}(this),this.rebaseCommand=function(e){const t={frag:(r=e.attributeMapper,s`
precision lowp float;

uniform float ts;

uniform sampler2D previousValuesTexture;
uniform sampler2D targetValuesTexture;

varying float varyingTexelIndex;
varying vec2 varyingRebaseUv;

vec4 previousTexelValues[${r.texelsPerSwatch}];
vec4 targetTexelValues[${r.texelsPerSwatch}];

${r.generateAttributeDefinesGLSL("previous","previousTexelValues")}
${r.generateAttributeDefinesGLSL("target","targetTexelValues")}

// Import utility shader functions.
${l()}
${c()}

float computeValueAtTime(
    float startingValue,
    float startingDelta,
    float targetValue,
    float ts) {
  float rangeT =
    ts >= targetTransitionTimeMs() ? 1. :
    ts <= previousTransitionTimeMs() ? 0. :
    clamp(
        range(previousTransitionTimeMs(), targetTransitionTimeMs(), ts),
        0., 1.);
  float easeT = cubicEaseInOut(rangeT);

  float currentValue = mix(startingValue, targetValue, easeT);
  float projectedValue = startingDelta *
    (targetTransitionTimeMs() - previousTransitionTimeMs());

  return currentValue + projectedValue * rangeT * pow(1. - rangeT, 3.);
}

// DELTA_MS is the duration in milliseconds to use when estimating the
// 'instantaneous' change in a value. INV_DELTA_MS is its inverse.
#define DELTA_MS 1.
#define INV_DELTA_MS 1.

float computeDeltaAtTime(
    float startingValue,
    float startingDelta,
    float targetValue,
    float ts
) {
  if (ts >= targetTransitionTimeMs()) {
    return 0.;
  }
  if (ts <= previousTransitionTimeMs()) {
    return startingDelta;
  }
  return (
      computeValueAtTime(
          startingValue, startingDelta, targetValue, ts + DELTA_MS) -
      computeValueAtTime(
          startingValue, startingDelta, targetValue, ts)
      ) * INV_DELTA_MS;
}

float computeThresholdValue(
    float previousValue,
    float targetValue,
    float rebaseTs
) {
  float mid = mix(previousTransitionTimeMs(), targetTransitionTimeMs(), .5);
  return rebaseTs < mid ? previousValue : targetValue;
}

void readInputTexels() {
${r.generateTexelReaderGLSL("previousTexelValues","previousValuesTexture","varyingRebaseUv")}
${r.generateTexelReaderGLSL("targetTexelValues","targetValuesTexture","varyingRebaseUv")}
}

void setOutputTexel() {
  float rebaseTs = ts;
  ${r.generateRebaseFragmentGLSL("previousTexelValues","targetTexelValues","varyingTexelIndex","rebaseTs")}
}

void main () {
  readInputTexels();
  setOutputTexel();
}
`),vert:v(e.attributeMapper),attributes:{vertexCoordinates:[[-.5,-.5],[.5,-.5],[-.5,.5],[.5,.5]],instanceRebaseUv:{buffer:()=>e.instanceRebaseUvBuffer,divisor:1}},uniforms:{ts:()=>e.elapsedTimeMs(),targetValuesTexture:e.targetValuesTexture,previousValuesTexture:e.previousValuesTexture},primitive:"triangle strip",count:4,instances:()=>e.rebaseCount,framebuffer:()=>e.previousValuesFramebuffer};var r;const i=e.regl(t);return()=>{i()}}(this),this.hitTestCommand=function(e){const t={frag:s`
precision lowp float;

// Need to know the maximum possible value for the index of the Sprite to
// normalize the value for RGBA packing.
uniform float capacity;

varying float varyingHitTestResult;

vec4 packFloatToVec4i(const float value) {
  const vec4 bitSh = vec4(256. * 256. * 256., 256. * 256., 256., 1.);
  const vec4 bitMsk = vec4(0., 1./256., 1./256., 1./256.);
  vec4 res = fract(value * bitSh);
  res -= res.xxyz * bitMsk;
  return res;
}

float fitToRange(const float result) {
  // Adding 1 to account for missing values (-1 becomes 0, etc.)
  return (result + 1.) / (capacity + 1.);
}

void main () {
  // Packing requires a number in the range 0-1.
  float n = fitToRange(varyingHitTestResult);
  gl_FragColor = packFloatToVec4i(n);
}
`,vert:(r=e.hitTestAttributeMapper,i=e.attributeMapper,s`
precision lowp float;

/**
 * WebGL vertex shaders output coordinates in clip space, which is a 3D volume
 * where each component is clipped to the range (-1,1). The distance from
 * edge-to-edge is therefore 2.
 */
const float CLIP_SPACE_RANGE = 2.;

/**
 * Each sprite receives the same vertex coordinates, which describe a unit
 * square centered at the origin. However, the distance calculations performed
 * by the fragment shader use a distance of 1 to mean the dead center of a
 * circle, which implies a diameter of 2. So to convert from sprite vertex
 * coordinate space to edge distance space requires a dilation of 2.
 */
const float EDGE_DISTANCE_DILATION = 2.;

uniform float ts;

uniform float devicePixelRatio;

/**
 * Screen pixel coordinates for performing the hit test. The XY channels contain
 * the screen x and y coordinates respectively. The ZW channels hold the width
 * and height of the bounding box of interest. Currently those are ignored.
 */
uniform vec4 hitTestCoordinates;
uniform bool inclusive;

uniform mat3 viewMatrix;

/**
 * Scale includes the X and Y dimensions of the viewMatrix, and their inverses
 * in the WZ components.
 */
uniform vec4 viewMatrixScale;

uniform sampler2D previousValuesTexture;
uniform sampler2D targetValuesTexture;

attribute vec2 vertexCoordinates;

attribute vec2 inputUv;
attribute vec2 indexActive;
attribute vec2 outputUv;

#define TEXELS_PER_SWATCH ${r.texelsPerSwatch}.
#define TEXTURE_WIDTH ${r.textureWidth}.
#define TEXTURE_HEIGHT ${r.textureHeight}.

// The result of the hit test, written to the data texel by the fragment shader.
varying float varyingHitTestResult;

vec4 previousTexelValues[${i.texelsPerSwatch}];
vec4 targetTexelValues[${i.texelsPerSwatch}];

${i.generateAttributeDefinesGLSL("previous","previousTexelValues")}
${i.generateAttributeDefinesGLSL("target","targetTexelValues")}

float rangeT;
float easeT;

// Import utility shader functions.
${l()}
${c()}
${f("rangeT","easeT")}
${m()}
${p()}
${h()}
${d()}

void readInputTexels() {
${i.generateTexelReaderGLSL("previousTexelValues","previousValuesTexture","inputUv")}
${i.generateTexelReaderGLSL("targetTexelValues","targetValuesTexture","inputUv")}
}

const vec2 swatchSize =
  vec2(TEXELS_PER_SWATCH / TEXTURE_WIDTH, 1. / TEXTURE_HEIGHT);

bool spriteOverlapsTest(const vec4 spriteBox, const vec4 testBox) {
  return (
    spriteBox.x <= testBox.x + testBox.z &&
    spriteBox.x + spriteBox.z >= testBox.x &&
    spriteBox.y >= testBox.y - testBox.w &&
    spriteBox.y + spriteBox.w <= testBox.y
  );
}

bool spriteInsideTest(const vec4 spriteBox, const vec4 testBox) {
  return (
    spriteBox.x >= testBox.x &&
    spriteBox.x + spriteBox.z <= testBox.x + testBox.z &&
    spriteBox.y <= testBox.y &&
    spriteBox.y + spriteBox.w >= testBox.y - testBox.w
  );
}

void main () {
  readInputTexels();

  // Compute time variables.
  rangeT =
    ts >= targetTransitionTimeMs() ? 1. :
    ts <= previousTransitionTimeMs() ? 0. :
    clamp(range(previousTransitionTimeMs(), targetTransitionTimeMs(), ts),
        0., 1.);
  easeT = cubicEaseInOut(rangeT);

  // Compute current size component values by interpolation (parallelized).
  vec4 currentSizePixelAndWorld = computeCurrentSizePixelAndWorld();
  vec2 currentSizePixel = currentSizePixelAndWorld.xy;
  vec2 currentSizeWorld = currentSizePixelAndWorld.zw;

  vec2 currentGeometricZoom = computeCurrentValue(
      previousGeometricZoom(),
      previousGeometricZoomDelta(),
      targetGeometricZoom()
  );

  vec4 currentMaxAndMinSizePixel = computeCurrentMaxAndMinSizePixel();
  vec2 currentMaxSizePixel = currentMaxAndMinSizePixel.xy;
  vec2 currentMinSizePixel = currentMaxAndMinSizePixel.zw;

  // Compute the current size of the sprite in world units, including the effect
  // of geometric zoom and applying min and max pixel sizes.
  vec2 computedSize = computeSize(
    currentSizeWorld,
    currentSizePixel,
    currentGeometricZoom,
    viewMatrixScale,
    currentMaxSizePixel,
    currentMinSizePixel
  );

  // Compute border attributes in parallel.
  vec3 borderProperties = computeCurrentValue(
      vec3(
        previousBorderRadiusPixel(),
        previousBorderRadiusRelative(),
        previousBorderPlacement()),
      vec3(
        previousBorderRadiusPixelDelta(),
        previousBorderRadiusRelativeDelta(),
        previousBorderPlacementDelta()),
      vec3(
        targetBorderRadiusPixel(),
        targetBorderRadiusRelative(),
        targetBorderPlacement())
  );
  float currentBorderRadiusPixel = borderProperties.x;
  float currentBorderRadiusRelative = borderProperties.y;
  float currentBorderPlacement = borderProperties.z;

  // Project the computed size into pixels by using the viewMatrixScale. Note
  // that this already includes the effect of the devicePixelRatio, and a 2x
  // multiplier for clip-space, which goes from -1 to 1 in all dimensions.
  vec2 projectedSizePixel = computedSize.xy * viewMatrixScale.xy;

  // Compute the distance from the sprite edge to the extent of the border. Used
  // to shift the corners before hit testing to make sure the bounding box
  // includes borders outside of the shape.
  float edgeDistance = currentBorderRadiusRelative + (
      currentBorderRadiusPixel *
      CLIP_SPACE_RANGE *
      EDGE_DISTANCE_DILATION *
      devicePixelRatio /
      min(projectedSizePixel.x, projectedSizePixel.y)
    );

  // Shift coorner vertices outward to account for borders, which may expand
  // the bounding box of the sprite. XY are the bottom left corner, ZW are for
  // the top right.
  vec4 cornerCoordinates = vec4(-.5, -.5, .5, .5) *
    (1. + edgeDistance * currentBorderPlacement);

  // Compute the current position component attributes.
  vec2 currentPositionPixel = computeCurrentValue(
      previousPositionPixel(),
      previousPositionPixelDelta(),
      targetPositionPixel());

  vec2 currentPositionWorld = computeCurrentValue(
      previousPositionWorld(),
      previousPositionWorldDelta(),
      targetPositionWorld());

  vec2 currentPositionRelative = computeCurrentValue(
      previousPositionRelative(),
      previousPositionRelativeDelta(),
      targetPositionRelative());

  // Project the world position into pixel space for the bottom left and top
  // right corners of the sprite's quad.
  vec2 bottomLeft = computeViewVertexPosition(
      currentPositionWorld,
      computedSize,
      currentPositionRelative,
      currentPositionPixel,
      cornerCoordinates.xy,
      viewMatrix
  ) * .5 / devicePixelRatio;
  vec2 topRight = computeViewVertexPosition(
      currentPositionWorld,
      computedSize,
      currentPositionRelative,
      currentPositionPixel,
      cornerCoordinates.zw,
      viewMatrix
  ) * .5 / devicePixelRatio;
  vec4 spriteBox = vec4(bottomLeft.xy, topRight.xy - bottomLeft.xy);

  // Hit test coordinates are presented based on the top-left corner, so to
  // orient it from the bottom left we need to subtract the height.
  vec4 testBox = hitTestCoordinates + vec4(0., hitTestCoordinates.w, 0., 0.);

  // Test whether the coordinates of interest are within the sprite quad's
  // bounding box.
  bool hit = inclusive ?
    spriteOverlapsTest(spriteBox, testBox) :
    spriteInsideTest(spriteBox, testBox);

  // The hit test result will either be -1 if it's a miss (or the Sprite was
  // inactive), or it will be the index of the Sprite.
  varyingHitTestResult =
    indexActive.y <= 0. ? -1. :
    !hit ? -1. :
    indexActive.x;

  vec2 swatchUv =
    outputUv + (vertexCoordinates.xy + .5) * swatchSize;

  // Position the verts to write into the appropriate data texel.
  gl_Position = vec4(2. * swatchUv - 1., 0., 1.);
}
`),attributes:{vertexCoordinates:[[-.5,-.5],[.5,-.5],[-.5,.5],[.5,.5]],inputUv:{buffer:()=>e.instanceHitTestInputUvBuffer,divisor:1},indexActive:{buffer:()=>e.instanceHitTestInputIndexActiveBuffer,divisor:1},outputUv:{buffer:e.instanceHitTestOutputUvBuffer,divisor:1}},uniforms:{ts:()=>e.elapsedTimeMs(),capacity:()=>e.hitTestAttributeMapper.totalSwatches,devicePixelRatio:()=>e.getDevicePixelRatio(),hitTestCoordinates:()=>[e.hitTestParameters.x,e.hitTestParameters.y,e.hitTestParameters.width||0,e.hitTestParameters.height||0],inclusive:()=>void 0===e.hitTestParameters||!!e.hitTestParameters.inclusive,viewMatrix:()=>e.getViewMatrix(),viewMatrixScale:()=>e.getViewMatrixScale(),targetValuesTexture:e.targetValuesTexture,previousValuesTexture:e.previousValuesTexture},primitive:"triangle strip",count:4,instances:()=>e.hitTestCount,framebuffer:()=>e.hitTestOutputValuesFramebuffer};var r,i;const n=e.regl(t);return()=>{n()}}(this),this.queueDraw()}getDevicePixelRatio(){return"undefined"!=typeof window&&window.devicePixelRatio||1}initView(){if(this.isViewInitialized)return;const{width:e,height:t}=this.canvas.getBoundingClientRect();if(!e||!t)return;this.lastDevicePixelRatio=this.getDevicePixelRatio(),this.canvas.width=e*this.lastDevicePixelRatio,this.canvas.height=t*this.lastDevicePixelRatio;const r=Math.min(e,t)||Math.max(e,t)||Math.min(window.innerWidth,window.innerHeight);this.scale.x=r,this.scale.y=r,this.offset.x=e/2,this.offset.y=t/2,this.isViewInitialized=!0}handleViewChange(){this.isViewInitialized=!0,this.queueDraw()}resize(e){if(!this.isViewInitialized)return void this.initView();if(!this.lastDevicePixelRatio)throw new I("initView must set lastDevicePixelRatio");const t=this.canvas.width/this.lastDevicePixelRatio,r=this.canvas.height/this.lastDevicePixelRatio;e=e||{x:t/2,y:r/2};const i=t>0?e.x/t:.5,n=r>0?e.y/r:.5,{width:a,height:o}=this.canvas.getBoundingClientRect();this.lastDevicePixelRatio=this.getDevicePixelRatio(),this.canvas.width=a*this.lastDevicePixelRatio,this.canvas.height=o*this.lastDevicePixelRatio,this.offset.x+=i*(a-t),this.offset.y+=n*(o-r),this.queueDraw()}hitTest(e){const{sprites:t,x:r,y:i,width:n,height:a,inclusive:o}=e;if(!Array.isArray(t))throw new Error("Hit testing requires an array of candidate sprites");if(isNaN(r)||isNaN(i))throw new Error("Hit testing requires numeric x and y coordinates");if(void 0!==n&&isNaN(n)||void 0!==a&&isNaN(a))throw new Error("If specified, width and height must be numeric");return this.hitTestParameters={sprites:t,x:r,y:i,width:n||0,height:a||0,inclusive:void 0===o||!!o},t.length?(function(e){const{sprites:t,width:r,height:i,inclusive:n}=e.hitTestParameters;e.hitTestCount=t.length;const a=e.hitTestOutputResults.subarray(0,e.hitTestCount);if(!(n||r&&i))return console.warn("Inclusive hit test on a box with zero size always misses"),void a.fill(-1);const o=e.instanceHitTestInputUvValues,s=e.instanceHitTestInputIndexActiveValues,u=e.instanceSwatchUvValues;for(let e=0;e<t.length;e++){const r=t[e],i=r[R].index||0;o[2*e]=u[2*i],o[2*e+1]=u[2*i+1],s[2*e]=i,s[2*e+1]=r.isActive?1:0}e.instanceHitTestInputUvBuffer(o.subarray(0,2*e.hitTestCount)),e.instanceHitTestInputIndexActiveBuffer(s.subarray(0,2*e.hitTestCount)),e.hitTestCommand();const l=Math.ceil(e.hitTestCount/e.hitTestAttributeMapper.swatchesPerRow);e.regl.read({x:0,y:0,width:e.hitTestAttributeMapper.textureWidth,height:l,data:e.hitTestOutputValues,framebuffer:e.hitTestOutputValuesFramebuffer});const{totalSwatches:c}=e.hitTestAttributeMapper,f=e.hitTestOutputValues;for(let t=0;t<e.hitTestCount;t++){const e=(f[4*t]/16777216+f[4*t+1]/65536+f[4*t+2]/256+f[4*t+3])/255;a[t]=e*(c+1)-1}}(this),this.hitTestOutputResults.subarray(0,t.length)):new Float32Array(0)}doDraw(){this.initView();const e=this.elapsedTimeMs();this.drawCommand(),this.toDrawTsRange.isDefined&&(this.toDrawTsRange.truncateToWithin(e,1/0),this.queueDraw(!1))}queueDraw(e=!0){this.queueTask(this.drawTaskId,(()=>{this.doDraw()}),e)}snapshot(){return t(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{this.canvas.toBlob((r=>{r?e(r):t(r)}))}))}))}getViewMatrix(){if(!this.lastDevicePixelRatio)throw new I("initView must set lastDevicePixelRatio");const e=2*this.lastDevicePixelRatio;return[this.scale.x*e,0,0,0,this.scale.y*-e,0,this.offset.x*e,this.offset.y*e,1]}getViewMatrixScale(){if(!this.lastDevicePixelRatio)throw new I("initView must set lastDevicePixelRatio");const e=2*this.lastDevicePixelRatio,t=this.scale.x*e,r=this.scale.y*e;return[t,r,1/t,1/r]}getProjectionMatrix({viewportWidth:e,viewportHeight:t}){return[1/e,0,0,0,-1/t,0,-1,1,1]}getNextIndex(){if(!this.removedIndexRange.isDefined)return this.sprites.length<this.attributeMapper.totalSwatches?this.sprites.length:void 0;const{lowBound:e,highBound:t}=this.removedIndexRange;for(let r=e;r<=t;r++){if(this.sprites[r][R].lifecyclePhase===B.Removed)return r===t?this.removedIndexRange.clear():this.removedIndexRange.truncateToWithin(r+1,t),r}throw new I("No removed sprites found in removed index range")}createSprite(){const e=Object.seal(new F(this));if(this.waitingSprites.length>0||!this.removedIndexRange.isDefined&&this.sprites.length>=this.attributeMapper.totalSwatches)this.waitingSprites.push(e);else{const t=this.getNextIndex();if(void 0===t)throw new I("Next index undefined despite available capacity");this.assignSpriteToIndex(e,t)}return e}assignSpriteToIndex(e,t){const r=e[R];if(r.lifecyclePhase!==B.Created)throw new I("Only sprites in the Created phase can be assigned indices");const{valuesPerSwatch:i}=this.attributeMapper,n=this.targetValuesArray.subarray(t*i,(t+1)*i);n.fill(0),r.lifecyclePhase=B.Rest,r.index=t,r.spriteView=Object.seal(new z(n)),this.sprites[t]=e,this.instanceCount<=t+1&&(this.instanceCount=t+1)}markSpriteCallback(e){this.callbacksIndexRange.expandToInclude(e),this.queueRunCallbacks()}removeSprite(e){if(e.isRemoved)throw new I("Sprite can be removed only once");const t=e[R];t.index===this.instanceCount-1&&this.instanceCount--,t.lifecyclePhase=B.Removed,t.spriteView&&(t.spriteView[E]=void 0),void 0!==t.index&&this.removedIndexRange.expandToInclude(t.index)}queueTask(e,t,r=!1){this.workScheduler.isScheduledId(e)||this.workScheduler.scheduleTask({id:e,callback:t,beginImmediately:r})}queueRebase(){this.queueTask(this.rebaseTaskId,(()=>{!function(e){if(!e.needsRebaseIndexRange.isDefined)throw new I("No sprites are queued for rebase");e.rebaseCount=0;const{lowBound:t,highBound:r}=e.needsRebaseIndexRange;for(let i=t;i<=r;i++){const t=e.sprites[i][R];t.lifecyclePhase===B.NeedsRebase&&(e.needsTextureSyncIndexRange.expandToInclude(i),t.lifecyclePhase=B.NeedsTextureSync,e.instanceRebaseUvValues[2*e.rebaseCount]=e.instanceSwatchUvValues[2*i],e.instanceRebaseUvValues[2*e.rebaseCount+1]=e.instanceSwatchUvValues[2*i+1],e.rebaseCount++)}if(!e.rebaseCount)throw new I("No sprites were found to need rebase");e.queueTextureSync(),e.instanceRebaseUvBuffer(e.instanceRebaseUvValues.subarray(0,2*e.rebaseCount)),e.rebaseCommand(),e.previousValuesFramebuffer.use((()=>e.previousValuesTexture({copy:!0}))),e.needsRebaseIndexRange.clear()}(this)}))}queueAssignWaiting(){this.queueTask(this.runAssignWaitingTaskId,(e=>{!function(e,t,r){const{removedIndexRange:i,sprites:n,waitingSprites:a}=e;if(!i.isDefined)throw new I("No removed indices available to assign");if(!a.length)throw new I("No waiting sprites to assign");let o=0,s=i.lowBound,u=1,l=!1;for(;o<a.length&&s<=i.highBound&&!(o>0&&u++%r==0&&t()<=0);){for(;o<a.length&&a[o][R].isAbandoned;)o++;if(o>=a.length)break;for(;s<=i.highBound&&!n[s].isRemoved;)s++;if(s>i.highBound)throw new I("Removed index range ended on a non-removed sprite");const t=a[o],r=n[s][R],u=t[R];if(void 0===r.index)throw new I("Removed Sprite lacks index");if(e.assignSpriteToIndex(t,r.index),void 0===u.index)throw new I("Sprite index was not assigned");u.hasCallback&&(l=!0,u.lifecyclePhase=B.HasCallback,e.callbacksIndexRange.expandToInclude(u.index)),o++,s++}a.splice(0,o),s>i.highBound?i.clear():i.truncateToWithin(s,i.highBound),l&&e.queueRunCallbacks(),a.length&&i.isDefined&&e.queueAssignWaiting()}(this,e,Q)}))}queueRunCallbacks(){this.queueTask(this.runCallbacksTaskId,(e=>{!function(e,t,r){if(!e.callbacksIndexRange.isDefined)throw new I("Running callbacks requires a range of indices");const{lowBound:i,highBound:n}=e.callbacksIndexRange;let a,o;e.callbacksIndexRange.clear();let s=!1,u=!1;const l=e.elapsedTimeMs(),c=()=>{if(!o)throw new I("Attempted to re-run afterCallback steps");const{spriteView:t,index:r}=o;if(!t||void 0===r)throw new I("Sprite missing required properties");t.TransitionTimeMs+=l,e.toDrawTsRange.expandToInclude(t.TransitionTimeMs+e.workScheduler.maxWorkTimeMs),t.TransitionTimeMs>l?(s=!0,o.lifecyclePhase=B.NeedsRebase,e.needsRebaseIndexRange.expandToInclude(r)):(u=!0,o.lifecyclePhase=B.NeedsTextureSync,e.needsTextureSyncIndexRange.expandToInclude(r),o.toBeRemoved&&!o.hasCallback&&t[E].fill(0)),a=void 0,o=void 0};let f=i;try{let l=1;for(;f<=n&&!(f>i&&l++%r==0&&t()<=0);){if(a=e.sprites[f],o=a[R],f++,o.lifecyclePhase!==B.HasCallback)continue;if(!o.spriteView)throw new I("Sprite in HasCallback lifecycle phase missing SpriteView");let t;if(o.enterCallback)t=o.enterCallback,o.enterCallback=void 0;else if(o.updateCallback)t=o.updateCallback,o.updateCallback=void 0;else{if(!o.exitCallback)throw new I("Sprite in HasCallback state missing callbacks");t=o.exitCallback,o.exitCallback=void 0}o.spriteView.TransitionTimeMs=e.defaultTransitionTimeMs,l=0,t.call(a,o.spriteView),c()}}catch(e){throw o&&o.lifecyclePhase===B.HasCallback&&c(),e}finally{s&&e.queueRebase(),u&&e.queueTextureSync(),f<=n&&(e.callbacksIndexRange.expandToInclude(f),e.callbacksIndexRange.expandToInclude(n)),e.callbacksIndexRange.isDefined&&e.queueRunCallbacks(),e.toDrawTsRange.isDefined&&e.queueDraw()}}(this,e,Q)}))}queueRemovalTask(){this.queueTask(this.runRemovalTaskId,(e=>{!function(e,t,r){if(!e.toBeRemovedIndexRange.isDefined||!e.toBeRemovedTsRange.isDefined)throw new I("No sprites are queued for removal");const i=e.elapsedTimeMs();if(i<e.toBeRemovedTsRange.lowBound)return void e.queueRemovalTask();const{lowBound:n,highBound:a}=e.toBeRemovedIndexRange;e.toBeRemovedIndexRange.clear(),e.toBeRemovedTsRange.clear();let o=n;try{let s=1;for(;o<=a&&!(o>n&&s++%r==0&&t()<=0);o++){const t=e.sprites[o][R];if(t.toBeRemoved&&t.lifecyclePhase===B.Rest){if(!t.spriteView||void 0===t.index)throw new I("Sprite missing required properties");t.spriteView.TransitionTimeMs>i?(e.toBeRemovedIndexRange.expandToInclude(o),e.toBeRemovedTsRange.expandToInclude(t.spriteView.TransitionTimeMs)):(t.spriteView[E].fill(0),t.lifecyclePhase=B.NeedsTextureSync,e.needsTextureSyncIndexRange.expandToInclude(t.index))}}}finally{if(e.needsTextureSyncIndexRange.isDefined&&e.queueTextureSync(),o<a){e.toBeRemovedIndexRange.expandToInclude(o+1),e.toBeRemovedIndexRange.expandToInclude(a);for(let t=o+1;t<=a;t++){const r=e.sprites[t][R];if(!0===r.toBeRemoved&&r.lifecyclePhase===B.Rest){if(!r.spriteView)throw new I("Sprite lacks a SpriteView");e.toBeRemovedTsRange.expandToInclude(r.spriteView.TransitionTimeMs)}}}e.toBeRemovedIndexRange.isDefined&&e.queueRemovalTask()}}(this,e,Q)}))}queueTextureSync(){this.queueTask(this.textureSyncTaskId,(()=>{!function(e){if(!e.needsTextureSyncIndexRange.isDefined)throw new I("No sprites are in need of texture sync");const{swatchesPerRow:t,textureWidth:r,valuesPerRow:i}=e.attributeMapper;if(e.needsRebaseIndexRange.isDefined){const r=W(e.needsRebaseIndexRange,t);if(W(e.needsTextureSyncIndexRange,t).overlaps(r))return e.queueRebase(),void e.queueTextureSync()}const{lowBound:n,highBound:a}=e.needsTextureSyncIndexRange,o=Math.floor(n/t),s=Math.floor(a/t)+1,u=s-o,l=e.targetValuesArray.subarray(o*i,s*i);let c=!1,f=!1;const d=e.elapsedTimeMs(),h=o*t,p=Math.min(s*t-1,e.sprites.length-1);for(let t=h;t<=p;t++){const r=e.sprites[t],i=r[R];if(i.lifecyclePhase===B.NeedsRebase)throw new I("Sprite is in the wrong lifecycle phase for sync");if(i.lifecyclePhase===B.NeedsTextureSync){if(!i.spriteView)throw new I("Sprite queued for texture sync lacks a SpriteView");i.hasCallback?(c=!0,i.lifecyclePhase=B.HasCallback,e.callbacksIndexRange.expandToInclude(t)):i.toBeRemoved?i.spriteView.TransitionTimeMs<=d?e.removeSprite(r):(f=!0,i.lifecyclePhase=B.Rest,e.toBeRemovedIndexRange.expandToInclude(t),e.toBeRemovedTsRange.expandToInclude(i.spriteView.TransitionTimeMs)):i.lifecyclePhase=B.Rest}}e.waitingSprites.length&&e.removedIndexRange.isDefined&&e.queueAssignWaiting(),c&&e.queueRunCallbacks(),f&&e.queueRemovalTask(),e.needsTextureSyncIndexRange.clear();const m={data:l,width:r,height:u};e.targetValuesTexture.subimage(m,0,o)}(this)}))}createSelection(){return new M(Q,this)}createTextSelection(){return new H(Q,this,this.workScheduler,this.glyphMapper)}}e.Scene=class{constructor(e={}){this[D]=new K(e)}get scale(){return this[D].scale}get offset(){return this[D].offset}get canvas(){return this[D].canvas}resize(e){this[D].resize(e)}elapsedTimeMs(){return this[D].elapsedTimeMs()}createSprite(){return this[D].createSprite()}hitTest(e){return this[D].hitTest(e)}createSelection(){return this[D].createSelection()}createTextSelection(){return this[D].createTextSelection()}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=megaplot-v0.1.2.bundle.es2015.min.js.map
